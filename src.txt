// SRC BUNDLE 2025-12-11T03:34:25.320Z

/* FILE: src/api/axios.config.ts */
// src/api/axios.config.ts
import axios from 'axios';
import { useAuthStore } from '../store/authStore';

const api = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL,
  headers: { 'Content-Type': 'application/json', Accept: 'application/json' },
});

api.interceptors.request.use((config) => {
  const token = useAuthStore.getState().token;
  if (token) config.headers.Authorization = `Bearer ${token}`;
  return config;
});

api.interceptors.response.use(
  (response) => response, // keep AxiosResponse
  (error) => {
    const { response } = error || {};
    const structuredError = {
      status: response?.status,
      message:
        response?.data?.message ||
        response?.data?.error ||
        'Something went wrong',
      errors: response?.data?.errors ?? null,
    };
    // Override Axios default text
    error.message = structuredError.message;
    return Promise.reject(structuredError); // or Promise.reject(error);
  }
);

export default api;

/* FILE: src/api/handlers/adminDashboard.api.ts */
// FILE PATH: src/api/handlers/adminDashboard.api.ts

/**
 * Admin Dashboard API Handler
 * Handles all API calls for admin dashboard analytics
 */

import api from '../axios.config';

// ==================== TYPES ====================

export interface DashboardFilters {
  from?: string;
  to?: string;
  granularity?: 'day' | 'week' | 'month';
  client_id?: number;
  project_id?: number;
  supplier_id?: number;
  product_id?: number;
  workflow?: string;
  payment_status?: string;
  delivery_method?: string;
  tz?: string;
  charts?: string;
  buckets?: string;
}

export interface DashboardKPIs {
  // Primary metrics
  orders_total: number;
  orders_total_prev: number;
  orders_change: number;
  
  revenue: number;
  revenue_prev: number;
  revenue_change: number;
  
  avg_order_value: number;
  
  completed_orders: number;
  completed_orders_prev: number;
  completed_change: number;
  
  // Activity metrics
  active_clients: number;
  active_clients_prev: number;
  active_clients_change: number;
  
  active_suppliers: number;
  
  // Alerts & Actions
  awaiting_payment: number;
  supplier_missing: number;
  pending_supplier_approvals: number;
  
  // Performance
  cancellation_rate: number;
  repeat_client_rate: number;
  
  // System totals
  total_clients: number;
  total_suppliers: number;
}

export interface ChartSeries {
  name: string;
  data: string[];
}

export interface Chart {
  id: string;
  title: string;
  group_by: string;
  type?: string;
  labels: string[];
  series: ChartSeries[];
}

export interface TopClient {
  client_id: number;
  client_name: string;
  client_email: string;
  order_count: number;
  total_spend: number;
}

export interface TopSupplier {
  supplier_id: number;
  supplier_name: string;
  supplier_email: string;
  order_count: number;
  revenue: number;
}

export interface RecentActivity {
  id: number;
  type: string;
  order_id: number;
  po_number: string;
  client_name: string;
  project_name: string;
  amount: number;
  workflow: string;
  timestamp: string;
  time_ago: string;
}

export interface Alert {
  type: 'warning' | 'error' | 'info' | 'success';
  priority: 'high' | 'medium' | 'low';
  message: string;
  action_url: string;
}

export interface DashboardMetadata {
  generated_at: string;
  data_freshness: string;
  total_records_analyzed: number;
  period_days: number;
}

export interface DashboardResponse {
  filters: DashboardFilters & {
    group_by: null;
    metric: string;
    currency: string;
    charts: string[];
  };
  kpis: DashboardKPIs;
  charts: Chart[];
  tables: {
    top_clients_by_spend: TopClient[];
    top_suppliers_by_revenue: TopSupplier[];
    recent_activity: RecentActivity[];
  };
  alerts: Alert[];
  metadata: DashboardMetadata;
}

// ==================== API FUNCTIONS ====================

export const adminDashboardAPI = {
  /**
   * Get dashboard summary with KPIs, charts, and tables
   * @param filters - Dashboard filters
   * @returns Dashboard data
   */
  getSummary: async (filters?: DashboardFilters): Promise<DashboardResponse> => {
    try {
      const response = await api.get('/admin/dashboard/summary', { params: filters });
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || 'Failed to fetch dashboard data');
    }
  },
};

/* FILE: src/api/handlers/adminOrders.api.ts */
// FILE PATH: src/api/handlers/adminOrders.api.ts

/**
 * Admin Orders API Handler
 * Handles all API calls for admin order management
 */

import api from '../axios.config';
import type {
  AdminOrdersListResponse,
  AdminOrderDetailResponse,
  AdminOrdersQueryParams,
  AdminOrderUpdatePayload,
} from '../../types/adminOrder.types';

export const adminOrdersAPI = {
  /**
   * Get list of all orders with filters
   */
  getOrders: async (params: AdminOrdersQueryParams): Promise<AdminOrdersListResponse> => {
    try {
      const response = await api.get('/admin/orders', { params });
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || 'Failed to fetch orders');
    }
  },

  /**
   * Get single order details
   */
  getOrderDetail: async (orderId: number): Promise<AdminOrderDetailResponse> => {
    try {
      const response = await api.get(`/admin/orders/${orderId}`);
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || `Failed to fetch order ${orderId}`);
    }
  },

  /**
   * Update order (admin only) - currently only discount
   */
  updateOrder: async (
    orderId: number,
    payload: AdminOrderUpdatePayload
  ): Promise<{ message: string }> => {
    try {
      const response = await api.post(`/admin/orders/${orderId}/admin-update`, payload);
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || 'Failed to update order');
    }
  },

  /**
   * Assign supplier to order item
   */
  assignSupplier: async (payload: {
    order_id: number;
    item_id: number;
    supplier: number;
    offer_id?: number;
  }): Promise<{ message: string; order: any; item: any; offer: any }> => {
    try {
      const response = await api.post('/admin/orders/assign-supplier', payload);
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || 'Failed to assign supplier');
    }
  },

  /**
   * Set quoted price for order item
   */
  setItemQuotedPrice: async (
    orderId: number,
    itemId: number,
    quotedPrice: number | null
  ): Promise<{ message: string; order: any; item: any }> => {
    try {
      const response = await api.post(
        `/admin/orders/${orderId}/items/${itemId}/quoted-price`,
        { quoted_price: quotedPrice }
      );
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || 'Failed to set quoted price');
    }
  },

  /**
   * Mark item as paid
   */
  markItemAsPaid: async (
    orderId: number,
    itemId: number,
    isPaid: boolean
  ): Promise<{ message: string }> => {
    try {
      const response = await api.post(
        `/admin/orders/${orderId}/items/${itemId}/mark-paid`,
        { is_paid: isPaid }
      );
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || 'Failed to update payment status');
    }
  },


  updateOrderStatus: async (
    orderId: number,
    order_status: string
  ): Promise<{ order_status: string; message: string }> => {
    try {
      const response = await api.post(
        `/admin/orders/update-order-status/${orderId}`,
        { order_status }
      );
      return response.data;
    } catch (error: any) {
      throw new Error(error.message || 'Failed to update order status');
    }
  },


  /**
   * Admin update order item pricing
   * Endpoint: POST /admin/update-item-pricing/{orderItem}
   */
  adminUpdateOrderItem: async (
    orderItemId: number,
    payload: {
      supplier_unit_cost?: number;
      supplier_discount?: number;
      delivery_cost?: number;
      delivery_type?: 'Included' | 'Supplier' | 'ThirdParty' | 'Fleet' | 'None';
      supplier_delivery_date?: string;
      supplier_confirms?: boolean;
      supplier_notes?: string;
      quantity?: number;
    }
  ): Promise<{ success: boolean; message: string; data: any }> => {
    try {
      const response = await api.post(
        `/admin/update-item-pricing/${orderItemId}`,
        payload
      );
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || 'Failed to update order item');
    }
  },
};
/* FILE: src/api/handlers/adminSupplierZones.api.ts */
// src/api/handlers/adminSupplierZones.api.ts
import api from '../axios.config';

export interface DeliveryZone {
  address: string;
  lat: number;
  long: number;
  radius: number;
}

export interface SupplierWithZones {
  id: number;
  name: string;
  email: string;
  profile_image?: string;
  delivery_zones: DeliveryZone[];
}

export interface PaginatedSuppliersResponse {
  current_page: number;
  data: SupplierWithZones[];
  first_page_url: string;
  from: number;
  last_page: number;
  last_page_url: string;
  links: Array<{
    url: string | null;
    label: string;
    page: number | null;
    active: boolean;
  }>;
  next_page_url: string | null;
  path: string;
  per_page: number;
  prev_page_url: string | null;
  to: number;
  total: number;
}

export interface AdminSupplierZonesParams {
  page?: number;
  per_page?: number;
  search?: string;
}

export const adminSupplierZonesAPI = {
  /**
   * Get all suppliers with their delivery zones (paginated)
   */
  getSuppliersWithZones: async (
    params: AdminSupplierZonesParams = {}
  ): Promise<PaginatedSuppliersResponse> => {
    try {
      const response = await api.get('/suppliers-with-zones', { params });
      return response.data;
    } catch (error: any) {
      throw new Error(
        error?.message || 'Failed to fetch suppliers with zones'
      );
    }
  },
};
/* FILE: src/api/handlers/auth.api.ts */
// src/api/handlers/auth.api.ts
import api from '../axios.config';

interface LoginCredentials {
  email: string;
  password: string;
}

interface ClientRegistrationData {
  name: string;
  email: string;
  password: string;
  contact_name: string;
  contact_number: string;
  shipping_address: string;
  billing_address: string;
  company_name?: string;
  profile_image?: File;
  lat: number; long: number; 
}

interface SupplierRegistrationData {
  name: string;
  email: string;
  password: string;
  contact_name: string;
  contact_number: string;
  location: string;
  delivery_radius?: number;
  company_name: string;
  profile_image?: File;
}

export const authAPI = {
  login: async (credentials: LoginCredentials) => {
    try {
        const res = await api.post('/login', credentials);
        return res.data;
      } catch (e: any) {
        const msg =
          e?.message ||
          e?.response?.data?.error ||
          (e?.status === 401 ? 'Invalid credentials' : 'Something went wrong');
        throw new Error(msg);
      }
  },

  // ✅ FIXED: Client Registration with FormData
  registerClient: async (data: ClientRegistrationData) => {
  const formData = new FormData();
  formData.append('name', data.name);
  formData.append('email', data.email);
  formData.append('password', data.password);
  formData.append('contact_name', data.contact_name);
  formData.append('contact_number', data.contact_number);
  formData.append('shipping_address', data.shipping_address);
  formData.append('billing_address', data.billing_address);
  if (data.company_name) formData.append('company_name', data.company_name);
  if (data.profile_image) formData.append('profile_image', data.profile_image);
  formData.append('lat', String(data.lat));    // ← send
  formData.append('long', String(data.long));  // ← send
  return api.post('/register/client', formData, { headers: { 'Content-Type': 'multipart/form-data' }});
},

  // ✅ FIXED: Supplier Registration with FormData
  registerSupplier: async (data: SupplierRegistrationData) => {
    const formData = new FormData();
    
    // Append all fields to FormData
    formData.append('name', data.name);
    formData.append('email', data.email);
    formData.append('password', data.password);
    formData.append('contact_name', data.contact_name);
    formData.append('contact_number', data.contact_number);
    formData.append('location', data.location);
    formData.append('company_name', data.company_name);
    
    // ✅ CRITICAL: Properly append file
    if (data.profile_image) {
      formData.append('profile_image', data.profile_image);
    }
    
    return await api.post('/register/supplier', formData, {
      headers: { 
        'Content-Type': 'multipart/form-data' 
      },
    });
  },

  logout: async () => {
    return await api.post('/logout');
  },

  checkAuth: async () => {
    return await api.get('/user');
  },
};
/* FILE: src/api/handlers/clientOrders.api.ts */
// FILE PATH: src/api/handlers/clientOrders.api.ts
// Updated Client Orders API with proper type handling

import api from '../axios.config';
import type {
  ClientOrdersResponse,
  ClientOrderDetailResponse,
  RepeatOrderPayload,
} from '../../types/clientOrder.types';

export interface ClientOrdersQueryParams {
  per_page?: number;
  page?: number;
  search?: string;
  order_status?: string;
  project_id?: string;
  delivery_date_from?: string;
  delivery_date_to?: string;
  details?: boolean;
}

export const clientOrdersAPI = {
  /**
   * Get all client orders with filters
   */
  getOrders: async (params?: ClientOrdersQueryParams): Promise<ClientOrdersResponse> => {
    try {
      const response = await api.get('/my-orders', { params });
      return response.data;
    } catch (error: any) {
      throw new Error(error?.response?.data?.message || 'Failed to fetch orders');
    }
  },

  /**
   * Get single order details
   */
  getOrderDetail: async (orderId: number): Promise<ClientOrderDetailResponse> => {
    try {
      const response = await api.get(`/orders/${orderId}`);
      return response.data;
    } catch (error: any) {
      throw new Error(error?.response?.data?.message || 'Failed to fetch order details');
    }
  },

  /**
   * Repeat an existing order
   */
  repeatOrder: async (orderId: number, payload: RepeatOrderPayload): Promise<any> => {
    try {
      const response = await api.post(`/repeat-order/${orderId}`, payload);
      return response.data;
    } catch (error: any) {
      throw new Error(error?.response?.data?.message || 'Failed to repeat order');
    }
  },

  /**
   * Mark order as repeat order
   */
  markRepeatOrder: async (orderId: number): Promise<any> => {
    try {
      const response = await api.post(`/mark-repeat-order/${orderId}`);
      return response.data;
    } catch (error: any) {
      throw new Error(error?.response?.data?.message || 'Failed to mark as repeat order');
    }
  },
};
/* FILE: src/api/handlers/masterProducts.api.ts */
// FILE PATH: src/api/handlers/masterProducts.api.ts

/**
 * Master Products API Handler
 * 
 * Following the project's pattern:
 * - Uses centralized axios config
 * - TypeScript interfaces for type safety
 * - Structured error handling
 * - Returns response.data directly
 */

import api from '../axios.config';

// ===========================
// TypeScript Interfaces
// ===========================

export interface Category {
  id: number;
  name: string;
  created_at?: string;
  updated_at?: string;
}

export interface User {
  id: number;
  name: string;
  email: string;
  profile_image?: string | null;
}

export interface MasterProduct {
  id: number;
  added_by: User;
  is_approved: 0 | 1;
  approved_by: User | null;
  slug: string;
  category: Category;
  product_name: string;
  product_type: string;
  specifications: string;
  unit_of_measure: string;
  tech_doc: string | null;
  photo: string | null;
  created_at: string;
  updated_at: string;
  supplierOffersCount: number;
}

export interface SupplierOffer {
  id: number;
  supplier_id: number;
  master_product_id: number;
  price: string;
  availability_status: string;
  status: string;
  created_at: string;
  updated_at: string;
  supplier: {
    id: number;
    name: string;
    email: string;
    profile_image: string | null;
    delivery_zones: Array<{
      address: string;
      lat: number;
      long: number;
      radius: number;
    }>;
  };
}

export interface MasterProductWithOffers extends MasterProduct {
  supplierOffers: SupplierOffer[];
}

export interface PaginatedMasterProductsResponse {
  current_page: number;
  data: MasterProduct[];
  first_page_url: string;
  from: number;
  last_page: number;
  last_page_url: string;
  links: Array<{
    url: string | null;
    label: string;
    page: number | null;
    active: boolean;
  }>;
  next_page_url: string | null;
  path: string;
  per_page: number;
  prev_page_url: string | null;
  to: number;
  total: number;
}

export interface CategoriesResponse {
  current_page: number;
  data: Category[];
  first_page_url: string;
  from: number;
  last_page: number;
  last_page_url: string;
  next_page_url: string | null;
  path: string;
  per_page: number;
  prev_page_url: string | null;
  to: number;
  total: number;
}

export interface MasterProductsFilters {
  page?: number;
  per_page?: number;
  search?: string;
  category?: string;
  is_approved?: 0 | 1;
}

export interface CreateMasterProductPayload {
  product_name: string;
  product_type: string;
  specifications: string;
  unit_of_measure: string;
  category: number;
  photo?: File | null;
  tech_doc?: File | null;
}

export interface UpdateMasterProductPayload extends Partial<CreateMasterProductPayload> {}

export interface ApproveRejectOfferPayload {
  status: 'Approved' | 'Rejected' | 'Pending';
}

// ===========================
// API Handler
// ===========================

export const masterProductsAPI = {
  /**
   * Get paginated list of master products
   */
  getAll: async (filters: MasterProductsFilters = {}): Promise<PaginatedMasterProductsResponse> => {
    try {
      const response = await api.get('/master-products', { params: filters });
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || 'Failed to fetch master products');
    }
  },

  /**
   * Get single master product by ID with supplier offers
   */
  getById: async (id: number): Promise<MasterProductWithOffers> => {
    try {
      const response = await api.get(`/master-products/${id}`);
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || `Failed to fetch product with ID ${id}`);
    }
  },

  /**
   * Get all categories
   */
  getCategories: async (): Promise<CategoriesResponse> => {
    try {
      const response = await api.get('/categories');
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || 'Failed to fetch categories');
    }
  },

  /**
   * Create new master product
   */
  create: async (payload: CreateMasterProductPayload): Promise<{ message: string; product: MasterProduct }> => {
    try {
      const formData = new FormData();
      
      formData.append('product_name', payload.product_name);
      formData.append('product_type', payload.product_type);
      formData.append('specifications', payload.specifications);
      formData.append('unit_of_measure', payload.unit_of_measure);
      formData.append('category', payload.category.toString());
      
      if (payload.photo) formData.append('photo', payload.photo);
      if (payload.tech_doc) formData.append('tech_doc', payload.tech_doc);

      const response = await api.post('/master-products', formData, {
        headers: { 'Content-Type': 'multipart/form-data' },
      });
      
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || 'Failed to create product');
    }
  },

  /**
   * Update existing master product
   */
  update: async (id: number, payload: UpdateMasterProductPayload): Promise<{ message: string; product: MasterProduct }> => {
    try {
      const formData = new FormData();
      
      if (payload.product_name) formData.append('product_name', payload.product_name);
      if (payload.product_type) formData.append('product_type', payload.product_type);
      if (payload.specifications) formData.append('specifications', payload.specifications);
      if (payload.unit_of_measure) formData.append('unit_of_measure', payload.unit_of_measure);
      if (payload.category) formData.append('category', payload.category.toString());
      
      if (payload.photo) formData.append('photo', payload.photo);
      if (payload.tech_doc) formData.append('tech_doc', payload.tech_doc);

      const response = await api.post(`/master-products/${id}`, formData, {
        headers: { 'Content-Type': 'multipart/form-data' },
      });
      
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || `Failed to update product with ID ${id}`);
    }
  },

  /**
   * Approve or Reject master product
   */
  toggleApproval: async (id: number): Promise<{ message: string; is_approved: boolean }> => {
    try {
      const response = await api.get(`/approve-reject-master-product/${id}`);
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || `Failed to toggle approval for product ID ${id}`);
    }
  },

  /**
   * Delete master product
   */
  delete: async (id: number): Promise<{ message: string }> => {
    try {
      const response = await api.delete(`/master-products/${id}`);
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || `Failed to delete product with ID ${id}`);
    }
  },

  /**
   * Approve or Reject supplier offer
   */
  approveRejectOffer: async (
    offerId: number, 
    payload: ApproveRejectOfferPayload
  ): Promise<{ message: string; status: string }> => {
    try {
      const response = await api.post(`/approve-reject-supplier-offer/${offerId}`, payload);
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || `Failed to update supplier offer status`);
    }
  },
};
/* FILE: src/api/handlers/orders.api.ts */
// FILE PATH: src/api/handlers/orders.api.ts

/**
 * Orders API Handler
 * 
 * Handles all API calls related to order creation and management:
 * - Fetch products for client
 * - Get categories
 * - Get product details
 * - Create orders
 */

import api from '../axios.config';
import type { ProductsResponse, Product, OrderFormData, OrderResponse } from '../../types/order.types';

// ===========================
// Category Type
// ===========================

export interface Category {
  id: number;
  name: string;
}

export interface CategoriesResponse {
  data: Category[];
}

// ===========================
// API Functions
// ===========================

export const ordersAPI = {
  /**
   * Get products for client with search and filters
   * @param params - Query parameters (page, per_page, search, category)
   * @returns Paginated products list
   */
  getClientProducts: async (params: {
    page?: number;
    per_page?: number;
    search?: string;
    category?: number;
  }): Promise<ProductsResponse> => {
    try {
      const response = await api.get('/client/products', { params });
      return response.data;
    } catch (error: any) {
      throw new Error(error?.response?.data?.message || 'Failed to fetch products');
    }
  },

  /**
   * Get all categories for filtering
   * @returns List of all product categories
   */
  getCategories: async (): Promise<CategoriesResponse> => {
    try {
      const response = await api.get('/categories');
      return response.data;
    } catch (error: any) {
      throw new Error(error?.response?.data?.message || 'Failed to fetch categories');
    }
  },

  /**
   * Get single product details
   * @param id - Product ID
   * @returns Full product details
   */
  getProductById: async (id: number): Promise<{ data: Product }> => {
    try {
      const response = await api.get(`/client/products/${id}`);
      return response.data;
    } catch (error: any) {
      throw new Error(error?.response?.data?.message || 'Failed to fetch product details');
    }
  },

  /**
   * Create a new order
   * @param orderData - Order form data including items, delivery details
   * @returns Created order response
   */
  createOrder: async (orderData: OrderFormData): Promise<OrderResponse> => {
    try {
      const response = await api.post('/orders', orderData);
      return response.data;
    } catch (error: any) {
      throw new Error(error?.response?.data?.message || 'Failed to create order');
    }
  },
};
// ===========================================================================
// END OF FILE
// ===========================================================================
/* FILE: src/api/handlers/payment.api.ts */
// FILE PATH: src/api/handlers/payment.api.ts

import api from '../axios.config';

export interface ProcessPaymentPayload {
  payment_method_id: string;
  order_id: number;
}

export interface ProcessPaymentResponse {
  success: boolean;
  message: string;
  order?: {
    id: number;
    payment_status: string;
    workflow: string;
  };
}

export const paymentAPI = {
  processPayment: async (payload: ProcessPaymentPayload): Promise<ProcessPaymentResponse> => {
    const response = await api.post('/process-payment', payload);
    return response.data;
  },
};
/* FILE: src/api/handlers/profile.api.ts */
// src/api/handlers/profile.api.ts
import api from '../axios.config';

interface UpdateProfileData {
  name?: string;
  email?: string;
  contact_name?: string;
  contact_number?: string;
  company_name?: string;
  profile_image?: File;
  
  // Client-specific
  shipping_address?: string;
  billing_address?: string;
  lat?: number;
  long?: number;
  
  // Supplier-specific
  location?: string;
  delivery_radius?: number;
}

interface ChangePasswordData {
  current_password: string;
  new_password: string;
  new_password_confirmation: string;
}

export const profileAPI = {
  /**
   * Update user profile - only sends changed fields
   * @param data - Partial profile data (only dirty fields)
   */
  updateProfile: async (data: UpdateProfileData) => {
    try {
      const formData = new FormData();
      
      // Append only the fields that are present in data object
      Object.entries(data).forEach(([key, value]) => {
        if (value !== undefined && value !== null) {
          if (key === 'profile_image' && value instanceof File) {
            formData.append('profile_image', value);
          } else if (typeof value === 'number') {
            formData.append(key, String(value));
          } else {
            formData.append(key, value as string);
          }
        }
      });

      const response = await api.post('/profile', formData, {
        headers: {
          'Content-Type': 'multipart/form-data',
        },
      });

      return response.data;
    } catch (error: any) {
      throw new Error(
        error?.response?.data?.message || 
        error?.message || 
        'Failed to update profile'
      );
    }
  },

  /**
   * Change user password
   * @param data - Current and new password
   * @returns response with message and new token
   */
  changePassword: async (data: ChangePasswordData) => {
    try {
      const response = await api.post('/change-password', data);
      return response.data; // { message: "Password updated", token: "..." }
    } catch (error: any) {
      // Handle structured error from backend
      if (error?.response?.data?.error) {
        const errors = error.response.data.error;
        
        // Check if it's a validation error object
        if (typeof errors === 'object') {
          const firstError = Object.values(errors)[0];
          throw new Error(
            Array.isArray(firstError) ? firstError[0] : String(firstError)
          );
        }
        
        throw new Error(String(errors));
      }
      
      throw new Error(
        error?.message || 
        'Failed to change password'
      );
    }
  },

  /**
   * Get current user profile
   */
  getCurrentUser: async () => {
    try {
      const response = await api.get('/user');
      return response.data;
    } catch (error: any) {
      throw new Error(
        error?.response?.data?.message || 
        error?.message || 
        'Failed to fetch user data'
      );
    }
  },
};
/* FILE: src/api/handlers/projects.api.ts */
/* FILE: src/api/handlers/projects.api.ts */
// --- src/api/handlers/projects.api.ts ---
import api from '../axios.config';

export interface ProjectDTO {
  id: number;
  name: string;
  site_contact_name?: string | null;
  site_contact_phone?: string | null;
  site_instructions?: string | null;
  delivery_address: string;
  delivery_lat: number;
  delivery_long: number
  added_by: number;
  created_at: string;
  updated_at: string;
  
  // Analytics fields (optional - may not be present in listing)
  total_orders: number;
  total_order_amount: number;
  avg_order_value?: number;
  order_status_breakdown?: Record<string, number>;
  payment_status_breakdown?: Record<string, number>;
  pending_payment_amount?: number;
  paid_amount?: number;
  first_order_date?: string | null;
  last_order_date?: string | null;
  days_since_last_order?: number | null;
  top_products?: Array<{
    product_id: number;
    product_name: string;
    product_image: string | null;
    total_quantity: number;
    order_count: number;
  }>;
  has_incomplete_orders?: boolean;
  incomplete_orders_count?: number;
}

export interface ProjectOrderItem {
  id: number;
  product_id: number;
  product_name: string;
  product_image: string | null;
  product_type: string;
  product_specifications: string;
  quantity: number;
  is_quoted: number;
  quoted_price: string;
  supplier_unit_cost: string;
  supplier_delivery_cost: string;
  display_unit_price: number;
  supplier_name: string | null;
  custom_blend_mix: string | null;
}

export interface ProjectOrder {
  id: number;
  po_number: string;
  delivery_date: string;
  delivery_time: string;
  delivery_method: string;
  order_status: string;
  payment_status: string;
  total_price: number;
  items: ProjectOrderItem[];
}

export interface ProjectProduct {
  product_id: number;
  product_name: string;
  product_image: string | null;
  product_type: string;
  product_specifications: string;
  unit_price: number;
  delivery_cost: number;
  total_quantity: number;
  orders_count: number;
  first_order_id: number;
  last_order_id: number;
  last_order_item_id: number; // NEW
}

export interface ProjectAnalytics {
  total_orders: number;
  total_order_amount: number;
  avg_order_value: number;
  by_order_status: Record<string, number>;
  first_order_date: string | null;
  last_order_date: string | null;
}

export interface ProjectDetailsResponse {
  project: ProjectDTO;
  analytics: ProjectAnalytics;
  orders: ProjectOrder[];
  project_products: ProjectProduct[];
}

export interface Paginated<T> { data: T[]; meta: { page: number; per_page: number; total: number } }

export type ProjectCreateInput = {
  name: string;
  site_contact_name?: string | null;
  site_contact_phone?: string | null;
  site_instructions?: string | null;
  delivery_address: string;
  delivery_lat: number;
  delivery_long: number;
};


export interface ReorderFromProjectPayload {
  project_id: number;
  product_id: number;
  order_item_id: number; // NEW - Required for pricing consistency
  quantity: number;
  po_number?: string;
  delivery_date: string;
  delivery_time?: string;
  delivery_method?: string;
  special_notes?: string;
  custom_blend_mix?: string;
}

export type ProjectUpdateInput = Partial<ProjectCreateInput> & { id: number };

const BASE = '/projects';

export const projectsAPI = {
  list: (params: Record<string, unknown>) => api.get<Paginated<ProjectDTO>>(BASE, { params }).then(r => r.data),
  get:  (id: number) => api.get<ProjectDTO>(`${BASE}/${id}`).then(r => r.data),
  getDetails: (id: number, params?: Record<string, unknown>) => 
    api.get<ProjectDetailsResponse>(`/project-details/${id}`, { params }).then(r => r.data),
  create: (payload: ProjectCreateInput) => api.post<ProjectDTO>(BASE, payload).then(r => r.data),
  update: ({ id, ...payload }: ProjectUpdateInput) => api.post<ProjectDTO>(`${BASE}/${id}`, payload).then(r => r.data),
  remove: (id: number) => api.delete(`${BASE}/${id}`).then(r => r.data),
  reorderFromProject: (payload: ReorderFromProjectPayload) => 
    api.post<{message: string; order: any}>('/reorder-from-project', payload).then(r => r.data),
};
/* FILE: src/api/handlers/supplierOrders.api.ts */
// src/api/handlers/supplierOrders.api.ts

import api from '../axios.config';

// ===========================
// Types & Interfaces
// ===========================

export type DeliveryType = 'Included' | 'Supplier' | 'ThirdParty' | 'Fleet' | 'None';

export interface SupplierOrderItem {
  id: number;
  order_id: number;
  product_id: number;
  quantity: string;
  supplier_id: number;
  choosen_offer_id: number;
  custom_blend_mix: string | null;
  supplier_unit_cost: string;
  supplier_delivery_cost: string;
  delivery_cost: string;
  delivery_type: DeliveryType;
  supplier_discount: string;
  supplier_delivery_date: string;
  supplier_confirms: boolean;
  is_paid: boolean;
  supplier_notes?: string | null;
  created_at: string;
  updated_at: string;
  product: {
    id: number;
    product_name: string;
    photo: string | null;
    unit_of_measure: string;
    specifications: string;
    product_type: string;
  };
  chosen_offer: {
    id: number;
    supplier_id: number;
    master_product_id: number;
    price: string;
    availability_status: string;
    status: string;
  };
}

export interface SupplierOrder {
  id: number;
  po_number: string;
  order_status: string;  // Changed from workflow to order_status
  total_amount: number;
  created_at: string;
  updated_at: string;
  supplier_items_count: number;
  supplier_items: SupplierOrderItem[];
}

export interface OrderMetrics {
  total_orders_count: number;
  supplier_confirmed_count: number;
  awaiting_payment_count: number;
  delivered_count: number;
}

export interface ProductFilter {
  id: number;
  product_name: string;
  photo: string | null;
}

export interface SupplierOrdersResponse {
  success: boolean;
  data: {
    data: SupplierOrder[];
    pagination: {
      current_page: number;
      per_page: number;
      total: number;
      last_page: number;
    };
    metrics: OrderMetrics;
    filters?: {
      products: ProductFilter[];
    };
  };
}

export interface OrderDetailResponse {
  success: boolean;
  data: {
    order: {
      id: number;
      po_number: string;
      project_id: number;
      client_id: number;
      workflow: string;  // Detail API still uses workflow
      delivery_address: string;
      delivery_date: string;
      delivery_time: string;
      delivery_window: string;
      delivery_method: string;
      load_size: string;
      special_equipment: string;
      special_notes: string;
      created_at: string;
      updated_at: string;
      client: {
        id: number;
        name: string;
        email: string;
      };
      project: {
        id: number;
        name: string;
        site_contact_name: string;
        site_contact_phone: string;
        site_instructions: string;
      };
    };
    supplier_items: SupplierOrderItem[];
  };
}

export interface UpdateOrderItemPayload {
  supplier_unit_cost?: number;
  delivery_cost?: number;
  delivery_type: DeliveryType;
  supplier_discount?: number;
  supplier_delivery_date?: string;
  supplier_confirms?: boolean;
  supplier_notes?: string | null;
}

export interface SupplierOrderFilters {
  page?: number;
  per_page?: number;
  search?: string;
  product_id?: string;
  supplier_confirms?: string;
  supplier_delivery_date?: string;
}

// ===========================
// API Handler
// ===========================

export const supplierOrdersAPI = {
  /**
   * Get supplier orders with filters and pagination
   */
  getOrders: async (filters: SupplierOrderFilters = {}, includeDetails = false): Promise<SupplierOrdersResponse> => {
    try {
      const params: any = { ...filters };
      if (includeDetails) {
        params.details = 'true';
      }
      const response = await api.get('/supplier-orders', { params });
      return response.data;
    } catch (error: any) {
      throw new Error(error?.response?.data?.message || 'Failed to fetch orders');
    }
  },

  /**
   * Get single order details
   */
  getOrderDetails: async (orderId: number): Promise<OrderDetailResponse> => {
    try {
      const response = await api.get(`/supplier-orders/${orderId}`);
      return response.data;
    } catch (error: any) {
      throw new Error(error?.response?.data?.error || 'Failed to fetch order details');
    }
  },

  /**
   * Update order item
   */
  updateOrderItem: async (orderItemId: number, payload: UpdateOrderItemPayload): Promise<any> => {
    try {
      const response = await api.post(`/supplier-orders/update-pricing/${orderItemId}`, payload);
      console.log('Update order item response:', response);
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || 'Failed to update order item');
    }
  },
};
/* FILE: src/api/handlers/supplierProducts.api.ts */
// FILE PATH: src/api/handlers/supplierProducts.api.ts
/**
 * SUPPLIER PRODUCTS API - UPDATED
 * 
 * CHANGES:
 * ✅ Added price to RequestProductPayload
 * ✅ Added availability_status to RequestProductPayload  
 * ✅ Updated requestMasterProduct function to send new fields
 */

import axiosInstance from '../axios.config';

// ==================== TYPE DEFINITIONS ====================

export interface Category {
  id: number;
  name: string;
  created_at: string;
  updated_at: string;
}

export interface AddedBy {
  id: number;
  name: string;
  email: string;
  profile_image: string | null;
}

export interface ProductCategory {
  id: number;
  name: string;
}

export interface Supplier {
  id: number;
  name: string;
  email: string;
  profile_image: string | null;
  delivery_zones: Array<{
    address: string;
    lat: number;
    long: number;
    radius: number;
  }>;
}

export interface SupplierOffer {
  id: number;
  supplier_id: number;
  master_product_id: number;
  price: string;
  availability_status: string;
  status: string;
  created_at: string;
  updated_at: string;
  isMe: boolean;
  supplier: Supplier;
  pivot?: {
    price: string;
    availability_status: string;
    is_active: boolean;
    admin_approval_status: string;
  };
}

export interface MasterProduct {
  id: number;
  added_by: AddedBy;
  is_approved: number;
  approved_by: AddedBy | null;
  slug: string;
  category: ProductCategory;
  product_name: string;
  product_type: string;
  specifications: string;
  unit_of_measure: string;
  tech_doc: string | null;
  photo: string;
  created_at: string;
  updated_at: string;
  supplierOffersCount: number;
  suppliers: SupplierOffer[];
}

export interface ProductsResponse {
  current_page: number;
  data: MasterProduct[];
  first_page_url: string;
  from: number;
  last_page: number;
  last_page_url: string;
  links: Array<{
    url: string | null;
    label: string;
    page: number | null;
    active: boolean;
  }>;
  next_page_url: string | null;
  path: string;
  per_page: number;
  prev_page_url: string | null;
  to: number;
  total: number;
}

export interface CategoriesResponse {
  current_page: number;
  data: Category[];
  first_page_url: string;
  from: number;
  last_page: number;
  last_page_url: string;
  links: Array<{
    url: string | null;
    label: string;
    page: number | null;
    active: boolean;
  }>;
  next_page_url: string | null;
  path: string;
  per_page: number;
  prev_page_url: string | null;
  to: number;
  total: number;
}

export interface AddOfferPayload {
  master_product_id: number;
  price: number;
  availability_status: string;
}

export interface UpdateOfferPayload {
  price: number;
  availability_status: string;
}

// ========== UPDATED: Request Product Payload with NEW FIELDS ==========
export interface RequestProductPayload {
  product_name: string;
  product_type: string;
  category_id: number;
  specifications: string;
  unit_of_measure: string;
  price: string;                    // ✅ NEW FIELD
  availability_status: string;      // ✅ NEW FIELD
  photo?: File | null;
}

export interface OfferStatus {
  id: number;
  supplier_id: number;
  master_product_id: number;
  price: string;
  availability_status: string;
  status: string;
  created_at: string;
  updated_at: string;
}

// ==================== API FUNCTIONS ====================

/**
 * Get all master products with supplier offers
 */
export const getProducts = async (params?: {
  page?: number;
  per_page?: number;
  search?: string;
  category_id?: number;
}): Promise<ProductsResponse> => {
  const response = await axiosInstance.get('/master-product-inventory', { params });
  return response.data;
};

/**
 * Get all categories
 */
export const getCategories = async (): Promise<CategoriesResponse> => {
  const response = await axiosInstance.get('/categories');
  return response.data;
};

/**
 * Add product to supplier offers
 */
export const addSupplierOffer = async (payload: AddOfferPayload): Promise<{ message: string }> => {
  const response = await axiosInstance.post('/supplier-offers', payload);
  return response.data;
};

/**
 * Update supplier offer (price/availability)
 */
export const updateSupplierOffer = async (
  offerId: number,
  payload: UpdateOfferPayload
): Promise<{ message: string }> => {
  const response = await axiosInstance.post(`/update-pricing/${offerId}`, payload);
  return response.data;
};

/**
 * Delete supplier offer
 */
export const deleteSupplierOffer = async (offerId: number): Promise<{ message: string }> => {
  const response = await axiosInstance.delete(`/supplier-offers/${offerId}`);
  return response.data;
};

/**
 * Request new master product - UPDATED WITH NEW FIELDS
 * 
 * WHAT: Submit request for new product to be added to master catalog
 * WHY: Suppliers can request products not in the system
 * HOW: Sends FormData with all fields including NEW price and availability_status
 */
export const requestMasterProduct = async (payload: RequestProductPayload): Promise<{ message: string }> => {
  const formData = new FormData();
  
  // Existing fields
  formData.append('product_name', payload.product_name);
  formData.append('product_type', payload.product_type);
  formData.append('category_id', payload.category_id.toString());
  formData.append('specifications', payload.specifications);
  formData.append('unit_of_measure', payload.unit_of_measure);
  
  // ✅ NEW FIELDS
  formData.append('price', payload.price);
  formData.append('availability_status', payload.availability_status);
  
  // Optional photo
  if (payload.photo) {
    formData.append('photo', payload.photo);
  }

  const response = await axiosInstance.post('/request-master-product', formData, {
    headers: {
      'Content-Type': 'multipart/form-data',
    },
  });
  
  return response.data;
};

/**
 * Get supplier offer status
 */
export const getOfferStatus = async (): Promise<OfferStatus[]> => {
  const response = await axiosInstance.get('/supplier-offer-status');
  return response.data;
};

// Export as default object
export const supplierProductsAPI = {
  getProducts,
  getCategories,
  addSupplierOffer,
  updateSupplierOffer,
  deleteSupplierOffer,
  requestMasterProduct,
  getOfferStatus,
};
/* FILE: src/api/handlers/users.api.ts */
// src/api/handlers/users.api.ts
import api from '../axios.config';

export interface UserFilters {
  role?: string;
  company_id?: string;
  contact_name?: string;
  location?: string;
  lat?: number;
  long?: number;
  isDeleted?: boolean;
  page?: number;
  per_page?: number;
}

export interface User {
  id: number;
  name: string;
  email: string;
  role: 'admin' | 'client' | 'supplier';
  company_id?: number;
  company?: {
    id: number;
    name: string;
  };
  contact_name?: string;
  contact_number?: string;
  location?: string;
  lat?: number;
  long?: number;
  delivery_radius?: number;
  shipping_address?: string;
  billing_address?: string;
  client_public_id?: string;
  profile_image?: string;
  isDeleted: boolean;
  notes?: string;
  created_at: string;
  updated_at: string;
}

export interface PaginatedUsers {
  current_page: number;
  data: User[];
  first_page_url: string;
  from: number;
  last_page: number;
  last_page_url: string;
  next_page_url: string | null;
  path: string;
  per_page: number;
  prev_page_url: string | null;
  to: number;
  total: number;
}

export const usersAPI = {
  /**
   * Get paginated list of users with filters
   */
  getUsers: async (params: UserFilters): Promise<PaginatedUsers> => {
    try {
      const response = await api.get('/users', { params });
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || 'Failed to fetch users');
    }
  },

  /**
   * Get single user by ID
   */
  getUser: async (id: number): Promise<User> => {
    try {
      const response = await api.get(`/users/${id}`);
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || 'Failed to fetch user details');
    }
  },

  /**
   * Create new user
   */
  createUser: async (data: FormData) => {
    try {
      const response = await api.post('/users', data, {
        headers: { 'Content-Type': 'multipart/form-data' },
      });
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || 'Failed to create user');
    }
  },

  /**
   * Update existing user
   */
  updateUser: async (id: number, data: FormData) => {
    try {
      const response = await api.post(`/users/${id}`, data, {
        headers: { 'Content-Type': 'multipart/form-data' },
      });
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || 'Failed to update user');
    }
  },

  /**
   * Soft delete or restore user (toggle)
   */
  deleteRestoreUser: async (id: number) => {
    try {
      const response = await api.get(`/user-delete-restore/${id}`);
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || 'Failed to update user status');
    }
  },

  /**
   * Check if company exists
   */
  checkCompany: async (companyName: string) => {
    try {
      const response = await api.post('/check-company', { company_name: companyName });
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || 'Failed to check company');
    }
  },
};

/**
 * Companies API - separate concern
 */
export const companiesAPI = {
  /**
   * Get all companies (no pagination from your backend)
   */
  getAll: async () => {
    try {
      const response = await api.get('/companies');
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || 'Failed to fetch companies');
    }
  },
};
/* FILE: src/api/handlers/zones.api.ts */
// src/api/handlers/zones.api.ts
import api from '../axios.config';

export interface DeliveryZone {
  address: string;
  lat: number;
  long: number;
  radius: number;
}

export interface ZonesResponse {
  delivery_zones: DeliveryZone[];
}

export interface SaveZonesResponse {
  message: string;
  delivery_zones: DeliveryZone[];
}

export const zonesAPI = {
  getZones: async (): Promise<ZonesResponse> => {
    try {
      const response = await api.get('/delivery-zones');
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || 'Failed to fetch delivery zones');
    }
  },

  saveZones: async (zones: DeliveryZone[]): Promise<SaveZonesResponse> => {
    try {
      const response = await api.post('/delivery-zones', { zones });
      return response.data;
    } catch (error: any) {
      throw new Error(error?.message || 'Failed to save delivery zones');
    }
  },
};
/* FILE: src/App.css */
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}

/* FILE: src/App.tsx */
// src/App.tsx
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import AppRouter from "./routes";
import ToasterProvider from "./components/common/Toaster"; // Changed from ToasterProvider
import "./index.css";

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      refetchOnWindowFocus: false,
      retry: 1,
      staleTime: 5 * 60 * 1000, // 5 minutes
    },
  },
});

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <ToasterProvider />
      <AppRouter />
    </QueryClientProvider>
  );
}

export default App;
/* FILE: src/components/admin/AdminSupplierZonesMapView.tsx */
// src/components/admin/AdminSupplierZonesMapView.tsx
import React, { useEffect, useRef, useState } from 'react';
import { Loader2, AlertCircle, MapPin } from 'lucide-react';
import type { SupplierWithZones } from '../../api/handlers/adminSupplierZones.api';

interface MapViewProps {
  suppliers: SupplierWithZones[];
  supplierColors: Map<number, string>;
}

declare global {
  interface Window {
    google: any;
  }
}

const AdminSupplierZonesMapView: React.FC<MapViewProps> = ({ suppliers, supplierColors }) => {
  const mapRef = useRef<HTMLDivElement>(null);
  const [map, setMap] = useState<google.maps.Map | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const markersRef = useRef<google.maps.Marker[]>([]);
  const circlesRef = useRef<google.maps.Circle[]>([]);
  const [visibleSuppliers, setVisibleSuppliers] = useState<Set<number>>(
    new Set(suppliers.map(s => s.id))
  );

  // Initialize map
  useEffect(() => {
    const initWhenReady = () => {
      if (!mapRef.current) {
        requestAnimationFrame(initWhenReady);
        return;
      }
      if (!window.google || !window.google.maps) return;

      try {
        const defaultCenter = { lat: -25.2744, lng: 133.7751 }; // Australia center
        
        const mapInstance = new window.google.maps.Map(mapRef.current, {
          center: defaultCenter,
          zoom: 4,
          mapTypeControl: true,
          streetViewControl: false,
          fullscreenControl: true,
        });

        setMap(mapInstance);
        setLoading(false);
      } catch (e) {
        setError('Failed to initialize map');
        setLoading(false);
      }
    };

    // Check if already loaded
    if (window.google && window.google.maps) {
      initWhenReady();
      return;
    }

    // Check for existing script
    const existing = document.getElementById('google-maps-script') as HTMLScriptElement | null;
    if (existing) {
      existing.addEventListener('load', initWhenReady, { once: true });
      return;
    }

    // Load script
    const apiKey = import.meta.env.VITE_GOOGLE_MAPS_API_KEY;
    if (!apiKey) {
      setError('Missing VITE_GOOGLE_MAPS_API_KEY');
      setLoading(false);
      return;
    }

    const script = document.createElement('script');
    script.id = 'google-maps-script';
    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places`;
    script.async = true;
    script.defer = true;
    script.onload = initWhenReady;
    script.onerror = () => {
      setError('Failed to load Google Maps');
      setLoading(false);
    };
    document.head.appendChild(script);

    return () => {
      markersRef.current.forEach(m => m.setMap(null));
      circlesRef.current.forEach(c => c.setMap(null));
    };
  }, []);

  // Draw zones on map
  useEffect(() => {
    if (!map || !window.google) return;

    // Clear old markers and circles
    markersRef.current.forEach(m => m.setMap(null));
    circlesRef.current.forEach(c => c.setMap(null));
    markersRef.current = [];
    circlesRef.current = [];

    const bounds = new window.google.maps.LatLngBounds();
    let hasZones = false;

    suppliers.forEach((supplier) => {
      if (!visibleSuppliers.has(supplier.id)) return;
      if (supplier.delivery_zones.length === 0) return;

      const color = supplierColors.get(supplier.id) || '#3B82F6';

      supplier.delivery_zones.forEach((zone, zoneIdx) => {
        const pos = { lat: zone.lat, lng: zone.long };

        // Create marker
        const marker = new window.google.maps.Marker({
          position: pos,
          map,
          title: `${supplier.name} - Zone ${zoneIdx + 1}`,
          label: {
            text: String(zoneIdx + 1),
            color: 'white',
            fontWeight: 'bold',
          },
          icon: {
            path: window.google.maps.SymbolPath.CIRCLE,
            scale: 14,
            fillColor: color,
            fillOpacity: 1,
            strokeColor: 'white',
            strokeWeight: 3,
          },
        });

        // Create InfoWindow
        const infoWindow = new window.google.maps.InfoWindow({
          content: `
            <div style="padding:12px;max-width:280px">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                <div style="width:12px;height:12px;border-radius:50%;background-color:${color}"></div>
                <h3 style="margin:0;font-weight:700;color:#111827;font-size:16px">${supplier.name}</h3>
              </div>
              <div style="font-size:13px;color:#374151;line-height:1.6">
                <div style="margin-bottom:4px"><strong>Zone ${zoneIdx + 1}</strong></div>
                <div style="margin-bottom:4px">📍 ${zone.address}</div>
                <div style="margin-bottom:4px"><strong>Radius:</strong> ${zone.radius} km</div>
                <div style="margin-bottom:4px"><strong>Coverage:</strong> ~${(Math.PI * zone.radius * zone.radius).toFixed(0)} km²</div>
                <div style="color:#6B7280;font-size:11px;margin-top:6px">
                  ${zone.lat.toFixed(6)}, ${zone.long.toFixed(6)}
                </div>
              </div>
            </div>
          `,
        });

        marker.addListener('click', () => infoWindow.open(map, marker));

        // Create circle
        const circle = new window.google.maps.Circle({
          strokeColor: color,
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: color,
          fillOpacity: 0.15,
          map,
          center: pos,
          radius: zone.radius * 1000, // km to meters
        });

        markersRef.current.push(marker);
        circlesRef.current.push(circle);
        bounds.extend(pos);
        hasZones = true;
      });
    });

    // Fit bounds
    if (hasZones) {
      map.fitBounds(bounds);
    }
  }, [map, suppliers, supplierColors, visibleSuppliers]);

  const toggleSupplierVisibility = (supplierId: number) => {
    setVisibleSuppliers((prev) => {
      const newSet = new Set(prev);
      if (newSet.has(supplierId)) {
        newSet.delete(supplierId);
      } else {
        newSet.add(supplierId);
      }
      return newSet;
    });
  };

  const showAllSuppliers = () => {
    setVisibleSuppliers(new Set(suppliers.map(s => s.id)));
  };

  const hideAllSuppliers = () => {
    setVisibleSuppliers(new Set());
  };

  const suppliersWithZones = suppliers.filter(s => s.delivery_zones.length > 0);

  return (
    <div className="bg-white rounded-xl border-2 border-secondary-200 p-6">
      <div className="relative">
        {/* Map Container */}
        <div
          ref={mapRef}
          className="w-full h-[600px] rounded-lg overflow-hidden border border-secondary-200"
        />

        {/* Loading Overlay */}
        {loading && (
          <div className="absolute inset-0 flex items-center justify-center bg-white/70 z-10">
            <div className="text-center">
              <Loader2 className="animate-spin text-primary-600 mx-auto mb-2" size={40} />
              <p className="text-secondary-600">Loading map...</p>
            </div>
          </div>
        )}

        {/* Error Overlay */}
        {error && (
          <div className="absolute inset-0 flex flex-col items-center justify-center bg-white/90 p-6 text-center z-10">
            <AlertCircle className="text-error-600 mb-2" size={28} />
            <p className="text-error-700 font-medium mb-1">Map Loading Error</p>
            <p className="text-sm text-secondary-600">{error}</p>
          </div>
        )}
      </div>

      {/* Legend */}
      {suppliersWithZones.length > 0 ? (
        <div className="mt-4 p-4 bg-secondary-50 rounded-lg">
          <div className="flex items-center justify-between mb-3">
            <p className="text-sm font-semibold text-secondary-900">Supplier Legend</p>
            <div className="flex gap-2">
              <button
                onClick={showAllSuppliers}
                className="text-xs px-3 py-1 bg-primary-100 text-primary-700 rounded hover:bg-primary-200 transition-colors"
              >
                Show All
              </button>
              <button
                onClick={hideAllSuppliers}
                className="text-xs px-3 py-1 bg-secondary-200 text-secondary-700 rounded hover:bg-secondary-300 transition-colors"
              >
                Hide All
              </button>
            </div>
          </div>
          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 max-h-48 overflow-y-auto">
            {suppliersWithZones.map((supplier) => {
              const color = supplierColors.get(supplier.id) || '#3B82F6';
              const isVisible = visibleSuppliers.has(supplier.id);

              return (
                <button
                  key={supplier.id}
                  onClick={() => toggleSupplierVisibility(supplier.id)}
                  className={`flex items-center gap-2 p-2 rounded border-2 transition-all text-left ${
                    isVisible
                      ? 'border-secondary-300 bg-white hover:border-primary-300'
                      : 'border-secondary-200 bg-secondary-100 opacity-50 hover:opacity-75'
                  }`}
                >
                  <div
                    className="w-4 h-4 rounded-full border-2 border-white shadow-sm flex-shrink-0"
                    style={{ backgroundColor: color }}
                  />
                  <div className="flex-1 min-w-0">
                    <p className="text-xs font-medium text-secondary-900 truncate">
                      {supplier.name}
                    </p>
                    <p className="text-xs text-secondary-600">
                      {supplier.delivery_zones.length} zone{supplier.delivery_zones.length !== 1 ? 's' : ''}
                    </p>
                  </div>
                </button>
              );
            })}
          </div>
        </div>
      ) : (
        <div className="h-32 flex flex-col items-center justify-center text-secondary-600 mt-4">
          <MapPin className="mb-2 text-secondary-400" size={20} />
          <p className="text-sm">No delivery zones to display</p>
        </div>
      )}
    </div>
  );
};

export default AdminSupplierZonesMapView;
/* FILE: src/components/admin/AdminSupplierZonesStats.tsx */
// src/components/admin/AdminSupplierZonesStats.tsx
import React, { useMemo } from 'react';
import { Users, MapPin, Layers, TrendingUp } from 'lucide-react';
import type { SupplierWithZones } from '../../api/handlers/adminSupplierZones.api';

interface StatsProps {
  suppliers: SupplierWithZones[];
  totalSuppliers: number;
}

const AdminSupplierZonesStats: React.FC<StatsProps> = ({ suppliers, totalSuppliers }) => {
  const stats = useMemo(() => {
    const totalZones = suppliers.reduce((sum, s) => sum + s.delivery_zones.length, 0);
    
    const totalCoverage = suppliers.reduce((sum, supplier) => {
      const supplierCoverage = supplier.delivery_zones.reduce((zoneSum, zone) => {
        return zoneSum + (Math.PI * zone.radius * zone.radius);
      }, 0);
      return sum + supplierCoverage;
    }, 0);

    const allRadii = suppliers.flatMap(s => s.delivery_zones.map(z => z.radius));
    const avgRadius = allRadii.length > 0 
      ? allRadii.reduce((sum, r) => sum + r, 0) / allRadii.length 
      : 0;

    const suppliersWithZones = suppliers.filter(s => s.delivery_zones.length > 0).length;
    const suppliersWithoutZones = totalSuppliers - suppliersWithZones;

    return {
      totalSuppliers,
      totalZones,
      totalCoverage: totalCoverage.toFixed(0),
      avgRadius: avgRadius.toFixed(1),
      suppliersWithZones,
      suppliersWithoutZones,
    };
  }, [suppliers, totalSuppliers]);

  const statCards = [
    {
      icon: Users,
      label: 'Total Suppliers',
      value: stats.totalSuppliers,
      subtext: `${stats.suppliersWithZones} with zones`,
      bgColor: 'bg-primary-100',
      iconColor: 'text-primary-600',
    },
    {
      icon: MapPin,
      label: 'Total Zones',
      value: stats.totalZones,
      subtext: `Across ${stats.suppliersWithZones} suppliers`,
      bgColor: 'bg-success-100',
      iconColor: 'text-success-600',
    },
    {
      icon: Layers,
      label: 'Total Coverage',
      value: `${stats.totalCoverage} km²`,
      subtext: 'Combined area',
      bgColor: 'bg-warning-100',
      iconColor: 'text-warning-600',
    },
    {
      icon: TrendingUp,
      label: 'Avg Radius',
      value: `${stats.avgRadius} km`,
      subtext: 'Per delivery zone',
      bgColor: 'bg-secondary-100',
      iconColor: 'text-secondary-600',
    },
  ];

  return (
    <div className="bg-white rounded-xl border-2 border-secondary-200 p-6">
      <h2 className="text-lg font-bold text-secondary-900 mb-4">System Statistics</h2>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {statCards.map((stat, index) => (
          <div key={index} className="flex items-center gap-4">
            <div className={`w-12 h-12 rounded-lg ${stat.bgColor} flex items-center justify-center flex-shrink-0`}>
              <stat.icon size={24} className={stat.iconColor} />
            </div>
            <div className="flex-1 min-w-0">
              <p className="text-sm text-secondary-600 mb-1">{stat.label}</p>
              <p className="text-2xl font-bold text-secondary-900 truncate">{stat.value}</p>
              <p className="text-xs text-secondary-500">{stat.subtext}</p>
            </div>
          </div>
        ))}
      </div>

      {stats.suppliersWithoutZones > 0 && (
        <div className="mt-4 p-3 bg-warning-50 border border-warning-200 rounded-lg">
          <p className="text-sm text-warning-700">
            ⚠️ <strong>{stats.suppliersWithoutZones}</strong> supplier{stats.suppliersWithoutZones > 1 ? 's' : ''} without delivery zones
          </p>
        </div>
      )}
    </div>
  );
};

export default AdminSupplierZonesStats;
/* FILE: src/components/admin/Dashboard/AlertsSection.tsx */
// FILE PATH: src/components/admin/Dashboard/AlertsSection.tsx

/**
 * Alerts Section Component
 * Displays system alerts and notifications
 */

import React from 'react';
import { AlertCircle, AlertTriangle, Info, CheckCircle, X } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import type { Alert } from '../../../api/handlers/adminDashboard.api';

interface AlertsSectionProps {
  alerts: Alert[];
  loading: boolean;
  onDismiss?: (index: number) => void;
}

const AlertsSection: React.FC<AlertsSectionProps> = ({ alerts, loading, onDismiss }) => {
  const navigate = useNavigate();

  if (loading) {
    return (
      <div className="bg-white rounded-xl shadow-card p-6">
        <div className="h-20 bg-gray-200 rounded animate-pulse" />
      </div>
    );
  }

  if (!alerts || alerts.length === 0) {
    return null;
  }

  const getAlertConfig = (type: Alert['type']) => {
    const configs = {
      error: {
        icon: AlertCircle,
        bgColor: 'bg-red-50',
        borderColor: 'border-red-200',
        textColor: 'text-red-800',
        iconColor: 'text-red-600',
      },
      warning: {
        icon: AlertTriangle,
        bgColor: 'bg-orange-50',
        borderColor: 'border-orange-200',
        textColor: 'text-orange-800',
        iconColor: 'text-orange-600',
      },
      info: {
        icon: Info,
        bgColor: 'bg-blue-50',
        borderColor: 'border-blue-200',
        textColor: 'text-blue-800',
        iconColor: 'text-blue-600',
      },
      success: {
        icon: CheckCircle,
        bgColor: 'bg-green-50',
        borderColor: 'border-green-200',
        textColor: 'text-green-800',
        iconColor: 'text-green-600',
      },
    };
    return configs[type] || configs.info;
  };

  const getPriorityBadge = (priority: Alert['priority']) => {
    const styles = {
      high: 'bg-red-100 text-red-800',
      medium: 'bg-yellow-100 text-yellow-800',
      low: 'bg-gray-100 text-gray-800',
    };
    return styles[priority];
  };

  return (
    <div className="space-y-4">
      {alerts.map((alert, index) => {
        const config = getAlertConfig(alert.type);
        const Icon = config.icon;

        return (
          <div
            key={index}
            className={`${config.bgColor} ${config.borderColor} border rounded-xl p-4`}
          >
            <div className="flex items-start gap-4">
              {/* Icon */}
              <div className={`${config.iconColor} flex-shrink-0 mt-0.5`}>
                <Icon className="w-5 h-5" />
              </div>

              {/* Content */}
              <div className="flex-1">
                <div className="flex items-start justify-between gap-4">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-1">
                      <span className={`text-xs px-2 py-1 rounded-full font-medium ${getPriorityBadge(alert.priority)}`}>
                        {alert.priority.toUpperCase()}
                      </span>
                    </div>
                    <p className={`${config.textColor} font-medium text-sm`}>
                      {alert.message}
                    </p>
                    
                    {/* Action Button */}
                    {alert.action_url && (
                      <button
                        onClick={() => navigate(alert.action_url)}
                        className={`${config.textColor} text-sm font-semibold mt-2 hover:underline`}
                      >
                        View Details →
                      </button>
                    )}
                  </div>

                  {/* Dismiss Button */}
                  {onDismiss && (
                    <button
                      onClick={() => onDismiss(index)}
                      className={`${config.iconColor} hover:opacity-70 transition-opacity flex-shrink-0`}
                    >
                      <X className="w-4 h-4" />
                    </button>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
};

export default AlertsSection;

/* FILE: src/components/admin/Dashboard/ChartsSection.tsx */
// FILE PATH: src/components/admin/Dashboard/ChartsSection.tsx

/**
 * Charts Section Component
 * Displays all dashboard charts (Revenue, Status, Suppliers, Products, Price Distribution)
 */

import React from 'react';
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  ArcElement,
  Title,
  Tooltip,
  Legend,
  Filler,
} from 'chart.js';
import { Line, Bar, Doughnut } from 'react-chartjs-2';
import type { Chart } from '../../../api/handlers/adminDashboard.api';

// Register ChartJS components
ChartJS.register(
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  ArcElement,
  Title,
  Tooltip,
  Legend,
  Filler
);

interface ChartsSectionProps {
  charts: Chart[];
  loading: boolean;
}

const ChartsSection: React.FC<ChartsSectionProps> = ({ charts, loading }) => {
  if (loading) {
    return (
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {[...Array(4)].map((_, i) => (
          <div key={i} className="bg-white rounded-xl shadow-card p-6">
            <div className="h-80 bg-gray-200 rounded animate-pulse" />
          </div>
        ))}
      </div>
    );
  }

  if (!charts || charts.length === 0) {
    return (
      <div className="bg-white rounded-xl shadow-card p-6 text-center">
        <p className="text-gray-500">No chart data available</p>
      </div>
    );
  }

  const renderChart = (chart: Chart) => {
    const { id, type, labels, series } = chart;

    // Donut Chart (Order Status)
    if (type === 'donut' && Array.isArray(series) && typeof series[0] === 'number') {
      const data = {
        labels,
        datasets: [
          {
            data: series as unknown as number[],
            backgroundColor: [
              '#3B82F6', // blue
              '#10B981', // green
              '#F59E0B', // amber
              '#EF4444', // red
              '#8B5CF6', // purple
              '#06B6D4', // cyan
            ],
            borderWidth: 2,
            borderColor: '#fff',
          },
        ],
      };

      const options = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom' as const,
            labels: {
              padding: 15,
              font: { size: 12 },
            },
          },
          tooltip: {
            callbacks: {
              label: (context: any) => {
                const label = context.label || '';
                const value = context.parsed || 0;
                const total = (context.dataset.data as number[]).reduce((a: number, b: number) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return `${label}: ${value} (${percentage}%)`;
              },
            },
          },
        },
      };

      return (
        <div className="h-80">
          <Doughnut data={data} options={options} />
        </div>
      );
    }

    // Line/Area Chart (Revenue Over Time)
    if (id === 'time_revenue' && Array.isArray(series) && series[0]?.data) {
      const data = {
        labels,
        datasets: series.map((s, idx) => ({
          label: s.name,
          data: s.data,
          borderColor: idx === 0 ? '#3B82F6' : '#10B981',
          backgroundColor: idx === 0 
            ? 'rgba(59, 130, 246, 0.1)' 
            : 'rgba(16, 185, 129, 0.1)',
          fill: true,
          tension: 0.4,
          yAxisID: idx === 0 ? 'y' : 'y1',
        })),
      };

      const options = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index' as const,
          intersect: false,
        },
        scales: {
          y: {
            type: 'linear' as const,
            display: true,
            position: 'left' as const,
            title: {
              display: true,
              text: 'Revenue',
            },
          },
          y1: {
            type: 'linear' as const,
            display: true,
            position: 'right' as const,
            title: {
              display: true,
              text: 'Orders',
            },
            grid: {
              drawOnChartArea: false,
            },
          },
        },
        plugins: {
          legend: {
            position: 'top' as const,
          },
          tooltip: {
            callbacks: {
              label: (context: any) => {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed.y !== null) {
                  if (context.datasetIndex === 0) {
                    label += new Intl.NumberFormat('en-AU', {
                      style: 'currency',
                      currency: 'AUD',
                    }).format(context.parsed.y);
                  } else {
                    label += context.parsed.y + ' orders';
                  }
                }
                return label;
              },
            },
          },
        },
      };

      return (
        <div className="h-80">
          <Line data={data} options={options} />
        </div>
      );
    }

    // Bar Chart (Suppliers, Products, Price Distribution)
    if (Array.isArray(series) && series[0]?.data) {
      const data = {
        labels,
        datasets: series.map((s) => ({
          label: s.name,
          data: s.data,
          backgroundColor: '#3B82F6',
          borderRadius: 6,
        })),
      };

      const options = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          },
          tooltip: {
            callbacks: {
              label: (context: any) => {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed.y !== null) {
                  if (id === 'supplier_revenue') {
                    label += new Intl.NumberFormat('en-AU', {
                      style: 'currency',
                      currency: 'AUD',
                    }).format(context.parsed.y);
                  } else {
                    label += context.parsed.y;
                  }
                }
                return label;
              },
            },
          },
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value: any) {
                if (id === 'supplier_revenue') {
                  return new Intl.NumberFormat('en-AU', {
                    style: 'currency',
                    currency: 'AUD',
                    notation: 'compact',
                  }).format(value);
                }
                return value;
              },
            },
          },
        },
      };

      return (
        <div className="h-80">
          <Bar data={data} options={options} />
        </div>
      );
    }

    return <div className="h-80 flex items-center justify-center text-gray-500">Chart data unavailable</div>;
  };

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {charts.map((chart) => (
        <div key={chart.id} className="bg-white rounded-xl shadow-card p-6">
          <h3 className="text-lg font-semibold text-gray-900 mb-4">{chart.title}</h3>
          {renderChart(chart)}
        </div>
      ))}
    </div>
  );
};

export default ChartsSection;

/* FILE: src/components/admin/Dashboard/DashboardFilters.tsx */
// FILE PATH: src/components/admin/Dashboard/DashboardFilters.tsx

/**
 * Dashboard Filters Component
 * Date range, granularity, and other filter controls
 */

import React from 'react';
import { Calendar, RefreshCw } from 'lucide-react';
import type { DashboardFilters } from '../../../api/handlers/adminDashboard.api';

interface DashboardFiltersProps {
  filters: DashboardFilters;
  onFilterChange: (filters: Partial<DashboardFilters>) => void;
  onRefresh: () => void;
  isRefreshing?: boolean;
}

const DashboardFiltersBar: React.FC<DashboardFiltersProps> = ({
  filters,
  onFilterChange,
  onRefresh,
  isRefreshing = false,
}) => {
  const handleDateChange = (type: 'from' | 'to', value: string) => {
    onFilterChange({ [type]: value });
  };

  const handleGranularityChange = (granularity: 'day' | 'week' | 'month') => {
    onFilterChange({ granularity });
  };

  const handleQuickDate = (range: string) => {
    const today = new Date();
    let from = new Date();
    
    switch (range) {
      case 'today':
        from = new Date(today);
        break;
      case '7days':
        from = new Date(today.setDate(today.getDate() - 7));
        break;
      case '30days':
        from = new Date(today.setDate(today.getDate() - 30));
        break;
      case 'month':
        from = new Date(today.getFullYear(), today.getMonth(), 1);
        break;
      case 'year':
        from = new Date(today.getFullYear(), 0, 1);
        break;
    }

    onFilterChange({
      from: from.toISOString().split('T')[0],
      to: new Date().toISOString().split('T')[0],
    });
  };

  return (
    <div className="bg-white rounded-xl shadow-card p-6">
      <div className="flex flex-col lg:flex-row gap-4 lg:items-center lg:justify-between">
        {/* Date Range */}
        <div className="flex flex-col sm:flex-row gap-4 flex-1">
          <div className="flex-1">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              From Date
            </label>
            <div className="relative">
              <Calendar className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
              <input
                type="date"
                value={filters.from || ''}
                onChange={(e) => handleDateChange('from', e.target.value)}
                className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
          </div>

          <div className="flex-1">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              To Date
            </label>
            <div className="relative">
              <Calendar className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
              <input
                type="date"
                value={filters.to || ''}
                onChange={(e) => handleDateChange('to', e.target.value)}
                className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
          </div>

          {/* Granularity */}
          <div className="flex-1">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Granularity
            </label>
            <select
              value={filters.granularity || 'day'}
              onChange={(e) => handleGranularityChange(e.target.value as 'day' | 'week' | 'month')}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="day">Daily</option>
              <option value="week">Weekly</option>
              <option value="month">Monthly</option>
            </select>
          </div>
        </div>

        {/* Quick Date Buttons */}
        <div className="flex flex-wrap gap-2">
          <button
            onClick={() => handleQuickDate('today')}
            className="px-3 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
          >
            Today
          </button>
          <button
            onClick={() => handleQuickDate('7days')}
            className="px-3 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
          >
            7 Days
          </button>
          <button
            onClick={() => handleQuickDate('30days')}
            className="px-3 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
          >
            30 Days
          </button>
          <button
            onClick={() => handleQuickDate('month')}
            className="px-3 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
          >
            This Month
          </button>
          
          {/* Refresh Button */}
          <button
            onClick={onRefresh}
            disabled={isRefreshing}
            className="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
          >
            <RefreshCw className={`w-4 h-4 ${isRefreshing ? 'animate-spin' : ''}`} />
            Refresh
          </button>
        </div>
      </div>
    </div>
  );
};

export default DashboardFiltersBar;

/* FILE: src/components/admin/Dashboard/KPICards.tsx */
// FILE PATH: src/components/admin/Dashboard/KPICards.tsx
// ============================================
// KPI CARDS WITH PERMISSION-BASED VISIBILITY
// ============================================

/**
 * KPI Cards Component
 * Displays key performance indicators with comparisons
 * Revenue/Profit cards hidden for Support role
 */

import React from 'react';
import { 
  TrendingUp, 
  TrendingDown, 
  DollarSign, 
  ShoppingCart, 
  CheckCircle,
  Users,
  AlertCircle,
  Lock
} from 'lucide-react';
import type { DashboardKPIs } from '../../../api/handlers/adminDashboard.api';

interface KPICardsProps {
  kpis: DashboardKPIs | null;
  loading: boolean;
  currency?: string;
  /** If false, hides revenue/profit cards (for Support role) */
  showFinancialData?: boolean;
}

interface KPICardData {
  id: string;
  title: string;
  value: string | number;
  change: number;
  icon: React.ReactNode;
  color: string;
  subValue?: string;
  /** If true, this card requires financial permissions to view */
  isFinancial?: boolean;
}

const KPICards: React.FC<KPICardsProps> = ({ 
  kpis, 
  loading, 
  currency = 'AUD',
  showFinancialData = true 
}) => {
  if (loading || !kpis) {
    // Adjust skeleton count based on permissions
    const skeletonCount = showFinancialData ? 8 : 5;
    return (
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {[...Array(skeletonCount)].map((_, i) => (
          <div key={i} className="bg-white rounded-xl shadow-card p-6">
            <div className="h-24 bg-gray-200 rounded animate-pulse" />
          </div>
        ))}
      </div>
    );
  }

  const formatCurrency = (value: number): string => {
    return new Intl.NumberFormat('en-AU', {
      style: 'currency',
      currency: currency,
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(value);
  };

  const allCards: KPICardData[] = [
    {
      id: 'revenue',
      title: 'Total Revenue',
      value: formatCurrency(kpis.revenue),
      change: kpis.revenue_change,
      icon: <DollarSign className="w-6 h-6" />,
      color: 'bg-green-500',
      subValue: `${formatCurrency(kpis.revenue_prev)} last period`,
      isFinancial: true, // Hidden for Support
    },
    {
      id: 'orders',
      title: 'Total Orders',
      value: kpis.orders_total,
      change: kpis.orders_change,
      icon: <ShoppingCart className="w-6 h-6" />,
      color: 'bg-blue-500',
      subValue: `${kpis.orders_total_prev} last period`,
      isFinancial: false, // Always visible
    },
    {
      id: 'avg_order',
      title: 'Avg Order Value',
      value: formatCurrency(kpis.avg_order_value),
      change: 0,
      icon: <DollarSign className="w-6 h-6" />,
      color: 'bg-purple-500',
      isFinancial: true, // Hidden for Support
    },
    {
      id: 'completed',
      title: 'Completed Orders',
      value: kpis.completed_orders,
      change: kpis.completed_change,
      icon: <CheckCircle className="w-6 h-6" />,
      color: 'bg-green-500',
      subValue: `${kpis.completed_orders_prev} last period`,
      isFinancial: false, // Always visible
    },
    {
      id: 'active_clients',
      title: 'Active Clients',
      value: kpis.active_clients,
      change: kpis.active_clients_change,
      icon: <Users className="w-6 h-6" />,
      color: 'bg-indigo-500',
      subValue: `${kpis.total_clients} total`,
      isFinancial: false, // Always visible
    },
    {
      id: 'active_suppliers',
      title: 'Active Suppliers',
      value: kpis.active_suppliers,
      change: 0,
      icon: <Users className="w-6 h-6" />,
      color: 'bg-cyan-500',
      subValue: `${kpis.total_suppliers} total`,
      isFinancial: false, // Always visible
    },
    {
      id: 'awaiting_payment',
      title: 'Awaiting Payment',
      value: kpis.awaiting_payment,
      change: 0,
      icon: <AlertCircle className="w-6 h-6" />,
      color: 'bg-orange-500',
      isFinancial: false, // Always visible
    },
    {
      id: 'supplier_missing',
      title: 'Supplier Missing',
      value: kpis.supplier_missing,
      change: 0,
      icon: <AlertCircle className="w-6 h-6" />,
      color: 'bg-red-500',
      isFinancial: false, // Always visible
    },
  ];

  // Filter cards based on permissions
  const cards = showFinancialData 
    ? allCards 
    : allCards.filter(card => !card.isFinancial);

  return (
    <div className="space-y-4">
      {/* Cards Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {cards.map((card) => (
          <div
            key={card.id}
            className="bg-white rounded-xl shadow-card p-6 hover:shadow-lg transition-shadow"
          >
            {/* Icon & Title */}
            <div className="flex items-center justify-between mb-4">
              <div className={`${card.color} text-white p-3 rounded-lg`}>
                {card.icon}
              </div>
              {card.change !== 0 && (
                <div
                  className={`flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${
                    card.change > 0
                      ? 'bg-green-100 text-green-700'
                      : 'bg-red-100 text-red-700'
                  }`}
                >
                  {card.change > 0 ? (
                    <TrendingUp className="w-3 h-3" />
                  ) : (
                    <TrendingDown className="w-3 h-3" />
                  )}
                  {Math.abs(card.change)}%
                </div>
              )}
            </div>

            {/* Value */}
            <h3 className="text-2xl font-bold text-gray-900 mb-1">{card.value}</h3>
            
            {/* Title */}
            <p className="text-sm text-gray-600 mb-2">{card.title}</p>

            {/* Sub Value */}
            {card.subValue && (
              <p className="text-xs text-gray-500">{card.subValue}</p>
            )}
          </div>
        ))}
      </div>

      {/* Hidden Cards Notice - Only show if some cards are hidden */}
      {!showFinancialData && (
        <div className="flex items-center justify-center gap-2 p-3 bg-gray-50 rounded-lg border border-gray-200">
          <Lock size={14} className="text-gray-500" />
          <span className="text-xs text-gray-600">
            Revenue and profit metrics are hidden based on your role
          </span>
        </div>
      )}
    </div>
  );
};

export default KPICards;
/* FILE: src/components/admin/Dashboard/TablesSection.tsx */
// FILE PATH: src/components/admin/Dashboard/TablesSection.tsx
// ============================================
// TABLES SECTION WITH PERMISSION-BASED VISIBILITY
// ============================================

/**
 * Tables Section Component
 * Displays Top Clients, Top Suppliers, and Recent Activity tables
 * Spend/Revenue amounts hidden for Support role
 */

import React from 'react';
import { TrendingUp, Clock, Package, Lock } from 'lucide-react';
import type { TopClient, TopSupplier, RecentActivity } from '../../../api/handlers/adminDashboard.api';

interface TablesSectionProps {
  topClients: TopClient[];
  topSuppliers: TopSupplier[];
  recentActivity: RecentActivity[];
  loading: boolean;
  currency?: string;
  /** If false, hides spend/revenue amounts (for Support role) */
  showFinancialData?: boolean;
}

const TablesSection: React.FC<TablesSectionProps> = ({
  topClients,
  topSuppliers,
  recentActivity,
  loading,
  currency = 'AUD',
  showFinancialData = true,
}) => {
  const formatCurrency = (value: number): string => {
    return new Intl.NumberFormat('en-AU', {
      style: 'currency',
      currency,
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(value);
  };

  const getWorkflowBadgeClass = (workflow: string): string => {
    const styles: Record<string, string> = {
      'Requested': 'bg-yellow-100 text-yellow-800',
      'Supplier Missing': 'bg-red-100 text-red-800',
      'Supplier Assigned': 'bg-blue-100 text-blue-800',
      'Payment Requested': 'bg-orange-100 text-orange-800',
      'On Hold': 'bg-gray-100 text-gray-800',
      'Delivered': 'bg-green-100 text-green-800',
    };
    return styles[workflow] || 'bg-gray-100 text-gray-800';
  };

  if (loading) {
    return (
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {[...Array(3)].map((_, i) => (
          <div key={i} className="bg-white rounded-xl shadow-card p-6">
            <div className="h-96 bg-gray-200 rounded animate-pulse" />
          </div>
        ))}
      </div>
    );
  }

  return (
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
      {/* Top Clients */}
      <div className="bg-white rounded-xl shadow-card p-6">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg font-semibold text-gray-900 flex items-center gap-2">
            <TrendingUp className="w-5 h-5 text-blue-600" />
            Top Clients
          </h3>
          {!showFinancialData && (
            <span className="text-xs text-gray-500 flex items-center gap-1">
              <Lock size={12} />
              Amounts hidden
            </span>
          )}
        </div>

        <div className="space-y-3">
          {topClients.length === 0 ? (
            <p className="text-gray-500 text-sm text-center py-4">No data available</p>
          ) : (
            topClients.map((client, idx) => (
              <div
                key={client.client_id}
                className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
              >
                <div className="flex-1">
                  <div className="flex items-center gap-2">
                    <span className="text-sm font-semibold text-gray-400">#{idx + 1}</span>
                    <div>
                      <p className="font-medium text-gray-900">{client.client_name}</p>
                      <p className="text-xs text-gray-500">{client.client_email}</p>
                    </div>
                  </div>
                  <p className="text-xs text-gray-600 mt-1">{client.order_count} orders</p>
                </div>
                {/* Only show spend if authorized */}
                {showFinancialData ? (
                  <div className="text-right">
                    <p className="font-bold text-blue-600">{formatCurrency(client.total_spend)}</p>
                  </div>
                ) : (
                  <div className="text-right">
                    <span className="text-xs text-gray-400 bg-gray-200 px-2 py-1 rounded">
                      Hidden
                    </span>
                  </div>
                )}
              </div>
            ))
          )}
        </div>
      </div>

      {/* Top Suppliers */}
      <div className="bg-white rounded-xl shadow-card p-6">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg font-semibold text-gray-900 flex items-center gap-2">
            <Package className="w-5 h-5 text-green-600" />
            Top Suppliers
          </h3>
          {!showFinancialData && (
            <span className="text-xs text-gray-500 flex items-center gap-1">
              <Lock size={12} />
              Revenue hidden
            </span>
          )}
        </div>

        <div className="space-y-3">
          {topSuppliers.length === 0 ? (
            <p className="text-gray-500 text-sm text-center py-4">No data available</p>
          ) : (
            topSuppliers.map((supplier, idx) => (
              <div
                key={supplier.supplier_id}
                className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
              >
                <div className="flex-1">
                  <div className="flex items-center gap-2">
                    <span className="text-sm font-semibold text-gray-400">#{idx + 1}</span>
                    <div>
                      <p className="font-medium text-gray-900">{supplier.supplier_name}</p>
                      <p className="text-xs text-gray-500">{supplier.supplier_email}</p>
                    </div>
                  </div>
                  <p className="text-xs text-gray-600 mt-1">{supplier.order_count} orders</p>
                </div>
                {/* Only show revenue if authorized */}
                {showFinancialData ? (
                  <div className="text-right">
                    <p className="font-bold text-green-600">{formatCurrency(supplier.revenue)}</p>
                  </div>
                ) : (
                  <div className="text-right">
                    <span className="text-xs text-gray-400 bg-gray-200 px-2 py-1 rounded">
                      Hidden
                    </span>
                  </div>
                )}
              </div>
            ))
          )}
        </div>
      </div>

      {/* Recent Activity */}
      <div className="bg-white rounded-xl shadow-card p-6">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg font-semibold text-gray-900 flex items-center gap-2">
            <Clock className="w-5 h-5 text-purple-600" />
            Recent Activity
          </h3>
        </div>

        <div className="space-y-3 max-h-[500px] overflow-y-auto">
          {recentActivity.length === 0 ? (
            <p className="text-gray-500 text-sm text-center py-4">No recent activity</p>
          ) : (
            recentActivity.map((activity) => (
              <div
                key={activity.id}
                className="p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
              >
                <div className="flex items-start justify-between mb-2">
                  <div className="flex-1">
                    <p className="text-sm font-medium text-gray-900">
                      {activity.po_number}
                    </p>
                    <p className="text-xs text-gray-600">
                      {activity.client_name} • {activity.project_name}
                    </p>
                  </div>
                  <span
                    className={`text-xs px-2 py-1 rounded-full font-medium ${getWorkflowBadgeClass(
                      activity.workflow
                    )}`}
                  >
                    {activity.workflow}
                  </span>
                </div>
                <div className="flex items-center justify-between">
                  <p className="text-xs text-gray-500">{activity.time_ago}</p>
                  {/* Only show amount if authorized AND amount > 0 */}
                  {activity.amount > 0 && (
                    showFinancialData ? (
                      <p className="text-xs font-semibold text-gray-700">
                        {formatCurrency(activity.amount)}
                      </p>
                    ) : (
                      <span className="text-xs text-gray-400">
                        Amount hidden
                      </span>
                    )
                  )}
                </div>
              </div>
            ))
          )}
        </div>
      </div>
    </div>
  );
};

export default TablesSection;
/* FILE: src/components/admin/Orders/ActiveFilterChips.tsx */
// FILE PATH: src/components/admin/Orders/ActiveFilterChips.tsx

/**
 * Active Filter Chips Component
 * Shows active filters as removable chips
 */

import React from 'react';
import { X } from 'lucide-react';
import type { AdminOrderFilters } from '../../../types/adminOrder.types';

interface ActiveFilterChipsProps {
  filters: {
    search: string;
    client_id: string;
    project_id: string;
    supplier_id: string;
    workflow: string;
    payment_status: string;
    delivery_method: string;
    delivery_date_from: string;
    delivery_date_to: string;
    repeat_order: string;
    has_missing_supplier: string;
    supplier_confirms: string;
    min_total: string;
    max_total: string;
  };
  onFilterChange: (key: string, value: string) => void;
  availableFilters: AdminOrderFilters | null;
}

const ActiveFilterChips: React.FC<ActiveFilterChipsProps> = ({
  filters,
  onFilterChange,
  availableFilters,
}) => {
  const activeFilters: { key: string; label: string; value: string }[] = [];

  // Helper to get label from ID
  const getClientName = (id: string) =>
    availableFilters?.clients?.find((c) => c.id === parseInt(id))?.name || id;
  const getProjectName = (id: string) =>
    availableFilters?.projects?.find((p) => p.id === parseInt(id))?.name || id;
  const getSupplierName = (id: string) =>
    availableFilters?.suppliers?.find((s) => s.id === parseInt(id))?.name || id;

  // Build active filters array
  if (filters.search) {
    activeFilters.push({ key: 'search', label: 'Search', value: filters.search });
  }
  if (filters.client_id) {
    activeFilters.push({ key: 'client_id', label: 'Client', value: getClientName(filters.client_id) });
  }
  if (filters.project_id) {
    activeFilters.push({ key: 'project_id', label: 'Project', value: getProjectName(filters.project_id) });
  }
  if (filters.supplier_id) {
    activeFilters.push({ key: 'supplier_id', label: 'Supplier', value: getSupplierName(filters.supplier_id) });
  }
  if (filters.workflow) {
    activeFilters.push({ key: 'workflow', label: 'Workflow', value: filters.workflow });
  }
  if (filters.payment_status) {
    activeFilters.push({ key: 'payment_status', label: 'Payment', value: filters.payment_status });
  }
  if (filters.delivery_method) {
    activeFilters.push({ key: 'delivery_method', label: 'Delivery', value: filters.delivery_method });
  }
  if (filters.delivery_date_from) {
    activeFilters.push({ key: 'delivery_date_from', label: 'From Date', value: filters.delivery_date_from });
  }
  if (filters.delivery_date_to) {
    activeFilters.push({ key: 'delivery_date_to', label: 'To Date', value: filters.delivery_date_to });
  }
  if (filters.repeat_order) {
    activeFilters.push({ key: 'repeat_order', label: 'Repeat', value: filters.repeat_order === 'true' ? 'Yes' : 'No' });
  }
  if (filters.has_missing_supplier) {
    activeFilters.push({ key: 'has_missing_supplier', label: 'Missing Supplier', value: filters.has_missing_supplier === 'true' ? 'Yes' : 'No' });
  }
  if (filters.supplier_confirms) {
    activeFilters.push({ key: 'supplier_confirms', label: 'Supplier Confirms', value: filters.supplier_confirms === '1' ? 'Confirmed' : 'Pending' });
  }
  if (filters.min_total) {
    activeFilters.push({ key: 'min_total', label: 'Min Total', value: `$${filters.min_total}` });
  }
  if (filters.max_total) {
    activeFilters.push({ key: 'max_total', label: 'Max Total', value: `$${filters.max_total}` });
  }

  if (activeFilters.length === 0) return null;

  return (
    <div className="flex flex-wrap items-center gap-2">
      <span className="text-sm font-medium text-gray-600">Active Filters:</span>
      {activeFilters.map((filter) => (
        <div
          key={filter.key}
          className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-blue-100 text-blue-800 rounded-full text-sm font-medium border border-blue-200 hover:bg-blue-200 transition-colors group"
        >
          <span className="font-semibold">{filter.label}:</span>
          <span className="max-w-[120px] truncate">{filter.value}</span>
          <button
            onClick={() => onFilterChange(filter.key, '')}
            className="ml-1 p-0.5 hover:bg-blue-300 rounded-full transition-colors"
            title={`Remove ${filter.label} filter`}
          >
            <X size={14} />
          </button>
        </div>
      ))}
    </div>
  );
};

export default ActiveFilterChips;
/* FILE: src/components/admin/Orders/AdminOrderItemEditModal.tsx */
// FILE PATH: src/components/admin/Orders/AdminOrderItemEditModal.tsx

import React, { useState, useEffect } from 'react';
import { X, Save, AlertCircle, Truck, Package, DollarSign, Calendar } from 'lucide-react';
import toast from 'react-hot-toast';
import type { AdminOrderItem } from '../../../types/adminOrder.types';
import { useAdminUpdateOrderItem } from '../../../features/adminOrders/hooks';

interface AdminOrderItemEditModalProps {
  item: AdminOrderItem | null;
  isOpen: boolean;
  onClose: () => void;
  onSuccess: () => void;
}

type DeliveryType = 'Included' | 'Supplier' | 'ThirdParty' | 'Fleet' | 'None';

const DELIVERY_TYPE_OPTIONS: Array<{ value: DeliveryType; label: string; description: string }> = [
  { value: 'Included', label: 'Included in Price', description: 'Delivery cost included in item price' },
  { value: 'Supplier', label: 'Supplier Delivery', description: 'Supplier handles delivery' },
  { value: 'ThirdParty', label: 'Third Party', description: 'External delivery service' },
  { value: 'Fleet', label: 'Fleet', description: 'Company fleet delivery' },
  { value: 'None', label: 'No Delivery', description: 'Pickup only, no delivery' },
];

const AdminOrderItemEditModal: React.FC<AdminOrderItemEditModalProps> = ({
  item,
  isOpen,
  onClose,
  onSuccess,
}) => {
  const [formData, setFormData] = useState({
    supplier_unit_cost: '',
    supplier_discount: '',
    delivery_cost: '',
    delivery_type: 'Supplier' as DeliveryType,
    supplier_delivery_date: '',
    supplier_notes: '',
    supplier_confirms: false,
    quantity: '', // NEW: Add quantity field
  });
  const [errors, setErrors] = useState<Record<string, string>>({});

  const updateMutation = useAdminUpdateOrderItem();

  useEffect(() => {
    if (item) {
      setFormData({
        supplier_unit_cost: item.supplier_unit_cost?.toString() || '',
        delivery_cost: item.delivery_cost?.toString() || '',
        delivery_type: (item.delivery_type as DeliveryType) || 'Supplier',
        supplier_discount: item.supplier_discount?.toString() || '0',
        supplier_delivery_date: item.supplier_delivery_date?.split('T')[0] || '',
        supplier_notes: item.supplier_notes || '',
        supplier_confirms: Boolean(item.supplier_confirms),
        quantity: item.quantity?.toString() || '1', // NEW: Set quantity from item
      });
    }
  }, [item]);

  const handleChange = (
    e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>
  ) => {
    const { name, value, type } = e.target;
    const checked = (e.target as HTMLInputElement).checked;

    if (name === 'delivery_type' && (value === 'None' || value === 'Included')) {
      setFormData((prev) => ({
        ...prev,
        delivery_type: value as DeliveryType,
        delivery_cost: '0',
      }));
    } else {
      setFormData((prev) => ({
        ...prev,
        [name]: type === 'checkbox' ? checked : value,
      }));
    }

    if (errors[name]) {
      setErrors((prev) => ({ ...prev, [name]: '' }));
    }
  };

  const shouldShowDeliveryCost = () => {
    return formData.delivery_type !== 'None' && formData.delivery_type !== 'Included';
  };

  const validate = () => {
    const newErrors: Record<string, string> = {};

    if (!formData.supplier_unit_cost || parseFloat(formData.supplier_unit_cost) < 0) {
      newErrors.supplier_unit_cost = 'Unit cost must be a positive number';
    }

    if (parseFloat(formData.supplier_discount) < 0) {
      newErrors.supplier_discount = 'Discount cannot be negative';
    }

    if (!formData.supplier_delivery_date) {
      newErrors.supplier_delivery_date = 'Delivery date is required';
    }

    if (!formData.delivery_type) {
      newErrors.delivery_type = 'Delivery type is required';
    }

    if (shouldShowDeliveryCost()) {
      if (!formData.delivery_cost || parseFloat(formData.delivery_cost) < 0) {
        newErrors.delivery_cost = 'Delivery cost must be a positive number';
      }
    }

    // NEW: Validate quantity
    if (!formData.quantity || parseFloat(formData.quantity) <= 0) {
      newErrors.quantity = 'Quantity must be greater than 0';
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();

    if (!validate()) {
      toast.error('Please fix the errors before submitting');
      return;
    }

    if (!item) return;

    const deliveryCost = shouldShowDeliveryCost() ? parseFloat(formData.delivery_cost) : 0;

    updateMutation.mutate(
      {
        orderItemId: item.id,
        payload: {
          supplier_unit_cost: parseFloat(formData.supplier_unit_cost),
          supplier_discount: parseFloat(formData.supplier_discount),
          delivery_cost: deliveryCost,
          delivery_type: formData.delivery_type,
          supplier_delivery_date: formData.supplier_delivery_date,
          supplier_notes: formData.supplier_notes,
          supplier_confirms: formData.supplier_confirms,
          quantity: parseFloat(formData.quantity), // NEW: Include quantity in payload
        },
      },
      {
        onSuccess: () => {
          toast.success('Order item updated successfully');
          onSuccess();
          onClose();
        },
        onError: (error: Error) => {
          toast.error(error.message || 'Failed to update order item');
        },
      }
    );
  };

  const calculateItemTotal = () => {
    const unitCost = parseFloat(formData.supplier_unit_cost) || 0;
    const discount = parseFloat(formData.supplier_discount) || 0;
    const deliveryCost = shouldShowDeliveryCost() ? parseFloat(formData.delivery_cost) || 0 : 0;
    const quantity = parseFloat(formData.quantity) || 1; // NEW: Use dynamic quantity
    return (unitCost * quantity - discount + deliveryCost).toFixed(2);
  };

  if (!isOpen || !item) return null;

  const isConfirmed = Boolean(item.supplier_confirms);

  return (
    <>
      <div
        className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50"
        onClick={onClose}
      />
      <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
          {/* Header */}
          <div className="bg-gradient-to-r from-orange-600 to-amber-600 px-6 py-4 flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-white/20 rounded-lg backdrop-blur-sm">
                <Package size={24} className="text-white" />
              </div>
              <div>
                <h2 className="text-xl font-bold text-white">Admin Edit Item</h2>
                <p className="text-orange-100 text-sm">{item.product_name}</p>
              </div>
            </div>
            <button
              onClick={onClose}
              className="p-2 hover:bg-white/20 rounded-lg transition-colors"
            >
              <X size={24} className="text-white" />
            </button>
          </div>

          {/* Warning for confirmed items */}
          {isConfirmed && (
            <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mx-6 mt-4">
              <div className="flex items-start gap-3">
                <AlertCircle className="text-yellow-600 flex-shrink-0 mt-0.5" size={20} />
                <div>
                  <h4 className="text-sm font-bold text-yellow-900">Item Already Confirmed</h4>
                  <p className="text-sm text-yellow-700 mt-1">
                    This item has been confirmed. Once confirmed, it cannot be unconfirmed.
                  </p>
                </div>
              </div>
            </div>
          )}

          {/* Form */}
          <form onSubmit={handleSubmit} className="p-6 overflow-y-auto max-h-[calc(90vh-180px)]">
            <div className="space-y-6">
              {/* Item Info */}
              <div className="bg-gray-50 rounded-lg p-4 border-2 border-gray-200">
                <div className="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <span className="text-gray-600">Product:</span>
                    <span className="ml-2 font-bold text-gray-900">{item.product_name}</span>
                  </div>
                  <div>
                    <span className="text-gray-600">Supplier:</span>
                    <span className="ml-2 font-bold text-gray-900">
                      {item.supplier?.name || 'Not assigned'}
                    </span>
                  </div>
                </div>
              </div>

              {/* NEW: Quantity Field */}
              <div>
                <label className="block text-sm font-bold text-gray-900 mb-2 flex items-center gap-2">
                  <Package size={16} className="text-purple-600" />
                  Quantity *
                </label>
                <input
                  type="number"
                  name="quantity"
                  value={formData.quantity}
                  onChange={handleChange}
                  step="0.01"
                  min="0.01"
                  required
                  className={`w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors ${
                    errors.quantity ? 'border-red-300 bg-red-50' : 'border-gray-300'
                  }`}
                  placeholder="1.00"
                />
                {errors.quantity && (
                  <p className="text-red-600 text-sm mt-1 flex items-center gap-1">
                    <AlertCircle size={14} />
                    {errors.quantity}
                  </p>
                )}
              </div>

              {/* Supplier Unit Cost */}
              <div>
                <label className="block text-sm font-bold text-gray-900 mb-2 flex items-center gap-2">
                  <DollarSign size={16} className="text-blue-600" />
                  Supplier Unit Cost *
                </label>
                <input
                  type="number"
                  name="supplier_unit_cost"
                  value={formData.supplier_unit_cost}
                  onChange={handleChange}
                  step="0.01"
                  min="0"
                  required
                  className={`w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors ${
                    errors.supplier_unit_cost ? 'border-red-300 bg-red-50' : 'border-gray-300'
                  }`}
                  placeholder="0.00"
                />
                {errors.supplier_unit_cost && (
                  <p className="text-red-600 text-sm mt-1 flex items-center gap-1">
                    <AlertCircle size={14} />
                    {errors.supplier_unit_cost}
                  </p>
                )}
              </div>

              {/* Supplier Discount */}
              <div>
                <label className="block text-sm font-bold text-gray-900 mb-2 flex items-center gap-2">
                  <DollarSign size={16} className="text-green-600" />
                  Supplier Discount
                </label>
                <input
                  type="number"
                  name="supplier_discount"
                  value={formData.supplier_discount}
                  onChange={handleChange}
                  step="0.01"
                  min="0"
                  className={`w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors ${
                    errors.supplier_discount ? 'border-red-300 bg-red-50' : 'border-gray-300'
                  }`}
                  placeholder="0.00"
                />
                {errors.supplier_discount && (
                  <p className="text-red-600 text-sm mt-1 flex items-center gap-1">
                    <AlertCircle size={14} />
                    {errors.supplier_discount}
                  </p>
                )}
              </div>

              {/* Delivery Type */}
              <div>
                <label className="block text-sm font-bold text-gray-900 mb-2 flex items-center gap-2">
                  <Truck size={16} className="text-blue-600" />
                  Delivery Type *
                </label>
                <select
                  name="delivery_type"
                  value={formData.delivery_type}
                  onChange={handleChange}
                  required
                  className={`w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors ${
                    errors.delivery_type ? 'border-red-300 bg-red-50' : 'border-gray-300'
                  }`}
                >
                  {DELIVERY_TYPE_OPTIONS.map((option) => (
                    <option key={option.value} value={option.value}>
                      {option.label} - {option.description}
                    </option>
                  ))}
                </select>
                {errors.delivery_type && (
                  <p className="text-red-600 text-sm mt-1 flex items-center gap-1">
                    <AlertCircle size={14} />
                    {errors.delivery_type}
                  </p>
                )}
              </div>

              {/* Delivery Cost - Conditional */}
              {shouldShowDeliveryCost() && (
                <div>
                  <label className="block text-sm font-bold text-gray-900 mb-2 flex items-center gap-2">
                    <Truck size={16} className="text-indigo-600" />
                    Delivery Cost *
                  </label>
                  <input
                    type="number"
                    name="delivery_cost"
                    value={formData.delivery_cost}
                    onChange={handleChange}
                    step="0.01"
                    min="0"
                    required={shouldShowDeliveryCost()}
                    className={`w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors ${
                      errors.delivery_cost ? 'border-red-300 bg-red-50' : 'border-gray-300'
                    }`}
                    placeholder="0.00"
                  />
                  {errors.delivery_cost && (
                    <p className="text-red-600 text-sm mt-1 flex items-center gap-1">
                      <AlertCircle size={14} />
                      {errors.delivery_cost}
                    </p>
                  )}
                </div>
              )}

              {/* Supplier Delivery Date */}
              <div>
                <label className="block text-sm font-bold text-gray-900 mb-2 flex items-center gap-2">
                  <Calendar size={16} className="text-teal-600" />
                  Delivery Date *
                </label>
                <input
                  type="date"
                  name="supplier_delivery_date"
                  value={formData.supplier_delivery_date}
                  onChange={handleChange}
                  required
                  className={`w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors ${
                    errors.supplier_delivery_date ? 'border-red-300 bg-red-50' : 'border-gray-300'
                  }`}
                />
                {errors.supplier_delivery_date && (
                  <p className="text-red-600 text-sm mt-1 flex items-center gap-1">
                    <AlertCircle size={14} />
                    {errors.supplier_delivery_date}
                  </p>
                )}
              </div>

              {/* Supplier Notes */}
              <div>
                <label className="block text-sm font-bold text-gray-900 mb-2">
                  Supplier Notes
                </label>
                <textarea
                  name="supplier_notes"
                  value={formData.supplier_notes}
                  onChange={handleChange}
                  rows={3}
                  maxLength={500}
                  className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none"
                  placeholder="Add any notes about this item..."
                />
                <p className="text-gray-500 text-xs mt-1">
                  {formData.supplier_notes.length}/500 characters
                </p>
              </div>

              {/* Supplier Confirms */}
              <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                <label className="flex items-start gap-3 cursor-pointer">
                  <input
                    type="checkbox"
                    name="supplier_confirms"
                    checked={formData.supplier_confirms}
                    onChange={handleChange}
                    disabled={isConfirmed}
                    className="mt-1 w-5 h-5 text-blue-600 border-2 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                  />
                  <div className="flex-1">
                    <span className="text-sm font-bold text-gray-900 block">
                      Confirm Item Pricing & Details
                    </span>
                    <span className="text-sm text-gray-600 block mt-1">
                      {isConfirmed
                        ? 'This item is already confirmed and cannot be unconfirmed.'
                        : 'Check this to confirm all pricing and delivery details are final.'}
                    </span>
                  </div>
                </label>
              </div>

              {/* Total Preview */}
              <div className="bg-gradient-to-br from-gray-50 to-gray-100 border-2 border-gray-300 rounded-xl p-4">
                <h4 className="text-sm font-bold text-gray-900 mb-3">Item Total Preview</h4>
                <div className="space-y-2 text-sm">
                  <div className="flex justify-between">
                    <span className="text-gray-600">
                      Unit Cost × {parseFloat(formData.quantity) || 1}:
                    </span>
                    <span className="font-medium text-gray-900">
                      ${((parseFloat(formData.supplier_unit_cost) || 0) * (parseFloat(formData.quantity) || 1)).toFixed(2)}
                    </span>
                  </div>
                  {parseFloat(formData.supplier_discount) > 0 && (
                    <div className="flex justify-between text-green-600">
                      <span>Discount:</span>
                      <span className="font-medium">
                        -${parseFloat(formData.supplier_discount).toFixed(2)}
                      </span>
                    </div>
                  )}
                  {shouldShowDeliveryCost() && parseFloat(formData.delivery_cost) > 0 && (
                    <div className="flex justify-between text-blue-600">
                      <span>Delivery:</span>
                      <span className="font-medium">
                        +${parseFloat(formData.delivery_cost).toFixed(2)}
                      </span>
                    </div>
                  )}
                  <div className="flex justify-between pt-2 border-t-2 border-gray-300">
                    <span className="font-bold text-gray-900">Total:</span>
                    <span className="font-bold text-lg text-blue-600">
                      ${calculateItemTotal()}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </form>

          {/* Footer */}
          <div className="px-6 py-4 bg-gray-50 border-t-2 border-gray-200 flex gap-3">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 px-4 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-white transition-colors font-medium"
            >
              Cancel
            </button>
            <button
              onClick={handleSubmit}
              disabled={updateMutation.isPending}
              className="flex-1 px-4 py-3 bg-gradient-to-r from-orange-600 to-amber-600 text-white rounded-lg hover:from-orange-700 hover:to-amber-700 transition-all shadow-md hover:shadow-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
            >
              {updateMutation.isPending ? (
                <>
                  <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
                  Updating...
                </>
              ) : (
                <>
                  <Save size={20} />
                  Save Changes
                </>
              )}
            </button>
          </div>
        </div>
      </div>
    </>
  );
};

export default AdminOrderItemEditModal;
/* FILE: src/components/admin/Orders/AdminOrderView.tsx */
// FILE PATH: src/pages/admin/Orders/AdminOrderView.tsx

/**
 * Admin Order View Page - IMPROVED
 * Comprehensive order details with professional tabbed interface
 * Updated with consistent color scheme and improved UX
 */

import React, { useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import {
  ArrowLeft,
  FileText,
  Package,
  Calculator,
  MapPin,
  Settings,
  Loader2,
  AlertCircle,
} from 'lucide-react';
import DashboardLayout from '../../../components/layout/DashboardLayout';
import OrderOverviewTab from '../../../components/admin/Orders/OrderOverviewTab';
import OrderItemsTab from '../../../components/admin/Orders/OrderItemsTab';
import OrderCostingTab from '../../../components/admin/Orders/OrderCostingTab';
import OrderMapTab from '../../../components/admin/Orders/OrderMapTab';
import OrderAdminUpdateTab from '../../../components/admin/Orders/OrderAdminUpdateTab';
import { useAdminOrderDetail } from '../../../features/adminOrders/hooks';
import { adminMenuItems } from '../../../utils/menuItems';

type TabType = 'overview' | 'items' | 'costing' | 'map' | 'admin';

const AdminOrderView: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const [activeTab, setActiveTab] = useState<TabType>('overview');

  const { data, isLoading, error } = useAdminOrderDetail(parseInt(id || '0'));

  // Loading State
  if (isLoading) {
    return (
      <DashboardLayout menuItems={adminMenuItems}>
        <div className="flex items-center justify-center h-96">
          <div className="text-center">
            <Loader2 className="animate-spin text-blue-600 mx-auto mb-4" size={48} />
            <p className="text-gray-600 font-medium">Loading order details...</p>
          </div>
        </div>
      </DashboardLayout>
    );
  }

  // Error State
  if (error || !data?.data) {
    return (
      <DashboardLayout menuItems={adminMenuItems}>
        <div className="bg-white rounded-xl border-2 border-red-200 p-8 text-center shadow-lg">
          <AlertCircle className="mx-auto text-red-600 mb-4" size={48} />
          <p className="text-red-600 font-bold text-lg mb-4">
            {(error as Error)?.message || 'Order not found'}
          </p>
          <button
            onClick={() => navigate('/admin/orders')}
            className="text-blue-600 hover:text-blue-700 inline-flex items-center gap-2 font-bold transition-colors"
          >
            <ArrowLeft size={18} />
            Back to Orders
          </button>
        </div>
      </DashboardLayout>
    );
  }

  const order = data.data;

  // Get workflow badge color
  const getWorkflowColor = (workflow: string) => {
    const colorMap: Record<string, string> = {
      'Requested': 'bg-blue-100 text-blue-700 border-blue-300',
      'Supplier Missing': 'bg-yellow-100 text-yellow-700 border-yellow-300',
      'Supplier Assigned': 'bg-indigo-100 text-indigo-700 border-indigo-300',
      'Payment Requested': 'bg-purple-100 text-purple-700 border-purple-300',
      'On Hold': 'bg-gray-200 text-gray-700 border-gray-400',
      'Delivered': 'bg-green-100 text-green-700 border-green-300',
    };
    return colorMap[workflow] || 'bg-gray-100 text-gray-700 border-gray-300';
  };

  // Get payment status badge color
  const getPaymentColor = (status: string) => {
    const colorMap: Record<string, string> = {
      'Pending': 'bg-gray-200 text-gray-700 border-gray-400',
      'Requested': 'bg-yellow-100 text-yellow-700 border-yellow-300',
      'Paid': 'bg-green-100 text-green-700 border-green-300',
      'Partially Paid': 'bg-indigo-100 text-indigo-700 border-indigo-300',
      'Partial Refunded': 'bg-purple-100 text-purple-700 border-purple-300',
      'Refunded': 'bg-red-100 text-red-700 border-red-300',
    };
    return colorMap[status] || 'bg-gray-100 text-gray-700 border-gray-300';
  };

  // Tab Configuration with consistent colors
  const tabs = [
    {
      id: 'overview' as TabType,
      label: 'Overview',
      icon: FileText,
      activeClass: 'bg-blue-600 text-white border-blue-700 shadow-md',
      inactiveClass: 'text-blue-700 hover:bg-blue-50 border-blue-200',
    },
    {
      id: 'items' as TabType,
      label: 'Items',
      icon: Package,
      badge: order.items.length,
      activeClass: 'bg-purple-600 text-white border-purple-700 shadow-md',
      inactiveClass: 'text-purple-700 hover:bg-purple-50 border-purple-200',
    },
    {
      id: 'costing' as TabType,
      label: 'Costing',
      icon: Calculator,
      activeClass: 'bg-green-600 text-white border-green-700 shadow-md',
      inactiveClass: 'text-green-700 hover:bg-green-50 border-green-200',
    },
    {
      id: 'map' as TabType,
      label: 'Map',
      icon: MapPin,
      activeClass: 'bg-orange-600 text-white border-orange-700 shadow-md',
      inactiveClass: 'text-orange-700 hover:bg-orange-50 border-orange-200',
    },
    {
      id: 'admin' as TabType,
      label: 'Admin Controls',
      icon: Settings,
      activeClass: 'bg-indigo-600 text-white border-indigo-700 shadow-md',
      inactiveClass: 'text-indigo-700 hover:bg-indigo-50 border-indigo-200',
    },
  ];

  return (
    <DashboardLayout menuItems={adminMenuItems}>
      <div className="space-y-6">
        {/* Back Button */}
        <div className="flex items-center justify-between">
          <button
            onClick={() => navigate('/admin/orders')}
            className="flex items-center gap-2 text-gray-600 hover:text-blue-600 transition-colors font-medium group"
          >
            <ArrowLeft size={20} className="group-hover:-translate-x-1 transition-transform" />
            Back to Orders
          </button>
          
          {/* Status Badges */}
          <div className="flex items-center gap-3">
            <span className={`px-4 py-2 text-sm font-bold rounded-lg border-2 ${getWorkflowColor(order.workflow)} transition-colors`}>
              {order.workflow}
            </span>
            <span className={`px-4 py-2 text-sm font-bold rounded-lg border-2 ${getPaymentColor(order.payment_status)} transition-colors`}>
              {order.payment_status}
            </span>
          </div>
        </div>

        {/* Order Header Card */}
        <div className="bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 rounded-xl p-8 text-white shadow-xl">
          <div className="flex items-center justify-between">
            <div>
              <div className="flex items-center gap-3 mb-3">
                <div className="p-2 bg-white/10 rounded-lg backdrop-blur-sm">
                  <Package size={32} />
                </div>
                <h1 className="text-4xl font-bold">Order #{order.po_number}</h1>
              </div>
              <div className="flex items-center gap-4 text-blue-100">
                <div className="flex items-center gap-2">
                  <div className="w-2 h-2 bg-white rounded-full"></div>
                  <span className="font-medium">{order.client}</span>
                </div>
                <span>•</span>
                <div className="flex items-center gap-2">
                  <div className="w-2 h-2 bg-white rounded-full"></div>
                  <span className="font-medium">{order.project}</span>
                </div>
              </div>
            </div>
            
            {/* Quick Stats */}
            <div className="flex gap-4">
              <div className="bg-white/10 backdrop-blur-sm rounded-lg p-4 border border-white/20">
                <p className="text-xs text-blue-100 mb-1">Total Items</p>
                <p className="text-2xl font-bold">{order.items.length}</p>
              </div>
              <div className="bg-white/10 backdrop-blur-sm rounded-lg p-4 border border-white/20">
                <p className="text-xs text-blue-100 mb-1">Total Value</p>
                <p className="text-2xl font-bold">
                  ${(order.total_price || order.customer_cost || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* Tab Navigation */}
        <div className="bg-white rounded-xl border-2 border-gray-200 p-2 shadow-sm">
          <div className="flex gap-2 overflow-x-auto">
            {tabs.map((tab) => {
              const Icon = tab.icon;
              const isActive = activeTab === tab.id;

              return (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id)}
                  className={`
                    flex items-center gap-2 px-6 py-3 rounded-lg font-bold transition-all border-2 whitespace-nowrap
                    ${isActive ? tab.activeClass : tab.inactiveClass}
                  `}
                >
                  <Icon size={20} />
                  <span>{tab.label}</span>
                  {tab.badge !== undefined && (
                    <span
                      className={`
                        px-2 py-0.5 rounded-full text-xs font-bold
                        ${isActive ? 'bg-white/20' : 'bg-gray-200 text-gray-700'}
                      `}
                    >
                      {tab.badge}
                    </span>
                  )}
                </button>
              );
            })}
          </div>
        </div>

        {/* Tab Content */}
        <div className="bg-white rounded-xl border-2 border-gray-200 p-6 shadow-sm min-h-[400px]">
          {activeTab === 'overview' && <OrderOverviewTab order={order} />}
          {activeTab === 'items' && (
            <OrderItemsTab items={order.items} workflow={order.workflow} orderId={order.id} />
          )}
          {activeTab === 'costing' && <OrderCostingTab order={order} />}
          {activeTab === 'map' && (
            <OrderMapTab
              deliveryLat={order.delivery_lat}
              deliveryLong={order.delivery_long}
              items={order.items}
            />
          )}
          {activeTab === 'admin' && <OrderAdminUpdateTab order={order} />}
        </div>
      </div>
    </DashboardLayout>
  );
};

export default AdminOrderView;

/* FILE: src/components/admin/Orders/OrderAdminUpdateTab.tsx */
// FILE PATH: src/components/admin/Orders/OrderAdminUpdateTab.tsx

/**
 * Order Admin Update Tab Component - IMPROVED
 * Comprehensive admin controls for:
 * 1. Discount management
 * 2. Supplier assignment overview
 * 3. Payment status overview
 * 4. Quoted prices summary
 */

import React, { useState } from 'react';
import {
  Save,
  RotateCcw,
  DollarSign,
  AlertCircle,
  TrendingUp,
  Package,
  CreditCard,
  CheckCircle,
  XCircle,
} from 'lucide-react';
import type { AdminOrderDetail } from '../../../types/adminOrder.types';
import { useUpdateAdminOrder } from '../../../features/adminOrders/hooks';
import { canEditOrder, formatCurrency } from '../../../features/adminOrders/utils';

interface OrderAdminUpdateTabProps {
  order: AdminOrderDetail;
}

const OrderAdminUpdateTab: React.FC<OrderAdminUpdateTabProps> = ({ order }) => {
  const updateMutation = useUpdateAdminOrder();
  const canEdit = canEditOrder(order.workflow);

  const [discount, setDiscount] = useState<string>(order.discount.toString());
  const [hasChanges, setHasChanges] = useState(false);

  const handleDiscountChange = (value: string) => {
    setDiscount(value);
    setHasChanges(value !== order.discount.toString());
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    const discountValue = parseFloat(discount);
    if (isNaN(discountValue) || discountValue < 0) {
      return;
    }

    updateMutation.mutate(
      {
        orderId: order.id,
        payload: { discount: discountValue },
      },
      {
        onSuccess: () => {
          setHasChanges(false);
        },
      }
    );
  };

  const handleReset = () => {
    setDiscount(order.discount.toString());
    setHasChanges(false);
  };

  // Calculate statistics
  const totalItems = order.items.length;
  const assignedItems = order.items.filter((item) => item.supplier?.id).length;
  console.log(assignedItems,order.items)
  const unassignedItems = totalItems - assignedItems;
  const quotedItems = order.items.filter((item) => item.is_quoted === 1).length;
  const paidItems = order.items.filter((item) => item.is_paid === 1).length;
  const unpaidItems = assignedItems - paidItems;

  // Calculate price after discount
  const currentTotal = order.total_price || order.customer_cost || 0;
  const discountValue = parseFloat(discount) || 0;
  const totalAfterDiscount = currentTotal - discountValue;

  if (!canEdit) {
    return (
      <div className="space-y-6">
        <div className="bg-gradient-to-br from-gray-100 to-gray-200 border-2 border-gray-300 rounded-xl p-8 text-center">
          <AlertCircle className="mx-auto text-gray-500 mb-4" size={48} />
          <h3 className="text-xl font-bold text-gray-900 mb-2">Order Cannot Be Edited</h3>
          <p className="text-gray-700">
            Delivered orders are locked and cannot be modified.
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl p-6 text-white shadow-lg">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-white/10 rounded-lg">
            <AlertCircle size={28} />
          </div>
          <div>
            <h3 className="text-2xl font-bold">Admin Controls</h3>
            <p className="text-indigo-100 text-sm mt-1">
              Manage order pricing, suppliers, and payment status
            </p>
          </div>
        </div>
      </div>

      {/* Quick Stats Overview */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {/* Total Items */}
        <div className="bg-white border-2 border-blue-200 rounded-xl p-4 shadow-sm">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-blue-100 rounded-lg">
              <Package className="text-blue-600" size={20} />
            </div>
            <div>
              <p className="text-xs text-gray-600 font-medium">Total Items</p>
              <p className="text-2xl font-bold text-gray-900">{totalItems}</p>
            </div>
          </div>
        </div>

        {/* Supplier Assignment */}
        <div className={`bg-white border-2 rounded-xl p-4 shadow-sm ${
          unassignedItems > 0 ? 'border-yellow-300' : 'border-green-300'
        }`}>
          <div className="flex items-center gap-3">
            <div className={`p-2 rounded-lg ${
              unassignedItems > 0 ? 'bg-yellow-100' : 'bg-green-100'
            }`}>
              {unassignedItems > 0 ? (
                <XCircle className="text-yellow-600" size={20} />
              ) : (
                <CheckCircle className="text-green-600" size={20} />
              )}
            </div>
            <div>
              <p className="text-xs text-gray-600 font-medium">Suppliers</p>
              <p className="text-2xl font-bold text-gray-900">
                {assignedItems}/{totalItems}
              </p>
            </div>
          </div>
          {unassignedItems > 0 && (
            <p className="text-xs text-yellow-700 mt-2 font-medium">
              {unassignedItems} item{unassignedItems !== 1 ? 's' : ''} need supplier
            </p>
          )}
        </div>

        {/* Quoted Items */}
        <div className="bg-white border-2 border-purple-200 rounded-xl p-4 shadow-sm">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-purple-100 rounded-lg">
              <DollarSign className="text-purple-600" size={20} />
            </div>
            <div>
              <p className="text-xs text-gray-600 font-medium">Quoted Prices</p>
              <p className="text-2xl font-bold text-gray-900">{quotedItems}</p>
            </div>
          </div>
          {quotedItems > 0 && (
            <p className="text-xs text-purple-700 mt-2 font-medium">
              Custom pricing applied
            </p>
          )}
        </div>

        {/* Payment Status */}
        <div className={`bg-white border-2 rounded-xl p-4 shadow-sm ${
          unpaidItems > 0 ? 'border-orange-300' : 'border-green-300'
        }`}>
          <div className="flex items-center gap-3">
            <div className={`p-2 rounded-lg ${
              unpaidItems > 0 ? 'bg-orange-100' : 'bg-green-100'
            }`}>
              <CreditCard className={unpaidItems > 0 ? 'text-orange-600' : 'text-green-600'} size={20} />
            </div>
            <div>
              <p className="text-xs text-gray-600 font-medium">Paid Items</p>
              <p className="text-2xl font-bold text-gray-900">
                {paidItems}/{assignedItems}
              </p>
            </div>
          </div>
          {unpaidItems > 0 && (
            <p className="text-xs text-orange-700 mt-2 font-medium">
              {unpaidItems} item{unpaidItems !== 1 ? 's' : ''} unpaid
            </p>
          )}
        </div>
      </div>

      {/* Discount Management Section */}
      <form onSubmit={handleSubmit} className="space-y-6">
        <div className="bg-white border-2 border-gray-200 rounded-xl p-6 shadow-sm">
          <div className="flex items-center gap-3 mb-6">
            <div className="p-3 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg shadow-sm">
              <DollarSign className="text-white" size={24} />
            </div>
            <div>
              <h4 className="text-xl font-bold text-gray-900">Apply Discount</h4>
              <p className="text-sm text-gray-600">Reduce the final price for this order</p>
            </div>
          </div>

          {/* Current Total Display */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div className="bg-blue-50 rounded-xl p-4 border-2 border-blue-200">
              <div className="text-sm text-blue-700 font-medium mb-1">Current Total</div>
              <div className="text-2xl font-bold text-blue-900">
                {formatCurrency(currentTotal)}
              </div>
              <div className="text-xs text-blue-600 mt-1">Before discount</div>
            </div>
            
            <div className="bg-purple-50 rounded-xl p-4 border-2 border-purple-200">
              <div className="text-sm text-purple-700 font-medium mb-1">Discount</div>
              <div className="text-2xl font-bold text-purple-900">
                {formatCurrency(discountValue)}
              </div>
              <div className="text-xs text-purple-600 mt-1">Amount to deduct</div>
            </div>
            
            <div className="bg-green-50 rounded-xl p-4 border-2 border-green-200">
              <div className="text-sm text-green-700 font-medium mb-1">Final Total</div>
              <div className="text-2xl font-bold text-green-900">
                {formatCurrency(totalAfterDiscount)}
              </div>
              <div className="text-xs text-green-600 mt-1">After discount</div>
            </div>
          </div>

          {/* Discount Input */}
          <div>
            <label className="block text-sm font-bold text-gray-900 mb-3">
              Discount Amount ($)
            </label>
            <input
              type="number"
              value={discount}
              onChange={(e) => handleDiscountChange(e.target.value)}
              min="0"
              step="0.01"
              className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg font-bold transition-colors"
              placeholder="0.00"
            />
            <p className="text-sm text-gray-600 mt-2">
              Enter the discount amount to be subtracted from the final price
            </p>
          </div>

          {/* Impact on Profit */}
          {discountValue !== order.discount && (
            <div className="mt-4 p-4 bg-amber-50 border-2 border-amber-200 rounded-lg">
              <div className="flex items-start gap-2">
                <TrendingUp className="text-amber-600 mt-0.5" size={18} />
                <div className="flex-1">
                  <p className="text-sm font-bold text-amber-900 mb-1">Profit Impact</p>
                  <p className="text-xs text-amber-800">
                    Changing discount from {formatCurrency(order.discount)} to {formatCurrency(discountValue)} will{' '}
                    {discountValue > order.discount ? 'decrease' : 'increase'} profit by{' '}
                    <span className="font-bold">
                      {formatCurrency(Math.abs(discountValue - order.discount))}
                    </span>
                  </p>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Action Buttons */}
        {hasChanges && (
          <div className="flex gap-4">
            <button
              type="submit"
              disabled={updateMutation.isPending}
              className="flex-1 flex items-center justify-center gap-2 px-6 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl hover:from-blue-700 hover:to-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all font-bold text-lg shadow-lg hover:shadow-xl"
            >
              <Save size={20} />
              {updateMutation.isPending ? 'Saving...' : 'Save Discount'}
            </button>
            <button
              type="button"
              onClick={handleReset}
              disabled={!hasChanges}
              className="flex items-center justify-center gap-2 px-6 py-4 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-bold text-lg"
            >
              <RotateCcw size={20} />
              Reset
            </button>
          </div>
        )}
      </form>

      {/* Information Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* How Discount Works */}
        <div className="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-6">
          <h4 className="text-sm font-bold text-blue-900 mb-3 flex items-center gap-2">
            <AlertCircle size={16} />
            How Discount Works
          </h4>
          <div className="space-y-2 text-sm text-gray-800">
            <p>• Discount is subtracted from the final total</p>
            <p>• Formula: <code className="bg-white px-2 py-0.5 rounded font-mono text-xs">Final = Subtotal + Tax - Discount</code></p>
            <p>• Discount directly reduces profit margin</p>
          </div>
        </div>

        {/* Quick Actions Guide */}
        <div className="bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-200 rounded-xl p-6">
          <h4 className="text-sm font-bold text-purple-900 mb-3 flex items-center gap-2">
            <Package size={16} />
            Quick Actions
          </h4>
          <div className="space-y-2 text-sm text-gray-800">
            <p>• Assign suppliers in the <span className="font-bold text-purple-700">Items</span> tab</p>
            <p>• Set quoted prices in the <span className="font-bold text-purple-700">Items</span> tab</p>
            <p>• Mark items paid in the <span className="font-bold text-purple-700">Items</span> tab</p>
          </div>
        </div>
      </div>
    </div>
  );
};

export default OrderAdminUpdateTab;

/* FILE: src/components/admin/Orders/OrderCostingCard.tsx */
// FILE PATH: src/components/admin/Orders/OrderCostingCard.tsx

/**
 * Order Costing Card Component
 * Shows client and supplier costing breakdown
 */

import React from 'react';
import { DollarSign, TrendingUp, AlertCircle } from 'lucide-react';
import type { AdminOrderDetail } from '../../../types/adminOrder.types';
import { formatCurrency, getMarginColor, canShowPricing } from '../../../features/adminOrders/utils';

interface OrderCostingCardProps {
  order: AdminOrderDetail;
}

const OrderCostingCard: React.FC<OrderCostingCardProps> = ({ order }) => {
  const showPricing = canShowPricing(order.workflow);

  if (!showPricing) {
    return (
      <div className="bg-white rounded-lg border border-gray-200 p-6">
        <h2 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
          <DollarSign size={24} />
          Order Costing
        </h2>
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
          <AlertCircle className="mx-auto text-blue-600 mb-2" size={32} />
          <p className="text-blue-800 font-medium">Pricing Not Available</p>
          <p className="text-sm text-blue-600 mt-1">
            Costing information will be available once payment is requested.
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="bg-white rounded-lg border border-gray-200 p-6">
      <h2 className="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2">
        <DollarSign size={24} />
        Order Costing
      </h2>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* Client Costing */}
        <div className="bg-green-50 border border-green-200 rounded-lg p-4">
          <h3 className="font-semibold text-green-900 mb-4 text-lg">Client Costing</h3>
          <div className="space-y-3 text-sm">
            <div className="flex justify-between">
              <span className="text-green-700">Subtotal:</span>
              <span className="font-medium text-green-900">{formatCurrency(order.subtotal)}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-green-700">Fuel Levy:</span>
              <span className="font-medium text-green-900">{formatCurrency(order.fuel_levy)}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-green-700">GST Tax:</span>
              <span className="font-medium text-green-900">{formatCurrency(order.gst_tax)}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-green-700">Other Charges:</span>
              <span className="font-medium text-green-900">
                {formatCurrency(order.other_charges)}
              </span>
            </div>
            {order.discount > 0 && (
              <div className="flex justify-between text-green-600">
                <span>Discount:</span>
                <span className="font-medium">-{formatCurrency(order.discount)}</span>
              </div>
            )}
            <div className="pt-3 border-t-2 border-green-300">
              <div className="flex justify-between items-center">
                <span className="text-green-900 font-bold text-base">Total (Customer Cost):</span>
                <span className="text-green-900 font-bold text-xl">
                  {formatCurrency(order.customer_cost)}
                </span>
              </div>
            </div>
          </div>
        </div>

        {/* Supplier Costing */}
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <h3 className="font-semibold text-blue-900 mb-4 text-lg">Supplier Costing</h3>
          <div className="space-y-3 text-sm">
            <div className="flex justify-between">
              <span className="text-blue-700">Items Total:</span>
              <span className="font-medium text-blue-900">
                {formatCurrency(
                  order.items.reduce(
                    (sum, item) => sum + (item.supplier_unit_cost || 0) * item.quantity,
                    0
                  )
                )}
              </span>
            </div>
            <div className="flex justify-between">
              <span className="text-blue-700">Delivery Cost:</span>
              <span className="font-medium text-blue-900">
                {formatCurrency(
                  order.items.reduce((sum, item) => sum + (item.supplier_delivery_cost || 0), 0)
                )}
              </span>
            </div>
            <div className="flex justify-between">
              <span className="text-blue-700">Discount:</span>
              <span className="font-medium text-blue-900">
                -{formatCurrency(
                  order.items.reduce((sum, item) => sum + (item.supplier_discount || 0), 0)
                )}
              </span>
            </div>
            <div className="pt-3 border-t-2 border-blue-300">
              <div className="flex justify-between items-center">
                <span className="text-blue-900 font-bold text-base">Total (Supplier Cost):</span>
                <span className="text-blue-900 font-bold text-xl">
                  {formatCurrency(order.supplier_cost)}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Admin Margin */}
      <div className="mt-6 bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-lg p-4">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <TrendingUp className="text-purple-600" size={24} />
            <span className="text-purple-900 font-bold text-lg">Admin Margin:</span>
          </div>
          <div className="text-right">
            <p className={`font-bold text-2xl ${getMarginColor(order.admin_margin)}`}>
              {formatCurrency(order.admin_margin)}
            </p>
            <p className="text-sm text-gray-600">
              {((order.admin_margin / order.customer_cost) * 100).toFixed(1)}% margin
            </p>
          </div>
        </div>
      </div>
    </div>
  );
};

export default OrderCostingCard;
/* FILE: src/components/admin/Orders/OrderCostingTab.tsx */
// FILE PATH: src/components/admin/Orders/OrderCostingTab.tsx

/**
 * Order Costing Tab Component - WITH PERMISSION-BASED VISIBILITY
 * Shows detailed cost breakdown with hover tooltips for formulas
 * HIDES supplier cost and profit sections based on user permissions
 */

import React from 'react';
import { Calculator, TrendingUp, DollarSign, Package, Truck, Eye, EyeOff, Lock } from 'lucide-react';
import type { AdminOrderDetail } from '../../../types/adminOrder.types';
import { formatCurrency } from '../../../features/adminOrders/utils';
import FormulaTooltip from '../../common/FormulaTooltip';
import { usePermissions } from '../../../hooks/usePermissions';
import PermissionGate, { CostPriceGate, ProfitMarginGate } from '../../common/PermissionGate';

interface OrderCostingTabProps {
  order: AdminOrderDetail;
}

const OrderCostingTab: React.FC<OrderCostingTabProps> = ({ order }) => {
  // Get permissions
  const { canViewCostPrice, isReadOnly } = usePermissions();

  // Constants from pricing logic
  const ADMIN_MARGIN = 0.50; // 50%
  const GST_RATE = 0.10; // 10%

  // Calculate supplier totals
  const supplierItemTotal = order.supplier_item_cost || 0;
  const supplierDeliveryTotal = order.supplier_delivery_cost || 0;
  const supplierDiscountTotal = order.items.reduce(
    (sum, item) => sum + (item.supplier_discount || 0),
    0
  );
  const supplierGrandTotal = order.supplier_item_cost + order.supplier_delivery_cost;

  // Calculate customer totals
  const customerItemTotal = order.customer_item_cost || 0;
  const customerDeliveryTotal = order.customer_delivery_cost || 0;
  const gstAmount = order.gst_tax || 0;
  const discountAmount = order.discount || 0;
  const otherCharges = order.other_charges || 0;
  const customerGrandTotal = order.total_price || order.customer_cost || 0;

  // Profit calculations
  const profitAmount = order.profit_amount || 0;
  const profitMarginPercent = order.profit_margin_percent * 100 || 0;

  // Count quoted items
  const quotedItemsCount = order.items.filter((item) => item.is_quoted === 1).length;

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl p-6 text-white shadow-lg">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-white/10 rounded-lg">
              <Calculator size={28} />
            </div>
            <div>
              <h3 className="text-2xl font-bold">Cost Breakdown & Calculations</h3>
              <p className="text-blue-100 text-sm mt-1">
                Detailed pricing analysis based on Material Connect pricing logic
              </p>
            </div>
          </div>
          
          {/* Permission Indicator */}
          <div className="flex items-center gap-2">
            {isReadOnly && (
              <span className="px-3 py-1.5 bg-white/20 rounded-lg text-sm font-medium flex items-center gap-2">
                <Eye size={16} />
                Read Only
              </span>
            )}
            {!canViewCostPrice && (
              <span className="px-3 py-1.5 bg-yellow-500/20 rounded-lg text-sm font-medium flex items-center gap-2">
                <EyeOff size={16} />
                Cost Hidden
              </span>
            )}
          </div>
        </div>
      </div>

      {/* ============================================ */}
      {/* SUPPLIER COST SECTION - Permission Protected */}
      {/* ============================================ */}
      <CostPriceGate
        fallback={
          <div className="bg-gray-50 border-2 border-gray-200 rounded-xl p-6 shadow-sm">
            <div className="flex items-center gap-3 text-gray-500">
              <div className="p-3 bg-gray-200 rounded-lg">
                <Lock size={24} />
              </div>
              <div>
                <h4 className="text-lg font-bold text-gray-600">Supplier Cost</h4>
                <p className="text-sm text-gray-500">
                  You don't have permission to view supplier cost information
                </p>
              </div>
            </div>
          </div>
        }
      >
        <div className="bg-white border-2 border-blue-200 rounded-xl p-6 shadow-sm">
          <div className="flex items-center gap-3 mb-6">
            <div className="p-3 bg-blue-600 rounded-lg shadow-sm">
              <DollarSign className="text-white" size={24} />
            </div>
            <div>
              <h4 className="text-xl font-bold text-blue-900">Supplier Cost</h4>
              <p className="text-sm text-blue-600">What we pay to suppliers</p>
            </div>
          </div>

          <div className="space-y-3">
            {/* Items Cost */}
            <div className="flex justify-between items-center p-4 bg-blue-50 rounded-lg border border-blue-200">
              <div className="flex items-center gap-2">
                <Package size={18} className="text-blue-600" />
                <span className="text-gray-700 font-medium">Items Cost</span>
                <FormulaTooltip formula="Sum of (Unit Cost × Quantity) for all items" />
              </div>
              <span className="font-bold text-gray-900 text-lg">
                {formatCurrency(supplierItemTotal)}
              </span>
            </div>

            {/* Delivery Cost */}
            <div className="flex justify-between items-center p-4 bg-blue-50 rounded-lg border border-blue-200">
              <div className="flex items-center gap-2">
                <Truck size={18} className="text-blue-600" />
                <span className="text-gray-700 font-medium">Delivery Cost</span>
                <FormulaTooltip formula="Sum of supplier delivery fees for all items" />
              </div>
              <span className="font-bold text-gray-900 text-lg">
                {formatCurrency(supplierDeliveryTotal)}
              </span>
            </div>

            {/* Supplier Discounts */}
            {supplierDiscountTotal > 0 && (
              <div className="flex justify-between items-center p-4 bg-green-50 rounded-lg border border-green-200">
                <div className="flex items-center gap-2">
                  <span className="text-green-700 font-medium">Supplier Discounts</span>
                  <FormulaTooltip formula="Total discounts provided by suppliers" />
                </div>
                <span className="font-bold text-green-700 text-lg">
                  -{formatCurrency(supplierDiscountTotal)}
                </span>
              </div>
            )}

            {/* Total Supplier Cost */}
            <div className="flex justify-between items-center p-5 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg border-2 border-blue-800 shadow-md mt-4">
              <div className="flex items-center gap-2">
                <span className="font-bold text-lg">Total Supplier Cost</span>
                <FormulaTooltip
                  formula="Item Cost + Delivery Cost - Supplier Discounts"
                  className="text-white"
                />
              </div>
              <span className="font-bold text-2xl">{formatCurrency(supplierGrandTotal)}</span>
            </div>
          </div>
        </div>
      </CostPriceGate>

      {/* ============================================ */}
      {/* CUSTOMER PRICE SECTION - Always Visible */}
      {/* ============================================ */}
      <div className="bg-white border-2 border-green-200 rounded-xl p-6 shadow-sm">
        <div className="flex items-center gap-3 mb-6">
          <div className="p-3 bg-green-600 rounded-lg shadow-sm">
            <TrendingUp className="text-white" size={24} />
          </div>
          <div>
            <h4 className="text-xl font-bold text-green-900">Customer Price</h4>
            <p className="text-sm text-green-600">What client pays</p>
          </div>
        </div>

        {/* System Constants Info - Only show if can view cost price */}
        <PermissionGate permission="pricing.view_cost_price">
          <div className="mb-6 p-4 bg-green-50 rounded-lg border border-green-200">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="px-3 py-1.5 bg-green-600 text-white rounded-lg font-bold text-sm">
                  Admin Margin: {ADMIN_MARGIN * 100}%
                </div>
                <div className="px-3 py-1.5 bg-green-600 text-white rounded-lg font-bold text-sm">
                  GST Rate: {GST_RATE * 100}%
                </div>
              </div>
              {quotedItemsCount > 0 && (
                <div className="px-3 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold text-sm border border-purple-300">
                  {quotedItemsCount} item{quotedItemsCount > 1 ? 's' : ''} with quoted prices
                </div>
              )}
            </div>
          </div>
        </PermissionGate>

        <div className="space-y-3">
          {/* Customer Item Cost */}
          <div className="flex justify-between items-center p-4 bg-green-50 rounded-lg border border-green-200">
            <div className="flex items-center gap-2">
              <Package size={18} className="text-green-600" />
              <span className="text-gray-700 font-medium">Item Cost</span>
              <PermissionGate permission="pricing.view_cost_price">
                <FormulaTooltip
                  formula={`Base Material × (1 + ${ADMIN_MARGIN * 100}%)\nOR Quoted Price if set (overrides calculation)`}
                />
              </PermissionGate>
            </div>
            <span className="font-bold text-gray-900 text-lg">
              {formatCurrency(customerItemTotal)}
            </span>
          </div>

          {/* Customer Delivery Cost */}
          <div className="flex justify-between items-center p-4 bg-green-50 rounded-lg border border-green-200">
            <div className="flex items-center gap-2">
              <Truck size={18} className="text-green-600" />
              <span className="text-gray-700 font-medium">Delivery Cost</span>
              <PermissionGate permission="pricing.view_cost_price">
                <FormulaTooltip formula="Supplier Delivery × (1 + Admin Margin)" />
              </PermissionGate>
            </div>
            <span className="font-bold text-gray-900 text-lg">
              {formatCurrency(customerDeliveryTotal)}
            </span>
          </div>

          {/* GST */}
          <div className="flex justify-between items-center p-4 bg-green-50 rounded-lg border border-green-200">
            <div className="flex items-center gap-2">
              <span className="text-gray-700 font-medium">GST ({GST_RATE * 100}%)</span>
              <FormulaTooltip formula="(Item Cost + Delivery Cost) × 10%" />
            </div>
            <span className="font-bold text-gray-900 text-lg">
              {formatCurrency(gstAmount)}
            </span>
          </div>

          {/* Other Charges */}
          {otherCharges > 0 && (
            <div className="flex justify-between items-center p-4 bg-green-50 rounded-lg border border-green-200">
              <div className="flex items-center gap-2">
                <span className="text-gray-700 font-medium">Other Charges</span>
                <FormulaTooltip formula="Additional fees and charges" />
              </div>
              <span className="font-bold text-gray-900 text-lg">
                {formatCurrency(otherCharges)}
              </span>
            </div>
          )}

          {/* Admin Discount */}
          {discountAmount > 0 && (
            <div className="flex justify-between items-center p-4 bg-red-50 rounded-lg border border-red-200">
              <div className="flex items-center gap-2">
                <span className="text-red-700 font-medium">Admin Discount</span>
                <FormulaTooltip formula="Discount applied by admin (reduces final total)" />
              </div>
              <span className="font-bold text-red-700 text-lg">
                -{formatCurrency(discountAmount)}
              </span>
            </div>
          )}

          {/* Total Customer Price */}
          <div className="flex justify-between items-center p-5 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg border-2 border-green-800 shadow-md mt-4">
            <div className="flex items-center gap-2">
              <span className="font-bold text-lg">Total Customer Price</span>
              <FormulaTooltip
                formula="Item Cost + Delivery + GST - Discount + Other Charges"
                className="text-white"
              />
            </div>
            <span className="font-bold text-2xl">{formatCurrency(customerGrandTotal)}</span>
          </div>
        </div>
      </div>

      {/* ============================================ */}
      {/* PROFIT ANALYSIS SECTION - Permission Protected */}
      {/* ============================================ */}
      <ProfitMarginGate
        fallback={
          <div className="bg-gray-50 border-2 border-gray-200 rounded-xl p-6 shadow-sm">
            <div className="flex items-center gap-3 text-gray-500">
              <div className="p-3 bg-gray-200 rounded-lg">
                <Lock size={24} />
              </div>
              <div>
                <h4 className="text-lg font-bold text-gray-600">Profit Analysis</h4>
                <p className="text-sm text-gray-500">
                  You don't have permission to view profit analysis
                </p>
              </div>
            </div>
          </div>
        }
      >
        <div className="bg-white border-2 border-purple-200 rounded-xl p-6 shadow-sm">
          <div className="flex items-center gap-3 mb-6">
            <div className="p-3 bg-gradient-to-br from-purple-600 to-pink-600 rounded-lg shadow-sm">
              <TrendingUp className="text-white" size={24} />
            </div>
            <div>
              <h4 className="text-xl font-bold text-purple-900">Profit Analysis</h4>
              <p className="text-sm text-purple-600">Revenue and margins</p>
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Profit Amount */}
            <div className="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-6 border-2 border-purple-200">
              <div className="flex items-center gap-2 mb-3">
                <span className="text-sm font-medium text-purple-700">Profit Amount</span>
                <FormulaTooltip formula="Total Customer - Total Supplier - GST" />
              </div>
              <div
                className={`text-4xl font-bold mb-2 ${
                  profitAmount >= 0 ? 'text-green-600' : 'text-red-600'
                }`}
              >
                {formatCurrency(profitAmount)}
              </div>
              <p className="text-xs text-gray-600">
                Customer price minus supplier cost and GST
              </p>
            </div>

            {/* Profit Margin */}
            <div className="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-6 border-2 border-purple-200">
              <div className="flex items-center gap-2 mb-3">
                <span className="text-sm font-medium text-purple-700">Profit Margin</span>
                <FormulaTooltip formula="(Profit Amount / Supplier Total) × 100%" />
              </div>
              <div
                className={`text-4xl font-bold mb-2 ${
                  profitMarginPercent >= 0 ? 'text-green-600' : 'text-red-600'
                }`}
              >
                {profitMarginPercent.toFixed(2)}%
              </div>
              <p className="text-xs text-gray-600">
                Profit as percentage of supplier cost
              </p>
            </div>
          </div>

          {/* Additional Info */}
          <div className="mt-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
            <p className="text-sm text-purple-900 font-medium mb-2">
              💡 Profit Calculation Notes:
            </p>
            <ul className="text-xs text-gray-700 space-y-1">
              <li>• Quoted prices override standard margin calculations for individual items</li>
              <li>• Admin discount reduces profit margin dollar-for-dollar</li>
              <li>• GST is excluded from profit calculation (passed through to government)</li>
              <li>• Supplier discounts increase profit margin</li>
            </ul>
          </div>
        </div>
      </ProfitMarginGate>
    </div>
  );
};

export default OrderCostingTab;
/* FILE: src/components/admin/Orders/OrderFiltersPanel.tsx */
// FILE PATH: src/components/admin/Orders/OrderFiltersPanel.tsx

/**
 * Order Filters Panel Component
 * Slide-in panel from right side with overlay
 */

import React from 'react';
import { X, Filter, RotateCcw } from 'lucide-react';
import type { AdminOrderFilters } from '../../../types/adminOrder.types';

interface FiltersPanelProps {
  isOpen: boolean;
  onClose: () => void;
  filters: {
    search: string;
    client_id: string;
    project_id: string;
    supplier_id: string;
    workflow: string;
    payment_status: string;
    delivery_method: string;
    delivery_date_from: string;
    delivery_date_to: string;
    repeat_order: string;
    has_missing_supplier: string;
    supplier_confirms: string;
    min_total: string;
    max_total: string;
    sort: string;
    dir: string;
  };
  onFilterChange: (key: string, value: string) => void;
  onClearFilters: () => void;
  availableFilters: AdminOrderFilters | null;
}

const OrderFiltersPanel: React.FC<FiltersPanelProps> = ({
  isOpen,
  onClose,
  filters,
  onFilterChange,
  onClearFilters,
  availableFilters,
}) => {
  const hasActiveFilters = Object.entries(filters).some(
    ([key, value]) => value !== '' && key !== 'sort' && key !== 'dir' && key !== 'page' && key !== 'search'
  );

  return (
    <>
      {/* Overlay */}
      {isOpen && (
        <div
          className="fixed inset-0 bg-black bg-opacity-50 z-40 transition-opacity duration-300"
          onClick={onClose}
        />
      )}

      {/* Sliding Panel */}
      <div
        className={`
          fixed top-0 right-0 h-full w-full sm:w-[480px] bg-white shadow-2xl z-50
          transform transition-transform duration-300 ease-in-out
          ${isOpen ? 'translate-x-0' : 'translate-x-full'}
          flex flex-col
        `}
      >
        {/* Header */}
        <div className="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-white rounded-lg shadow-sm">
              <Filter className="text-blue-600" size={20} />
            </div>
            <div>
              <h3 className="text-lg font-bold text-gray-900">Filters</h3>
              <p className="text-xs text-gray-600">Refine your search</p>
            </div>
          </div>
          <button
            onClick={onClose}
            className="p-2 hover:bg-white rounded-lg transition-colors"
          >
            <X size={24} className="text-gray-600" />
          </button>
        </div>

        {/* Filters Content - Scrollable */}
        <div className="flex-1 overflow-y-auto px-6 py-4">
          <div className="space-y-4">
            {/* Client */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Client
              </label>
              <select
                value={filters.client_id}
                onChange={(e) => onFilterChange('client_id', e.target.value)}
                className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
              >
                <option value="">All Clients</option>
                {availableFilters?.clients?.map((client) => (
                  <option key={client.id} value={client.id}>
                    {client.name}
                  </option>
                ))}
              </select>
            </div>

            {/* Project */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Project
              </label>
              <select
                value={filters.project_id}
                onChange={(e) => onFilterChange('project_id', e.target.value)}
                className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
              >
                <option value="">All Projects</option>
                {availableFilters?.projects?.map((project) => (
                  <option key={project.id} value={project.id}>
                    {project.name}
                  </option>
                ))}
              </select>
            </div>

            {/* Supplier */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Supplier
              </label>
              <select
                value={filters.supplier_id}
                onChange={(e) => onFilterChange('supplier_id', e.target.value)}
                className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
              >
                <option value="">All Suppliers</option>
                {availableFilters?.suppliers?.map((supplier) => (
                  <option key={supplier.id} value={supplier.id}>
                    {supplier.name}
                  </option>
                ))}
              </select>
            </div>

            {/* Workflow */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Workflow Status
              </label>
              <select
                value={filters.workflow}
                onChange={(e) => onFilterChange('workflow', e.target.value)}
                className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
              >
                <option value="">All Workflows</option>
                {availableFilters?.workflows?.map((status) => (
                  <option key={status} value={status}>
                    {status}
                  </option>
                ))}
              </select>
            </div>

            {/* Payment Status */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Payment Status
              </label>
              <select
                value={filters.payment_status}
                onChange={(e) => onFilterChange('payment_status', e.target.value)}
                className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
              >
                <option value="">All Statuses</option>
                {availableFilters?.payment_statuses?.map((status) => (
                  <option key={status} value={status}>
                    {status}
                  </option>
                ))}
              </select>
            </div>

            {/* Delivery Method */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Delivery Method
              </label>
              <select
                value={filters.delivery_method}
                onChange={(e) => onFilterChange('delivery_method', e.target.value)}
                className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
              >
                <option value="">All Methods</option>
                {availableFilters?.delivery_methods?.map((method) => (
                  <option key={method} value={method}>
                    {method}
                  </option>
                ))}
              </select>
            </div>

            {/* Date Range */}
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  From Date
                </label>
                <input
                  type="date"
                  value={filters.delivery_date_from}
                  onChange={(e) => onFilterChange('delivery_date_from', e.target.value)}
                  className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  To Date
                </label>
                <input
                  type="date"
                  value={filters.delivery_date_to}
                  onChange={(e) => onFilterChange('delivery_date_to', e.target.value)}
                  className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
            </div>

            {/* Price Range */}
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Min Total ($)
                </label>
                <input
                  type="number"
                  value={filters.min_total}
                  onChange={(e) => onFilterChange('min_total', e.target.value)}
                  placeholder="0"
                  className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Max Total ($)
                </label>
                <input
                  type="number"
                  value={filters.max_total}
                  onChange={(e) => onFilterChange('max_total', e.target.value)}
                  placeholder="999999"
                  className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
            </div>

            {/* Additional Filters */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Repeat Order
              </label>
              <select
                value={filters.repeat_order}
                onChange={(e) => onFilterChange('repeat_order', e.target.value)}
                className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
              >
                <option value="">All</option>
                <option value="true">Yes</option>
                <option value="false">No</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Missing Supplier
              </label>
              <select
                value={filters.has_missing_supplier}
                onChange={(e) => onFilterChange('has_missing_supplier', e.target.value)}
                className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
              >
                <option value="">All</option>
                <option value="true">Yes</option>
                <option value="false">No</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Supplier Confirmation
              </label>
              <select
                value={filters.supplier_confirms}
                onChange={(e) => onFilterChange('supplier_confirms', e.target.value)}
                className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
              >
                <option value="">All</option>
                <option value="1">Confirmed</option>
                <option value="0">Pending</option>
              </select>
            </div>

            {/* Sort Options */}
            <div className="pt-4 border-t border-gray-200">
              <h4 className="text-sm font-semibold text-gray-700 mb-3">Sort Options</h4>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-2">
                    Sort By
                  </label>
                  <select
                    value={filters.sort}
                    onChange={(e) => onFilterChange('sort', e.target.value)}
                    className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
                  >
                    <option value="created_at">Created Date</option>
                    <option value="delivery_date">Delivery Date</option>
                    <option value="po_number">PO Number</option>
                    <option value="total_price">Total Price</option>
                    <option value="profit_amount">Profit Amount</option>
                    <option value="profit_margin_percent">Profit Margin %</option>
                    <option value="items_count">Items Count</option>
                  </select>
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-2">
                    Direction
                  </label>
                  <select
                    value={filters.dir}
                    onChange={(e) => onFilterChange('dir', e.target.value)}
                    className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
                  >
                    <option value="desc">Newest First</option>
                    <option value="asc">Oldest First</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Footer */}
        <div className="px-6 py-4 border-t border-gray-200 bg-gray-50">
          <div className="flex gap-3">
            <button
              onClick={onClearFilters}
              disabled={!hasActiveFilters}
              className="flex-1 flex items-center justify-center gap-2 px-4 py-2.5 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed font-medium"
            >
              <RotateCcw size={18} />
              Clear All
            </button>
            <button
              onClick={onClose}
              className="flex-1 px-4 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all shadow-md hover:shadow-lg font-medium"
            >
              Apply Filters
            </button>
          </div>
        </div>
      </div>
    </>
  );
};

export default OrderFiltersPanel;
/* FILE: src/components/admin/Orders/OrderItemsSection.tsx */
// FILE PATH: src/components/admin/Orders/OrderItemsSection.tsx

/**
 * Order Items Section Component - FIXED v2
 * Displays items with workflow-specific logic
 * ✅ Handles both supplier_id field AND supplier object
 */

import React from 'react';
import { Package, CheckCircle, Clock, AlertCircle } from 'lucide-react';
import toast from 'react-hot-toast';
import type { AdminOrderItem, WorkflowStatus } from '../../../types/adminOrder.types';
import { formatCurrency } from '../../../features/adminOrders/utils';

interface OrderItemsSectionProps {
  items: AdminOrderItem[];
  workflow: WorkflowStatus;
}

const OrderItemsSection: React.FC<OrderItemsSectionProps> = ({ items, workflow }) => {
  const handleSupplierSelect = (itemId: number, supplierId: number, supplierName: string) => {
    console.log(itemId, supplierId, supplierName)
    toast('Functionality coming soon', {
      icon: '🚧',
      duration: 2000,
    });
  };

  const renderSupplierMissingItem = (item: AdminOrderItem) => (
    <div key={item.id} className="border border-yellow-200 bg-yellow-50 rounded-lg p-4">
      <div className="flex items-start justify-between mb-3">
        <div className="flex-1">
          <div className="flex items-center gap-2 mb-1">
            <Package size={18} className="text-gray-600" />
            <h4 className="font-semibold text-gray-900">{item.product_name}</h4>
          </div>
          <p className="text-sm text-gray-600">Quantity: {item.quantity}</p>
        </div>
        <span className="px-2 py-1 bg-yellow-200 text-yellow-800 text-xs font-semibold rounded-full">
          Missing Supplier
        </span>
      </div>

      {/* Supplier Dropdown */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">
          Select Supplier
        </label>
        <select
          onChange={(e) => {
            const selected = item.eligible_suppliers?.find(
              (s) => s.supplier_id === parseInt(e.target.value)
            );
            if (selected) {
              handleSupplierSelect(item.id, selected.supplier_id, selected.name);
            }
          }}
          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          defaultValue=""
        >
          <option value="" disabled>
            Choose a supplier...
          </option>
          {item.eligible_suppliers?.map((supplier) => (
            <option key={supplier.supplier_id} value={supplier.supplier_id}>
              {supplier.name}
              {supplier.distance !== null && ` - ${supplier.distance.toFixed(1)} km`}
            </option>
          ))}
        </select>
        {item.eligible_suppliers && item.eligible_suppliers.length === 0 && (
          <p className="text-sm text-red-600 mt-2 flex items-center gap-1">
            <AlertCircle size={14} />
            No eligible suppliers found for this product
          </p>
        )}
      </div>
    </div>
  );

  const renderSupplierAssignedItem = (item: AdminOrderItem) => (
    <div
      key={item.id}
      className={`border rounded-lg p-4 ${
        item.supplier_confirms === 1
          ? 'border-green-200 bg-green-50'
          : 'border-gray-200 bg-white'
      }`}
    >
      <div className="flex items-start justify-between mb-3">
        <div className="flex-1">
          <div className="flex items-center gap-2 mb-1">
            <Package size={18} className="text-gray-600" />
            <h4 className="font-semibold text-gray-900">{item.product_name}</h4>
          </div>
          <p className="text-sm text-gray-600">Quantity: {item.quantity}</p>
        </div>
        <span
          className={`px-2 py-1 text-xs font-semibold rounded-full flex items-center gap-1 ${
            item.supplier_confirms === 1
              ? 'bg-green-100 text-green-800'
              : 'bg-yellow-100 text-yellow-800'
          }`}
        >
          {item.supplier_confirms === 1 ? (
            <>
              <CheckCircle size={14} />
              Confirmed
            </>
          ) : (
            <>
              <Clock size={14} />
              Pending Confirmation
            </>
          )}
        </span>
      </div>

      {/* Supplier Info */}
      <div className="bg-white rounded-lg p-3 border border-gray-200">
        <div className="flex items-center gap-3">
          {item.supplier?.profile_image ? (
            <img
              src={`${import.meta.env.VITE_IMAGE_BASE_URL}${item.supplier.profile_image}`}
              alt={item.supplier.name}
              className="w-10 h-10 rounded-full object-cover"
            />
          ) : (
            <div className="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
              <span className="text-blue-600 font-semibold text-sm">
                {item.supplier?.name?.charAt(0) || 'S'}
              </span>
            </div>
          )}
          <div>
            <p className="font-medium text-gray-900">{item.supplier?.name}</p>
            <p className="text-xs text-gray-500">Assigned Supplier</p>
          </div>
        </div>

        {/* Initial Pricing (if available) */}
        {item.supplier_unit_cost && (
          <div className="mt-3 pt-3 border-t border-gray-200 text-sm space-y-1">
            <div className="flex justify-between">
              <span className="text-gray-600">Unit Cost:</span>
              <span className="font-medium">{formatCurrency(item.supplier_unit_cost)}</span>
            </div>
            {item.supplier_delivery_cost && item.supplier_delivery_cost > 0 && (
              <div className="flex justify-between">
                <span className="text-gray-600">Delivery Cost:</span>
                <span className="font-medium">
                  {formatCurrency(item.supplier_delivery_cost)}
                </span>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );

  const renderPricedItem = (item: AdminOrderItem) => (
    <div key={item.id} className="border border-gray-200 bg-white rounded-lg p-4">
      <div className="flex items-start justify-between mb-3">
        <div className="flex-1">
          <div className="flex items-center gap-2 mb-1">
            <Package size={18} className="text-gray-600" />
            <h4 className="font-semibold text-gray-900">{item.product_name}</h4>
          </div>
          <p className="text-sm text-gray-600">Quantity: {item.quantity}</p>
        </div>
      </div>

      {/* Supplier Info */}
      <div className="bg-gray-50 rounded-lg p-3 mb-3">
        <div className="flex items-center gap-3 mb-3">
          {item.supplier?.profile_image ? (
            <img
              src={item.supplier.profile_image}
              alt={item.supplier.name}
              className="w-10 h-10 rounded-full object-cover"
            />
          ) : (
            <div className="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
              <span className="text-blue-600 font-semibold text-sm">
                {item.supplier?.name?.charAt(0) || 'S'}
              </span>
            </div>
          )}
          <div>
            <p className="font-medium text-gray-900">{item.supplier?.name}</p>
            <p className="text-xs text-gray-500">Supplier</p>
          </div>
        </div>

        {/* Detailed Pricing */}
        <div className="space-y-2 text-sm">
          <div className="flex justify-between">
            <span className="text-gray-600">Unit Cost:</span>
            <span className="font-medium">{formatCurrency(item.supplier_unit_cost || 0)}</span>
          </div>
          <div className="flex justify-between">
            <span className="text-gray-600">Quantity:</span>
            <span className="font-medium">×{item.quantity}</span>
          </div>
          <div className="flex justify-between">
            <span className="text-gray-600">Subtotal:</span>
            <span className="font-medium">
              {formatCurrency((item.supplier_unit_cost || 0) * item.quantity)}
            </span>
          </div>
          {item.supplier_delivery_cost && item.supplier_delivery_cost > 0 && (
            <div className="flex justify-between">
              <span className="text-gray-600">Delivery Cost:</span>
              <span className="font-medium">{formatCurrency(item.supplier_delivery_cost)}</span>
            </div>
          )}
          {item.supplier_discount && item.supplier_discount > 0 && (
            <div className="flex justify-between text-green-600">
              <span>Discount:</span>
              <span className="font-medium">-{formatCurrency(item.supplier_discount)}</span>
            </div>
          )}
        </div>
      </div>
    </div>
  );

  return (
    <div className="bg-white rounded-lg border border-gray-200 p-6">
      <h2 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
        <Package size={24} />
        Order Items ({items.length})
      </h2>

      <div className="space-y-4">
        {items.map((item) => {
          // ✅ FIX v2: Check BOTH supplier_id AND supplier object
          // Backend returns different structures:
          // - With supplier: { supplier: {...} } (no supplier_id field)
          // - Without supplier: { supplier_id: null, eligible_suppliers: [...] }
          const hasSupplier = item.supplier_id || item.supplier;
          
          if (!hasSupplier) {
            // Item has no supplier assigned yet
            return renderSupplierMissingItem(item);
          } else if (workflow === 'Payment Requested' || workflow === 'Delivered') {
            // Order has progressed to payment/delivery
            return renderPricedItem(item);
          } else {
            // Item has supplier assigned
            return renderSupplierAssignedItem(item);
          }
        })}
      </div>
    </div>
  );
};

export default OrderItemsSection;
/* FILE: src/components/admin/Orders/OrderItemsTab.tsx */
// FILE PATH: src/components/admin/Orders/OrderItemsTab.tsx

/**
 * Order Items Tab Component - WITH PERMISSION-BASED VISIBILITY
 * Displays items with supplier assignment, quoted price, payment status
 * HIDES cost columns based on user permissions
 * HIDES edit actions for read-only users (Accountant)
 */

import React, { useState } from 'react';
import {
  Package,
  CheckCircle,
  Clock,
  AlertCircle,
  DollarSign,
  Edit3,
  X,
  Check,
  CreditCard,
  User,
  Edit,
  Lock,
  Eye,
} from 'lucide-react';
import type { AdminOrderItem, WorkflowStatus } from '../../../types/adminOrder.types';
import { formatCurrency } from '../../../features/adminOrders/utils';
import {
  useAssignSupplier,
  useSetQuotedPrice,
  useMarkItemAsPaid,
} from '../../../features/adminOrders/hooks';
import AdminOrderItemEditModal from './AdminOrderItemEditModal';
import { usePermissions } from '../../../hooks/usePermissions';
import PermissionGate from '../../common/PermissionGate';

interface OrderItemsTabProps {
  items: AdminOrderItem[];
  workflow: WorkflowStatus;
  orderId: number;
}

const OrderItemsTab: React.FC<OrderItemsTabProps> = ({ items, workflow, orderId }) => {
  const [editingQuotedPrice, setEditingQuotedPrice] = useState<number | null>(null);
  const [quotedPriceValue, setQuotedPriceValue] = useState<string>('');
  const [editingItem, setEditingItem] = useState<AdminOrderItem | null>(null);
  const [isEditModalOpen, setIsEditModalOpen] = useState(false);

  // Get permissions
  const {
    canViewCostPrice,

    canEnterQuotedRates,
    canEditOrders,
    canAssignSupplier,
  
    isReadOnly,

  } = usePermissions();

  const assignSupplierMutation = useAssignSupplier();
  const setQuotedPriceMutation = useSetQuotedPrice();
  const markAsPaidMutation = useMarkItemAsPaid();

  // Check if admin can edit item pricing
  const canEditItemPricing = (item: AdminOrderItem) => {
    // If user is read-only, they can't edit anything
    if (isReadOnly) return false;
    // Check if user has edit permission
    if (!canEditOrders) return false;

    const hasSupplier = item.supplier_id || item.supplier;
    const allowedWorkflows: WorkflowStatus[] = ['Supplier Assigned', 'Payment Requested'];
    return hasSupplier && allowedWorkflows.includes(workflow);
  };

  // Handle admin edit
  const handleOpenEditModal = (item: AdminOrderItem) => {
    if (isReadOnly) return;
    setEditingItem(item);
    setIsEditModalOpen(true);
  };

  const handleCloseEditModal = () => {
    setEditingItem(null);
    setIsEditModalOpen(false);
  };

  // Handle supplier selection
  const handleSupplierSelect = (itemId: number, supplierId: number, offerId: number) => {
    if (isReadOnly || !canAssignSupplier) return;
    assignSupplierMutation.mutate({
      order_id: orderId,
      item_id: itemId,
      supplier: supplierId,
      offer_id: offerId,
    });
  };

  // Handle quoted price editing
  const handleStartEditQuotedPrice = (item: AdminOrderItem) => {
    if (isReadOnly || !canEnterQuotedRates) return;
    setEditingQuotedPrice(item.id);
    setQuotedPriceValue(item.quoted_price?.toString() || '');
  };

  const handleSaveQuotedPrice = (itemId: number) => {
    if (isReadOnly) return;
    const price = quotedPriceValue === '' ? null : parseFloat(quotedPriceValue);
    if (price !== null && (isNaN(price) || price < 0)) {
      return;
    }
    setQuotedPriceMutation.mutate(
      { orderId, itemId, quotedPrice: price },
      {
        onSuccess: () => {
          setEditingQuotedPrice(null);
          setQuotedPriceValue('');
        },
      }
    );
  };

  const handleCancelEditQuotedPrice = () => {
    setEditingQuotedPrice(null);
    setQuotedPriceValue('');
  };

  // Handle payment status toggle
  const handleTogglePaidStatus = (itemId: number, currentStatus: number) => {
    if (isReadOnly) return;
    markAsPaidMutation.mutate({
      orderId,
      itemId,
      isPaid: currentStatus === 0,
    });
  };

  // Render item for "Supplier Missing" workflow
  const renderSupplierMissingItem = (item: AdminOrderItem) => (
    <div
      key={item.id}
      className="bg-white border-2 border-yellow-300 rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow"
    >
      {/* Header */}
      <div className="flex items-start justify-between mb-4">
        <div className="flex-1">
          <div className="flex items-center gap-2 mb-2">
            <Package size={20} className="text-yellow-600" />
            <h4 className="font-bold text-gray-900 text-lg">{item.product_name}</h4>
          </div>
          <div className="flex items-center gap-4 text-sm text-gray-600">
            <span className="font-medium">
              Quantity: <span className="text-gray-900 font-bold">{item.quantity}</span>
            </span>
          </div>
        </div>
        <span className="px-3 py-1.5 bg-yellow-100 text-yellow-800 text-xs font-bold rounded-full border-2 border-yellow-300 flex items-center gap-1.5">
          <AlertCircle size={14} />
          Missing Supplier
        </span>
      </div>

      {/* Supplier Selection - Only if can assign supplier */}
      <PermissionGate
        permission="orders.assign_supplier"
        fallback={
          <div className="bg-gray-50 rounded-lg p-4 border-2 border-gray-200">
            <div className="flex items-center gap-2 text-gray-500">
              <Lock size={16} />
              <span className="text-sm">Supplier assignment requires additional permissions</span>
            </div>
          </div>
        }
      >
        <div className="bg-yellow-50 rounded-lg p-4 border-2 border-yellow-200">
          <label className="block text-sm font-bold text-gray-900 mb-3 flex items-center gap-2">
            <User size={16} className="text-yellow-600" />
            Assign Supplier
          </label>
          <select
            onChange={(e) => {
              const selected = item.eligible_suppliers?.find(
                (s) => s.supplier_id === parseInt(e.target.value)
              );
              if (selected) {
                handleSupplierSelect(item.id, selected.supplier_id, selected.offer_id);
              }
            }}
            disabled={assignSupplierMutation.isPending || isReadOnly}
            className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed bg-white"
          >
            <option value="">Select a supplier...</option>
            {item.eligible_suppliers?.map((supplier) => (
              <option key={supplier.supplier_id} value={supplier.supplier_id}>
                {supplier.name}
                {/* Only show cost if user can view cost price */}
                {canViewCostPrice && ` - ${formatCurrency(supplier.unit_cost as number)}`}
              </option>
            ))}
          </select>
          {!item.eligible_suppliers?.length && (
            <p className="text-yellow-700 text-sm mt-2 flex items-center gap-1.5">
              <AlertCircle size={14} />
              No eligible suppliers found for this product
            </p>
          )}
        </div>
      </PermissionGate>
    </div>
  );

  // Render item with supplier assigned (not yet confirmed or paid)
  const renderSupplierAssignedItem = (item: AdminOrderItem) => (
    <div
      key={item.id}
      className="bg-white border-2 border-indigo-200 rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow"
    >
      {/* Header with Admin Edit Button */}
      <div className="flex items-start justify-between mb-4">
        <div className="flex-1">
          <div className="flex items-center gap-2 mb-2">
            <Package size={20} className="text-indigo-600" />
            <h4 className="font-bold text-gray-900 text-lg">{item.product_name}</h4>
          </div>
          <div className="flex items-center gap-4 text-sm text-gray-600">
            <span className="font-medium">
              Quantity: <span className="text-gray-900 font-bold">{item.quantity}</span>
            </span>
            <span className="font-medium">
              Supplier: <span className="text-indigo-700 font-bold">{item.supplier?.name || 'Unknown'}</span>
            </span>
          </div>
        </div>
        <div className="flex items-center gap-2">
          {item.supplier_confirms ? (
            <span className="px-3 py-1.5 bg-green-100 text-green-800 text-xs font-bold rounded-full border-2 border-green-300 flex items-center gap-1.5">
              <CheckCircle size={14} />
              Confirmed
            </span>
          ) : (
            <span className="px-3 py-1.5 bg-blue-100 text-blue-800 text-xs font-bold rounded-full border-2 border-blue-300 flex items-center gap-1.5">
              <Clock size={14} />
              Pending Confirmation
            </span>
          )}
          
          {/* Read-Only Badge */}
          {isReadOnly && (
            <span className="px-3 py-1.5 bg-yellow-100 text-yellow-800 text-xs font-bold rounded-full border-2 border-yellow-300 flex items-center gap-1.5">
              <Eye size={14} />
              View Only
            </span>
          )}
          
          {/* Admin Edit Button - Only if can edit */}
          {canEditItemPricing(item) && !isReadOnly && (
            <button
              onClick={() => handleOpenEditModal(item)}
              className="px-3 py-1.5 bg-gradient-to-r from-orange-500 to-amber-500 text-white text-xs font-bold rounded-full hover:from-orange-600 hover:to-amber-600 transition-all shadow-md hover:shadow-lg flex items-center gap-1.5"
              title="Admin Override - Edit Item Pricing"
            >
              <Edit size={14} />
              Admin Edit
            </button>
          )}
        </div>
      </div>

      {/* Pricing Details - Only show if user can view cost price */}
      <PermissionGate
        permission="pricing.view_cost_price"
        fallback={
          <div className="bg-gray-50 rounded-lg p-4 border-2 border-gray-200">
            <div className="flex items-center gap-2 text-gray-500">
              <Lock size={16} />
              <span className="text-sm font-medium">Pricing details hidden</span>
            </div>
          </div>
        }
      >
        <div className="bg-gray-50 rounded-lg p-4 border-2 border-gray-200 space-y-2">
          <div className="flex justify-between text-sm">
            <span className="text-gray-600">Unit Cost:</span>
            <span className="font-bold text-gray-900">
              {formatCurrency(item.supplier_unit_cost as number)}
            </span>
          </div>
          {item.supplier_discount && item.supplier_discount > 0 && (
            <div className="flex justify-between text-sm text-green-600">
              <span>Discount:</span>
              <span className="font-medium">-{formatCurrency(item.supplier_discount)}</span>
            </div>
          )}
          {item.delivery_type && (
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">Delivery Type:</span>
              <span className="font-medium text-gray-900">{item.delivery_type}</span>
            </div>
          )}
          {item.delivery_cost && item.delivery_cost > 0 && (
            <div className="flex justify-between text-sm text-blue-600">
              <span>Delivery Cost:</span>
              <span className="font-medium">+{formatCurrency(item.delivery_cost)}</span>
            </div>
          )}
        </div>
      </PermissionGate>

      {/* Quoted Price Section - Only if can enter quoted rates */}
      <PermissionGate permission="pricing.enter_quoted_rates">
        <div className="mt-4 bg-purple-50 rounded-lg p-4 border-2 border-purple-200">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <DollarSign size={16} className="text-purple-600" />
              <span className="text-sm font-bold text-gray-900">Quoted Price Override</span>
            </div>
            {editingQuotedPrice === item.id ? (
              <div className="flex items-center gap-2">
                <input
                  type="number"
                  value={quotedPriceValue}
                  onChange={(e) => setQuotedPriceValue(e.target.value)}
                  placeholder="0.00"
                  step="0.01"
                  min="0"
                  className="w-32 px-3 py-1.5 text-sm border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                  autoFocus
                />
                <button
                  onClick={() => handleSaveQuotedPrice(item.id)}
                  disabled={setQuotedPriceMutation.isPending}
                  className="p-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50"
                  title="Save"
                >
                  <Check size={16} />
                </button>
                <button
                  onClick={handleCancelEditQuotedPrice}
                  className="p-1.5 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
                  title="Cancel"
                >
                  <X size={16} />
                </button>
              </div>
            ) : (
              <div className="flex items-center gap-2">
                <span className="text-sm font-bold text-purple-700">
                  {item.is_quoted === 1 && item.quoted_price !== null
                    ? formatCurrency(item.quoted_price as number)
                    : 'Not Set'}
                </span>
                {!isReadOnly && (
                  <button
                    onClick={() => handleStartEditQuotedPrice(item)}
                    className="p-1.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                    title="Edit Quoted Price"
                  >
                    <Edit3 size={16} />
                  </button>
                )}
              </div>
            )}
          </div>
        </div>
      </PermissionGate>

      {/* Payment Status Section */}
      <div className="mt-4 bg-blue-50 rounded-lg p-4 border-2 border-blue-200">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <CreditCard size={16} className="text-blue-600" />
            <span className="text-sm font-bold text-gray-900">Payment Status</span>
          </div>
          {isReadOnly ? (
            <span
              className={`px-3 py-1.5 text-xs font-bold rounded-full ${
                item.is_paid === 1
                  ? 'bg-green-100 text-green-800 border-2 border-green-300'
                  : 'bg-gray-100 text-gray-800 border-2 border-gray-300'
              }`}
            >
              {item.is_paid === 1 ? '✓ Paid' : 'Unpaid'}
            </span>
          ) : (
            <PermissionGate
              permission="payments.mark_paid"
              fallback={
                <span
                  className={`px-3 py-1.5 text-xs font-bold rounded-full ${
                    item.is_paid === 1
                      ? 'bg-green-100 text-green-800 border-2 border-green-300'
                      : 'bg-gray-100 text-gray-800 border-2 border-gray-300'
                  }`}
                >
                  {item.is_paid === 1 ? '✓ Paid' : 'Unpaid'}
                </span>
              }
            >
              <button
                onClick={() => handleTogglePaidStatus(item.id, item.is_paid)}
                disabled={markAsPaidMutation.isPending}
                className={`px-3 py-1.5 text-xs font-bold rounded-full transition-all ${
                  item.is_paid === 1
                    ? 'bg-green-100 text-green-800 border-2 border-green-300 hover:bg-green-200'
                    : 'bg-gray-100 text-gray-800 border-2 border-gray-300 hover:bg-gray-200'
                } disabled:opacity-50 disabled:cursor-not-allowed`}
              >
                {item.is_paid === 1 ? '✓ Paid' : 'Mark as Paid'}
              </button>
            </PermissionGate>
          )}
        </div>
      </div>
    </div>
  );

  // Render item with pricing visible (Payment Requested or Delivered)
  const renderPricedItem = (item: AdminOrderItem) => (
    <div
      key={item.id}
      className="bg-white border-2 border-green-200 rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow"
    >
      {/* Header with Admin Edit Button */}
      <div className="flex items-start justify-between mb-4">
        <div className="flex-1">
          <div className="flex items-center gap-2 mb-2">
            <Package size={20} className="text-green-600" />
            <h4 className="font-bold text-gray-900 text-lg">{item.product_name}</h4>
          </div>
          <div className="flex items-center gap-4 text-sm text-gray-600">
            <span className="font-medium">
              Quantity: <span className="text-gray-900 font-bold">{item.quantity}</span>
            </span>
            <span className="font-medium">
              Supplier: <span className="text-green-700 font-bold">{item.supplier?.name || 'Unknown'}</span>
            </span>
          </div>
        </div>
        <div className="flex items-center gap-2">
          <span className="px-3 py-1.5 bg-green-100 text-green-800 text-xs font-bold rounded-full border-2 border-green-300 flex items-center gap-1.5">
            <CheckCircle size={14} />
            {workflow === 'Delivered' ? 'Delivered' : 'Ready'}
          </span>
          
          {/* Read-Only Badge */}
          {isReadOnly && (
            <span className="px-3 py-1.5 bg-yellow-100 text-yellow-800 text-xs font-bold rounded-full border-2 border-yellow-300 flex items-center gap-1.5">
              <Eye size={14} />
              View Only
            </span>
          )}
          
          {/* Admin Edit Button - only for Payment Requested and if can edit */}
          {workflow === 'Payment Requested' && canEditItemPricing(item) && !isReadOnly && (
            <button
              onClick={() => handleOpenEditModal(item)}
              className="px-3 py-1.5 bg-gradient-to-r from-orange-500 to-amber-500 text-white text-xs font-bold rounded-full hover:from-orange-600 hover:to-amber-600 transition-all shadow-md hover:shadow-lg flex items-center gap-1.5"
              title="Admin Override - Edit Item Pricing"
            >
              <Edit size={14} />
              Admin Edit
            </button>
          )}
        </div>
      </div>

      {/* Full Pricing Breakdown */}
      <div className="space-y-4">
        {/* Supplier Costs - Only show if can view cost price */}
        <PermissionGate
          permission="pricing.view_cost_price"
          fallback={
            <div className="bg-gray-50 rounded-lg p-4 border-2 border-gray-200">
              <div className="flex items-center gap-2 text-gray-500">
                <Lock size={16} />
                <span className="text-sm font-medium">Supplier costs hidden</span>
              </div>
            </div>
          }
        >
          <div className="bg-gray-50 rounded-lg p-4 border-2 border-gray-200">
            <h5 className="text-xs font-bold text-gray-600 uppercase mb-3">Supplier Costs</h5>
            <div className="space-y-2 text-sm">
              <div className="flex justify-between">
                <span className="text-gray-600">Unit Cost × {item.quantity}:</span>
                <span className="font-bold text-gray-900">
                  {formatCurrency((item.supplier_unit_cost || 0) * item.quantity)}
                </span>
              </div>
              {item.supplier_discount && item.supplier_discount > 0 && (
                <div className="flex justify-between text-green-600">
                  <span>Discount:</span>
                  <span className="font-medium">-{formatCurrency(item.supplier_discount)}</span>
                </div>
              )}
              {item.delivery_type && (
                <div className="flex justify-between">
                  <span className="text-gray-600">Delivery ({item.delivery_type}):</span>
                  <span className="font-medium text-gray-900">
                    {item.delivery_cost ? formatCurrency(item.delivery_cost) : 'Included'}
                  </span>
                </div>
              )}
            </div>
          </div>
        </PermissionGate>

        {/* Payment Status */}
        <div className="bg-blue-50 rounded-lg p-4 border-2 border-blue-200">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <CreditCard size={16} className="text-blue-600" />
              <span className="text-sm font-bold text-gray-900">Payment Status</span>
            </div>
            {isReadOnly ? (
              <span
                className={`px-3 py-1.5 text-xs font-bold rounded-full ${
                  item.is_paid === 1
                    ? 'bg-green-100 text-green-800 border-2 border-green-300'
                    : 'bg-gray-100 text-gray-800 border-2 border-gray-300'
                }`}
              >
                {item.is_paid === 1 ? '✓ Paid' : 'Unpaid'}
              </span>
            ) : (
              <PermissionGate
                permission="payments.mark_paid"
                fallback={
                  <span
                    className={`px-3 py-1.5 text-xs font-bold rounded-full ${
                      item.is_paid === 1
                        ? 'bg-green-100 text-green-800 border-2 border-green-300'
                        : 'bg-gray-100 text-gray-800 border-2 border-gray-300'
                    }`}
                  >
                    {item.is_paid === 1 ? '✓ Paid' : 'Unpaid'}
                  </span>
                }
              >
                <button
                  onClick={() => handleTogglePaidStatus(item.id, item.is_paid)}
                  disabled={markAsPaidMutation.isPending}
                  className={`px-3 py-1.5 text-xs font-bold rounded-full transition-all ${
                    item.is_paid === 1
                      ? 'bg-green-100 text-green-800 border-2 border-green-300 hover:bg-green-200'
                      : 'bg-gray-100 text-gray-800 border-2 border-gray-300 hover:bg-gray-200'
                  } disabled:opacity-50 disabled:cursor-not-allowed`}
                >
                  {item.is_paid === 1 ? '✓ Paid' : 'Mark as Paid'}
                </button>
              </PermissionGate>
            )}
          </div>
        </div>
      </div>
    </div>
  );

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl p-6 text-white shadow-lg">
        <div className="flex items-center justify-between">
          <div>
            <h2 className="text-2xl font-bold mb-2">Order Items</h2>
            <p className="text-blue-100">
              {items.length} item{items.length !== 1 ? 's' : ''} in this order
            </p>
          </div>
          <div className="flex items-center gap-3">
            {/* Permission Indicators */}
            {!canViewCostPrice && (
              <span className="px-3 py-1.5 bg-white/20 rounded-lg text-sm font-medium flex items-center gap-2">
                <Lock size={14} />
                Costs Hidden
              </span>
            )}
            {isReadOnly && (
              <span className="px-3 py-1.5 bg-yellow-500/30 rounded-lg text-sm font-medium flex items-center gap-2">
                <Eye size={14} />
                Read Only
              </span>
            )}
            <div className="px-4 py-2 bg-white/20 rounded-lg border-2 border-white/30">
              <span className="text-2xl font-bold">{items.length}</span>
            </div>
          </div>
        </div>
      </div>

      {/* Items List */}
      <div className="space-y-4">
        {items.map((item) => {
          const hasSupplier = item.supplier_id || item.supplier;

          if (!hasSupplier) {
            return renderSupplierMissingItem(item);
          } else if (workflow === 'Payment Requested' || workflow === 'Delivered') {
            return renderPricedItem(item);
          } else {
            return renderSupplierAssignedItem(item);
          }
        })}
      </div>

      {/* Admin Edit Modal - Only render if not read-only */}
      {!isReadOnly && (
        <AdminOrderItemEditModal
          item={editingItem}
          isOpen={isEditModalOpen}
          onClose={handleCloseEditModal}
          onSuccess={() => {
            // Refetch is handled by the mutation hook
          }}
        />
      )}
    </div>
  );
};

export default OrderItemsTab;
/* FILE: src/components/admin/Orders/OrderMapTab.tsx */
// FILE PATH: src/components/admin/Orders/OrderMapTab.tsx

/**
 * Order Map Tab Component (FIXED VERSION)
 * Shows client location and supplier zones on Google Maps
 * 
 * FIX: Added requestAnimationFrame to ensure DOM is ready before map initialization
 */

import React, { useEffect, useRef, useState } from 'react';
import { MapPin, Loader2, AlertCircle } from 'lucide-react';
import type { AdminOrderItem, DeliveryZone } from '../../../types/adminOrder.types';

interface OrderMapTabProps {
  deliveryLat: number | null;
  deliveryLong: number | null;
  items: AdminOrderItem[];
}

declare global {
  interface Window {
    google: any;
  }
}

const OrderMapTab: React.FC<OrderMapTabProps> = ({ deliveryLat, deliveryLong, items }) => {
  const mapRef = useRef<HTMLDivElement>(null);
  const [map, setMap] = useState<google.maps.Map | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const markersRef = useRef<google.maps.Marker[]>([]);
  const circlesRef = useRef<google.maps.Circle[]>([]);

  // Load Google Maps - FIXED VERSION
  useEffect(() => {
    console.log('[OrderMapTab] Initializing map...', { deliveryLat, deliveryLong, itemsCount: items.length });
    
    // ✅ FIX: Use requestAnimationFrame to ensure DOM is ready
    const initWhenReady = () => {
      if (!mapRef.current) {
        console.log('[OrderMapTab] Map container not ready, retrying...');
        requestAnimationFrame(initWhenReady);
        return;
      }
      
      console.log('[OrderMapTab] Map container ready');
      
      if (!window.google || !window.google.maps) {
        console.log('[OrderMapTab] Google Maps API not loaded yet');
        return;
      }

      console.log('[OrderMapTab] Google Maps API available, creating map...');

      try {
        const defaultCenter = { lat: -33.8688, lng: 151.2093 }; // Sydney
        const center = deliveryLat && deliveryLong
          ? { lat: deliveryLat, lng: deliveryLong }
          : defaultCenter;

        const mapInstance = new window.google.maps.Map(mapRef.current, {
          center,
          zoom: deliveryLat && deliveryLong ? 10 : 5,
          mapTypeControl: true,
          streetViewControl: false,
          fullscreenControl: true,
        });

        console.log('[OrderMapTab] Map created successfully');
        setMap(mapInstance);
        setLoading(false);
      } catch (e) {
        console.error('[OrderMapTab] Failed to initialize map:', e);
        setError('Failed to initialize map');
        setLoading(false);
      }
    };

    // Check if Google Maps already loaded
    if (window.google && window.google.maps) {
      console.log('[OrderMapTab] Google Maps already loaded');
      initWhenReady();
      return;
    }

    // Check for existing script
    const existing = document.getElementById('google-maps-script') as HTMLScriptElement | null;
    if (existing) {
      console.log('[OrderMapTab] Script tag exists, waiting for load...');
      existing.addEventListener('load', initWhenReady, { once: true });
      return;
    }

    // Load script
    const apiKey = import.meta.env.VITE_GOOGLE_MAPS_API_KEY;
    console.log('[OrderMapTab] API Key present:', !!apiKey);
    
    if (!apiKey) {
      console.error('[OrderMapTab] Missing Google Maps API key');
      setError('Missing Google Maps API key');
      setLoading(false);
      return;
    }

    console.log('[OrderMapTab] Creating script tag...');
    const script = document.createElement('script');
    script.id = 'google-maps-script';
    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places`;
    script.async = true;
    script.defer = true;
    script.onload = () => {
      console.log('[OrderMapTab] Script loaded successfully');
      initWhenReady();
    };
    script.onerror = () => {
      console.error('[OrderMapTab] Failed to load Google Maps script');
      setError('Failed to load Google Maps');
      setLoading(false);
    };
    document.head.appendChild(script);

    return () => {
      markersRef.current.forEach(m => m.setMap(null));
      circlesRef.current.forEach(c => c.setMap(null));
    };
  }, [deliveryLat, deliveryLong]);

  // Draw markers and zones
  useEffect(() => {
    if (!map || !window.google) {
      console.log('[OrderMapTab] Skipping markers - map not ready');
      return;
    }

    console.log('[OrderMapTab] Drawing markers and zones...', { 
      hasDeliveryCoords: !!(deliveryLat && deliveryLong),
      itemsCount: items.length 
    });

    // Clear old markers and circles
    markersRef.current.forEach(m => m.setMap(null));
    circlesRef.current.forEach(c => c.setMap(null));
    markersRef.current = [];
    circlesRef.current = [];

    const bounds = new window.google.maps.LatLngBounds();
    let hasMarkers = false;

    // Add client marker (green)
    if (deliveryLat && deliveryLong) {
      console.log('[OrderMapTab] Adding client marker at:', { deliveryLat, deliveryLong });
      const clientPos = { lat: deliveryLat, lng: deliveryLong };

      const clientMarker = new window.google.maps.Marker({
        position: clientPos,
        map,
        title: 'Delivery Location',
        icon: {
          path: window.google.maps.SymbolPath.CIRCLE,
          scale: 14,
          fillColor: '#10B981',
          fillOpacity: 1,
          strokeColor: '#fff',
          strokeWeight: 3,
        },
        label: {
          text: 'C',
          color: '#fff',
          fontWeight: 'bold',
        },
      });

      markersRef.current.push(clientMarker);
      bounds.extend(clientPos);
      hasMarkers = true;
    }

    // Add supplier markers and zones
    items.forEach((item, idx) => {
      const supplier = item.supplier;
      if (!supplier || !supplier.delivery_zones) {
        console.log(`[OrderMapTab] Item ${idx}: No supplier or zones`);
        return;
      }

      let zones: DeliveryZone[] = [];
      try {
        zones = typeof supplier.delivery_zones === 'string'
          ? JSON.parse(supplier.delivery_zones)
          : supplier.delivery_zones;
        console.log(`[OrderMapTab] Item ${idx}: Found ${zones.length} zones for supplier ${supplier.id}`);
      } catch (e) {
        console.error('[OrderMapTab] Failed to parse zones for supplier:', supplier.id, e);
        return;
      }

      zones.forEach((zone: DeliveryZone, zoneIdx: number) => {
        console.log(`[OrderMapTab] Drawing zone ${zoneIdx} for supplier ${supplier.id}:`, zone);
        const zonePos = { lat: zone.lat, lng: zone.long };

        // Supplier marker (blue if confirmed, yellow if pending)
        const isConfirmed = item.supplier_id !== null;
        const supplierMarker = new window.google.maps.Marker({
          position: zonePos,
          map,
          title: supplier.name || 'Supplier',
          icon: {
            path: window.google.maps.SymbolPath.CIRCLE,
            scale: 12,
            fillColor: isConfirmed ? '#3B82F6' : '#F59E0B',
            fillOpacity: 1,
            strokeColor: '#fff',
            strokeWeight: 2,
          },
          label: {
            text: 'S',
            color: '#fff',
            fontWeight: 'bold',
            fontSize: '12px',
          },
        });

        markersRef.current.push(supplierMarker);

        // Delivery zone circle
        const circle = new window.google.maps.Circle({
          center: zonePos,
          radius: zone.radius * 1000, // Convert km to meters
          map,
          fillColor: isConfirmed ? '#3B82F6' : '#F59E0B',
          fillOpacity: 0.1,
          strokeColor: isConfirmed ? '#3B82F6' : '#F59E0B',
          strokeOpacity: 0.5,
          strokeWeight: 2,
        });

        circlesRef.current.push(circle);
        bounds.extend(zonePos);
        hasMarkers = true;
      });
    });

    // Fit map to show all markers
    if (hasMarkers) {
      console.log('[OrderMapTab] Fitting bounds to show all markers');
      map.fitBounds(bounds);
      
      // Prevent over-zooming when there's only one marker
      const listener = window.google.maps.event.addListener(map, 'idle', () => {
        if (map.getZoom()! > 15) {
          console.log('[OrderMapTab] Limiting zoom to 15');
          map.setZoom(15);
        }
        window.google.maps.event.removeListener(listener);
      });
    } else {
      console.log('[OrderMapTab] No markers to display');
    }
  }, [map, deliveryLat, deliveryLong, items]);

  return (
    <div className="space-y-4">
      {/* Map Container - ALWAYS RENDERED */}
      <div className="relative">
        <div 
          ref={mapRef} 
          className="w-full h-[600px] rounded-lg border border-gray-200 overflow-hidden"
        />

        {/* Loading Overlay */}
        {loading && (
          <div className="absolute inset-0 flex items-center justify-center bg-white/70 z-10">
            <div className="text-center">
              <Loader2 size={40} className="text-primary-600 animate-spin mb-2" />
              <p className="text-gray-600 font-medium">Loading map...</p>
            </div>
          </div>
        )}

        {/* Error Overlay */}
        {error && (
          <div className="absolute inset-0 flex flex-col items-center justify-center bg-white/90 p-6 text-center z-10">
            <AlertCircle size={28} className="text-error-600 mb-2" />
            <p className="text-error-700 font-medium mb-1">Map Loading Error</p>
            <p className="text-sm text-gray-600">{error}</p>
            <p className="text-xs text-gray-500 mt-2">
              Ensure <code className="bg-gray-100 px-1 rounded">VITE_GOOGLE_MAPS_API_KEY</code> is set.
            </p>
          </div>
        )}
      </div>

      {/* Legend */}
      <div className="bg-gray-50 rounded-lg p-4 border border-gray-200">
        <h4 className="text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2">
          <MapPin size={16} />
          Map Legend
        </h4>
        <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm">
          <div className="flex items-center gap-2">
            <div className="w-4 h-4 rounded-full bg-green-500 border-2 border-white" />
            <span className="text-gray-700">Client Location</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-4 h-4 rounded-full bg-blue-500 border-2 border-white" />
            <span className="text-gray-700">Supplier (Confirmed)</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-4 h-4 rounded-full bg-yellow-500 border-2 border-white" />
            <span className="text-gray-700">Supplier (Pending)</span>
          </div>
        </div>
      </div>
    </div>
  );
};

export default OrderMapTab;
/* FILE: src/components/admin/Orders/OrderMetricsCards.tsx */
// FILE PATH: src/components/admin/Orders/OrderMetricsCards.tsx

/**
 * Order Metrics Cards Component
 * Colorful gradient cards with hover effects and animations
 */

import React from 'react';
import { ShoppingCart, AlertTriangle, UserCheck, CreditCard, CheckCircle } from 'lucide-react';
import type { AdminOrderMetrics } from '../../../types/adminOrder.types';

interface MetricsCardsProps {
  metrics: AdminOrderMetrics | null;
  loading: boolean;
}

const OrderMetricsCards: React.FC<MetricsCardsProps> = ({ metrics, loading }) => {
  const cards = [
    {
      label: 'Total Orders',
      value: metrics?.total_orders_count || 0,
      icon: ShoppingCart,
      gradient: 'from-blue-500 to-blue-600',
      lightBg: 'bg-blue-50',
      iconColor: 'text-blue-600',
      shadowColor: 'hover:shadow-blue-200',
    },
    {
      label: 'Supplier Missing',
      value: metrics?.supplier_missing_count || 0,
      icon: AlertTriangle,
      gradient: 'from-yellow-500 to-orange-500',
      lightBg: 'bg-yellow-50',
      iconColor: 'text-yellow-600',
      shadowColor: 'hover:shadow-yellow-200',
    },
    {
      label: 'Supplier Assigned',
      value: metrics?.supplier_assigned_count || 0,
      icon: UserCheck,
      gradient: 'from-indigo-500 to-purple-600',
      lightBg: 'bg-indigo-50',
      iconColor: 'text-indigo-600',
      shadowColor: 'hover:shadow-indigo-200',
    },
    {
      label: 'Awaiting Payment',
      value: metrics?.awaiting_payment_count || 0,
      icon: CreditCard,
      gradient: 'from-purple-500 to-pink-600',
      lightBg: 'bg-purple-50',
      iconColor: 'text-purple-600',
      shadowColor: 'hover:shadow-purple-200',
    },
    {
      label: 'Delivered',
      value: metrics?.delivered_count || 0,
      icon: CheckCircle,
      gradient: 'from-green-500 to-emerald-600',
      lightBg: 'bg-green-50',
      iconColor: 'text-green-600',
      shadowColor: 'hover:shadow-green-200',
    },
  ];

  if (loading) {
    return (
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
        {[...Array(5)].map((_, i) => (
          <div
            key={i}
            className="bg-white rounded-xl border border-gray-200 p-6 animate-pulse"
          >
            <div className="flex items-center justify-between mb-4">
              <div className="w-12 h-12 bg-gray-200 rounded-lg" />
            </div>
            <div className="h-8 w-20 bg-gray-200 rounded mb-2" />
            <div className="h-4 w-24 bg-gray-200 rounded" />
          </div>
        ))}
      </div>
    );
  }

  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
      {cards.map((card, index) => {
        const Icon = card.icon;
        return (
          <div
            key={card.label}
            className={`
              relative overflow-hidden
              bg-white rounded-xl border border-gray-200 
              p-6 
              transition-all duration-300
              hover:shadow-xl ${card.shadowColor}
              hover:-translate-y-1
              group
            `}
            style={{
              animation: loading ? 'none' : `slideInUp 0.4s ease-out ${index * 0.1}s both`,
            }}
          >
            {/* Gradient Background on Hover */}
            <div
              className={`
                absolute inset-0 opacity-0 group-hover:opacity-5
                bg-gradient-to-br ${card.gradient}
                transition-opacity duration-300
              `}
            />

            {/* Content */}
            <div className="relative">
              {/* Icon */}
              <div className="flex items-center justify-between mb-4">
                <div
                  className={`
                    p-3 rounded-xl ${card.lightBg}
                    transform transition-transform duration-300
                    group-hover:scale-110 group-hover:rotate-3
                  `}
                >
                  <Icon className={card.iconColor} size={24} strokeWidth={2.5} />
                </div>
              </div>

              {/* Value */}
              <div>
                <p className="text-3xl font-bold text-gray-900 mb-1 transition-colors group-hover:text-gray-800">
                  {card.value.toLocaleString()}
                </p>
                <p className="text-sm font-medium text-gray-600 group-hover:text-gray-700">
                  {card.label}
                </p>
              </div>

              {/* Bottom Accent Line */}
              <div
                className={`
                  absolute bottom-0 left-0 right-0 h-1 rounded-full
                  bg-gradient-to-r ${card.gradient}
                  transform scale-x-0 group-hover:scale-x-100
                  transition-transform duration-300 origin-left
                `}
              />
            </div>
          </div>
        );
      })}

      {/* Inline animation styles */}
      <style>{`
        @keyframes slideInUp {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
      `}</style>
    </div>
  );
};

export default OrderMetricsCards;
/* FILE: src/components/admin/Orders/OrderOverviewTab.tsx */
// FILE PATH: src/components/admin/Orders/OrderOverviewTab.tsx

/**
 * Order Overview Tab Component
 * Displays basic order information
 */

import React from 'react';
import {
  FileText,
  Calendar,
  MapPin,
  Truck,
  User,
  Briefcase,
  Clock,
  Package,
} from 'lucide-react';
import type { AdminOrderDetail } from '../../../types/adminOrder.types';
import { formatDate } from '../../../features/adminOrders/utils';

interface OrderOverviewTabProps {
  order: AdminOrderDetail;
}

const OrderOverviewTab: React.FC<OrderOverviewTabProps> = ({ order }) => {
  const infoCards = [
    {
      icon: User,
      label: 'Client',
      value: order.client,
      color: 'blue',
    },
    {
      icon: Briefcase,
      label: 'Project',
      value: order.project,
      color: 'purple',
    },
    {
      icon: MapPin,
      label: 'Delivery Address',
      value: order.delivery_address,
      color: 'green',
    },
    {
      icon: Calendar,
      label: 'Delivery Date',
      value: formatDate(order.delivery_date),
      color: 'orange',
    },
    {
      icon: Clock,
      label: 'Delivery Time',
      value: order.delivery_time,
      color: 'pink',
    },
    {
      icon: Truck,
      label: 'Delivery Method',
      value: order.delivery_method || 'Not specified',
      color: 'yellow',
    },
    {
      icon: Package,
      label: 'Total Items',
      value: `${order.items.length} item${order.items.length !== 1 ? 's' : ''}`,
      color: 'indigo',
    },
    {
      icon: FileText,
      label: 'PO Number',
      value: order.po_number,
      color: 'cyan',
    },
  ];

  const colorClasses: Record<string, { bg: string; icon: string; border: string }> = {
    blue: { bg: 'bg-blue-50', icon: 'text-blue-600', border: 'border-blue-200' },
    purple: { bg: 'bg-purple-50', icon: 'text-purple-600', border: 'border-purple-200' },
    green: { bg: 'bg-green-50', icon: 'text-green-600', border: 'border-green-200' },
    orange: { bg: 'bg-orange-50', icon: 'text-orange-600', border: 'border-orange-200' },
    pink: { bg: 'bg-pink-50', icon: 'text-pink-600', border: 'border-pink-200' },
    yellow: { bg: 'bg-yellow-50', icon: 'text-yellow-600', border: 'border-yellow-200' },
    indigo: { bg: 'bg-indigo-50', icon: 'text-indigo-600', border: 'border-indigo-200' },
    cyan: { bg: 'bg-cyan-50', icon: 'text-cyan-600', border: 'border-cyan-200' },
  };

  return (
    <div className="space-y-6">
      {/* Order Information Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {infoCards.map((card) => {
          const Icon = card.icon;
          const colors = colorClasses[card.color];
          return (
            <div
              key={card.label}
              className={`${colors.bg} border-2 ${colors.border} rounded-xl p-5 hover:shadow-md transition-shadow`}
            >
              <div className="flex items-start gap-4">
                <div className={`p-3 ${colors.bg} rounded-lg border ${colors.border}`}>
                  <Icon className={colors.icon} size={24} />
                </div>
                <div className="flex-1 min-w-0">
                  <p className="text-sm font-medium text-gray-600 mb-1">{card.label}</p>
                  <p className="text-lg font-bold text-gray-900 break-words">{card.value}</p>
                </div>
              </div>
            </div>
          );
        })}
      </div>

      {/* Special Notes */}
      {order.special_notes && (
        <div className="bg-gradient-to-br from-amber-50 to-yellow-50 border-2 border-amber-200 rounded-xl p-6">
          <div className="flex items-start gap-3">
            <div className="p-2 bg-amber-100 rounded-lg border border-amber-300">
              <FileText className="text-amber-600" size={20} />
            </div>
            <div className="flex-1">
              <h4 className="text-lg font-bold text-amber-900 mb-2">Special Notes</h4>
              <p className="text-gray-800 leading-relaxed whitespace-pre-wrap">
                {order.special_notes}
              </p>
            </div>
          </div>
        </div>
      )}

      {/* Location Coordinates (if available) */}
      {order.delivery_lat && order.delivery_long && (
        <div className="bg-gray-50 border-2 border-gray-200 rounded-xl p-5">
          <h4 className="text-sm font-bold text-gray-700 mb-3">GPS Coordinates</h4>
          <div className="grid grid-cols-2 gap-4">
            <div className="bg-white p-3 rounded-lg border border-gray-300">
              <div className="text-xs text-gray-600">Latitude</div>
              <div className="text-sm font-mono font-bold text-gray-900">
                {order.delivery_lat.toFixed(6)}
              </div>
            </div>
            <div className="bg-white p-3 rounded-lg border border-gray-300">
              <div className="text-xs text-gray-600">Longitude</div>
              <div className="text-sm font-mono font-bold text-gray-900">
                {order.delivery_long.toFixed(6)}
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default OrderOverviewTab;
/* FILE: src/components/admin/Orders/OrdersTable.tsx */
// FILE PATH: src/components/admin/Orders/OrdersTable.tsx

/**
 * Orders Table Component - WITH PERMISSION-BASED COLUMNS
 * Comprehensive table with pricing information
 * HIDES supplier cost, profit, and margin columns for Support role
 */

import React from 'react';
import { useNavigate } from 'react-router-dom';
import { Eye, ChevronLeft, ChevronRight, TrendingUp, TrendingDown, Lock } from 'lucide-react';
import type { AdminOrder } from '../../../types/adminOrder.types';
import {
  getWorkflowBadgeClass,
  getPaymentBadgeClass,
  formatCurrency,
  formatDate,
} from '../../../features/adminOrders/utils';
import { usePermissions } from '../../../hooks/usePermissions';

interface OrdersTableProps {
  orders: AdminOrder[];
  loading: boolean;
  pagination: {
    per_page: number;
    current_page: number;
    total_pages: number;
    total_items: number;
    has_more_pages: boolean;
  } | null;
  onPageChange: (page: number) => void;
}

const OrdersTable: React.FC<OrdersTableProps> = ({
  orders,
  loading,
  pagination,
  onPageChange,
}) => {
  const navigate = useNavigate();
  
  // Get permissions
  const { canViewCostPrice, canViewProfitMargin } = usePermissions();

  if (loading) {
    return (
      <div className="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
        <div className="p-6 space-y-4">
          {[...Array(5)].map((_, i) => (
            <div key={i} className="h-16 bg-gray-200 rounded animate-pulse" />
          ))}
        </div>
      </div>
    );
  }

  if (!orders.length) {
    return (
      <div className="bg-white rounded-xl border border-gray-200 p-12 text-center shadow-sm">
        <div className="w-20 h-20 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
          <Eye className="text-gray-400" size={40} />
        </div>
        <h3 className="text-lg font-semibold text-gray-900 mb-2">No orders found</h3>
        <p className="text-gray-600">Try adjusting your filters to see more results.</p>
      </div>
    );
  }

  return (
    <div className="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
      {/* Permission Notice Banner */}
      {(!canViewCostPrice || !canViewProfitMargin) && (
        <div className="px-4 py-3 bg-yellow-50 border-b border-yellow-200 flex items-center gap-2">
          <Lock size={16} className="text-yellow-600" />
          <span className="text-sm text-yellow-800">
            Some pricing columns are hidden based on your role permissions
          </span>
        </div>
      )}

      {/* Table */}
      <div className="overflow-x-auto">
        <table className="w-full">
          <thead className="bg-gradient-to-r from-gray-50 to-gray-100 border-b-2 border-gray-200">
            <tr>
              <th className="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider whitespace-nowrap">
                PO Number
              </th>
              <th className="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider whitespace-nowrap">
                Client / Project
              </th>
              <th className="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider whitespace-nowrap">
                Delivery
              </th>
              <th className="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider whitespace-nowrap">
                Status
              </th>
              <th className="px-4 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider whitespace-nowrap">
                Items
              </th>
              
              {/* Supplier Cost Column - Only visible if can view cost price */}
              {canViewCostPrice && (
                <th className="px-4 py-4 text-right text-xs font-bold text-gray-700 uppercase tracking-wider whitespace-nowrap bg-blue-50">
                  Supplier Cost
                </th>
              )}
              
              {/* Customer Price - Always visible */}
              <th className="px-4 py-4 text-right text-xs font-bold text-gray-700 uppercase tracking-wider whitespace-nowrap bg-green-50">
                Customer Price
              </th>
              
              {/* Profit Column - Only visible if can view profit margin */}
              {canViewProfitMargin && (
                <th className="px-4 py-4 text-right text-xs font-bold text-gray-700 uppercase tracking-wider whitespace-nowrap bg-purple-50">
                  Profit
                </th>
              )}
              
              {/* Margin % Column - Only visible if can view profit margin */}
              {canViewProfitMargin && (
                <th className="px-4 py-4 text-right text-xs font-bold text-gray-700 uppercase tracking-wider whitespace-nowrap bg-purple-50">
                  Margin %
                </th>
              )}
              
              <th className="px-4 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider whitespace-nowrap">
                Actions
              </th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200">
            {orders.map((order) => {
              const profitIsPositive = order.profit_amount >= 0;
              const marginColor = profitIsPositive ? 'text-green-600' : 'text-red-600';

              return (
                <tr
                  key={order.id}
                  className="hover:bg-blue-50 transition-colors cursor-pointer group"
                  onClick={() => navigate(`/admin/orders/${order.id}`)}
                >
                  {/* PO Number */}
                  <td className="px-4 py-4">
                    <div className="flex flex-col">
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          navigate(`/admin/orders/${order.id}`);
                        }}
                        className="text-blue-600 hover:text-blue-800 font-bold text-left"
                      >
                        {order.po_number}
                      </button>
                      {order.repeat_order && (
                        <span className="inline-block mt-1 px-2 py-0.5 bg-purple-100 text-purple-700 text-xs font-semibold rounded">
                          Repeat
                        </span>
                      )}
                    </div>
                  </td>

                  {/* Client / Project */}
                  <td className="px-4 py-4">
                    <div className="flex flex-col gap-1">
                      <span className="font-semibold text-gray-900">{order.client}</span>
                      <span className="text-sm text-gray-600">{order.project}</span>
                    </div>
                  </td>

                  {/* Delivery */}
                  <td className="px-4 py-4">
                    <div className="flex flex-col gap-1">
                      <span className="text-sm font-medium text-gray-900">
                        {formatDate(order.delivery_date)}
                      </span>
                      <span className="text-xs text-gray-500">{order.delivery_time}</span>
                      {order.delivery_method && (
                        <span className="text-xs text-blue-600 font-medium">
                          {order.delivery_method}
                        </span>
                      )}
                    </div>
                  </td>

                  {/* Status */}
                  <td className="px-4 py-4">
                    <div className="flex flex-col gap-2">
                      <span
                        className={`inline-flex px-2.5 py-1 text-xs font-bold rounded-full ${getWorkflowBadgeClass(
                          order.workflow
                        )}`}
                      >
                        {order.workflow}
                      </span>
                      <span
                        className={`inline-flex px-2.5 py-1 text-xs font-bold rounded-full ${getPaymentBadgeClass(
                          order.payment_status
                        )}`}
                      >
                        {order.payment_status}
                      </span>
                    </div>
                    {order.order_info && (
                      <div className="text-xs text-gray-500 mt-1 italic">{order.order_info}</div>
                    )}
                  </td>

                  {/* Items */}
                  <td className="px-4 py-4 text-center">
                    <div className="flex flex-col gap-1 items-center">
                      <span className="text-lg font-bold text-gray-900">
                        {order.items_count}
                      </span>
                      <span className="text-xs text-gray-500">
                        {order.suppliers_count} supplier{order.suppliers_count !== 1 ? 's' : ''}
                      </span>
                      {order.unassigned_items_count > 0 && (
                        <span className="inline-block px-2 py-0.5 bg-yellow-100 text-yellow-800 text-xs font-semibold rounded">
                          {order.unassigned_items_count} unassigned
                        </span>
                      )}
                    </div>
                  </td>

                  {/* Supplier Cost - Only visible if can view cost price */}
                  {canViewCostPrice && (
                    <td className="px-4 py-4 text-right bg-blue-50/50">
                      <div className="flex flex-col gap-1">
                        <span className="text-base font-bold text-gray-900">
                          {formatCurrency(order.supplier_total)}
                        </span>
                        <div className="text-xs text-gray-600 space-y-0.5">
                          <div>Items: {formatCurrency(order.supplier_item_cost)}</div>
                          <div>Delivery: {formatCurrency(order.supplier_delivery_cost)}</div>
                        </div>
                      </div>
                    </td>
                  )}

                  {/* Customer Price - Always visible */}
                  <td className="px-4 py-4 text-right bg-green-50/50">
                    <div className="flex flex-col gap-1">
                      <span className="text-base font-bold text-gray-900">
                        {formatCurrency(order.total_price)}
                      </span>
                      <div className="text-xs text-gray-600 space-y-0.5">
                        <div>Items: {formatCurrency(order.customer_item_cost)}</div>
                        <div>Delivery: {formatCurrency(order.customer_delivery_cost)}</div>
                        <div>GST: {formatCurrency(order.gst_tax)}</div>
                        {order.discount > 0 && (
                          <div className="text-red-600">
                            Discount: -{formatCurrency(order.discount)}
                          </div>
                        )}
                      </div>
                    </div>
                  </td>

                  {/* Profit - Only visible if can view profit margin */}
                  {canViewProfitMargin && (
                    <td className="px-4 py-4 text-right bg-purple-50/50">
                      <div className="flex flex-col items-end gap-1">
                        <div className="flex items-center gap-1">
                          {profitIsPositive ? (
                            <TrendingUp size={16} className="text-green-600" />
                          ) : (
                            <TrendingDown size={16} className="text-red-600" />
                          )}
                          <span className={`text-base font-bold ${marginColor}`}>
                            {formatCurrency(order.profit_amount)}
                          </span>
                        </div>
                      </div>
                    </td>
                  )}

                  {/* Margin % - Only visible if can view profit margin */}
                  {canViewProfitMargin && (
                    <td className="px-4 py-4 text-right bg-purple-50/50">
                      <span className={`text-base font-bold ${marginColor}`}>
                        {(order.profit_margin_percent * 100).toFixed(2)}%
                      </span>
                    </td>
                  )}

                  {/* Actions */}
                  <td className="px-4 py-4 text-center">
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        navigate(`/admin/orders/${order.id}`);
                      }}
                      className="inline-flex items-center gap-1.5 px-4 py-2 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors font-medium shadow-sm hover:shadow-md"
                    >
                      <Eye size={16} />
                      View
                    </button>
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>

      {/* Pagination */}
      {pagination && pagination.total_pages > 1 && (
        <div className="px-6 py-4 border-t-2 border-gray-200 flex items-center justify-between bg-gray-50">
          <div className="text-sm text-gray-600 font-medium">
            Showing page {pagination.current_page} of {pagination.total_pages} (
            {pagination.total_items.toLocaleString()} total orders)
          </div>
          <div className="flex items-center gap-2">
            <button
              onClick={() => onPageChange(pagination.current_page - 1)}
              disabled={pagination.current_page === 1}
              className="px-4 py-2 border-2 border-gray-300 rounded-lg text-sm font-bold text-gray-700 hover:bg-white disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1 transition-colors"
            >
              <ChevronLeft size={16} />
              Previous
            </button>

            {/* Page Numbers */}
            <div className="flex items-center gap-1">
              {[...Array(pagination.total_pages)].map((_, i) => {
                const page = i + 1;
                if (
                  page === 1 ||
                  page === pagination.total_pages ||
                  (page >= pagination.current_page - 1 && page <= pagination.current_page + 1)
                ) {
                  return (
                    <button
                      key={page}
                      onClick={() => onPageChange(page)}
                      className={`px-4 py-2 text-sm font-bold rounded-lg transition-colors ${
                        page === pagination.current_page
                          ? 'bg-blue-600 text-white shadow-md'
                          : 'text-gray-700 hover:bg-gray-100 border-2 border-gray-300'
                      }`}
                    >
                      {page}
                    </button>
                  );
                } else if (
                  page === pagination.current_page - 2 ||
                  page === pagination.current_page + 2
                ) {
                  return (
                    <span key={page} className="px-2 text-gray-500 font-bold">
                      ...
                    </span>
                  );
                }
                return null;
              })}
            </div>

            <button
              onClick={() => onPageChange(pagination.current_page + 1)}
              disabled={!pagination.has_more_pages}
              className="px-4 py-2 border-2 border-gray-300 rounded-lg text-sm font-bold text-gray-700 hover:bg-white disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1 transition-colors"
            >
              Next
              <ChevronRight size={16} />
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

export default OrdersTable;
/* FILE: src/components/admin/Orders/OrderUpdateForm.tsx */
// FILE PATH: src/components/admin/Orders/OrderUpdateForm.tsx

/**
 * Order Update Form Component
 * Allows admin to update order details
 */

import React, { useState } from 'react';
import { Save, X } from 'lucide-react';
import type { AdminOrderDetail } from '../../../types/adminOrder.types';
import { useUpdateAdminOrder } from '../../../features/adminOrders/hooks';
import { canEditOrder } from '../../../features/adminOrders/utils';

interface OrderUpdateFormProps {
  order: AdminOrderDetail;
}

const OrderUpdateForm: React.FC<OrderUpdateFormProps> = ({ order }) => {
  const updateMutation = useUpdateAdminOrder();
  const canEdit = canEditOrder(order.workflow);

  // Helper function to format date for input[type="date"]
  const formatDateForInput = (dateString: string): string => {
    if (!dateString) return '';
    // Extract just the date part (yyyy-MM-dd) from ISO string
    return dateString.split('T')[0];
  };

  const [formData, setFormData] = useState({
    project_id: order.filters.projects.find((p) => p.name === order.project)?.id || 0,
    delivery_date: formatDateForInput(order.delivery_date),
    delivery_method: order.delivery_method || 'Other',
    special_notes: order.special_notes || '',
    discount: order.discount,
  });

  const [hasChanges, setHasChanges] = useState(false);

  const handleChange = (field: string, value: any) => {
    setFormData((prev) => ({ ...prev, [field]: value }));
    setHasChanges(true);
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();

    // Build payload with only changed fields
    const payload: any = {};

    if (formData.project_id !== order.filters.projects.find((p) => p.name === order.project)?.id) {
      payload.project_id = formData.project_id;
    }
    if (formData.delivery_date !== order.delivery_date) {
      payload.delivery_date = formData.delivery_date;
    }
    if (formData.delivery_method !== order.delivery_method) {
      payload.delivery_method = formData.delivery_method;
    }
    if (formData.special_notes !== (order.special_notes || '')) {
      payload.special_notes = formData.special_notes;
    }
    if (formData.discount !== order.discount) {
      payload.discount = formData.discount;
    }

    if (Object.keys(payload).length === 0) {
      return;
    }

    updateMutation.mutate(
      { orderId: order.id, payload },
      {
        onSuccess: () => {
          setHasChanges(false);
        },
      }
    );
  };

  const handleReset = () => {
    setFormData({
      project_id: order.filters.projects.find((p) => p.name === order.project)?.id || 0,
      delivery_date: order.delivery_date,
      delivery_method: order.delivery_method || 'Other',
      special_notes: order.special_notes || '',
      discount: order.discount,
    });
    setHasChanges(false);
  };

  if (!canEdit) {
    return (
      <div className="bg-white rounded-lg border border-gray-200 p-6">
        <h2 className="text-xl font-bold text-gray-900 mb-4">Update Order</h2>
        <div className="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center">
          <p className="text-gray-700 font-medium">Order Cannot Be Edited</p>
          <p className="text-sm text-gray-600 mt-1">
            Delivered orders are locked and cannot be modified.
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="bg-white rounded-lg border border-gray-200 p-6">
      <h2 className="text-xl font-bold text-gray-900 mb-4">Update Order</h2>

      <form onSubmit={handleSubmit} className="space-y-4">
        {/* Project */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Project</label>
          <select
            value={formData.project_id}
            onChange={(e) => handleChange('project_id', parseInt(e.target.value))}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
            <option value={0}>Select project...</option>
            {order.filters.projects.map((project) => (
              <option key={project.id} value={project.id}>
                {project.name}
              </option>
            ))}
          </select>
        </div>

        {/* Delivery Date */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Delivery Date</label>
          <input
            type="date"
            value={formData.delivery_date}
            onChange={(e) => handleChange('delivery_date', e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        {/* Delivery Method */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Delivery Method</label>
          <select
            value={formData.delivery_method}
            onChange={(e) => handleChange('delivery_method', e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="Other">Other</option>
            <option value="Tipper">Tipper</option>
            <option value="Agitator">Agitator</option>
            <option value="Pump">Pump</option>
            <option value="Ute">Ute</option>
          </select>
        </div>

        {/* Special Notes */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Special Notes</label>
          <textarea
            value={formData.special_notes}
            onChange={(e) => handleChange('special_notes', e.target.value)}
            rows={3}
            maxLength={1000}
            placeholder="Add any special instructions..."
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
          <p className="text-xs text-gray-500 mt-1">
            {formData.special_notes.length}/1000 characters
          </p>
        </div>

        {/* Discount */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Discount ($)</label>
          <input
            type="number"
            value={formData.discount}
            onChange={(e) => handleChange('discount', parseFloat(e.target.value) || 0)}
            min="0"
            step="0.01"
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        {/* Action Buttons */}
        <div className="flex gap-3 pt-2">
          <button
            type="submit"
            disabled={!hasChanges || updateMutation.isPending}
            className="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
          >
            <Save size={18} />
            {updateMutation.isPending ? 'Saving...' : 'Save Changes'}
          </button>
          <button
            type="button"
            onClick={handleReset}
            disabled={!hasChanges}
            className="flex items-center justify-center gap-2 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
          >
            <X size={18} />
            Reset
          </button>
        </div>
      </form>
    </div>
  );
};

export default OrderUpdateForm;
/* FILE: src/components/admin/SupplierZoneCard.tsx */
// src/components/admin/SupplierZoneCard.tsx
import React, { useState } from 'react';
import { MapPin, Mail, ChevronDown, ChevronUp, Layers } from 'lucide-react';
import type { SupplierWithZones } from '../../api/handlers/adminSupplierZones.api';

interface SupplierZoneCardProps {
  supplier: SupplierWithZones;
  color: string;
}

const SupplierZoneCard: React.FC<SupplierZoneCardProps> = ({ supplier, color }) => {
  const [isExpanded, setIsExpanded] = useState(false);

  const totalCoverage = supplier.delivery_zones.reduce((sum, zone) => {
    return sum + (Math.PI * zone.radius * zone.radius);
  }, 0);

  const hasZones = supplier.delivery_zones.length > 0;

  return (
    <div 
      className="bg-white rounded-xl border-2 hover:border-primary-300 hover:shadow-lg transition-all overflow-hidden"
      style={{ borderLeftColor: color, borderLeftWidth: '6px' }}
    >
      {/* Header */}
      <div className="p-6">
        <div className="flex items-start gap-4 mb-4">
          {/* Profile Image */}
          <div 
            className="w-16 h-16 rounded-full flex items-center justify-center flex-shrink-0 border-4"
            style={{ borderColor: color + '40' }}
          >
            {supplier.profile_image ? (
              <img
                src={`${import.meta.env.VITE_IMAGE_BASE_URL}${supplier.profile_image}`}
                alt={supplier.name}
                className="w-full h-full rounded-full object-cover"
              />
            ) : (
              <div 
                className="w-full h-full rounded-full flex items-center justify-center text-white font-bold text-xl"
                style={{ backgroundColor: color }}
              >
                {supplier.name.charAt(0).toUpperCase()}
              </div>
            )}
          </div>

          {/* Supplier Info */}
          <div className="flex-1 min-w-0">
            <h3 className="text-lg font-bold text-secondary-900 truncate mb-1">
              {supplier.name}
            </h3>
            <div className="flex items-center gap-2 text-sm text-secondary-600 mb-2">
              <Mail size={14} />
              <span className="truncate">{supplier.email}</span>
            </div>
            
            {/* Zone Stats */}
            <div className="flex items-center gap-4 text-sm">
              <span className="inline-flex items-center gap-1 text-secondary-700">
                <MapPin size={14} />
                <strong>{supplier.delivery_zones.length}</strong> Zone{supplier.delivery_zones.length !== 1 ? 's' : ''}
              </span>
              {hasZones && (
                <span className="inline-flex items-center gap-1 text-secondary-700">
                  <Layers size={14} />
                  <strong>~{totalCoverage.toFixed(0)}</strong> km²
                </span>
              )}
            </div>
          </div>
        </div>

        {/* Zone Summary */}
        {!hasZones ? (
          <div className="bg-secondary-50 rounded-lg p-4 text-center">
            <p className="text-sm text-secondary-600">No delivery zones configured</p>
          </div>
        ) : (
          <>
            {/* Show first 2 zones */}
            <div className="space-y-2">
              {supplier.delivery_zones.slice(0, isExpanded ? undefined : 2).map((zone, idx) => (
                <div 
                  key={idx}
                  className="flex items-start gap-3 p-3 bg-secondary-50 rounded-lg"
                >
                  <div 
                    className="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0"
                    style={{ backgroundColor: color }}
                  >
                    {idx + 1}
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="text-sm font-medium text-secondary-900 line-clamp-2 mb-1">
                      {zone.address}
                    </p>
                    <div className="flex items-center gap-3 text-xs text-secondary-600">
                      <span>📍 {zone.lat.toFixed(4)}, {zone.long.toFixed(4)}</span>
                      <span className="font-semibold text-primary-600">{zone.radius} km radius</span>
                    </div>
                    <p className="text-xs text-secondary-500 mt-1">
                      Coverage: ~{(Math.PI * zone.radius * zone.radius).toFixed(0)} km²
                    </p>
                  </div>
                </div>
              ))}
            </div>

            {/* Expand/Collapse Button */}
            {supplier.delivery_zones.length > 2 && (
              <button
                onClick={() => setIsExpanded(!isExpanded)}
                className="w-full mt-3 flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-primary-600 hover:bg-primary-50 rounded-lg transition-colors"
              >
                {isExpanded ? (
                  <>
                    <ChevronUp size={16} />
                    Show Less
                  </>
                ) : (
                  <>
                    <ChevronDown size={16} />
                    Show {supplier.delivery_zones.length - 2} More Zone{supplier.delivery_zones.length - 2 > 1 ? 's' : ''}
                  </>
                )}
              </button>
            )}
          </>
        )}
      </div>
    </div>
  );
};

export default SupplierZoneCard;
/* FILE: src/components/client/ClientActiveFilterChips.tsx */
// src/components/client/ClientActiveFilterChips.tsx

import React from 'react';
import { X } from 'lucide-react';
import type { ProjectFilter } from '../../types/clientOrder.types';

interface ClientActiveFilterChipsProps {
  filters: {
    project_id: string;
    order_status: string;
    payment_status: string;
    delivery_date: string;
    delivery_method: string;
    repeat_order: string;
  };
  onFilterChange: (key: string, value: string) => void;
  projects: ProjectFilter[];
}

const ClientActiveFilterChips: React.FC<ClientActiveFilterChipsProps> = ({
  filters,
  onFilterChange,
  projects,
}) => {
  const activeFilters: Array<{ key: string; label: string; value: string }> = [];

  if (filters.project_id) {
    const project = projects.find((p) => p.id.toString() === filters.project_id);
    if (project) {
      activeFilters.push({
        key: 'project_id',
        label: 'Project',
        value: project.name,
      });
    }
  }

  if (filters.order_status) {
    activeFilters.push({
      key: 'order_status',
      label: 'Status',
      value: filters.order_status,
    });
  }

  if (filters.payment_status) {
    activeFilters.push({
      key: 'payment_status',
      label: 'Payment',
      value: filters.payment_status,
    });
  }

  if (filters.delivery_date) {
    activeFilters.push({
      key: 'delivery_date',
      label: 'Delivery Date',
      value: new Date(filters.delivery_date).toLocaleDateString(),
    });
  }

  if (filters.delivery_method) {
    activeFilters.push({
      key: 'delivery_method',
      label: 'Method',
      value: filters.delivery_method,
    });
  }

  if (filters.repeat_order) {
    activeFilters.push({
      key: 'repeat_order',
      label: 'Type',
      value: filters.repeat_order === 'true' ? 'Repeat Orders' : 'New Orders',
    });
  }

  if (activeFilters.length === 0) return null;

  return (
    <div className="flex flex-wrap gap-2">
      {activeFilters.map((filter) => (
        <div
          key={filter.key}
          className="inline-flex items-center gap-2 px-3 py-1.5 bg-blue-100 text-blue-800 rounded-full text-sm font-medium"
        >
          <span className="font-semibold">{filter.label}:</span>
          <span>{filter.value}</span>
          <button
            onClick={() => onFilterChange(filter.key, '')}
            className="hover:bg-blue-200 rounded-full p-0.5 transition-colors"
          >
            <X size={14} />
          </button>
        </div>
      ))}
    </div>
  );
};

export default ClientActiveFilterChips;
/* FILE: src/components/client/ClientOrderFilters.tsx */
// src/components/client/ClientOrderFilters.tsx

import React from 'react';
import { X } from 'lucide-react';
import type { ProjectFilter } from '../../types/clientOrder.types';

interface ClientOrderFiltersProps {
  filters: {
    search: string;
    project_id: string;
    order_status: string;
    payment_status: string;
    delivery_date: string;
    delivery_method: string;
    repeat_order: string;
    sort: string;
    dir: string;
  };
  onFilterChange: (key: string, value: string) => void;
  onClearFilters: () => void;
  projects: ProjectFilter[];
  availableFilters?: {
    order_statuses?: string[];
    payment_statuses?: string[];
    delivery_methods?: string[];
  };
}

const ClientOrderFilters: React.FC<ClientOrderFiltersProps> = ({
  filters,
  onFilterChange,
  onClearFilters,
  projects,
  availableFilters,
}) => {
  const hasActiveFilters = Object.entries(filters).some(
    ([key, value]) =>
      value !== '' &&
      key !== 'sort' &&
      key !== 'dir' &&
      key !== 'per_page' &&
      key !== 'page' &&
      key !== 'search'
  );

  return (
    <div className="bg-white rounded-xl border border-gray-200 p-6 shadow-sm space-y-4">
      <div className="flex items-center justify-between">
        <h3 className="text-lg font-bold text-gray-900">Filters</h3>
        {hasActiveFilters && (
          <button
            onClick={onClearFilters}
            className="text-sm text-red-600 hover:text-red-700 flex items-center gap-1 font-medium"
          >
            <X size={16} />
            Clear All
          </button>
        )}
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {/* Project Filter */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Project</label>
          <select
            value={filters.project_id}
            onChange={(e) => onFilterChange('project_id', e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="">All Projects</option>
            {projects.map((project) => (
              <option key={project.id} value={project.id}>
                {project.name}
              </option>
            ))}
          </select>
        </div>

        {/* Order Status Filter */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Order Status</label>
          <select
            value={filters.order_status}
            onChange={(e) => onFilterChange('order_status', e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="">All Statuses</option>
            {(availableFilters?.order_statuses || ['Draft', 'Confirmed', 'Scheduled', 'In Transit', 'Delivered', 'Completed', 'Cancelled']).map((status) => (
              <option key={status} value={status}>
                {status}
              </option>
            ))}
          </select>
        </div>

        {/* Payment Status Filter */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
          <select
            value={filters.payment_status}
            onChange={(e) => onFilterChange('payment_status', e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="">All Payment Statuses</option>
            {(availableFilters?.payment_statuses || ['Unpaid', 'Partially Paid', 'Paid']).map((status) => (
              <option key={status} value={status}>
                {status}
              </option>
            ))}
          </select>
        </div>

        {/* Delivery Method Filter */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Delivery Method</label>
          <select
            value={filters.delivery_method}
            onChange={(e) => onFilterChange('delivery_method', e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="">All Methods</option>
            {(availableFilters?.delivery_methods || ['Tipper', 'Agitator', 'Pump', 'Ute', 'Other']).map((method) => (
              <option key={method} value={method}>
                {method}
              </option>
            ))}
          </select>
        </div>

        {/* Delivery Date Filter */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Delivery Date</label>
          <input
            type="date"
            value={filters.delivery_date}
            onChange={(e) => onFilterChange('delivery_date', e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        {/* Repeat Order Filter */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Repeat Orders</label>
          <select
            value={filters.repeat_order}
            onChange={(e) => onFilterChange('repeat_order', e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="">All Orders</option>
            <option value="true">Repeat Orders Only</option>
            <option value="false">New Orders Only</option>
          </select>
        </div>

        {/* Sort By */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
          <select
            value={filters.sort}
            onChange={(e) => onFilterChange('sort', e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="created_at">Created Date</option>
            <option value="delivery_date">Delivery Date</option>
            <option value="po_number">PO Number</option>
            <option value="total_price">Total Amount</option>
          </select>
        </div>

        {/* Sort Direction */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Direction</label>
          <select
            value={filters.dir}
            onChange={(e) => onFilterChange('dir', e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="desc">Newest First</option>
            <option value="asc">Oldest First</option>
          </select>
        </div>
      </div>
    </div>
  );
};

export default ClientOrderFilters;
/* FILE: src/components/client/ClientOrderMetricsCards.tsx */
// src/components/client/ClientOrderMetricsCards.tsx

import React from 'react';
import { ShoppingCart, FileText, Truck, CheckCircle } from 'lucide-react';
import type { ClientOrderMetrics } from '../../types/clientOrder.types';

interface MetricsCardsProps {
  metrics: ClientOrderMetrics | null;
  loading: boolean;
}

const ClientOrderMetricsCards: React.FC<MetricsCardsProps> = ({ metrics, loading }) => {
  const cards = [
    {
      label: 'Total Orders',
      value: metrics?.total_orders_count || 0,
      icon: ShoppingCart,
      gradient: 'from-blue-500 to-blue-600',
      lightBg: 'bg-blue-50',
      iconColor: 'text-blue-600',
      shadowColor: 'hover:shadow-blue-200',
    },
    {
      label: 'Draft',
      value: metrics?.draft_count || 0,
      icon: FileText,
      gradient: 'from-gray-500 to-gray-600',
      lightBg: 'bg-gray-50',
      iconColor: 'text-gray-600',
      shadowColor: 'hover:shadow-gray-200',
    },
    {
      label: 'Active',
      value: (metrics?.confirmed_count || 0) + (metrics?.scheduled_count || 0) + (metrics?.in_transit_count || 0),
      icon: Truck,
      gradient: 'from-indigo-500 to-purple-600',
      lightBg: 'bg-indigo-50',
      iconColor: 'text-indigo-600',
      shadowColor: 'hover:shadow-indigo-200',
    },
    {
      label: 'Completed',
      value: (metrics?.delivered_count || 0) + (metrics?.completed_count || 0),
      icon: CheckCircle,
      gradient: 'from-green-500 to-emerald-600',
      lightBg: 'bg-green-50',
      iconColor: 'text-green-600',
      shadowColor: 'hover:shadow-green-200',
    },
  ];

  if (loading) {
    return (
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        {[1, 2, 3, 4].map((i) => (
          <div key={i} className="bg-white rounded-xl border border-gray-200 p-6 animate-pulse">
            <div className="flex items-center justify-between">
              <div className="flex-1">
                <div className="h-4 bg-gray-200 rounded w-24 mb-3"></div>
                <div className="h-8 bg-gray-200 rounded w-16"></div>
              </div>
              <div className="w-12 h-12 bg-gray-200 rounded-full"></div>
            </div>
          </div>
        ))}
      </div>
    );
  }

  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
      {cards.map((card, index) => {
        const Icon = card.icon;
        return (
          <div
            key={index}
            className={`bg-gradient-to-br ${card.gradient} rounded-xl shadow-lg ${card.shadowColor} transition-all duration-300 p-6 text-white group hover:scale-105`}
          >
            <div className="flex items-center justify-between">
              <div className="flex-1">
                <p className="text-white/90 text-sm font-medium mb-1">{card.label}</p>
                <p className="text-4xl font-bold">{card.value}</p>
              </div>
              <div className="bg-white/20 rounded-full p-3 group-hover:bg-white/30 transition-colors">
                <Icon size={28} />
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
};

export default ClientOrderMetricsCards;
/* FILE: src/components/client/ClientOrdersTable.tsx */
// src/components/client/ClientOrdersTable.tsx

import React from 'react';
import { Eye, Package, Calendar, RefreshCw } from 'lucide-react';
import type {ClientOrderListItem } from '../../types/clientOrder.types';
import { getOrderStatusBadgeClass, getPaymentStatusBadgeClass, formatCurrency, formatDate } from '../../features/clientOrders/utils';

interface ClientOrdersTableProps {
  orders: ClientOrderListItem[];
  loading: boolean;
  pagination: {
    per_page: number;
    current_page: number;
    total_pages: number;
    total_items: number;
  } | null;
  onPageChange: (page: number) => void;
  onViewOrder: (orderId: number) => void;
}

const ClientOrdersTable: React.FC<ClientOrdersTableProps> = ({
  orders,
  loading,
  pagination,
  onPageChange,
  onViewOrder,
}) => {

  if (loading) {
    return (
      <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
        <div className="p-8 text-center">
          <div className="animate-spin w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full mx-auto mb-4"></div>
          <p className="text-gray-600 font-medium">Loading orders...</p>
        </div>
      </div>
    );
  }

  if (!orders || orders.length === 0) {
    return (
      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-12 text-center">
        <Package size={64} className="mx-auto text-gray-300 mb-4" />
        <h3 className="text-xl font-bold text-gray-900 mb-2">No Orders Found</h3>
        <p className="text-gray-600">Try adjusting your filters or create a new order.</p>
      </div>
    );
  }

  return (
    <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
      <div className="overflow-x-auto">
        <table className="w-full">
          <thead className="bg-gradient-to-r from-blue-50 to-indigo-50 border-b-2 border-blue-200">
            <tr>
              <th className="px-6 py-4 text-left text-sm font-bold text-gray-900">PO Number</th>
              <th className="px-6 py-4 text-left text-sm font-bold text-gray-900">Project</th>
              <th className="px-6 py-4 text-left text-sm font-bold text-gray-900">Delivery</th>
              <th className="px-6 py-4 text-left text-sm font-bold text-gray-900">Status</th>
              <th className="px-6 py-4 text-left text-sm font-bold text-gray-900">Payment</th>
              <th className="px-6 py-4 text-left text-sm font-bold text-gray-900">Items</th>
              <th className="px-6 py-4 text-left text-sm font-bold text-gray-900">Total</th>
              <th className="px-6 py-4 text-center text-sm font-bold text-gray-900">Actions</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200">
            {orders.map((order) => (
              <tr key={order.id} className="hover:bg-gray-50 transition-colors">
                <td className="px-6 py-4">
                  <div className="flex flex-col">
                    <span className="font-bold text-gray-900">{order.po_number}</span>
                    <span className="text-xs text-gray-500">ID: {order.id}</span>
                    {order.repeat_order && (
                      <span className="inline-flex items-center gap-1 text-xs text-blue-600 font-medium mt-1">
                        <RefreshCw size={12} />
                        Repeat
                      </span>
                    )}
                  </div>
                </td>
                <td className="px-6 py-4">
                  <span className="font-medium text-gray-900">{order.project?.name || 'N/A'}</span>
                </td>
                <td className="px-6 py-4">
                  <div className="flex flex-col gap-1">
                    <div className="flex items-center gap-2 text-sm">
                      <Calendar size={14} className="text-gray-400" />
                      <span className="font-medium text-gray-900">{formatDate(order.delivery_date)}</span>
                    </div>
                    {order.delivery_time && (
                      <span className="text-xs text-gray-600">{order.delivery_time}</span>
                    )}
                    {/* <div className="flex items-center gap-1 text-xs text-gray-600">
                      <span>{getDeliveryMethodIcon(order.delivery_method)}</span>
                      <span>{order.delivery_method}</span>
                    </div> */}
                  </div>
                </td>
                <td className="px-6 py-4">
                  <span className={`inline-block px-3 py-1 rounded-full text-xs font-bold ${getOrderStatusBadgeClass(order.order_status)}`}>
                    {order.order_status}
                  </span>
                  {order.order_info && (
                    <div className="text-xs text-gray-600 mt-1">{order.order_info}</div>
                  )}
                </td>
                <td className="px-6 py-4">
                  <span className={`inline-block px-3 py-1 rounded-full text-xs font-bold ${getPaymentStatusBadgeClass(order.payment_status)}`}>
                    {order.payment_status}
                  </span>
                </td>
                <td className="px-6 py-4">
                  <div className="flex items-center gap-2">
                    <Package size={16} className="text-gray-400" />
                    <span className="font-semibold text-gray-900">{order.items_count}</span>
                  </div>
                </td>
                <td className="px-6 py-4">
                  <div className="flex flex-col">
                    <span className="font-bold text-gray-900 text-lg">{formatCurrency(order.total_price ?? 0)}</span>
                    {(order.gst_tax ?? 0) > 0 && (
                      <span className="text-xs text-gray-500">GST: {formatCurrency((order.gst_tax ?? 0))}</span>
                    )}
                    {order.discount > 0 && (
                      <span className="text-xs text-green-600">Discount: -{formatCurrency(order.discount)}</span>
                    )}
                  </div>
                </td>
                <td className="px-6 py-4">
                  <div className="flex justify-center">
                    <button
                      onClick={() => onViewOrder(order.id)}
                      className="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium text-sm"
                    >
                      <Eye size={16} />
                      View
                    </button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* Pagination */}
      {pagination && pagination.total_pages > 1 && (
        <div className="px-6 py-4 bg-gray-50 border-t border-gray-200">
          <div className="flex items-center justify-between">
            <div className="text-sm text-gray-600">
              Showing page {pagination.current_page} of {pagination.total_pages} ({pagination.total_items} total orders)
            </div>
            <div className="flex gap-2">
              <button
                onClick={() => onPageChange(pagination.current_page - 1)}
                disabled={pagination.current_page === 1}
                className="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                Previous
              </button>
              <button
                onClick={() => onPageChange(pagination.current_page + 1)}
                disabled={pagination.current_page === pagination.total_pages}
                className="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                Next
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default ClientOrdersTable;
/* FILE: src/components/client/RepeatOrderModal.tsx */
// ============================================================================
// FILE: src/components/client/RepeatOrderModal.tsx
// ============================================================================

import { useState, useEffect } from 'react';
import { X, Package } from 'lucide-react';

const RepeatOrderModal = ({ isOpen, onClose, order, onSubmit, isSubmitting }: any) => {
  const [items, setItems] = useState<any[]>([]);

  useEffect(() => {
    if (order && order.items) {
      setItems(
        order.items.map((item: any) => ({
          product_id: item.product_id,
          product_name: item.product.product_name,
          quantity: parseFloat(item.quantity),
          unit_of_measure: item.product.unit_of_measure,
          custom_blend_mix: item.custom_blend_mix || '',
          has_custom_blend: !!item.custom_blend_mix,
        }))
      );
    }
  }, [order]);

  const handleQuantityChange = (index: number, value: string) => {
    const newItems = [...items];
    newItems[index].quantity = parseFloat(value) || 0;
    setItems(newItems);
  };

  const handleCustomBlendChange = (index: number, value: string) => {
    const newItems = [...items];
    newItems[index].custom_blend_mix = value;
    setItems(newItems);
  };

  const handleSubmit = () => {
    const payload = items.map((item) => ({
      product_id: item.product_id,
      quantity: item.quantity,
      ...(item.has_custom_blend && item.custom_blend_mix && { custom_blend_mix: item.custom_blend_mix }),
    }));
    onSubmit(payload);
  };

  if (!isOpen || !order) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col">
        <div className="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
              <Package className="w-6 h-6 text-green-600" />
            </div>
            <div>
              <h2 className="text-xl font-bold text-gray-900">Repeat Order</h2>
              <p className="text-sm text-gray-600">Update quantities for {order.po_number}</p>
            </div>
          </div>
          <button
            onClick={onClose}
            className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
            disabled={isSubmitting}
          >
            <X className="w-5 h-5 text-gray-500" />
          </button>
        </div>

        <div className="flex-1 overflow-y-auto p-6">
          <div className="space-y-4">
            {items.map((item, index) => (
              <div key={index} className="border border-gray-200 rounded-lg p-4">
                <div className="flex items-start justify-between mb-3">
                  <div>
                    <h3 className="font-semibold text-gray-900">{item.product_name}</h3>
                    <p className="text-sm text-gray-600">Unit: {item.unit_of_measure}</p>
                  </div>
                </div>

                <div className="grid grid-cols-1 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Quantity *
                    </label>
                    <input
                      type="number"
                      step="0.01"
                      min="0"
                      value={item.quantity}
                      onChange={(e) => handleQuantityChange(index, e.target.value)}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      disabled={isSubmitting}
                    />
                  </div>

                  {item.has_custom_blend && (
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Custom Blend/Mix
                      </label>
                      <input
                        type="text"
                        value={item.custom_blend_mix}
                        onChange={(e) => handleCustomBlendChange(index, e.target.value)}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="e.g., 32MPa, 20mm agg, slump 80"
                        disabled={isSubmitting}
                      />
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>

        <div className="px-6 py-4 border-t border-gray-200 flex items-center justify-end gap-3">
          <button
            onClick={onClose}
            disabled={isSubmitting}
            className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors disabled:opacity-50"
          >
            Cancel
          </button>
          <button
            onClick={handleSubmit}
            disabled={isSubmitting}
            className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 flex items-center gap-2"
          >
            {isSubmitting ? (
              <>
                <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                Submitting...
              </>
            ) : (
              'Submit Repeat Order'
            )}
          </button>
        </div>
      </div>
    </div>
  );
};

export default RepeatOrderModal;
/* FILE: src/components/client/StripePayment.tsx */
// FILE PATH: src/components/client/StripePayment.tsx

import { useState } from 'react';
import { loadStripe } from '@stripe/stripe-js';
import {
  Elements,
  CardElement,
  useStripe,
  useElements,
} from '@stripe/react-stripe-js';
import { CreditCard, Loader2, CheckCircle2, XCircle } from 'lucide-react';
import toast from 'react-hot-toast';
import { paymentAPI } from '../../api/handlers/payment.api';

const stripePromise = loadStripe(import.meta.env.VITE_STRIPE_PUBLISHABLE_KEY);

interface PaymentFormProps {
  orderId: number;
  totalAmount: number;
  onSuccess: () => void;
}

const PaymentForm: React.FC<PaymentFormProps> = ({
  orderId,
  totalAmount,
  onSuccess,
}) => {
  const stripe = useStripe();
  const elements = useElements();
  const [isProcessing, setIsProcessing] = useState(false);
  const [errorMessage, setErrorMessage] = useState<string>('');

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!stripe || !elements) {
      return;
    }

    const cardElement = elements.getElement(CardElement);
    if (!cardElement) {
      return;
    }

    setIsProcessing(true);
    setErrorMessage('');

    try {
      // Create payment method
      const { error, paymentMethod } = await stripe.createPaymentMethod({
        type: 'card',
        card: cardElement,
      });

      if (error) {
        setErrorMessage(error.message || 'Failed to create payment method');
        toast.error(error.message || 'Failed to create payment method');
        setIsProcessing(false);
        return;
      }

      // Send to backend for processing
      const response = await paymentAPI.processPayment({
        payment_method_id: paymentMethod.id,
        order_id: orderId,
      });

      if (response.success) {
        toast.success('Payment successful!');
        onSuccess();
      } else {
        setErrorMessage(response.message || 'Payment failed');
        toast.error(response.message || 'Payment failed');
      }
    } catch (error: any) {
      console.error('Payment error:', error);
      setErrorMessage(error.message || 'An unexpected error occurred');
      toast.error(error.message || 'An unexpected error occurred');
    } finally {
      setIsProcessing(false);
    }
  };

  const cardElementOptions = {
    style: {
      base: {
        fontSize: '16px',
        color: '#1f2937',
        fontFamily: 'system-ui, sans-serif',
        '::placeholder': {
          color: '#9ca3af',
        },
      },
      invalid: {
        color: '#dc2626',
        iconColor: '#dc2626',
      },
    },
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      {/* Card Element */}
      <div className="bg-white p-6 rounded-xl border-2 border-gray-200">
        <label className="block text-sm font-semibold text-gray-700 mb-3">
          Card Details
        </label>
        <div className="p-4 border-2 border-gray-200 rounded-lg focus-within:border-green-500 transition-colors">
          <CardElement options={cardElementOptions} />
        </div>
      </div>

      {/* Error Message */}
      {errorMessage && (
        <div className="bg-red-50 border-2 border-red-200 rounded-xl p-4 flex items-start gap-3">
          <XCircle className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />
          <div>
            <h4 className="font-semibold text-red-900 mb-1">Payment Error</h4>
            <p className="text-sm text-red-700">{errorMessage}</p>
          </div>
        </div>
      )}

      {/* Submit Button */}
      <button
        type="submit"
        disabled={!stripe || isProcessing}
        className="w-full flex items-center justify-center gap-3 px-6 py-4 bg-green-600 text-white rounded-xl hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all font-bold text-lg shadow-lg"
      >
        {isProcessing ? (
          <>
            <Loader2 className="w-5 h-5 animate-spin" />
            Processing Payment...
          </>
        ) : (
          <>
            <CreditCard className="w-5 h-5" />
            Pay ${totalAmount.toFixed(2)} AUD
          </>
        )}
      </button>

      {/* Security Badge */}
      <div className="flex items-center justify-center gap-2 text-sm text-gray-600">
        <CheckCircle2 className="w-4 h-4 text-green-600" />
        <span>Secure payment powered by Stripe</span>
      </div>
    </form>
  );
};

interface StripePaymentProps {
  orderId: number;
  totalAmount: number;
  onSuccess: () => void;
}

const StripePayment: React.FC<StripePaymentProps> = ({
  orderId,
  totalAmount,
  onSuccess,
}) => {
  // Safety check
  const safeAmount = isNaN(totalAmount) || totalAmount <= 0 ? 0 : totalAmount;

  if (safeAmount === 0) {
    return (
      <div className="bg-red-50 border-2 border-red-200 rounded-xl p-6">
        <div className="flex items-center gap-3">
          <XCircle className="w-6 h-6 text-red-600" />
          <div>
            <h3 className="text-lg font-bold text-red-900">Payment Error</h3>
            <p className="text-sm text-red-700">Invalid order amount. Please refresh the page.</p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="bg-gradient-to-br from-green-50 to-blue-50 rounded-xl border-2 border-green-200 p-6">
      <div className="flex items-center gap-3 mb-6">
        <div className="p-3 bg-green-100 rounded-xl border-2 border-green-300">
          <CreditCard className="w-6 h-6 text-green-600" />
        </div>
        <div>
          <h3 className="text-xl font-bold text-gray-900">Complete Payment</h3>
          <p className="text-sm text-gray-600">
            Total Amount: <span className="font-bold text-green-600">${safeAmount.toFixed(2)} AUD</span>
          </p>
        </div>
      </div>

      <Elements stripe={stripePromise}>
        <PaymentForm
          orderId={orderId}
          totalAmount={safeAmount}
          onSuccess={onSuccess}
        />
      </Elements>
    </div>
  );
};

export default StripePayment;
/* FILE: src/components/common/ApproveStatusBadge.tsx */
// FILE PATH: src/components/common/ApprovalStatusBadge.tsx
import React from "react";

export type BadgeStatus = "Pending" | "Approved" | "Rejected";

interface ApprovalStatusBadgeProps {
  status: BadgeStatus;
  onClick?: () => void;
  loading?: boolean;
  disabled?: boolean;
}

const ApproveStatusBadge: React.FC<ApprovalStatusBadgeProps> = ({
  status,
  onClick,
  loading = false,
  disabled = false,
}) => {
  const handleClick = () => {
    if (onClick && !disabled && !loading) onClick();
  };

  const base = "px-3 py-1 rounded-full text-xs font-semibold inline-flex items-center gap-2 border";
  const interactive = onClick && !disabled ? "cursor-pointer hover:opacity-80 transition-opacity" : "";
  const disabledClass = disabled ? "opacity-50 cursor-not-allowed" : "";

  const statusStyles: Record<typeof status, string> = {
    Pending: "bg-yellow-100 text-yellow-800 border-yellow-300",
    Approved: "bg-green-100 text-green-800 border-green-300",
    Rejected: "bg-red-100 text-red-800 border-red-300",
  };

  const dotColor: Record<typeof status, string> = {
    Pending: "bg-yellow-500",
    Approved: "bg-green-500",
    Rejected: "bg-red-500",
  };

  return (
    <span
      className={`${base} ${statusStyles[status]} ${interactive} ${disabledClass}`}
      onClick={handleClick}
      title={onClick ? "Click to update status" : ""}
    >
      <span className={`w-2 h-2 rounded-full ${dotColor[status]}`} />
      {loading ? <span className="animate-pulse">Processing...</span> : <span>{status}</span>}
    </span>
  );
};

export default ApproveStatusBadge;

/* FILE: src/components/common/Buttons.tsx */
// src/components/common/Buttons.tsx
import { Loader2 } from 'lucide-react';
import type { ButtonHTMLAttributes, ReactNode } from 'react';

interface ButtonProps extends ButtonHTMLAttributes<HTMLButtonElement> {
  children: ReactNode;
  variant?: 'primary' | 'secondary' | 'outline' | 'ghost';
  isLoading?: boolean;
  fullWidth?: boolean;
}

const Button = ({ 
  children, 
  variant = 'primary', 
  isLoading = false, 
  disabled = false,
  type = 'button',
  fullWidth = true,
  className = '',
  ...props 
}: ButtonProps) => {
  const baseStyles = `${fullWidth ? 'w-full' : ''} px-4 py-3 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed`;
  
  const variants = {
    primary: "bg-primary-500 text-white hover:bg-primary-600 active:bg-primary-700 shadow-sm hover:shadow-md",
    secondary: "bg-secondary-100 text-secondary-900 hover:bg-secondary-200 active:bg-secondary-300",
    outline: "border-2 border-primary-500 text-primary-500 hover:bg-primary-50 active:bg-primary-100",
    ghost: "text-primary-500 hover:bg-primary-50 active:bg-primary-100",
  };

  return (
    <button
      type={type}
      disabled={disabled || isLoading}
      className={`${baseStyles} ${variants[variant]} ${className}`}
      {...props}
    >
      {isLoading && <Loader2 className="w-5 h-5 animate-spin" />}
      {children}
    </button>
  );
};

export default Button;
/* FILE: src/components/common/ConfirmModal.tsx */
// FILE PATH: src/components/common/ConfirmModal.tsx

/**
 * ConfirmModal Component
 * 
 * Reusable confirmation modal for destructive or important actions.
 * 
 * Features:
 * - Customizable title, message, and button text
 * - Danger mode (red) or normal mode (blue)
 * - Loading state during action
 * - Backdrop click to cancel
 */

import React, { useEffect } from 'react';

interface ConfirmModalProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: () => void;
  title?: string;
  message?: string;
  confirmText?: string;
  cancelText?: string;
  isDanger?: boolean;
  loading?: boolean;
}

const ConfirmModal: React.FC<ConfirmModalProps> = ({ 
  isOpen,
  onClose,
  onConfirm,
  title = "Confirm Action",
  message = "Are you sure you want to proceed?",
  confirmText = "Confirm",
  cancelText = "Cancel",
  isDanger = false,
  loading = false
}) => {
  // Handle ESC key to close modal
  useEffect(() => {
    const handleEsc = (e: KeyboardEvent) => {
      if (e.key === 'Escape' && !loading) {
        onClose();
      }
    };
    
    if (isOpen) {
      document.addEventListener('keydown', handleEsc);
      // Prevent body scroll when modal is open
      document.body.style.overflow = 'hidden';
    }
    
    return () => {
      document.removeEventListener('keydown', handleEsc);
      document.body.style.overflow = 'unset';
    };
  }, [isOpen, loading, onClose]);

  if (!isOpen) return null;

  const handleBackdropClick = (e: React.MouseEvent<HTMLDivElement>) => {
    if (e.target === e.currentTarget && !loading) {
      onClose();
    }
  };

  const confirmButtonClass = isDanger
    ? "bg-red-600 hover:bg-red-700 focus:ring-red-500"
    : "bg-blue-600 hover:bg-blue-700 focus:ring-blue-500";

  return (
    <div 
      className="fixed inset-0 z-50 overflow-y-auto"
      aria-labelledby="modal-title" 
      role="dialog" 
      aria-modal="true"
    >
      {/* Backdrop */}
      <div 
        className="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0"
        onClick={handleBackdropClick}
      >
        {/* Background overlay */}
        <div 
          className="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" 
          aria-hidden="true"
        ></div>

        {/* Center modal */}
        <span 
          className="hidden sm:inline-block sm:align-middle sm:h-screen" 
          aria-hidden="true"
        >
          &#8203;
        </span>

        {/* Modal panel */}
        <div className="inline-block overflow-hidden text-left align-bottom transition-all transform bg-white rounded-lg shadow-xl sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
          <div className="px-4 pt-5 pb-4 bg-white sm:p-6 sm:pb-4">
            <div className="sm:flex sm:items-start">
              {/* Icon */}
              <div className={`flex items-center justify-center flex-shrink-0 w-12 h-12 mx-auto rounded-full sm:mx-0 sm:h-10 sm:w-10 ${
                isDanger ? 'bg-red-100' : 'bg-blue-100'
              }`}>
                {isDanger ? (
                  <svg 
                    className="w-6 h-6 text-red-600" 
                    fill="none" 
                    stroke="currentColor" 
                    viewBox="0 0 24 24"
                  >
                    <path 
                      strokeLinecap="round" 
                      strokeLinejoin="round" 
                      strokeWidth="2" 
                      d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" 
                    />
                  </svg>
                ) : (
                  <svg 
                    className="w-6 h-6 text-blue-600" 
                    fill="none" 
                    stroke="currentColor" 
                    viewBox="0 0 24 24"
                  >
                    <path 
                      strokeLinecap="round" 
                      strokeLinejoin="round" 
                      strokeWidth="2" 
                      d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" 
                    />
                  </svg>
                )}
              </div>

              {/* Content */}
              <div className="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                <h3 
                  className="text-lg font-medium leading-6 text-gray-900" 
                  id="modal-title"
                >
                  {title}
                </h3>
                <div className="mt-2">
                  <p className="text-sm text-gray-500">
                    {message}
                  </p>
                </div>
              </div>
            </div>
          </div>

          {/* Actions */}
          <div className="px-4 py-3 bg-gray-50 sm:px-6 sm:flex sm:flex-row-reverse">
            <button
              type="button"
              onClick={onConfirm}
              disabled={loading}
              className={`inline-flex justify-center w-full px-4 py-2 text-base font-medium text-white border border-transparent rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 sm:ml-3 sm:w-auto sm:text-sm ${confirmButtonClass} ${
                loading ? 'opacity-50 cursor-not-allowed' : ''
              }`}
            >
              {loading ? (
                <>
                  <svg 
                    className="w-5 h-5 mr-2 -ml-1 animate-spin" 
                    fill="none" 
                    viewBox="0 0 24 24"
                  >
                    <circle 
                      className="opacity-25" 
                      cx="12" 
                      cy="12" 
                      r="10" 
                      stroke="currentColor" 
                      strokeWidth="4"
                    ></circle>
                    <path 
                      className="opacity-75" 
                      fill="currentColor" 
                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                    ></path>
                  </svg>
                  Processing...
                </>
              ) : (
                confirmText
              )}
            </button>
            <button
              type="button"
              onClick={onClose}
              disabled={loading}
              className={`inline-flex justify-center w-full px-4 py-2 mt-3 text-base font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm ${
                loading ? 'opacity-50 cursor-not-allowed' : ''
              }`}
            >
              {cancelText}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ConfirmModal;
/* FILE: src/components/common/FormulaTooltip.tsx */
// FILE PATH: src/components/common/FormulaTooltip.tsx

/**
 * Formula Tooltip Component
 * Shows formula on hover with a small info icon
 * Uses shadcn/ui Tooltip component
 */

import React from 'react';
import { HelpCircle } from 'lucide-react';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '../ui/tooltip';

interface FormulaTooltipProps {
  formula: string;
  size?: number;
  className?: string;
}

/**
 * FormulaTooltip Component
 * 
 * @param formula - The formula to display in the tooltip
 * @param size - Size of the help icon (default: 16)
 * @param className - Additional CSS classes for the icon
 * 
 * @example
 * <FormulaTooltip formula="Total = Item Cost + Delivery - Discount" />
 */
const FormulaTooltip: React.FC<FormulaTooltipProps> = ({
  formula,
  size = 16,
  className = '',
}) => {
  return (
    <TooltipProvider delayDuration={200}>
      <Tooltip>
        <TooltipTrigger asChild>
          <button
            type="button"
            className={`inline-flex items-center justify-center transition-colors ${className}`}
          >
            <HelpCircle
              size={size}
              className="text-gray-400 hover:text-blue-500 cursor-help transition-colors"
            />
          </button>
        </TooltipTrigger>
        <TooltipContent
          side="top"
          className="max-w-xs bg-gray-900 text-white px-3 py-2 rounded-lg text-sm border border-gray-700"
        >
          <code className="font-mono text-xs whitespace-pre-wrap">{formula}</code>
        </TooltipContent>
      </Tooltip>
    </TooltipProvider>
  );
};

export default FormulaTooltip;

/* FILE: src/components/common/ImageUpload.tsx */
// src/components/common/ImageUpload.tsx
import { useState } from 'react';
import type { ChangeEvent } from 'react';
import { Upload, X, Image as ImageIcon } from 'lucide-react';

interface ImageUploadProps {
  label?: string;
  onChange: (file: File | null) => void;
  error?: string | null;
  currentImage?: string | null;
}

const ImageUpload = ({ 
  label, 
  onChange, 
  error, 
  currentImage = null 
}: ImageUploadProps) => {
  const [preview, setPreview] = useState<string | null>(currentImage);

  const handleFileChange = (e: ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      // Validate file type
      if (!file.type.startsWith('image/')) {
        onChange(null);
        return;
      }

      // Validate file size (max 2MB)
      if (file.size > 2 * 1024 * 1024) {
        onChange(null);
        return;
      }

      // Create preview
      const reader = new FileReader();
      reader.onloadend = () => {
        setPreview(reader.result as string);
      };
      reader.readAsDataURL(file);
      
      onChange(file);
    }
  };

  const clearImage = () => {
    setPreview(null);
    onChange(null);
  };

  return (
    <div className="space-y-2">
      {label && (
        <label className="block text-sm font-medium text-secondary-700">
          {label}
        </label>
      )}

      <div className="flex items-start gap-4">
        {/* Preview */}
        {preview ? (
          <div className="relative w-32 h-32 rounded-lg overflow-hidden border-2 border-secondary-200 bg-secondary-50">
            <img 
              src={preview} 
              alt="Preview" 
              className="w-full h-full object-cover"
            />
            <button
              type="button"
              onClick={clearImage}
              className="absolute top-2 right-2 p-1 bg-error-500 text-white rounded-full hover:bg-error-600 transition-colors"
            >
              <X size={16} />
            </button>
          </div>
        ) : (
          <div className="w-32 h-32 rounded-lg border-2 border-dashed border-secondary-300 bg-secondary-50 flex items-center justify-center">
            <ImageIcon size={32} className="text-secondary-400" />
          </div>
        )}

        {/* Upload Button */}
        <div className="flex-1">
          <label className="cursor-pointer">
            <input
              type="file"
              accept="image/*"
              onChange={handleFileChange}
              className="hidden"
            />
            <div className="flex items-center gap-2 px-4 py-3 border-2 border-secondary-300 rounded-lg hover:border-primary-500 hover:bg-primary-50 transition-all">
              <Upload size={20} className="text-secondary-600" />
              <span className="text-sm text-secondary-700">
                {preview ? 'Change Image' : 'Upload Image'}
              </span>
            </div>
          </label>
          <p className="text-xs text-secondary-500 mt-2">
            PNG, JPG, GIF up to 2MB
          </p>
        </div>
      </div>

      {error && (
        <p className="text-sm text-error-500">{error}</p>
      )}
    </div>
  );
};

export default ImageUpload;
/* FILE: src/components/common/Input.tsx */
// src/components/common/Input.tsx
import { Eye, EyeOff } from 'lucide-react';
import type { LucideIcon } from 'lucide-react';
import { useState } from 'react';
import type { InputHTMLAttributes} from 'react';
import type { UseFormRegisterReturn } from 'react-hook-form';

interface InputProps extends Omit<InputHTMLAttributes<HTMLInputElement>, 'type'> {
  label?: string;
  error?: string;
  type?: 'text' | 'email' | 'password' | 'number' | 'tel';
  register?: UseFormRegisterReturn;
  icon?: LucideIcon;
}

const Input = ({ 
  label, 
  error, 
  type = 'text',
  register,
  icon: Icon,
  ...props 
}: InputProps) => {
  const [showPassword, setShowPassword] = useState(false);
  const isPassword = type === 'password';
  const inputType = isPassword && showPassword ? 'text' : type;

  return (
    <div className="space-y-2">
      {label && (
        <label className="block text-sm font-medium text-secondary-700">
          {label}
          {props.required && <span className="text-error-500 ml-1">*</span>}
        </label>
      )}
      
      <div className="relative">
        {Icon && (
          <div className="absolute left-3 top-1/2 -translate-y-1/2 text-secondary-400">
            <Icon size={20} />
          </div>
        )}
        
        <input
          type={inputType}
          className={`
            w-full px-4 py-3 rounded-lg border-2 transition-all
            ${Icon ? 'pl-10' : ''}
            ${isPassword ? 'pr-10' : ''}
            ${error 
              ? 'border-error-500 focus:border-error-500 focus:ring-error-500' 
              : 'border-secondary-200 focus:border-primary-500 focus:ring-primary-500'
            }
            focus:outline-none focus:ring-2 focus:ring-opacity-20
            disabled:bg-secondary-50 disabled:cursor-not-allowed
          `}
          {...register}
          {...props}
        />
        
        {isPassword && (
          <button
            type="button"
            onClick={() => setShowPassword(!showPassword)}
            className="absolute right-3 top-1/2 -translate-y-1/2 text-secondary-400 hover:text-secondary-600"
          >
            {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}
          </button>
        )}
      </div>
      
      {error && (
        <p className="text-sm text-error-500 flex items-center gap-1">
          {error}
        </p>
      )}
    </div>
  );
};

export default Input;
/* FILE: src/components/common/Input2.tsx */
// src/components/common/Input2.tsx
import { Eye, EyeOff } from 'lucide-react';
import { useState } from 'react';
import type { FC , InputHTMLAttributes} from 'react';
import type { UseFormRegisterReturn } from 'react-hook-form';

// ✅ Type for Lucide Icon components
type LucideIconType = FC<{ size?: number | string; className?: string }>;

interface Input2Props extends Omit<InputHTMLAttributes<HTMLInputElement>, 'type'> {
  label?: string;
  error?: string;
  type?: 'text' | 'email' | 'password' | 'number' | 'tel';
  register?: UseFormRegisterReturn;
  icon?: LucideIconType; // ✅ Only accept Lucide component type
}

const Input2 = ({ 
  label, 
  error, 
  type = 'text',
  register,
  icon: IconComponent, // ✅ Renamed for clarity
  ...props 
}: Input2Props) => {
  const [showPassword, setShowPassword] = useState(false);
  const isPassword = type === 'password';
  const inputType = isPassword && showPassword ? 'text' : type;

  return (
    <div className="space-y-2">
      {label && (
        <label className="block text-sm font-medium text-secondary-700">
          {label}
          {props.required && <span className="text-error-500 ml-1">*</span>}
        </label>
      )}
      
      <div className="relative">
        {IconComponent && (
          <div className="absolute left-3 top-1/2 -translate-y-1/2 text-secondary-400">
            {/* ✅ Properly render the Lucide icon component */}
            <IconComponent size={20} />
          </div>
        )}
        
        <input
          type={inputType}
          className={`
            w-full px-4 py-3 rounded-lg border-2 transition-all
            ${IconComponent ? 'pl-10' : ''}
            ${isPassword ? 'pr-10' : ''}
            ${error 
              ? 'border-error-500 focus:border-error-500 focus:ring-error-500' 
              : 'border-secondary-200 focus:border-primary-500 focus:ring-primary-500'
            }
            focus:outline-none focus:ring-2 focus:ring-opacity-20
            disabled:bg-secondary-50 disabled:cursor-not-allowed
          `}
          {...register}
          {...props}
        />
        
        {isPassword && (
          <button
            type="button"
            onClick={() => setShowPassword(!showPassword)}
            className="absolute right-3 top-1/2 -translate-y-1/2 text-secondary-400 hover:text-secondary-600"
          >
            {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}
          </button>
        )}
      </div>

      {error && (
        <p className="text-sm text-error-500">{error}</p>
      )}
    </div>
  );
};

export default Input2;
/* FILE: src/components/common/LocationPicker.tsx */
// src/components/common/LocationPicker.tsx
import { useState, useEffect, useRef } from 'react';
import { MapPin, Loader2 } from 'lucide-react';

interface LocationPickerProps {
  onLocationSelect: (location: { lat: number; lng: number }) => void;
  initialLocation?: { lat: number; lng: number } | null;
  error?: string;
}

const LocationPicker = ({ 
  onLocationSelect, 
  initialLocation = null,
  error 
}: LocationPickerProps) => {
  const [map, setMap] = useState<google.maps.Map | null>(null);
  const [marker, setMarker] = useState<google.maps.Marker | null>(null);
  const [loading, setLoading] = useState(true);
  const [selectedLocation, setSelectedLocation] = useState<{ lat: number; lng: number } | null>(initialLocation);
  const mapRef = useRef<HTMLDivElement>(null);

  // useEffect(() => {
  //   const initMap = async () => {
  //     try {
  //       const loader = new Loader({
  //         apiKey: import.meta.env.VITE_GOOGLE_MAPS_API_KEY || '',
  //         version: 'weekly',
  //       });

  //       await loader.load();

  //       if (!mapRef.current) return;

  //       const mapInstance = new google.maps.Map(mapRef.current, {
  //         center: initialLocation || { lat: 24.8607, lng: 67.0011 }, // Karachi default
  //         zoom: 12,
  //         mapTypeControl: false,
  //       });

  //       setMap(mapInstance);

  //       // Add click listener
  //       mapInstance.addListener('click', (e: google.maps.MapMouseEvent) => {
  //         if (e.latLng) {
  //           const lat = e.latLng.lat();
  //           const lng = e.latLng.lng();
  //           updateLocation(lat, lng, mapInstance);
  //         }
  //       });

  //       // Set initial marker if location provided
  //       if (initialLocation) {
  //         updateLocation(initialLocation.lat, initialLocation.lng, mapInstance);
  //       }

  //       setLoading(false);
  //     } catch (error) {
  //       console.error('Error loading Google Maps:', error);
  //       setLoading(false);
  //     }
  //   };

  //   initMap();
  // }, []);

    useEffect(() => {
      const initMap = async () => {
        try {
          // Dynamically load Maps JS API
          await google.maps.importLibrary('maps');

          if (!mapRef.current) return;

          const map = new google.maps.Map(mapRef.current, {
            center: initialLocation ?? { lat: 24.8607, lng: 67.0011 },
            zoom: 12,
            mapTypeControl: false,
          });

          setMap(map);
          setLoading(false);
        } catch (err) {
          console.error('Google Maps failed to load:', err);
          setLoading(false);
        }
      };

      initMap();
    }, []);

  const updateLocation = (lat: number, lng: number, mapInstance: google.maps.Map) => {
    // Remove old marker
    if (marker) {
      marker.setMap(null);
    }

    // Create new marker
    const newMarker = new google.maps.Marker({
      position: { lat, lng },
      map: mapInstance,
      draggable: true,
    });

    // Update marker drag
    newMarker.addListener('dragend', (e: google.maps.MapMouseEvent) => {
      if (e.latLng) {
        const newLat = e.latLng.lat();
        const newLng = e.latLng.lng();
        setSelectedLocation({ lat: newLat, lng: newLng });
        onLocationSelect({ lat: newLat, lng: newLng });
      }
    });

    setMarker(newMarker);
    setSelectedLocation({ lat, lng });
    onLocationSelect({ lat, lng });
  };

  const getCurrentLocation = () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          if (map) {
            map.setCenter({ lat, lng });
            updateLocation(lat, lng, map);
          }
        },
        () => {
          alert('Could not get your location');
        }
      );
    } else {
      alert('Geolocation is not supported by your browser');
    }
  };

  return (
    <div className="space-y-2">
      <label className="block text-sm font-medium text-secondary-700">
        Select Location on Map
        <span className="text-error-500 ml-1">*</span>
      </label>

      <div className="relative">
        {loading && (
          <div className="absolute inset-0 bg-secondary-100 rounded-lg flex items-center justify-center z-10">
            <Loader2 className="w-8 h-8 animate-spin text-primary-500" />
          </div>
        )}
        
        <div 
          ref={mapRef}
          className="w-full h-64 rounded-lg border-2 border-secondary-200"
        />
        
        <button
          type="button"
          onClick={getCurrentLocation}
          className="absolute bottom-4 right-4 bg-white p-3 rounded-lg shadow-lg hover:shadow-xl transition-shadow border border-secondary-200"
        >
          <MapPin size={20} className="text-primary-500" />
        </button>
      </div>

      {selectedLocation && (
        <div className="text-sm text-secondary-600 bg-secondary-50 p-3 rounded-lg">
          <strong>Selected:</strong> {selectedLocation.lat.toFixed(6)}, {selectedLocation.lng.toFixed(6)}
        </div>
      )}

      {error && (
        <p className="text-sm text-error-500">{error}</p>
      )}
    </div>
  );
};

export default LocationPicker;
/* FILE: src/components/common/LocationPickerSimple.tsx */
// src/components/common/LocationPickerSimple.tsx
import { MapPin } from 'lucide-react';
import { useEffect } from 'react';

interface LocationPickerSimpleProps {
  onLocationSelect: (location: { lat: number; lng: number }) => void;
  initialLocation?: { lat: number; lng: number } | null;
  error?: string;
  currentLat?: number;
  currentLng?: number;
}

const LocationPickerSimple = ({ 
  onLocationSelect, 
  initialLocation = null,
  error,
  currentLat,
  currentLng
}: LocationPickerSimpleProps) => {
  
  // Update parent when initial location changes
  useEffect(() => {
    if (initialLocation) {
      onLocationSelect(initialLocation);
    }
  }, [initialLocation]);

  const handleLatChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const lat = parseFloat(e.target.value);
    if (!isNaN(lat)) {
      onLocationSelect({ 
        lat, 
        lng: currentLng || initialLocation?.lng || 0 
      });
    }
  };

  const handleLngChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const lng = parseFloat(e.target.value);
    if (!isNaN(lng)) {
      onLocationSelect({ 
        lat: currentLat || initialLocation?.lat || 0, 
        lng 
      });
    }
  };

  const getCurrentLocation = () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          onLocationSelect({ lat, lng });
        },
        () => {
          alert('Could not get your location. Please check location permissions.');
        }
      );
    } else {
      alert('Geolocation is not supported by your browser');
    }
  };

  const displayLat = currentLat || initialLocation?.lat || '';
  const displayLng = currentLng || initialLocation?.lng || '';

  return (
    <div className="space-y-2">
      <label className="block text-sm font-medium text-secondary-700">
        Business Location Coordinates
        <span className="text-error-500 ml-1">*</span>
      </label>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-xs text-secondary-600 mb-1">Latitude</label>
          <input
            type="number"
            step="any"
            placeholder="24.8607"
            value={displayLat}
            onChange={handleLatChange}
            className={`
              w-full px-4 py-3 rounded-lg border-2 transition-all
              ${error 
                ? 'border-error-500 focus:border-error-500 focus:ring-error-500' 
                : 'border-secondary-200 focus:border-primary-500 focus:ring-primary-500'
              }
              focus:outline-none focus:ring-2 focus:ring-opacity-20
            `}
          />
        </div>

        <div>
          <label className="block text-xs text-secondary-600 mb-1">Longitude</label>
          <input
            type="number"
            step="any"
            placeholder="67.0011"
            value={displayLng}
            onChange={handleLngChange}
            className={`
              w-full px-4 py-3 rounded-lg border-2 transition-all
              ${error 
                ? 'border-error-500 focus:border-error-500 focus:ring-error-500' 
                : 'border-secondary-200 focus:border-primary-500 focus:ring-primary-500'
              }
              focus:outline-none focus:ring-2 focus:ring-opacity-20
            `}
          />
        </div>
      </div>

      <button
        type="button"
        onClick={getCurrentLocation}
        className="flex items-center gap-2 px-4 py-2 text-sm text-primary-600 bg-primary-50 rounded-lg hover:bg-primary-100 transition-colors"
      >
        <MapPin size={16} />
        Use My Current Location
      </button>

      {error && (
        <p className="text-sm text-error-500">{error}</p>
      )}

      {displayLat && displayLng && (
        <div className="bg-success-50 border border-success-200 rounded-lg p-3">
          <p className="text-xs text-success-700 font-medium">
            ✓ Location Set: {displayLat}, {displayLng}
          </p>
        </div>
      )}

      <p className="text-xs text-secondary-500">
        💡 Tip: Select your address above and coordinates will auto-fill, or use "Use My Current Location"
      </p>
    </div>
  );
};

export default LocationPickerSimple;
/* FILE: src/components/common/Pagination.tsx */
// FILE PATH: src/components/common/Pagination.tsx

/**
 * Pagination Component
 * 
 * Handles pagination display and navigation.
 * Works with Laravel's pagination response format.
 * 
 * Features:
 * - Previous/Next buttons
 * - Page number display
 * - Total items count
 * - Responsive design
 */

import React from 'react';

interface PaginationProps {
  currentPage: number;
  lastPage: number;
  total: number;
  perPage: number;
  onPageChange: (page: number) => void;
  loading?: boolean;
}

const Pagination: React.FC<PaginationProps> = ({ 
  currentPage, 
  lastPage, 
  total, 
  perPage,
  onPageChange,
  loading = false 
}) => {
  // ✅ FIX: Handle edge cases properly
  const startItem = total === 0 ? 0 : Math.max(1, ((currentPage - 1) * perPage) + 1);
  const endItem = total === 0 ? 0 : Math.min(currentPage * perPage, total);

  const handlePrevious = () => {
    if (currentPage > 1 && !loading) {
      onPageChange(currentPage - 1);
    }
  };

  const handleNext = () => {
    if (currentPage < lastPage && !loading) {
      onPageChange(currentPage + 1);
    }
  };

  const handlePageClick = (page: number) => {
    if (page !== currentPage && !loading) {
      onPageChange(page);
    }
  };

  // Generate page numbers to display
  const getPageNumbers = (): (number | string)[] => {
    const pages: (number | string)[] = [];
    const maxPagesToShow = 5;
    
    if (lastPage <= maxPagesToShow) {
      // Show all pages if total pages is less than max
      for (let i = 1; i <= lastPage; i++) {
        pages.push(i);
      }
    } else {
      // Show first, last, current, and nearby pages
      const start = Math.max(1, currentPage - 2);
      const end = Math.min(lastPage, currentPage + 2);
      
      if (start > 1) {
        pages.push(1);
        if (start > 2) pages.push('...');
      }
      
      for (let i = start; i <= end; i++) {
        pages.push(i);
      }
      
      if (end < lastPage) {
        if (end < lastPage - 1) pages.push('...');
        pages.push(lastPage);
      }
    }
    
    return pages;
  };

  if (total === 0) {
    return null;
  }

  return (
    <div className="flex items-center justify-between px-4 py-3 bg-white border-t border-gray-200 sm:px-6">
      {/* Mobile view */}
      <div className="flex justify-between flex-1 sm:hidden">
        <button
          onClick={handlePrevious}
          disabled={currentPage === 1 || loading}
          className="relative inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Previous
        </button>
        <button
          onClick={handleNext}
          disabled={currentPage === lastPage || loading}
          className="relative ml-3 inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Next
        </button>
      </div>

      {/* Desktop view */}
      <div className="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
        <div>
          <p className="text-sm text-gray-700">
            Showing <span className="font-medium">{startItem}</span> to{' '}
            <span className="font-medium">{endItem}</span> of{' '}
            <span className="font-medium">{total}</span> results
          </p>
        </div>
        <div>
          <nav className="inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
            {/* Previous Button */}
            <button
              onClick={handlePrevious}
              disabled={currentPage === 1 || loading}
              className="relative inline-flex items-center px-2 py-2 text-gray-400 rounded-l-md border border-gray-300 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <span className="sr-only">Previous</span>
              <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clipRule="evenodd" />
              </svg>
            </button>

            {/* Page Numbers */}
            {getPageNumbers().map((page, index) => (
              page === '...' ? (
                <span
                  key={`ellipsis-${index}`}
                  className="relative inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300"
                >
                  ...
                </span>
              ) : (
                <button
                  key={`page-${page}`}
                  onClick={() => handlePageClick(Number(page))}
                  disabled={loading}
                  className={`relative inline-flex items-center px-4 py-2 text-sm font-medium border ${
                    page === currentPage
                      ? 'z-10 bg-blue-600 border-blue-600 text-white'
                      : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50'
                  } ${loading ? 'cursor-not-allowed opacity-50' : ''}`}
                >
                  {page}
                </button>
              )
            ))}

            {/* Next Button */}
            <button
              onClick={handleNext}
              disabled={currentPage === lastPage || loading}
              className="relative inline-flex items-center px-2 py-2 text-gray-400 rounded-r-md border border-gray-300 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <span className="sr-only">Next</span>
              <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clipRule="evenodd" />
              </svg>
            </button>
          </nav>
        </div>
      </div>
    </div>
  );
};

export default Pagination;
/* FILE: src/components/common/PermissionGate.tsx */
// src/components/common/PermissionGate.tsx
// ============================================
// PERMISSION GATE COMPONENT
// Use this to conditionally render UI based on permissions
// ============================================

import type { JSX, ReactNode } from 'react';
import { usePermissions } from '../../hooks/usePermissions';
import type { Permission, Role } from '../../config/permissions';

// ==================== MAIN PERMISSION GATE ====================

interface PermissionGateProps {
  /** Single permission to check */
  permission?: Permission;
  /** Multiple permissions to check */
  permissions?: Permission[];
  /** If true, requires ALL permissions. Default: any one permission is enough */
  requireAll?: boolean;
  /** Specific roles to allow (bypasses permission check) */
  allowedRoles?: Role[];
  /** Content to show if permission denied */
  fallback?: ReactNode;
  /** Children to render if permission granted */
  children: ReactNode;
}

/**
 * PermissionGate - Conditionally renders children based on user permissions
 *
 * @example
 * // Single permission
 * <PermissionGate permission="pricing.view_cost_price">
 *   <CostPriceColumn />
 * </PermissionGate>
 *
 * @example
 * // Multiple permissions (any)
 * <PermissionGate permissions={['orders.edit', 'orders.create']}>
 *   <OrderActions />
 * </PermissionGate>
 *
 * @example
 * // Multiple permissions (all required)
 * <PermissionGate permissions={['orders.edit', 'pricing.edit_supplier_rates']} requireAll>
 *   <AdvancedPricingEditor />
 * </PermissionGate>
 *
 * @example
 * // With fallback
 * <PermissionGate permission="orders.edit" fallback={<ViewOnlyBadge />}>
 *   <EditButton />
 * </PermissionGate>
 *
 * @example
 * // Role-based (bypasses permissions)
 * <PermissionGate allowedRoles={['admin']}>
 *   <DangerZone />
 * </PermissionGate>
 */
const PermissionGate = ({
  permission,
  permissions = [],
  requireAll = false,
  allowedRoles,
  fallback = null,
  children,
}: PermissionGateProps): JSX.Element => {
  const { role, hasPermission, hasAnyPermission, hasAllPermissions } = usePermissions();

  // If allowedRoles is specified, check role directly
  if (allowedRoles && allowedRoles.length > 0) {
    if (role && allowedRoles.includes(role)) {
      return <>{children}</>;
    }
    return <>{fallback}</>;
  }

  // Single permission check
  if (permission) {
    return hasPermission(permission) ? <>{children}</> : <>{fallback}</>;
  }

  // Multiple permissions check
  if (permissions.length > 0) {
    const hasAccess = requireAll
      ? hasAllPermissions(permissions)
      : hasAnyPermission(permissions);
    return hasAccess ? <>{children}</> : <>{fallback}</>;
  }

  // No permission specified, render children
  return <>{children}</>;
};

export default PermissionGate;


// ==================== SPECIALIZED GATE COMPONENTS ====================

/**
 * AdminOnlyGate - Only renders for admin users
 */
export const AdminOnlyGate = ({
  children,
  fallback = null,
}: {
  children: ReactNode;
  fallback?: ReactNode;
}): JSX.Element => {
  return (
    <PermissionGate allowedRoles={['admin']} fallback={fallback}>
      {children}
    </PermissionGate>
  );
};

/**
 * ReadOnlyGate - Shows content for read-only users (accountant)
 * Useful for showing "Read Only" badges or alternative UI
 */
export const ReadOnlyGate = ({
  children,
  fallback = null,
}: {
  children: ReactNode;
  fallback?: ReactNode;
}): JSX.Element => {
  return (
    <PermissionGate allowedRoles={['accountant']} fallback={fallback}>
      {children}
    </PermissionGate>
  );
};

/**
 * EditableGate - Shows edit controls for users who can edit
 * Excludes accountant role
 */
export const EditableGate = ({
  permission,
  children,
  fallback = null,
}: {
  permission: Permission;
  children: ReactNode;
  fallback?: ReactNode;
}): JSX.Element => {
  const { role, hasPermission } = usePermissions();

  // Accountant is always read-only
  if (role === 'accountant') {
    return <>{fallback}</>;
  }

  return hasPermission(permission) ? <>{children}</> : <>{fallback}</>;
};


// ==================== PRICING GATES ====================

/**
 * CostPriceGate - Shows cost price for authorized users
 * Admin, Accountant, Supplier can see cost price
 * Support and Client cannot
 */
export const CostPriceGate = ({
  children,
  fallback = null,
}: {
  children: ReactNode;
  fallback?: ReactNode;
}): JSX.Element => {
  return (
    <PermissionGate permission="pricing.view_cost_price" fallback={fallback}>
      {children}
    </PermissionGate>
  );
};

/**
 * ProfitMarginGate - Shows profit margin for authorized users
 * Admin, Accountant, Supplier can see profit margin
 * Support and Client cannot
 */
export const ProfitMarginGate = ({
  children,
  fallback = null,
}: {
  children: ReactNode;
  fallback?: ReactNode;
}): JSX.Element => {
  return (
    <PermissionGate permission="pricing.view_profit_margin" fallback={fallback}>
      {children}
    </PermissionGate>
  );
};


// ==================== ORDER GATES ====================

/**
 * OrderEditGate - Shows order edit controls
 */
export const OrderEditGate = ({
  children,
  fallback = null,
}: {
  children: ReactNode;
  fallback?: ReactNode;
}): JSX.Element => {
  return (
    <PermissionGate permission="orders.edit" fallback={fallback}>
      {children}
    </PermissionGate>
  );
};

/**
 * OrderCreateGate - Shows order create controls
 */
export const OrderCreateGate = ({
  children,
  fallback = null,
}: {
  children: ReactNode;
  fallback?: ReactNode;
}): JSX.Element => {
  return (
    <PermissionGate permission="orders.create" fallback={fallback}>
      {children}
    </PermissionGate>
  );
};

/**
 * MarkDeliveredGate - Shows mark delivered button
 */
export const MarkDeliveredGate = ({
  children,
  fallback = null,
}: {
  children: ReactNode;
  fallback?: ReactNode;
}): JSX.Element => {
  return (
    <PermissionGate permission="orders.mark_delivered" fallback={fallback}>
      {children}
    </PermissionGate>
  );
};


// ==================== USER MANAGEMENT GATES ====================

/**
 * UserEditGate - Shows user edit controls
 */
export const UserEditGate = ({
  children,
  fallback = null,
}: {
  children: ReactNode;
  fallback?: ReactNode;
}): JSX.Element => {
  return (
    <PermissionGate permission="users.edit" fallback={fallback}>
      {children}
    </PermissionGate>
  );
};

/**
 * UserDeleteGate - Shows user delete controls
 */
export const UserDeleteGate = ({
  children,
  fallback = null,
}: {
  children: ReactNode;
  fallback?: ReactNode;
}): JSX.Element => {
  return (
    <PermissionGate permission="users.delete" fallback={fallback}>
      {children}
    </PermissionGate>
  );
};


// ==================== INLINE PERMISSION CHECK COMPONENT ====================

interface ShowIfProps {
  /** Permission to check */
  can: Permission;
  /** Content to render if permitted */
  children: ReactNode;
  /** Optional content if not permitted */
  else?: ReactNode;
}

/**
 * ShowIf - Inline permission check with cleaner syntax
 *
 * @example
 * <ShowIf can="pricing.view_cost_price">
 *   ${costPrice}
 * </ShowIf>
 *
 * @example
 * <ShowIf can="orders.edit" else={<span>View Only</span>}>
 *   <EditButton />
 * </ShowIf>
 */
export const ShowIf = ({ can, children, else: elseContent = null }: ShowIfProps): JSX.Element => {
  const { hasPermission } = usePermissions();
  return hasPermission(can) ? <>{children}</> : <>{elseContent}</>;
};


// ==================== HIDE IF COMPONENT ====================

interface HideIfProps {
  /** Permission to check - hides if user HAS this permission */
  can: Permission;
  /** Content to render if NOT permitted */
  children: ReactNode;
}

/**
 * HideIf - Hides content if user HAS the permission
 * Useful for showing alternative content for lower-privilege users
 *
 * @example
 * <HideIf can="pricing.view_cost_price">
 *   <span>Cost price hidden</span>
 * </HideIf>
 */
export const HideIf = ({ can, children }: HideIfProps): JSX.Element => {
  const { hasPermission } = usePermissions();
  return !hasPermission(can) ? <>{children}</> : <></>;
};
/* FILE: src/components/common/StatusBadge.tsx */
// FILE PATH: src/components/common/StatusBadge.tsx

/**
 * StatusBadge Component
 * 
 * Displays approval status as a badge with toggle functionality.
 * - Green badge for "Active" (is_approved = 1)
 * - Red badge for "Inactive" (is_approved = 0)
 * - Optional: Click to toggle status (with confirmation)
 */

import React from 'react';

interface StatusBadgeProps {
  isApproved: boolean;
  onToggle?: () => void;
  loading?: boolean;
  disabled?: boolean;
}

const StatusBadge: React.FC<StatusBadgeProps> = ({ 
  isApproved, 
  onToggle, 
  loading = false,
  disabled = false 
}) => {
  const handleClick = () => {
    if (onToggle && !disabled && !loading) {
      onToggle();
    }
  };

  const baseClasses = "px-3 py-1 rounded-full text-xs font-semibold inline-flex items-center gap-2";
  const interactiveClasses = onToggle && !disabled 
    ? "cursor-pointer hover:opacity-80 transition-opacity" 
    : "";
  
  const statusClasses = isApproved
    ? "bg-green-100 text-green-800 border border-green-300"
    : "bg-red-100 text-red-800 border border-red-300";

  return (
    <span 
      className={`${baseClasses} ${statusClasses} ${interactiveClasses} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}
      onClick={handleClick}
      title={onToggle ? 'Click to toggle status' : ''}
    >
      <span className={`w-2 h-2 rounded-full ${isApproved ? 'bg-green-500' : 'bg-red-500'}`}></span>
      {loading ? (
        <span className="animate-pulse">Processing...</span>
      ) : (
        <span>{isApproved ? 'Active' : 'Inactive'}</span>
      )}
    </span>
  );
};

export default StatusBadge;
/* FILE: src/components/common/Toaster.tsx */
// src/components/common/Toaster.jsx
import { Toaster } from 'react-hot-toast';

const ToasterProvider = () => {
  return (
    <Toaster
      position="top-right"
      toastOptions={{
        duration: 4000,
        style: {
          background: '#fff',
          color: '#0f172a',
          padding: '16px',
          borderRadius: '8px',
          boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
        },
        success: {
          iconTheme: {
            primary: '#10b981',
            secondary: '#fff',
          },
        },
        error: {
          iconTheme: {
            primary: '#ef4444',
            secondary: '#fff',
          },
        },
      }}
    />
  );
};

export default ToasterProvider;
/* FILE: src/components/layout/DashboardLayout.tsx */
// src/components/layout/DashboardLayout.tsx
import { useState } from 'react';
import type { ReactNode } from 'react';
import { Link, useNavigate, useLocation } from 'react-router-dom';
import { 
  Menu, 
  X, 
  LogOut, 
  User, 
  Settings,
  ChevronDown
} from 'lucide-react';
import { useAuthStore } from '../../store/authStore';
import toast from 'react-hot-toast';

interface DashboardLayoutProps {
  children: ReactNode;
  menuItems: Array<{
    label: string;
    path: string;
    icon: ReactNode;
  }>;
}

const DashboardLayout = ({ children, menuItems }: DashboardLayoutProps) => {
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [profileDropdown, setProfileDropdown] = useState(false);
  const { user, logout } = useAuthStore();
  const navigate = useNavigate();
  const location = useLocation();

  const handleLogout = () => {
    logout();
    toast.success('Logged out successfully');
    navigate('/login');
  };

  // ✅ Navigate to profile page based on user role
  const handleProfileClick = () => {
    setProfileDropdown(false);
    navigate(`/${user?.role}/profile`);
  };

  const isActive = (path: string) => location.pathname === path;

  return (
    <div className="min-h-screen bg-secondary-50">
      {/* Header */}
      <header className="bg-white border-b border-secondary-200 fixed top-0 left-0 right-0 z-40">
        <div className="flex items-center justify-between px-4 py-4">
          {/* Mobile Menu Button */}
          <button
            onClick={() => setSidebarOpen(!sidebarOpen)}
            className="lg:hidden p-2 rounded-lg hover:bg-secondary-100 transition-colors"
          >
            {sidebarOpen ? <X size={24} /> : <Menu size={24} />}
          </button>

          {/* Logo */}
          <div className="flex items-center gap-3">
            <img
              src="https://demowebportals.com/material_connect/public/assets/img/logo-text.png"
              alt="Material Connect"
              className="h-8"
            />
          </div>

          {/* Profile Dropdown */}
          <div className="relative">
            <button
              onClick={() => setProfileDropdown(!profileDropdown)}
              className="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-secondary-100 transition-colors"
            >
              <div className="w-10 h-10 rounded-full bg-primary-500 flex items-center justify-center text-white font-medium">
                {user?.profile_image ? (
                  <img
                    src={`${import.meta.env.VITE_IMAGE_BASE_URL}${user.profile_image}`}
                    alt={user.name}
                    className="w-full h-full rounded-full object-cover"
                  />) : (
                  user?.name.charAt(0).toUpperCase()
                )}
              </div>
              <div className="hidden md:block text-left">
                <p className="text-sm font-medium text-secondary-900">{user?.name}</p>
                <p className="text-xs text-secondary-500 capitalize">{user?.role}</p>
              </div>
              <ChevronDown size={16} className="text-secondary-400" />
            </button>

            {/* Dropdown Menu */}
            {profileDropdown && (
              <>
                <div
                  className="fixed inset-0 z-40"
                  onClick={() => setProfileDropdown(false)}
                />
                <div className="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-secondary-200 py-2 z-50">
                  <div className="px-4 py-3 border-b border-secondary-200">
                    <p className="text-sm font-medium text-secondary-900">{user?.name}</p>
                    <p className="text-xs text-secondary-500">{user?.email}</p>
                  </div>
                  
                  {/* ✅ Profile button with navigation */}
                  <button 
                    onClick={handleProfileClick}
                    className="w-full px-4 py-2 text-left text-sm text-secondary-700 hover:bg-secondary-50 flex items-center gap-2 transition-colors"
                  >
                    <User size={16} />
                    Profile Settings
                  </button>
                  
                  <button className="w-full px-4 py-2 text-left text-sm text-secondary-700 hover:bg-secondary-50 flex items-center gap-2 transition-colors">
                    <Settings size={16} />
                    Settings
                  </button>
                  
                  <hr className="my-2 border-secondary-200" />
                  
                  <button
                    onClick={handleLogout}
                    className="w-full px-4 py-2 text-left text-sm text-error-600 hover:bg-error-50 flex items-center gap-2 transition-colors"
                  >
                    <LogOut size={16} />
                    Logout
                  </button>
                </div>
              </>
            )}
          </div>
        </div>
      </header>

      {/* Sidebar */}
      <aside
        className={`
          fixed top-16 left-0 bottom-0 w-64 bg-white border-r border-secondary-200 z-30 transition-transform duration-300
          ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}
          lg:translate-x-0
        `}
      >
        <nav className="p-4 space-y-2">
          {menuItems.map((item) => (
            <Link
              key={item.path}
              to={item.path}
              onClick={() => setSidebarOpen(false)}
              className={`
                flex items-center gap-3 px-4 py-3 rounded-lg transition-all
                ${
                  isActive(item.path)
                    ? 'bg-primary-50 text-primary-600 font-medium'
                    : 'text-secondary-700 hover:bg-secondary-50'
                }
              `}
            >
              {item.icon}
              {item.label}
            </Link>
          ))}
        </nav>
      </aside>

      {/* Main Content */}
      <main className="pt-16 lg:pl-64">
        <div className="p-6">
          {children}
        </div>
      </main>

      {/* Mobile Overlay */}
      {sidebarOpen && (
        <div
          className="fixed inset-0 bg-black/50 z-20 lg:hidden"
          onClick={() => setSidebarOpen(false)}
        />
      )}
    </div>
  );
};

export default DashboardLayout;
/* FILE: src/components/order/FloatingCartBadge.tsx */
// src/components/order/FloatingCartBadge.tsx
import React, { useState } from 'react';
import { ShoppingCart, X, Plus, Minus, Trash2, Package } from 'lucide-react';
import type { CartItem } from '../../types/order.types';
import Button from '../common/Buttons';

interface FloatingCartBadgeProps {
  itemCount: number;
  cartItems: CartItem[];
  onUpdateQuantity: (productId: number, quantity: number) => void;
  onRemoveItem: (productId: number) => void;
  onProceedToCheckout: () => void;
}

const FloatingCartBadge: React.FC<FloatingCartBadgeProps> = ({
  itemCount,
  cartItems,
  onUpdateQuantity,
  onRemoveItem,
  onProceedToCheckout,
}) => {
  const [isOpen, setIsOpen] = useState(false);

  const getImageUrl = (photo: string) => {
    return photo.startsWith('http')
      ? photo
      : `${import.meta.env.VITE_API_BASE_URL?.replace('/api', '/storage')}/${photo}`;
  };

  const handleProceed = () => {
    setIsOpen(false);
    onProceedToCheckout();
  };

  return (
    <>
      {/* Floating Badge Button */}
      <button
        onClick={() => setIsOpen(true)}
        className="fixed bottom-6 right-6 z-40 bg-primary-600 hover:bg-primary-700 text-white rounded-full p-4 shadow-2xl hover:shadow-primary-300 transition-all hover:scale-110 active:scale-95"
        aria-label="View cart"
      >
        <ShoppingCart size={24} />
        {itemCount > 0 && (
          <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full w-7 h-7 flex items-center justify-center border-2 border-white animate-bounce">
            {itemCount}
          </span>
        )}
      </button>

      {/* Sidebar Overlay */}
      {isOpen && (
        <>
          {/* Backdrop */}
          <div
            className="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 animate-fadeIn"
            onClick={() => setIsOpen(false)}
          />

          {/* Sidebar */}
          <div className="fixed top-0 right-0 h-full w-full sm:w-96 bg-white shadow-2xl z-50 animate-slideInRight overflow-hidden flex flex-col">
            {/* Header */}
            <div className="bg-gradient-to-r from-primary-600 to-primary-700 p-4 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <ShoppingCart className="text-white" size={24} />
                <div>
                  <h3 className="text-white font-bold text-lg">Your Cart</h3>
                  <p className="text-primary-100 text-xs">{itemCount} item(s)</p>
                </div>
              </div>
              <button
                onClick={() => setIsOpen(false)}
                className="text-white/80 hover:text-white transition-colors p-1 hover:bg-white/10 rounded-lg"
              >
                <X size={24} />
              </button>
            </div>

            {/* Cart Items */}
            <div className="flex-1 overflow-y-auto p-4">
              {cartItems.length === 0 ? (
                <div className="flex flex-col items-center justify-center h-full text-center space-y-4">
                  <div className="w-20 h-20 bg-secondary-100 rounded-full flex items-center justify-center">
                    <Package className="text-secondary-400" size={40} />
                  </div>
                  <div>
                    <p className="font-semibold text-secondary-900">Your cart is empty</p>
                    <p className="text-sm text-secondary-600 mt-1">Add some products to get started</p>
                  </div>
                </div>
              ) : (
                <div className="space-y-3">
                  {cartItems.map((item) => (
                    <div
                      key={item.product_id}
                      className="bg-white border-2 border-secondary-200 rounded-xl p-3 hover:border-primary-300 transition-all"
                    >
                      <div className="flex gap-3">
                        {/* Product Image */}
                        <div className="w-16 h-16 rounded-lg overflow-hidden bg-secondary-100 flex-shrink-0">
                          <img
                            src={getImageUrl(item.product_photo)}
                            alt={item.product_name}
                            className="w-full h-full object-cover"
                            onError={(e) => {
                              const target = e.target as HTMLImageElement;
                              target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjZTVlN2ViIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMCIgZmlsbD0iIzljYTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==';
                            }}
                          />
                        </div>

                        {/* Product Info */}
                        <div className="flex-1 min-w-0">
                          <h4 className="font-semibold text-secondary-900 text-sm truncate">
                            {item.product_name}
                          </h4>
                          <p className="text-xs text-secondary-600">{item.product_type}</p>
                          <p className="text-xs text-primary-600 font-medium mt-1">
                            Unit: {item.unit_of_measure}
                          </p>

                          {/* Quantity Controls */}
                          <div className="flex items-center gap-2 mt-2">
                            <button
                              onClick={() => onUpdateQuantity(item.product_id, item.quantity - 1)}
                              className="w-7 h-7 rounded-lg bg-secondary-100 hover:bg-secondary-200 flex items-center justify-center transition-colors"
                              disabled={item.quantity <= 1}
                            >
                              <Minus size={14} />
                            </button>
                            <span className="w-10 text-center font-semibold text-sm">
                              {item.quantity}
                            </span>
                            <button
                              onClick={() => onUpdateQuantity(item.product_id, item.quantity + 1)}
                              className="w-7 h-7 rounded-lg bg-primary-100 hover:bg-primary-200 flex items-center justify-center transition-colors text-primary-700"
                            >
                              <Plus size={14} />
                            </button>
                            <button
                              onClick={() => onRemoveItem(item.product_id)}
                              className="ml-auto w-7 h-7 rounded-lg bg-red-50 hover:bg-red-100 flex items-center justify-center transition-colors text-red-600"
                              title="Remove item"
                            >
                              <Trash2 size={14} />
                            </button>
                          </div>
                        </div>
                      </div>

                      {/* Custom Blend Note */}
                      {item.custom_blend_mix && (
                        <div className="mt-2 text-xs bg-amber-50 border border-amber-200 rounded px-2 py-1">
                          <span className="font-semibold text-amber-900">Custom Mix:</span>
                          <span className="text-amber-800 ml-1">{item.custom_blend_mix}</span>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Footer */}
            {cartItems.length > 0 && (
              <div className="border-t border-secondary-200 p-4 bg-secondary-50 space-y-3">
                {/* Pricing Note */}
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                  <p className="text-xs text-blue-900 leading-relaxed">
                    💡 <span className="font-semibold">Pricing:</span> Final costs will be 
                    calculated based on delivery location. You'll receive an invoice within 
                    20 minutes after placing your order.
                  </p>
                </div>

                {/* Proceed Button */}
                <Button
                  onClick={handleProceed}
                  variant="primary"
                  fullWidth
                  className="py-3 text-base font-semibold"
                >
                  Proceed to Checkout →
                </Button>
              </div>
            )}
          </div>
        </>
      )}
    </>
  );
};

export default FloatingCartBadge;
/* FILE: src/components/order/OrderWizard.tsx */
// src/components/order/OrderWizard.tsx
import React from 'react';
import { ShoppingCart, MapPin, CheckCircle } from 'lucide-react';


interface OrderWizardProps {
  currentStep: number;
  onStepChange: (step: number) => void;
  children: React.ReactNode;
}

const steps = [
  { number: 1, title: 'Products', icon: ShoppingCart, description: 'Select items' },
  { number: 2, title: 'Details', icon: MapPin, description: 'Project & delivery' },
  { number: 3, title: 'Review', icon: CheckCircle, description: 'Confirm order' },
];

const OrderWizard: React.FC<OrderWizardProps> = ({ currentStep, onStepChange, children }) => {
  return (
    <div className="space-y-6">
      {/* Progress Steps - Mobile & Desktop */}
      <div className="bg-white rounded-xl shadow-sm border border-secondary-200 p-6">
        {/* Desktop: Horizontal Steps */}
        <div className="hidden md:flex items-center justify-between">
          {steps.map((step, index) => {
            const isActive = currentStep === step.number;
            const isCompleted = currentStep > step.number;
            const Icon = step.icon;

            return (
              <React.Fragment key={step.number}>
                {/* Step Circle */}
                <div className="flex flex-col items-center flex-1">
                  <button
                    onClick={() => {
                      // Only allow going back to previous steps
                      if (step.number < currentStep) {
                        onStepChange(step.number);
                      }
                    }}
                    disabled={step.number > currentStep}
                    className={`
                      flex items-center justify-center w-14 h-14 rounded-full border-2 transition-all
                      ${isActive 
                        ? 'bg-primary-600 border-primary-600 text-white shadow-lg shadow-primary-200' 
                        : isCompleted 
                        ? 'bg-green-500 border-green-500 text-white' 
                        : 'bg-white border-secondary-300 text-secondary-400'
                      }
                      ${step.number < currentStep ? 'cursor-pointer hover:scale-110' : 'cursor-not-allowed'}
                    `}
                  >
                    <Icon size={24} />
                  </button>
                  <div className="mt-3 text-center">
                    <p className={`text-sm font-semibold ${isActive ? 'text-primary-600' : 'text-secondary-600'}`}>
                      {step.title}
                    </p>
                    <p className="text-xs text-secondary-500">{step.description}</p>
                  </div>
                </div>

                {/* Connector Line */}
                {index < steps.length - 1 && (
                  <div className={`h-0.5 flex-1 mx-4 transition-all ${
                    currentStep > step.number ? 'bg-green-500' : 'bg-secondary-200'
                  }`} />
                )}
              </React.Fragment>
            );
          })}
        </div>

        {/* Mobile: Vertical Steps */}
        <div className="md:hidden space-y-4">
          {steps.map((step) => {
            const isActive = currentStep === step.number;
            const isCompleted = currentStep > step.number;
            const Icon = step.icon;

            return (
              <div
                key={step.number}
                className={`flex items-center gap-4 p-3 rounded-lg transition-all ${
                  isActive ? 'bg-primary-50 border-2 border-primary-300' : 'bg-secondary-50'
                }`}
              >
                <div
                  className={`
                    flex items-center justify-center w-12 h-12 rounded-full border-2 transition-all
                    ${isActive 
                      ? 'bg-primary-600 border-primary-600 text-white' 
                      : isCompleted 
                      ? 'bg-green-500 border-green-500 text-white' 
                      : 'bg-white border-secondary-300 text-secondary-400'
                    }
                  `}
                >
                  <Icon size={20} />
                </div>
                <div className="flex-1">
                  <p className={`font-semibold ${isActive ? 'text-primary-600' : 'text-secondary-900'}`}>
                    Step {step.number}: {step.title}
                  </p>
                  <p className="text-xs text-secondary-600">{step.description}</p>
                </div>
                {isCompleted && (
                  <CheckCircle className="text-green-500" size={20} />
                )}
              </div>
            );
          })}
        </div>
      </div>

      {/* Step Content */}
      <div className="animate-fadeIn">
        {children}
      </div>
    </div>
  );
};

export default OrderWizard;
/* FILE: src/components/order/ProductCard.tsx */
// src/components/order/ProductCard.tsx
import { ShoppingCart, Check, Eye } from 'lucide-react';
import type { Product } from '../../types/order.types';
import Button from '../common/Buttons';

interface ProductCardProps {
  product: Product;
  isInCart: boolean;
  onAddToCart: (product: Product) => void;
  onViewDetails?: (product: Product) => void;
}

const ProductCard = ({ product, isInCart, onAddToCart, onViewDetails }: ProductCardProps) => {
  const imageUrl = product.photo.startsWith('http') 
    ? product.photo 
    : `${import.meta.env.VITE_API_BASE_URL?.replace('/api', '/storage')}/${product.photo}`;

  return (
    <div className="group bg-white rounded-xl border-2 border-secondary-200 hover:border-primary-300 hover:shadow-lg transition-all overflow-hidden">
      {/* Product Image */}
      <div className="relative aspect-square overflow-hidden bg-secondary-100">
        <img
          src={imageUrl}
          alt={product.product_name}
          className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
          onError={(e) => {
            const target = e.target as HTMLImageElement;
            target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgZmlsbD0iI2YzZjRmNiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM5Y2EzYWYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5ObyBJbWFnZTwvdGV4dD48L3N2Zz4=';
          }}
        />
        
        {/* Category Badge */}
        <div className="absolute top-3 left-3">
          <span className="bg-white/90 backdrop-blur-sm text-xs font-semibold text-primary-700 px-3 py-1 rounded-full shadow-sm">
            {product.category.name}
          </span>
        </div>

        {/* Quick Actions Overlay */}
        {onViewDetails && (
          <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex items-end justify-center pb-4">
            <button
              onClick={() => onViewDetails(product)}
              className="bg-white hover:bg-primary-50 text-primary-700 px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 shadow-lg transform translate-y-4 group-hover:translate-y-0 transition-transform"
            >
              <Eye size={16} />
              View Details
            </button>
          </div>
        )}
      </div>

      {/* Product Info */}
      <div className="p-4 space-y-3">
        <div>
          <h3 className="font-bold text-secondary-900 text-lg truncate">
            {product.product_name}
          </h3>
          <p className="text-sm text-secondary-600">{product.product_type}</p>
        </div>

        {/* Unit of Measure */}
        <div className="flex items-center justify-between py-2 px-3 bg-secondary-50 rounded-lg">
          <span className="text-xs text-secondary-600 font-medium">Unit:</span>
          <span className="text-sm font-bold text-secondary-900">{product.unit_of_measure}</span>
        </div>

        {/* Specifications Preview */}
        <p className="text-xs text-secondary-600 line-clamp-2">
          {product.specifications}
        </p>

        {/* Add to Cart Button */}
        <Button
          onClick={() => !isInCart && onAddToCart(product)}
          disabled={isInCart}
          variant={isInCart ? 'outline' : 'primary'}
          fullWidth
          className="mt-3"
        >
          {isInCart ? (
            <>
              <Check size={18} />
              In Cart
            </>
          ) : (
            <>
              <ShoppingCart size={18} />
              Add to Cart
            </>
          )}
        </Button>
      </div>
    </div>
  );
};

export default ProductCard;
/* FILE: src/components/order/ProductDetailModal.tsx */
// src/components/order/ProductDetailModal.tsx
import React from 'react';
import { X, Package, Tag, Ruler, FileText, Info } from 'lucide-react';
import type { Product } from '../../types/order.types';
import Button from '../common/Buttons';

interface ProductDetailModalProps {
  isOpen: boolean;
  onClose: () => void;
  product: Product | null;
  isInCart: boolean;
  onAddToCart: (product: Product) => void;
}

const ProductDetailModal: React.FC<ProductDetailModalProps> = ({
  isOpen,
  onClose,
  product,
  isInCart,
  onAddToCart,
}) => {
  if (!isOpen || !product) return null;

  const getImageUrl = (photo: string) => {
    return photo.startsWith('http')
      ? photo
      : `${import.meta.env.VITE_API_BASE_URL?.replace('/api', '/storage')}/${photo}`;
  };

  const getTechDocUrl = (techDoc: string | null) => {
    if (!techDoc) return null;
    return techDoc.startsWith('http')
      ? techDoc
      : `${import.meta.env.VITE_API_BASE_URL?.replace('/api', '')}/${techDoc}`;
  };

  const handleAddToCart = () => {
    onAddToCart(product);
    onClose();
  };

  return (
    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden animate-fadeIn">
        {/* Header */}
        <div className="bg-gradient-to-r from-primary-600 to-primary-700 px-6 py-4 flex items-center justify-between">
          <h2 className="text-xl font-bold text-white">Product Details</h2>
          <button
            onClick={onClose}
            className="text-white/80 hover:text-white transition-colors p-1 hover:bg-white/10 rounded-lg"
          >
            <X size={24} />
          </button>
        </div>

        {/* Content */}
        <div className="overflow-y-auto max-h-[calc(90vh-140px)]">
          <div className="grid md:grid-cols-2 gap-6 p-6">
            {/* Left: Image */}
            <div className="space-y-4">
              <div className="aspect-square rounded-xl overflow-hidden bg-secondary-100 border-2 border-secondary-200">
                <img
                  src={getImageUrl(product.photo)}
                  alt={product.product_name}
                  className="w-full h-full object-cover"
                  onError={(e) => {
                    const target = e.target as HTMLImageElement;
                    target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgZmlsbD0iI2YzZjRmNiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM5Y2EzYWYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5ObyBJbWFnZTwvdGV4dD48L3N2Zz4=';
                  }}
                />
              </div>

              {/* Category Badge */}
              <div className="flex items-center gap-2 bg-primary-50 border border-primary-200 rounded-lg px-4 py-2">
                <Tag className="text-primary-600" size={18} />
                <span className="text-sm font-medium text-primary-700">
                  {product.category.name}
                </span>
              </div>
            </div>

            {/* Right: Details */}
            <div className="space-y-6">
              {/* Product Name */}
              <div>
                <h3 className="text-2xl font-bold text-secondary-900 mb-2">
                  {product.product_name}
                </h3>
                <div className="flex items-center gap-2 text-secondary-600">
                  <Package size={18} />
                  <span className="font-medium">{product.product_type}</span>
                </div>
              </div>

              {/* Unit of Measure */}
              <div className="bg-secondary-50 rounded-lg p-4 border border-secondary-200">
                <div className="flex items-center gap-2 mb-1">
                  <Ruler className="text-secondary-600" size={18} />
                  <span className="text-sm font-semibold text-secondary-700">
                    Unit of Measure
                  </span>
                </div>
                <p className="text-lg font-bold text-secondary-900 ml-7">
                  {product.unit_of_measure}
                </p>
              </div>

              {/* Specifications */}
              <div>
                <div className="flex items-center gap-2 mb-3">
                  <Info className="text-secondary-600" size={20} />
                  <h4 className="font-semibold text-secondary-900">Specifications</h4>
                </div>
                <p className="text-secondary-700 leading-relaxed bg-secondary-50 rounded-lg p-4 border border-secondary-200">
                  {product.specifications}
                </p>
              </div>

              {/* Technical Documentation */}
              {product.tech_doc && (
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <div className="flex items-center gap-2 mb-2">
                    <FileText className="text-blue-600" size={18} />
                    <span className="text-sm font-semibold text-blue-900">
                      Technical Documentation
                    </span>
                  </div>
                  <a
                    href={getTechDocUrl(product.tech_doc) || '#'}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-sm text-blue-600 hover:text-blue-700 underline"
                  >
                    Download Technical Specifications →
                  </a>
                </div>
              )}

              {/* Pricing Note */}
              <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                <p className="text-sm text-amber-900 leading-relaxed">
                  <span className="font-semibold">📋 Note:</span> Final pricing will be 
                  calculated after order placement based on delivery location and supplier 
                  availability. You'll receive a detailed invoice within 20 minutes of 
                  order confirmation.
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* Footer */}
        <div className="border-t border-secondary-200 px-6 py-4 bg-secondary-50">
          <div className="flex items-center justify-between gap-4">
            <Button
              type="button"
              variant="outline"
              onClick={onClose}
              fullWidth={false}
              className="px-6"
            >
              Close
            </Button>
            <Button
              type="button"
              variant={isInCart ? 'outline' : 'primary'}
              onClick={handleAddToCart}
              disabled={isInCart}
              fullWidth={false}
              className="px-8"
            >
              {isInCart ? '✓ Already in Cart' : '+ Add to Cart'}
            </Button>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ProductDetailModal;
/* FILE: src/components/order/Step2_ProjectDelivery.tsx */
// src/components/order/Step2_ProjectDelivery.tsx
import React, { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import {
  MapPin,
  Calendar,
  Clock,
  FileText,
  Building2,
  Plus,
  ChevronDown,
  Search,
  User,
  Phone,
  AlertCircle,
  Edit2,
  RotateCcw,
  Minus,
  Trash2,
} from 'lucide-react';
import Autocomplete from 'react-google-autocomplete';
import { orderFormSchema } from '../../utils/validators';
import type { OrderFormValues } from '../../utils/validators';
import type { CartItem, Project } from '../../types/order.types';
import Button from '../common/Buttons';
import Input from '../common/Input';

interface Step2Props {
  cartItems: CartItem[];
  projects: Project[];
  onSubmit: (data: OrderFormValues) => void;
  onBack: () => void;
  isSubmitting: boolean;
  onCreateProject?: () => void;
  onUpdateQuantity: (productId: number, quantity: number) => void;
  onRemoveItem: (productId: number) => void;
  onUpdateCustomBlend?: (productId: number, blend: string) => void;
}

const Step2_ProjectDelivery: React.FC<Step2Props> = ({
  cartItems,
  projects,
  onSubmit,
  onBack,
  isSubmitting,
  onCreateProject,
  onUpdateQuantity,
  onRemoveItem,
  onUpdateCustomBlend,
}) => {
  const [selectedProject, setSelectedProject] = useState<Project | null>(null);
  const [showProjectDropdown, setShowProjectDropdown] = useState(false);
  const [projectSearchTerm, setProjectSearchTerm] = useState('');
  const [isEditingAddress, setIsEditingAddress] = useState(false);
  const [addressKey, setAddressKey] = useState(0);

  const {
    register,
    handleSubmit,
    setValue,
    watch,
    formState: { errors },
  } = useForm<OrderFormValues>({
    resolver: zodResolver(orderFormSchema),
  });

  const watchDeliveryAddress = watch('delivery_address');
  // const watchDeliveryLat = watch('delivery_lat');
  // const watchDeliveryLong = watch('delivery_long');

  useEffect(() => {
    if (projects.length === 1 && !selectedProject) {
      handleProjectSelect(projects[0]);
    }
  }, [projects]);

  const handleProjectSelect = (project: Project) => {
    setSelectedProject(project);
    setValue('project_id', project.id, { shouldValidate: true });
    
    if (project.delivery_address && project.delivery_lat && project.delivery_long) {
      setValue('delivery_address', project.delivery_address, { shouldValidate: true });
      setValue('delivery_lat', Number(project.delivery_lat), { shouldValidate: true });
      setValue('delivery_long', Number(project.delivery_long), { shouldValidate: true });
      setIsEditingAddress(false);
      setAddressKey(prev => prev + 1);
    }
    
    setShowProjectDropdown(false);
    setProjectSearchTerm('');
  };

  const handlePlaceSelected = (place: any) => {
    if (place.formatted_address) {
      setValue('delivery_address', place.formatted_address, { shouldValidate: true });
    }
    if (place.geometry?.location) {
      const lat = Number(place.geometry.location.lat());
      const lng = Number(place.geometry.location.lng());
      setValue('delivery_lat', lat, { shouldValidate: true });
      setValue('delivery_long', lng, { shouldValidate: true });
    }
  };

  const handleResetToProjectAddress = () => {
    if (selectedProject?.delivery_address && selectedProject?.delivery_lat && selectedProject?.delivery_long) {
      setValue('delivery_address', selectedProject.delivery_address, { shouldValidate: true });
      setValue('delivery_lat', Number(selectedProject.delivery_lat), { shouldValidate: true });
      setValue('delivery_long', Number(selectedProject.delivery_long), { shouldValidate: true });
      setIsEditingAddress(false);
      setAddressKey(prev => prev + 1);
    }
  };

  const filteredProjects = projects.filter((project) =>
    project.name.toLowerCase().includes(projectSearchTerm.toLowerCase())
  );

  const handleQuantityChange = (productId: number, value: string) => {
    const quantity = parseInt(value);
    if (!isNaN(quantity) && quantity > 0) {
      onUpdateQuantity(productId, quantity);
    }
  };

  const handleIncrement = (productId: number, currentQuantity: number) => {
    onUpdateQuantity(productId, currentQuantity + 1);
  };

  const handleDecrement = (productId: number, currentQuantity: number) => {
    if (currentQuantity > 1) {
      onUpdateQuantity(productId, currentQuantity - 1);
    }
  };

  const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
      <div className="grid lg:grid-cols-3 gap-6">
        {/* LEFT: Order Summary with EDITABLE QUANTITIES */}
        <div className="lg:col-span-1">
          <div className="bg-white rounded-xl shadow-sm border border-secondary-200 p-5 lg:sticky lg:top-6">
            <h3 className="font-bold text-secondary-900 mb-4 flex items-center gap-2">
              <FileText size={20} className="text-primary-600" />
              Order Summary
            </h3>

            <div className="space-y-4">
              {cartItems.map((item) => (
                <div
                  key={item.product_id}
                  className="pb-4 border-b border-secondary-100 last:border-0"
                >
                  {/* Product Info */}
                  <div className="flex items-start gap-3 mb-3">
                    <div className="w-14 h-14 rounded-lg bg-secondary-100 flex-shrink-0 overflow-hidden">
                      <img
                        src={
                          item.product_photo.startsWith('http')
                            ? item.product_photo
                            : `${import.meta.env.VITE_IMAGE_BASE_URL}storage/${item.product_photo}`
                        }
                        alt={item.product_name}
                        className="w-full h-full object-cover"
                      />
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="font-semibold text-secondary-900 text-sm">
                        {item.product_name}
                      </p>
                      <p className="text-xs text-secondary-600 mt-1">
                        {item.product_type}
                      </p>
                    </div>
                    <button
                      type="button"
                      onClick={() => {
                        if (window.confirm(`Remove ${item.product_name}?`)) {
                          onRemoveItem(item.product_id);
                        }
                      }}
                      className="text-red-500 hover:text-red-700 p-1"
                      title="Remove item"
                    >
                      <Trash2 size={16} />
                    </button>
                  </div>

                  {/* Quantity Controls */}
                  <div className="flex items-center gap-2">
                    <button
                      type="button"
                      onClick={() => handleDecrement(item.product_id, item.quantity)}
                      disabled={item.quantity <= 1}
                      className={`w-8 h-8 rounded-lg border flex items-center justify-center ${
                        item.quantity <= 1
                          ? 'border-secondary-200 text-secondary-400 cursor-not-allowed'
                          : 'border-secondary-300 hover:border-primary-500 hover:bg-primary-50 text-secondary-700'
                      }`}
                    >
                      <Minus size={14} />
                    </button>
                    
                    <input
                      type="number"
                      value={item.quantity}
                      onChange={(e) => handleQuantityChange(item.product_id, e.target.value)}
                      min="1"
                      className="w-16 px-2 py-1.5 border border-secondary-300 rounded-lg text-center text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-primary-500"
                    />
                    
                    <button
                      type="button"
                      onClick={() => handleIncrement(item.product_id, item.quantity)}
                      className="w-8 h-8 rounded-lg border border-secondary-300 hover:border-primary-500 hover:bg-primary-50 text-secondary-700 flex items-center justify-center"
                    >
                      <Plus size={14} />
                    </button>
                    
                    <span className="text-xs text-secondary-600 ml-1">
                      {item.unit_of_measure}
                    </span>
                  </div>

                  {/* Custom Blend Input */}
                  {onUpdateCustomBlend && (
                    <div className="mt-3">
                      <input
                        type="text"
                        value={item.custom_blend_mix || ''}
                        onChange={(e) => onUpdateCustomBlend(item.product_id, e.target.value)}
                        placeholder="Custom blend (optional)"
                        className="w-full px-3 py-2 border border-secondary-300 rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-primary-500"
                      />
                    </div>
                  )}
                </div>
              ))}
            </div>

            <div className="mt-4 pt-4 border-t border-secondary-200 space-y-2">
              <div className="flex justify-between text-sm">
                <span className="text-secondary-600">Total Items:</span>
                <span className="font-bold text-secondary-900">{cartItems.length}</span>
              </div>
              <div className="flex justify-between text-sm">
                <span className="text-secondary-600">Total Quantity:</span>
                <span className="font-bold text-secondary-900">{totalItems} units</span>
              </div>
            </div>

            <div className="mt-4 pt-4 border-t border-secondary-200">
              <Button
                type="button"
                onClick={onBack}
                variant="outline"
                className="w-full"
              >
                ← Add More Products
              </Button>
            </div>
          </div>
        </div>

        {/* RIGHT: Form Fields */}
        <div className="lg:col-span-2 space-y-6">
          {/* Section 1: Project Selection */}
          <div className="bg-white rounded-xl shadow-sm border border-secondary-200 p-6">
            {/* Validation Errors Summary */}
            {Object.keys(errors).length > 0 && (
              <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                <div className="flex items-start gap-2">
                  <AlertCircle className="text-red-600 flex-shrink-0 mt-0.5" size={18} />
                  <div>
                    <p className="text-sm font-semibold text-red-900">Please fix the following errors:</p>
                    <ul className="mt-2 text-sm text-red-800 list-disc list-inside space-y-1">
                      {Object.entries(errors).map(([key, error]) => (
                        <li key={key}>{error.message}</li>
                      ))}
                    </ul>
                  </div>
                </div>
              </div>
            )}
            
            <div className="flex items-center gap-2 mb-4">
              <Building2 className="text-primary-600" size={22} />
              <h3 className="font-bold text-secondary-900">Select Project</h3>
            </div>

            <div className="relative">
              <button
                type="button"
                onClick={() => setShowProjectDropdown(!showProjectDropdown)}
                className={`
                  w-full flex items-center justify-between px-4 py-3 border rounded-lg
                  transition-all
                  ${
                    selectedProject
                      ? 'border-primary-500 bg-primary-50'
                      : 'border-secondary-300 bg-white hover:border-primary-400'
                  }
                `}
              >
                <span className={selectedProject ? 'text-secondary-900 font-medium' : 'text-secondary-500'}>
                  {selectedProject ? selectedProject.name : 'Choose a project...'}
                </span>
                <ChevronDown
                  size={20}
                  className={`transition-transform ${showProjectDropdown ? 'rotate-180' : ''}`}
                />
              </button>

              {showProjectDropdown && (
                <div className="absolute z-10 w-full mt-2 bg-white border border-secondary-300 rounded-lg shadow-lg max-h-80 overflow-hidden">
                  <div className="p-3 border-b border-secondary-200">
                    <div className="relative">
                      <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-secondary-400" size={18} />
                      <input
                        type="text"
                        placeholder="Search projects..."
                        value={projectSearchTerm}
                        onChange={(e) => setProjectSearchTerm(e.target.value)}
                        className="w-full pl-10 pr-4 py-2 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                      />
                    </div>
                  </div>

                  <div className="max-h-60 overflow-y-auto">
                    {filteredProjects.length > 0 ? (
                      filteredProjects.map((project) => (
                        <button
                          key={project.id}
                          type="button"
                          onClick={() => handleProjectSelect(project)}
                          className="w-full px-4 py-3 text-left hover:bg-secondary-50 transition-colors border-b border-secondary-100 last:border-0"
                        >
                          <p className="font-medium text-secondary-900">{project.name}</p>
                          {project.site_contact_name && (
                            <p className="text-sm text-secondary-600 mt-1">Contact: {project.site_contact_name}</p>
                          )}
                        </button>
                      ))
                    ) : (
                      <div className="px-4 py-8 text-center text-secondary-500">
                        No projects found
                      </div>
                    )}
                  </div>

                  {onCreateProject && (
                    <div className="p-3 border-t border-secondary-200">
                      <button
                        type="button"
                        onClick={onCreateProject}
                        className="w-full flex items-center justify-center gap-2 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors"
                      >
                        <Plus size={18} />
                        Create New Project
                      </button>
                    </div>
                  )}
                </div>
              )}
              
              {errors.project_id && (
                <p className="mt-2 text-sm text-red-600">{errors.project_id.message}</p>
              )}
            </div>

            {selectedProject && (
              <div className="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                <p className="font-medium text-blue-900 mb-2">{selectedProject.name}</p>
                {selectedProject.site_contact_name && (
                  <div className="flex items-center gap-2 text-sm text-blue-800 mt-1">
                    <User size={14} />
                    <span>{selectedProject.site_contact_name}</span>
                  </div>
                )}
                {selectedProject.site_contact_phone && (
                  <div className="flex items-center gap-2 text-sm text-blue-800 mt-1">
                    <Phone size={14} />
                    <span>{selectedProject.site_contact_phone}</span>
                  </div>
                )}
              </div>
            )}
          </div>

          {/* Section 2: Delivery Details */}
          <div className="bg-white rounded-xl shadow-sm border border-secondary-200 p-6">
            <div className="flex items-center gap-2 mb-4">
              <MapPin className="text-primary-600" size={22} />
              <h3 className="font-bold text-secondary-900">Delivery Details</h3>
            </div>

            <div className="space-y-4">
              {/* PO Number */}
              <Input
                label="PO Number (Optional)"
                placeholder="Enter PO number if you have one"
                {...register('po_number')}
                error={errors.po_number?.message}
              />

              {/* Delivery Address */}
              <div>
                <label className="block text-sm font-medium text-secondary-700 mb-2">
                  Delivery Address *
                </label>
                {!isEditingAddress && watchDeliveryAddress ? (
                  <div className="flex items-start gap-2">
                    <div className="flex-1 px-4 py-3 bg-secondary-50 border border-secondary-200 rounded-lg">
                      <p className="text-sm text-secondary-900">{watchDeliveryAddress}</p>
                    </div>
                    <button
                      type="button"
                      onClick={() => setIsEditingAddress(true)}
                      className="p-3 border border-secondary-300 rounded-lg hover:bg-secondary-50"
                      title="Edit address"
                    >
                      <Edit2 size={18} />
                    </button>
                    {selectedProject?.delivery_address && watchDeliveryAddress !== selectedProject.delivery_address && (
                      <button
                        type="button"
                        onClick={handleResetToProjectAddress}
                        className="p-3 border border-secondary-300 rounded-lg hover:bg-secondary-50"
                        title="Reset to project address"
                      >
                        <RotateCcw size={18} />
                      </button>
                    )}
                  </div>
                ) : (
                  <Autocomplete
                    key={addressKey}
                    apiKey={import.meta.env.VITE_GOOGLE_MAPS_API_KEY}
                    onPlaceSelected={handlePlaceSelected}
                    options={{
                      types: ['address'],
                      componentRestrictions: { country: 'au' },
                    }}
                    defaultValue={watchDeliveryAddress || ''}
                    className="w-full px-4 py-3 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    placeholder="Start typing to search address..."
                  />
                )}
                {errors.delivery_address && (
                  <p className="mt-2 text-sm text-red-600">{errors.delivery_address.message}</p>
                )}
                {errors.delivery_lat && (
                  <p className="mt-2 text-sm text-red-600">{errors.delivery_lat.message}</p>
                )}
                {errors.delivery_long && (
                  <p className="mt-2 text-sm text-red-600">{errors.delivery_long.message}</p>
                )}
                
                {/* Hidden inputs for lat/long */}
                <input type="hidden" {...register('delivery_lat')} />
                <input type="hidden" {...register('delivery_long')} />
              </div>

              {/* Date and Time */}
              <div className="grid md:grid-cols-2 gap-4">
                {/* Delivery Date */}
                <div>
                  <label className="block text-sm font-medium text-secondary-700 mb-2">
                    Delivery Date *
                  </label>
                  <div className="relative">
                    <Calendar className="absolute left-3 top-1/2 -translate-y-1/2 text-secondary-400" size={20} />
                    <input
                      type="date"
                      {...register('delivery_date')}
                      className="w-full pl-10 px-4 py-3 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    />
                  </div>
                  {errors.delivery_date && (
                    <p className="mt-2 text-sm text-red-600">{errors.delivery_date.message}</p>
                  )}
                </div>

                {/* Delivery Time */}
                <div>
                  <label className="block text-sm font-medium text-secondary-700 mb-2">
                    Delivery Time *
                  </label>
                  <div className="relative">
                    <Clock className="absolute left-3 top-1/2 -translate-y-1/2 text-secondary-400" size={20} />
                    <input
                      type="time"
                      {...register('delivery_time')}
                      className="w-full pl-10 px-4 py-3 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    />
                  </div>
                  {errors.delivery_time && (
                    <p className="mt-2 text-sm text-red-600">{errors.delivery_time.message}</p>
                  )}
                </div>
              </div>

              {/* Load Size */}
              <Input
                label="Load Size *"
                placeholder="e.g., 6 cubic meters"
                {...register('load_size')}
                error={errors.load_size?.message}
              />

              {/* Special Equipment */}
              <Input
                label="Special Equipment (Optional)"
                placeholder="Any special equipment required"
                {...register('special_equipment')}
                error={errors.special_equipment?.message}
              />

              {/* Special Notes */}
              <div>
                <label className="block text-sm font-medium text-secondary-700 mb-2">
                  Special Notes (Optional)
                </label>
                <textarea
                  {...register('special_notes')}
                  rows={3}
                  className="w-full px-4 py-3 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  placeholder="Any special instructions or notes..."
                />
                {errors.special_notes && (
                  <p className="mt-2 text-sm text-red-600">{errors.special_notes.message}</p>
                )}
              </div>
            </div>
          </div>

          {/* Action Buttons */}
          <div className="flex gap-4">
            <Button
              type="button"
              onClick={onBack}
              variant="outline"
              className="flex-1"
            >
              ← Back
            </Button>
            <Button
              type="submit"
              disabled={isSubmitting || cartItems.length === 0}
              className="flex-1"
            >
              {isSubmitting ? 'Processing...' : 'Continue to Review →'}
            </Button>
          </div>
        </div>
      </div>
    </form>
  );
};

export default Step2_ProjectDelivery;
/* FILE: src/components/order/Step3_ReviewOrder.tsx */
// src/components/order/Step3_ReviewOrder.tsx
/**
 * STEP 3: REVIEW ORDER
 * 
 * Final review screen before order submission
 * - Shows complete order summary
 * - Displays all cart items
 * - Shows project and delivery details
 * - Confirms pricing note
 * - Has final "Place Order" button
 */

import React from 'react';
import { 
  Package, 
  MapPin, 
  Calendar, 
  Clock, 
  Truck, 
  FileText, 
  Building2,
  User,
  Phone,
  Edit,
  CheckCircle2,
  AlertCircle
} from 'lucide-react';
import type { CartItem, Project } from '../../types/order.types';
import type { OrderFormValues } from '../../utils/validators';
import Button from '../common/Buttons';

interface Step3Props {
  cartItems: CartItem[];
  orderDetails: OrderFormValues;
  selectedProject: Project | null;
  onBack: () => void;
  onConfirm: () => void;
  isSubmitting: boolean;
}

const Step3_ReviewOrder: React.FC<Step3Props> = ({
  cartItems,
  orderDetails,
  selectedProject,
  onBack,
  onConfirm,
  isSubmitting,
}) => {
  const getImageUrl = (photo: string) => {
    return photo.startsWith('http')
      ? photo
      : `${import.meta.env.VITE_API_BASE_URL?.replace('/api', '/storage')}/${photo}`;
  };

  const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);

  // const deliveryMethods: Record<string, string> = {
  //   Other: 'Other',
  //   Tipper: '🚛 Tipper',
  //   Agitator: '🔄 Agitator',
  //   Pump: '⚙️ Pump',
  //   Ute: '🚐 Ute',
  // };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-200 rounded-xl p-6">
        <div className="flex items-center gap-3 mb-2">
          <div className="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
            <CheckCircle2 className="text-white" size={28} />
          </div>
          <div>
            <h2 className="text-2xl font-bold text-secondary-900">Review Your Order</h2>
            <p className="text-secondary-600">Please review all details before placing your order</p>
          </div>
        </div>
      </div>

      <div className="grid lg:grid-cols-3 gap-6">
        {/* LEFT COLUMN: Order Items */}
        <div className="lg:col-span-2 space-y-6">
          
          {/* Cart Items */}
          <div className="bg-white rounded-xl shadow-sm border border-secondary-200 p-6">
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-2">
                <Package className="text-primary-600" size={24} />
                <h3 className="font-bold text-secondary-900">Order Items</h3>
              </div>
              <span className="text-sm font-semibold text-primary-600 bg-primary-50 px-3 py-1 rounded-full">
                {totalItems} item{totalItems !== 1 ? 's' : ''}
              </span>
            </div>

            <div className="space-y-3">
              {cartItems.map((item) => (
                <div
                  key={item.product_id}
                  className="flex items-start gap-4 p-4 bg-secondary-50 rounded-lg border border-secondary-200"
                >
                  {/* Product Image */}
                  <div className="w-20 h-20 rounded-lg overflow-hidden bg-white flex-shrink-0 border border-secondary-200">
                    <img
                      src={getImageUrl(item.product_photo)}
                      alt={item.product_name}
                      className="w-full h-full object-cover"
                      onError={(e) => {
                        const target = e.target as HTMLImageElement;
                        target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjZTVlN2ViIi8+PC9zdmc+';
                      }}
                    />
                  </div>

                  {/* Product Details */}
                  <div className="flex-1">
                    <h4 className="font-semibold text-secondary-900">{item.product_name}</h4>
                    <p className="text-sm text-secondary-600 mt-1">{item.product_type}</p>
                    
                    <div className="flex items-center gap-4 mt-2">
                      <div className="text-sm">
                        <span className="text-secondary-600">Quantity:</span>
                        <span className="font-semibold text-secondary-900 ml-2">
                          {item.quantity} {item.unit_of_measure}
                        </span>
                      </div>
                    </div>

                    {/* Custom Blend */}
                    {item.custom_blend_mix && (
                      <div className="mt-2 bg-amber-50 border border-amber-200 rounded px-3 py-2">
                        <p className="text-xs font-semibold text-amber-900">Custom Blend Mix:</p>
                        <p className="text-sm text-amber-800">{item.custom_blend_mix}</p>
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Project Details */}
          {selectedProject && (
            <div className="bg-white rounded-xl shadow-sm border border-secondary-200 p-6">
              <div className="flex items-center gap-2 mb-4">
                <Building2 className="text-primary-600" size={24} />
                <h3 className="font-bold text-secondary-900">Project Information</h3>
              </div>

              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <p className="font-semibold text-blue-900 mb-3">{selectedProject.name}</p>
                
                <div className="space-y-2">
                  {selectedProject.site_contact_name && (
                    <div className="flex items-center gap-2 text-sm text-blue-800">
                      <User size={16} />
                      <span>{selectedProject.site_contact_name}</span>
                    </div>
                  )}
                  
                  {selectedProject.site_contact_phone && (
                    <div className="flex items-center gap-2 text-sm text-blue-800">
                      <Phone size={16} />
                      <span>{selectedProject.site_contact_phone}</span>
                    </div>
                  )}
                  
                  {selectedProject.site_instructions && (
                    <div className="mt-3 pt-3 border-t border-blue-300">
                      <p className="text-xs font-semibold text-blue-900 mb-1">Site Instructions:</p>
                      <p className="text-sm text-blue-800">{selectedProject.site_instructions}</p>
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* Delivery Details */}
          <div className="bg-white rounded-xl shadow-sm border border-secondary-200 p-6">
            <div className="flex items-center gap-2 mb-4">
              <Truck className="text-primary-600" size={24} />
              <h3 className="font-bold text-secondary-900">Delivery Information</h3>
            </div>

            <div className="space-y-4">
              {/* PO Number */}
              {orderDetails.po_number && (
                <div className="flex items-start gap-3">
                  <FileText className="text-secondary-500 flex-shrink-0 mt-0.5" size={18} />
                  <div>
                    <p className="text-sm font-medium text-secondary-600">PO Number</p>
                    <p className="text-base font-semibold text-secondary-900">{orderDetails.po_number}</p>
                  </div>
                </div>
              )}

              {/* Address */}
              <div className="flex items-start gap-3">
                <MapPin className="text-secondary-500 flex-shrink-0 mt-0.5" size={18} />
                <div>
                  <p className="text-sm font-medium text-secondary-600">Delivery Address</p>
                  <p className="text-base text-secondary-900">{orderDetails.delivery_address}</p>
                </div>
              </div>

              {/* Date & Time */}
              <div className="grid md:grid-cols-2 gap-4">
                <div className="flex items-start gap-3">
                  <Calendar className="text-secondary-500 flex-shrink-0 mt-0.5" size={18} />
                  <div>
                    <p className="text-sm font-medium text-secondary-600">Delivery Date</p>
                    <p className="text-base font-semibold text-secondary-900">
                      {new Date(orderDetails.delivery_date).toLocaleDateString('en-US', {
                        weekday: 'short',
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                      })}
                    </p>
                  </div>
                </div>

                {orderDetails.delivery_time && (
                  <div className="flex items-start gap-3">
                    <Clock className="text-secondary-500 flex-shrink-0 mt-0.5" size={18} />
                    <div>
                      <p className="text-sm font-medium text-secondary-600">Preferred Time</p>
                      <p className="text-base font-semibold text-secondary-900">{orderDetails.delivery_time}</p>
                    </div>
                  </div>
                )}
              </div>

              {/* Delivery Method
              <div className="flex items-start gap-3">
                <Truck className="text-secondary-500 flex-shrink-0 mt-0.5" size={18} />
                <div>
                  <p className="text-sm font-medium text-secondary-600">Delivery Method</p>
                  <p className="text-base font-semibold text-secondary-900">
                    {deliveryMethods[orderDetails.delivery_method] || orderDetails.delivery_method}
                  </p>
                </div>
              </div> */}

              {/* Load Size */}
              {orderDetails.load_size && (
                <div className="flex items-start gap-3">
                  <Package className="text-secondary-500 flex-shrink-0 mt-0.5" size={18} />
                  <div>
                    <p className="text-sm font-medium text-secondary-600">Load Size</p>
                    <p className="text-base text-secondary-900">{orderDetails.load_size}</p>
                  </div>
                </div>
              )}

              {/* Special Equipment */}
              {orderDetails.special_equipment && (
                <div className="flex items-start gap-3">
                  <FileText className="text-secondary-500 flex-shrink-0 mt-0.5" size={18} />
                  <div>
                    <p className="text-sm font-medium text-secondary-600">Special Equipment</p>
                    <p className="text-base text-secondary-900">{orderDetails.special_equipment}</p>
                  </div>
                </div>
              )}

              {/* Special Notes */}
              {orderDetails.special_notes && (
                <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                  <p className="text-sm font-semibold text-amber-900 mb-1">Special Instructions:</p>
                  <p className="text-sm text-amber-800">{orderDetails.special_notes}</p>
                </div>
              )}

              {/* Repeat Order Flag */}
              {orderDetails.repeat_order && (
                <div className="flex items-center gap-2 text-sm text-green-700 bg-green-50 border border-green-200 rounded-lg px-3 py-2">
                  <CheckCircle2 size={16} />
                  <span className="font-medium">Marked as repeat order</span>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* RIGHT COLUMN: Summary & Actions */}
        <div className="lg:col-span-1">
          <div className="sticky top-6 space-y-4">
            
            {/* Order Summary Card */}
            <div className="bg-white rounded-xl shadow-sm border border-secondary-200 p-6">
              <h3 className="font-bold text-secondary-900 mb-4">Order Summary</h3>
              
              <div className="space-y-3 mb-4">
                <div className="flex justify-between text-sm">
                  <span className="text-secondary-600">Total Items:</span>
                  <span className="font-semibold text-secondary-900">{totalItems}</span>
                </div>
                <div className="flex justify-between text-sm">
                  <span className="text-secondary-600">Products:</span>
                  <span className="font-semibold text-secondary-900">{cartItems.length}</span>
                </div>
              </div>

              {/* Pricing Note */}
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div className="flex items-start gap-2 mb-2">
                  <AlertCircle className="text-blue-600 flex-shrink-0 mt-0.5" size={18} />
                  <p className="text-sm font-semibold text-blue-900">Pricing Information</p>
                </div>
                <p className="text-xs text-blue-800 leading-relaxed">
                  Final pricing will be calculated after order placement based on delivery location and supplier 
                  availability. You'll receive a detailed invoice within 20 minutes of order confirmation.
                </p>
              </div>
            </div>

            {/* Action Buttons */}
            <div className="space-y-3">
              <Button
                onClick={onConfirm}
                variant="primary"
                isLoading={isSubmitting}
                disabled={isSubmitting}
                fullWidth
                className="py-4 text-lg font-bold shadow-lg hover:shadow-xl"
              >
                {isSubmitting ? (
                  <>
                    <span className="animate-spin mr-2">⚙️</span>
                    Placing Order...
                  </>
                ) : (
                  <>
                    <CheckCircle2 size={24} className="mr-2" />
                    Place Order
                  </>
                )}
              </Button>

              <Button
                type="button"
                variant="outline"
                onClick={onBack}
                disabled={isSubmitting}
                fullWidth
                className="py-3"
              >
                <Edit size={18} className="mr-2" />
                Edit Order Details
              </Button>
            </div>

            {/* Confirmation Note */}
            <div className="bg-green-50 border border-green-200 rounded-lg p-4">
              <p className="text-xs text-green-800 leading-relaxed">
                ✅ By placing this order, you confirm that all details are correct and agree to receive 
                pricing and delivery confirmation via email.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Step3_ReviewOrder;
/* FILE: src/components/profile/ChangePasswordSection.tsx */
// src/components/profile/ChangePasswordSection.tsx
import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { useMutation } from '@tanstack/react-query';
import { ChevronDown, Lock, Shield } from 'lucide-react';
import toast from 'react-hot-toast';

import { profileAPI } from '../../api/handlers/profile.api';
import { useAuthStore } from '../../store/authStore';
import type { ChangePasswordFormData } from '../../utils/validators';
import { changePasswordSchema } from '../../utils/validators';
import Input from '../common/Input';
import Button from '../common/Buttons';

const ChangePasswordSection = () => {
  const [isExpanded, setIsExpanded] = useState(false);
  const { setToken } = useAuthStore();

  const {
    register,
    handleSubmit,
    formState: { errors },
    reset,
  } = useForm<ChangePasswordFormData>({
    resolver: zodResolver(changePasswordSchema),
  });

  const changePasswordMutation = useMutation({
    mutationFn: profileAPI.changePassword,
    onSuccess: (data) => {
      // Update token if backend returns a new one
      if (data.token) {
        setToken(data.token);
      }
      
      toast.success('🔒 Password changed successfully!');
      reset(); // Clear form
      setIsExpanded(false); // Collapse section
    },
    onError: (error: Error) => {
      toast.error(error.message || 'Failed to change password');
    },
  });

  const onSubmit = (data: ChangePasswordFormData) => {
    changePasswordMutation.mutate(data);
  };

  return (
    <div className="border-t border-secondary-200 pt-8 mt-8">
      {/* Header - Always Visible */}
      <button
        type="button"
        onClick={() => setIsExpanded(!isExpanded)}
        className="flex items-center justify-between w-full text-left group"
      >
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-lg bg-error-100 flex items-center justify-center group-hover:bg-error-200 transition-colors">
            <Shield size={20} className="text-error-600" />
          </div>
          <div>
            <h3 className="text-lg font-semibold text-secondary-900">
              Security Settings
            </h3>
            <p className="text-sm text-secondary-500">
              Update your password to keep your account secure
            </p>
          </div>
        </div>
        <ChevronDown
          size={24}
          className={`text-secondary-400 transition-transform duration-200 ${
            isExpanded ? 'rotate-180' : ''
          }`}
        />
      </button>

      {/* Expandable Content */}
      {isExpanded && (
        <div className="mt-6 bg-secondary-50 rounded-xl p-6 border border-secondary-200">
          <form onSubmit={handleSubmit(onSubmit)} className="space-y-5">
            <div className="flex items-center gap-2 mb-4 text-sm text-secondary-600">
              <Lock size={16} />
              <span>Your password must be at least 6 characters long</span>
            </div>

            <Input
              label="Current Password"
              type="password"
              placeholder="Enter your current password"
              icon={Lock}
              register={register('current_password')}
              error={errors.current_password?.message}
              required
            />

            <Input
              label="New Password"
              type="password"
              placeholder="Enter new password (min. 6 characters)"
              icon={Lock}
              register={register('new_password')}
              error={errors.new_password?.message}
              required
            />

            <Input
              label="Confirm New Password"
              type="password"
              placeholder="Re-enter new password"
              icon={Lock}
              register={register('new_password_confirmation')}
              error={errors.new_password_confirmation?.message}
              required
            />

            <div className="flex gap-3 pt-4">
              <Button
                type="submit"
                isLoading={changePasswordMutation.isPending}
                disabled={changePasswordMutation.isPending}
                fullWidth={false}
                className="flex-1"
              >
                <Lock size={18} />
                {changePasswordMutation.isPending
                  ? 'Changing Password...'
                  : 'Change Password'}
              </Button>

              <Button
                type="button"
                variant="outline"
                onClick={() => {
                  reset();
                  setIsExpanded(false);
                }}
                fullWidth={false}
                className="flex-1"
              >
                Cancel
              </Button>
            </div>
          </form>
        </div>
      )}
    </div>
  );
};

export default ChangePasswordSection;
/* FILE: src/components/supplier/AddOfferModal.tsx */
// FILE PATH: src/components/supplier/AddOfferModal.tsx
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { X, DollarSign, Package } from 'lucide-react';
import toast from 'react-hot-toast';
import type { MasterProduct } from '../../api/handlers/supplierProducts.api';
import {  supplierProductsAPI } from '../../api/handlers/supplierProducts.api';
import { addOfferSchema } from '../../utils/validators';
import type { AddOfferFormData } from '../../utils/validators';
import Input2 from '../common/Input2'; // ✅ Using Input2 instead of Input
import Button from '../common/Buttons';

interface AddOfferModalProps {
  isOpen: boolean;
  onClose: () => void;
  product: MasterProduct | null;
}

const AddOfferModal = ({ isOpen, onClose, product }: AddOfferModalProps) => {
  const queryClient = useQueryClient();

  const {
    register,
    handleSubmit,
    formState: { errors },
    reset,
  } = useForm<AddOfferFormData>({
    resolver: zodResolver(addOfferSchema),
    defaultValues: {
      availability_status: 'In Stock',
    },
  });

  const addOfferMutation = useMutation({
    mutationFn: supplierProductsAPI.addSupplierOffer,
    onSuccess: () => {
      toast.success('Product added to your offers successfully!');
      queryClient.invalidateQueries({ queryKey: ['supplier-products'] });
      handleClose();
    },
    onError: (error: any) => {
      const message = error.response?.data?.message || 'Failed to add product to offers';
      toast.error(message);
    },
  });

  const onSubmit = (data: AddOfferFormData) => {
    if (!product) return;

    addOfferMutation.mutate({
      master_product_id: product.id,
      price: parseFloat(data.price),
      availability_status: data.availability_status,
    });
  };

  const handleClose = () => {
    reset();
    onClose();
  };

  if (!isOpen || !product) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="flex items-center justify-between p-6 border-b border-secondary-100">
          <h2 className="text-2xl font-bold text-secondary-900">Add to Your Offers</h2>
          <button
            onClick={handleClose}
            className="text-secondary-400 hover:text-secondary-600 transition-colors"
          >
            <X size={24} />
          </button>
        </div>

        {/* Product Info */}
        <div className="p-6 bg-secondary-50 border-b border-secondary-100">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
              <Package size={24} className="text-primary-600" />
            </div>
            <div>
              <h3 className="font-semibold text-secondary-900">{product.product_name}</h3>
              <p className="text-sm text-secondary-600">
                {product.category.name} • {product.unit_of_measure}
              </p>
            </div>
          </div>
        </div>

        {/* Form */}
        <form onSubmit={handleSubmit(onSubmit)} className="p-6 space-y-6">
          {/* Price Input - Using Input2 with icon as component */}
          <Input2
            label={`Price per ${product.unit_of_measure}`}
            type="text"
            placeholder="0.00"
            icon={DollarSign} // ✅ Pass component reference
            error={errors.price?.message}
            {...register('price')}
            required
          />

          {/* Availability Status */}
          <div>
            <label className="block text-sm font-medium text-secondary-700 mb-2">
              Availability Status <span className="text-error-500">*</span>
            </label>
            <select
              {...register('availability_status')}
              className={`
                w-full px-4 py-3 rounded-lg border-2 transition-all
                ${errors.availability_status 
                  ? 'border-error-500 focus:border-error-500 focus:ring-error-500' 
                  : 'border-secondary-200 focus:border-primary-500 focus:ring-primary-500'
                }
                focus:outline-none focus:ring-2 focus:ring-opacity-20
              `}
            >
              <option value="In Stock">In Stock</option>
              <option value="Out of Stock">Out of Stock</option>
              <option value="Limited">Limited Stock</option>
            </select>
            {errors.availability_status && (
              <p className="text-sm text-error-500 mt-1">{errors.availability_status.message}</p>
            )}
          </div>

          {/* Action Buttons */}
          <div className="flex gap-3 pt-4">
            <Button
              type="submit"
              isLoading={addOfferMutation.isPending}
              disabled={addOfferMutation.isPending}
              fullWidth={false}
              className="flex-1"
            >
              {addOfferMutation.isPending ? 'Adding...' : 'Add to Offers'}
            </Button>

            <Button
              type="button"
              variant="outline"
              onClick={handleClose}
              fullWidth={false}
              className="flex-1"
            >
              Cancel
            </Button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default AddOfferModal;
/* FILE: src/components/supplier/DeliveryZonesManagement.tsx */
// src/components/supplier/DeliveryZonesManagement.tsx - COMPLETE WITH JSX
import React, { useState, useEffect, useCallback } from 'react';
import { 
  MapPin, 
  Plus, 
  Edit2, 
  Trash2, 
  Map as MapIcon,
  Grid3X3,
  Loader2,
  AlertCircle,
  Save,
  X,
  Radius,
  Navigation
} from 'lucide-react';
import Autocomplete from 'react-google-autocomplete';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import toast from 'react-hot-toast';

import DeliveryZonesMapView from './DeliveryZonesMapView';
import { zonesAPI } from '../../api/handlers/zones.api';

// ==================== TYPES ====================
interface DeliveryZone {
  address: string;
  lat: number;
  long: number;
  radius: number;
  id?: string;
}

interface ZoneFormData {
  address: string;
  lat: number | null;
  long: number | null;
  radius: number;
}

// ==================== UTILITY FUNCTIONS ====================
const calculateCoverageArea = (radius: number): string => {
  const area = Math.PI * radius * radius;
  return area.toFixed(0);
};

const generateId = () => Math.random().toString(36).substr(2, 9);

// ==================== ZONE CARD COMPONENT ====================
const ZoneCard: React.FC<{
  zone: DeliveryZone;
  onEdit: (zone: DeliveryZone) => void;
  onDelete: (zone: DeliveryZone) => void;
}> = ({ zone, onEdit, onDelete }) => {
  const coverageArea = calculateCoverageArea(zone.radius);
  
  return (
    <div className="bg-white rounded-xl border-2 border-secondary-200 p-6 hover:border-primary-300 hover:shadow-lg transition-all">
      <div className="w-full h-32 bg-secondary-100 rounded-lg mb-4 flex items-center justify-center relative overflow-hidden">
        <div className="absolute inset-0 bg-gradient-to-br from-primary-100 to-primary-200 opacity-50"></div>
        <MapPin size={40} className="text-primary-600 relative z-10" />
      </div>
      
      <div className="space-y-3 mb-4">
        <div>
          <p className="text-xs text-secondary-500 mb-1">Address</p>
          <p className="font-semibold text-secondary-900 line-clamp-2">{zone.address}</p>
        </div>
        
        <div className="grid grid-cols-2 gap-3">
          <div>
            <p className="text-xs text-secondary-500 mb-1">Coordinates</p>
            <p className="text-sm font-medium text-secondary-700">
              {zone.lat.toFixed(4)}, {zone.long.toFixed(4)}
            </p>
          </div>
          <div>
            <p className="text-xs text-secondary-500 mb-1">Coverage</p>
            <p className="text-sm font-medium text-primary-600">~{coverageArea} km²</p>
          </div>
        </div>
        
        <div className="inline-flex items-center gap-2 px-3 py-2 bg-primary-50 border border-primary-200 rounded-lg">
          <Radius size={16} className="text-primary-600" />
          <span className="text-sm font-semibold text-primary-700">{zone.radius} km radius</span>
        </div>
      </div>
      
      <div className="flex gap-2 pt-4 border-t border-secondary-200">
        <button
          onClick={() => onEdit(zone)}
          className="flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-secondary-100 hover:bg-secondary-200 text-secondary-700 rounded-lg transition-colors font-medium"
        >
          <Edit2 size={16} />
          Edit
        </button>
        <button
          onClick={() => onDelete(zone)}
          className="flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-error-50 hover:bg-error-100 text-error-600 rounded-lg transition-colors font-medium"
        >
          <Trash2 size={16} />
          Delete
        </button>
      </div>
    </div>
  );
};

// ==================== ZONE MODAL COMPONENT ====================
const ZoneModal: React.FC<{
  isOpen: boolean;
  onClose: () => void;
  onSave: (zone: Omit<DeliveryZone, 'id'>) => void;
  editingZone?: DeliveryZone | null;
}> = ({ isOpen, onClose, onSave, editingZone }) => {
  const [formData, setFormData] = useState<ZoneFormData>({
    address: '',
    lat: null,
    long: null,
    radius: 20
  });
  const [errors, setErrors] = useState<Record<string, string>>({});
  // ✅ NEW: Track if address input should be controlled
  const [addressValue, setAddressValue] = useState('');

  // ✅ FIXED: Reset form when modal opens or editingZone changes
  useEffect(() => {
    if (isOpen) {
      if (editingZone) {
        setFormData({
          address: editingZone.address,
          lat: editingZone.lat,
          long: editingZone.long,
          radius: editingZone.radius
        });
        setAddressValue(editingZone.address);
      } else {
        setFormData({
          address: '',
          lat: null,
          long: null,
          radius: 20
        });
        setAddressValue('');
      }
      setErrors({});
    }
  }, [editingZone, isOpen]);

  const handlePlaceSelected = useCallback((place: any) => {
    console.log('🗺️ Place Selected:', place);
    
    if (place.formatted_address) {
      setFormData(prev => ({ ...prev, address: place.formatted_address }));
      setAddressValue(place.formatted_address); // ✅ Update controlled value
    }
    
    if (place.geometry?.location) {
      const lat = place.geometry.location.lat();
      const lng = place.geometry.location.lng();
      
      console.log('📍 Coordinates:', { lat, lng });
      
      setFormData(prev => ({
        ...prev,
        lat,
        long: lng
      }));
      
      setErrors(prev => {
        const newErrors = { ...prev };
        delete newErrors.location;
        delete newErrors.address;
        return newErrors;
      });
    }
  }, []);

  // ✅ NEW: Handle manual address input changes
  const handleAddressChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setAddressValue(value);
    setFormData(prev => ({ ...prev, address: value }));
  };

  const validate = () => {
    const newErrors: Record<string, string> = {};
    
    if (!formData.address) {
      newErrors.address = 'Address is required';
    }
    if (!formData.lat || !formData.long) {
      newErrors.location = 'Please select a valid address from Google suggestions';
    }
    if (formData.radius < 5) {
      newErrors.radius = 'Minimum radius is 5 km';
    }
    if (formData.radius > 200) {
      newErrors.radius = 'Maximum radius is 200 km';
    }
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = () => {
    if (!validate()) return;
    
    console.log('💾 Submitting zone data:', formData); // ✅ Debug log
    
    onSave({
      address: formData.address,
      lat: formData.lat!,
      long: formData.long!,
      radius: formData.radius
    });
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div className="sticky top-0 bg-white border-b border-secondary-200 px-6 py-4 flex items-center justify-between">
          <div>
            <h2 className="text-2xl font-bold text-secondary-900">
              {editingZone ? 'Edit Delivery Zone' : 'Add Delivery Zone'}
            </h2>
            <p className="text-sm text-secondary-600 mt-1">
              Define your service area with address and radius
            </p>
          </div>
          <button
            onClick={onClose}
            className="p-2 hover:bg-secondary-100 rounded-lg transition-colors"
          >
            <X size={24} className="text-secondary-600" />
          </button>
        </div>

        <div className="p-6 space-y-6">
          <div>
            <label className="block text-sm font-medium text-secondary-700 mb-2">
              Business Address <span className="text-error-500">*</span>
            </label>
            <div className="relative">
              <MapPin className="absolute left-3 top-3.5 text-secondary-400 z-10" size={20} />
              {/* ✅ FIXED: Added key prop to force re-render + value prop for controlled input */}
              <Autocomplete
                key={editingZone?.address || 'new'} // Force re-mount when switching zones
                apiKey={import.meta.env.VITE_GOOGLE_MAPS_API_KEY}
                onPlaceSelected={handlePlaceSelected}
                options={{ 
                  types: ['address'],
                  componentRestrictions: { country: 'au' }
                }}
                defaultValue={addressValue} // Use state value
                onChange={handleAddressChange} // ✅ Handle manual typing
                className={`w-full pl-10 pr-4 py-3 rounded-lg border-2 transition-all ${
                  errors.address || errors.location
                    ? 'border-error-500 focus:border-error-500 focus:ring-error-500'
                    : 'border-secondary-200 focus:border-primary-500 focus:ring-primary-500'
                } focus:outline-none focus:ring-2 focus:ring-opacity-20`}
                placeholder="Start typing your business address..."
              />
            </div>
            {(errors.address || errors.location) && (
              <p className="text-sm text-error-500 mt-1 flex items-center gap-1">
                <AlertCircle size={14} />
                {errors.address || errors.location}
              </p>
            )}
            <p className="text-xs text-secondary-500 mt-2">
              💡 Type your address and select from Google suggestions
            </p>
          </div>

          {formData.lat && formData.long && (
            <div className="bg-success-50 border border-success-200 rounded-lg p-4">
              <p className="text-sm font-medium text-success-900 mb-2 flex items-center gap-2">
                <MapPin size={16} />
                Location Confirmed ✓
              </p>
              <p className="text-xs text-success-700">
                Coordinates: {formData.lat.toFixed(6)}, {formData.long.toFixed(6)}
              </p>
              <p className="text-xs text-success-600 mt-1 line-clamp-2">
                Address: {formData.address}
              </p>
            </div>
          )}

          <div>
            <div className="flex items-center justify-between mb-2">
              <label className="text-sm font-medium text-secondary-700">
                Delivery Radius <span className="text-error-500">*</span>
              </label>
              <span className="text-lg font-bold text-primary-600">
                {formData.radius} km
              </span>
            </div>
            <input
              type="range"
              min="5"
              max="200"
              step="5"
              value={formData.radius}
              onChange={(e) => {
                const newRadius = Number(e.target.value);
                console.log('🎚️ Radius changed to:', newRadius); // ✅ Debug log
                setFormData(prev => ({ ...prev, radius: newRadius }));
              }}
              className="w-full h-2 bg-secondary-200 rounded-lg appearance-none cursor-pointer accent-primary-500"
            />
            <div className="flex justify-between text-xs text-secondary-500 mt-1">
              <span>5 km</span>
              <span>200 km</span>
            </div>
            {errors.radius && (
              <p className="text-sm text-error-500 mt-1 flex items-center gap-1">
                <AlertCircle size={14} />
                {errors.radius}
              </p>
            )}
          </div>

          {formData.lat && formData.long && (
            <div className="bg-primary-50 border border-primary-200 rounded-lg p-4">
              <p className="text-sm font-medium text-primary-900 mb-2">
                📊 Coverage Information
              </p>
              <div className="grid grid-cols-2 gap-3 text-xs">
                <div>
                  <p className="text-primary-600">Coverage Area</p>
                  <p className="font-bold text-primary-900">
                    ~{calculateCoverageArea(formData.radius)} km²
                  </p>
                </div>
                <div>
                  <p className="text-primary-600">Radius</p>
                  <p className="font-bold text-primary-900">{formData.radius} km</p>
                </div>
              </div>
            </div>
          )}
        </div>

        <div className="sticky bottom-0 bg-white border-t border-secondary-200 px-6 py-4 flex gap-3">
          <button
            onClick={onClose}
            className="flex-1 px-6 py-3 border-2 border-secondary-300 text-secondary-700 rounded-lg hover:bg-secondary-50 transition-colors font-medium"
          >
            Cancel
          </button>
          <button
            onClick={handleSubmit}
            className="flex-1 px-6 py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors font-medium flex items-center justify-center gap-2"
          >
            <Save size={18} />
            {editingZone ? 'Update Zone' : 'Add Zone'}
          </button>
        </div>
      </div>
    </div>
  );
};

// ==================== MAIN COMPONENT ====================
const DeliveryZonesManagement: React.FC = () => {
  const queryClient = useQueryClient();
  const [activeView, setActiveView] = useState<'card' | 'map'>('card');
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingZone, setEditingZone] = useState<DeliveryZone | null>(null);
  const [deleteConfirm, setDeleteConfirm] = useState<DeliveryZone | null>(null);

  // ✅ DEBUG: Check API key
  useEffect(() => {
    const apiKey = import.meta.env.VITE_GOOGLE_MAPS_API_KEY;
    console.log('🔑 Google Maps API Key:', apiKey ? `Loaded (${apiKey.substring(0, 10)}...)` : 'Missing ❌');
  }, []);

  // ✅ Fetch zones using React Query
  const { data, isLoading, error } = useQuery({
    queryKey: ['delivery-zones'],
    queryFn: zonesAPI.getZones,
  });

  const zones: DeliveryZone[] = data?.delivery_zones.map(zone => ({
    ...zone,
    id: generateId()
  })) || [];

  // ✅ Save zones mutation
  const saveZonesMutation = useMutation({
    mutationFn: zonesAPI.saveZones,
    onSuccess: (response) => {
      queryClient.invalidateQueries({ queryKey: ['delivery-zones'] });
      toast.success('✅ ' + response.message);
    },
    onError: (error: any) => {
      toast.error('❌ ' + (error?.message || 'Failed to save zones'));
    },
  });

  const handleAddZone = (newZone: Omit<DeliveryZone, 'id'>) => {
    const allZones = [...zones.map(({ id, ...z }) => z), newZone];
    saveZonesMutation.mutate(allZones, {
      onSuccess: () => {
        setIsModalOpen(false);
        setEditingZone(null);
      }
    });
  };

  const handleEditZone = (updatedZone: Omit<DeliveryZone, 'id'>) => {
    if (!editingZone) return;
    
    // Map through zones and replace the one being edited
    const allZones = zones.map(zone => {
        if (zone.lat === editingZone.lat && zone.long === editingZone.long) {
        // Return the updated zone data (without frontend id)
        return {
            address: updatedZone.address,
            lat: updatedZone.lat,
            long: updatedZone.long,
            radius: updatedZone.radius,
        };
        }
        // Return other zones without their frontend id
        return {
        address: zone.address,
        lat: zone.lat,
        long: zone.long,
        radius: zone.radius,
        };
    });
  
    console.log('🔄 Updating zones:', allZones); // Debug log
    
    saveZonesMutation.mutate(allZones, {
        onSuccess: () => {
        setIsModalOpen(false);
        setEditingZone(null);
        }
    });
};

// ✅ FIXED: Delete Zone Handler
const handleDeleteZone = (zoneToDelete: DeliveryZone) => {
    // Filter out the deleted zone and clean the data
    console.log('🗑️ Deleting zone:', zoneToDelete); // Debug log
    const remainingZones = zones
        .filter(zone => (zone.lat !== zoneToDelete.lat && zone.long !== zoneToDelete.long))
        .map(zone => ({
        address: zone.address,
        lat: zone.lat,
        long: zone.long,
        radius: zone.radius,
        }));
    
    console.log('🗑️ Deleting zone, remaining:', remainingZones); // Debug log
    
    saveZonesMutation.mutate(remainingZones, {
        onSuccess: () => {
        setDeleteConfirm(null);
        }
    });
    };

  const openEditModal = (zone: DeliveryZone) => {
    setEditingZone(zone);
    setIsModalOpen(true);
  };

  const openAddModal = () => {
    setEditingZone(null);
    setIsModalOpen(true);
  };

  const isSaving = saveZonesMutation.isPending;

  return (
    <div className="min-h-screen bg-secondary-50 p-6">
      <div className="max-w-7xl mx-auto space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold text-secondary-900 flex items-center gap-3">
              <MapPin size={32} className="text-primary-600" />
              Delivery Zones
            </h1>
            <p className="text-secondary-600 mt-2">
              Manage your service areas and delivery coverage
            </p>
          </div>
          <button
            onClick={openAddModal}
            disabled={isSaving}
            className="flex items-center gap-2 px-6 py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 disabled:opacity-50 transition-all shadow-lg hover:shadow-xl font-medium"
          >
            <Plus size={20} />
            Add Delivery Zone
          </button>
        </div>

        {/* Stats Card */}
        <div className="bg-white rounded-xl border-2 border-secondary-200 p-6">
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div className="flex items-center gap-4">
              <div className="w-12 h-12 rounded-lg bg-primary-100 flex items-center justify-center">
                <MapPin size={24} className="text-primary-600" />
              </div>
              <div>
                <p className="text-sm text-secondary-600">Total Zones</p>
                <p className="text-2xl font-bold text-secondary-900">{zones.length}</p>
              </div>
            </div>
            <div className="flex items-center gap-4">
              <div className="w-12 h-12 rounded-lg bg-success-100 flex items-center justify-center">
                <Radius size={24} className="text-success-600" />
              </div>
              <div>
                <p className="text-sm text-secondary-600">Total Coverage</p>
                <p className="text-2xl font-bold text-secondary-900">
                  {zones.reduce((sum, z) => sum + parseFloat(calculateCoverageArea(z.radius)), 0).toFixed(0)} km²
                </p>
              </div>
            </div>
            <div className="flex items-center gap-4">
              <div className="w-12 h-12 rounded-lg bg-warning-100 flex items-center justify-center">
                <Navigation size={24} className="text-warning-600" />
              </div>
              <div>
                <p className="text-sm text-secondary-600">Avg. Radius</p>
                <p className="text-2xl font-bold text-secondary-900">
                  {zones.length > 0 ? (zones.reduce((sum, z) => sum + z.radius, 0) / zones.length).toFixed(0) : 0} km
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* View Toggle */}
        <div className="bg-white rounded-xl border-2 border-secondary-200 p-2 inline-flex gap-2">
          <button
            onClick={() => setActiveView('card')}
            className={`flex items-center gap-2 px-6 py-2.5 rounded-lg font-medium transition-all ${
              activeView === 'card'
                ? 'bg-primary-500 text-white shadow-lg'
                : 'text-secondary-600 hover:bg-secondary-50'
            }`}
          >
            <Grid3X3 size={20} />
            Card View
          </button>
          <button
            onClick={() => setActiveView('map')}
            className={`flex items-center gap-2 px-6 py-2.5 rounded-lg font-medium transition-all ${
              activeView === 'map'
                ? 'bg-primary-500 text-white shadow-lg'
                : 'text-secondary-600 hover:bg-secondary-50'
            }`}
          >
            <MapIcon size={20} />
            Map View
          </button>
        </div>

        {/* Loading State */}
        {isLoading && (
          <div className="flex flex-col items-center justify-center py-20">
            <Loader2 size={48} className="text-primary-600 animate-spin mb-4" />
            <p className="text-secondary-600">Loading delivery zones...</p>
          </div>
        )}

        {/* Error State */}
        {error && (
          <div className="bg-error-50 border border-error-200 rounded-xl p-6 text-center">
            <AlertCircle size={48} className="text-error-500 mx-auto mb-4" />
            <p className="text-error-700 font-medium">Failed to load zones</p>
            <p className="text-error-600 text-sm mt-2">{(error as Error).message}</p>
          </div>
        )}

        {/* Empty State */}
        {!isLoading && !error && zones.length === 0 && (
          <div className="bg-white rounded-xl border-2 border-dashed border-secondary-300 p-12 text-center">
            <div className="w-24 h-24 rounded-full bg-primary-50 flex items-center justify-center mx-auto mb-6">
              <MapPin size={48} className="text-primary-400" />
            </div>
            <h3 className="text-xl font-bold text-secondary-900 mb-2">
              No Delivery Zones Yet
            </h3>
            <p className="text-secondary-600 mb-6 max-w-md mx-auto">
              Start by adding your first delivery zone to define where you can service customers.
            </p>
            <button
              onClick={openAddModal}
              className="inline-flex items-center gap-2 px-8 py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-all shadow-lg hover:shadow-xl font-medium"
            >
              <Plus size={20} />
              Add Your First Zone
            </button>
          </div>
        )}

        {/* Card View */}
        {!isLoading && !error && activeView === 'card' && zones.length > 0 && (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {zones.map((zone) => (
              <ZoneCard
                key={zone.id}
                zone={zone}
                onEdit={openEditModal}
                onDelete={(zone) => setDeleteConfirm(zone)}
              />
            ))}
          </div>
        )}

        {/* Map View */}
        {!isLoading && !error && activeView === 'map' && zones.length > 0 && (
          <DeliveryZonesMapView zones={zones} />
        )}

        {/* Add/Edit Modal */}
        <ZoneModal
          isOpen={isModalOpen}
          onClose={() => {
            setIsModalOpen(false);
            setEditingZone(null);
          }}
          onSave={editingZone ? handleEditZone : handleAddZone}
          editingZone={editingZone}
        />

        {/* Delete Confirmation Modal */}
        {deleteConfirm && (
          <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
              <div className="w-16 h-16 rounded-full bg-error-100 flex items-center justify-center mx-auto mb-4">
                <AlertCircle size={32} className="text-error-600" />
              </div>
              <h3 className="text-xl font-bold text-secondary-900 text-center mb-2">
                Delete Delivery Zone?
              </h3>
              <p className="text-secondary-600 text-center mb-6">
                Are you sure you want to remove this zone? This action cannot be undone.
              </p>
              <div className="bg-secondary-50 rounded-lg p-3 mb-6">
                <p className="text-sm text-secondary-700">
                  <span className="font-semibold">Zone:</span> {deleteConfirm.address}
                </p>
                <p className="text-sm text-secondary-700 mt-1">
                  <span className="font-semibold">Radius:</span> {deleteConfirm.radius} km
                </p>
              </div>
              <div className="flex gap-3">
                <button
                  onClick={() => setDeleteConfirm(null)}
                  className="flex-1 px-4 py-3 border-2 border-secondary-300 text-secondary-700 rounded-lg hover:bg-secondary-50 transition-colors font-medium"
                >
                  Cancel
                </button>
                <button
                  onClick={() => handleDeleteZone(deleteConfirm)}
                  disabled={isSaving}
                  className="flex-1 px-4 py-3 bg-error-500 text-white rounded-lg hover:bg-error-600 disabled:opacity-50 transition-colors font-medium flex items-center justify-center gap-2"
                >
                  {isSaving ? (
                    <>
                      <Loader2 size={18} className="animate-spin" />
                      Deleting...
                    </>
                  ) : (
                    <>
                      <Trash2 size={18} />
                      Delete Zone
                    </>
                  )}
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Saving Overlay */}
        {isSaving && (
          <div className="fixed inset-0 bg-black/30 z-40 flex items-center justify-center">
            <div className="bg-white rounded-xl shadow-2xl p-6 flex items-center gap-4">
              <Loader2 size={32} className="text-primary-600 animate-spin" />
              <span className="text-lg font-medium text-secondary-900">
                Saving changes...
              </span>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default DeliveryZonesManagement;
/* FILE: src/components/supplier/DeliveryZonesMapView.tsx */
// DeliveryZonesMapView.tsx
import React, { useEffect, useRef, useState } from 'react';
import { Loader2, AlertCircle, MapPin } from 'lucide-react';

interface DeliveryZone {
  address: string;
  lat: number;
  long: number;
  radius: number; // in km
  id?: string;
}

interface MapViewProps {
  zones: DeliveryZone[];
}

declare global {
  interface Window {
    google: any;
  }
}

const DeliveryZonesMapView: React.FC<MapViewProps> = ({ zones }) => {
  const mapRef = useRef<HTMLDivElement>(null);
  const [map, setMap] = useState<google.maps.Map | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const markersRef = useRef<google.maps.Marker[]>([]);
  const circlesRef = useRef<google.maps.Circle[]>([]);

  const zoneColors = [
    '#EF4444', '#3B82F6', '#10B981', '#F59E0B',
    '#8B5CF6', '#EC4899', '#14B8A6', '#F97316',
  ];

  // --- Load script once and init when container exists
  useEffect(() => {
    const initWhenReady = () => {
      if (!mapRef.current) {
        requestAnimationFrame(initWhenReady);
        return;
      }
      if (!window.google || !window.google.maps) return;

      try {
        const defaultCenter = { lat: -33.8688, lng: 151.2093 }; // Sydney
        const center = zones.length
          ? { lat: zones[0].lat, lng: zones[0].long }
          : defaultCenter;

        const mapInstance = new window.google.maps.Map(mapRef.current, {
          center,
          zoom: zones.length ? 10 : 5,
          mapTypeControl: true,
          streetViewControl: false,
          fullscreenControl: true,
        });

        setMap(mapInstance);
        setLoading(false);
      } catch (e) {
        setError('Failed to initialize map');
        setLoading(false);
      }
    };

    // already loaded
    if (window.google && window.google.maps) {
      initWhenReady();
      return;
    }

    // avoid duplicate script
    const existing = document.getElementById('google-maps-script') as HTMLScriptElement | null;
    if (existing) {
      existing.addEventListener('load', initWhenReady, { once: true });
      return;
    }

    const apiKey = import.meta.env.VITE_GOOGLE_MAPS_API_KEY;
    if (!apiKey) {
      setError('Missing VITE_GOOGLE_MAPS_API_KEY');
      setLoading(false);
      return;
    }

    const s = document.createElement('script');
    s.id = 'google-maps-script';
    s.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places`;
    s.async = true;
    s.defer = true;
    s.onload = initWhenReady;
    s.onerror = () => {
      setError('Failed to load Google Maps. Check API key or network.');
      setLoading(false);
    };
    document.head.appendChild(s);

    return () => {
      // cleanup markers/circles on unmount
      markersRef.current.forEach(m => m.setMap(null));
      circlesRef.current.forEach(c => c.setMap(null));
    };
  }, []); // eslint-disable-line

  // --- Draw zones whenever data or map changes
  useEffect(() => {
    if (!map || !window.google) return;

    // clear old
    markersRef.current.forEach(m => m.setMap(null));
    circlesRef.current.forEach(c => c.setMap(null));
    markersRef.current = [];
    circlesRef.current = [];

    if (!zones.length) return;

    const bounds = new window.google.maps.LatLngBounds();

    zones.forEach((zone, idx) => {
      const pos = { lat: zone.lat, lng: zone.long };
      const color = zoneColors[idx % zoneColors.length];

      const marker = new window.google.maps.Marker({
        position: pos,
        map,
        title: zone.address,
        label: { text: String(idx + 1), color: 'white', fontWeight: 'bold' },
        icon: {
          path: window.google.maps.SymbolPath.CIRCLE,
          scale: 12,
          fillColor: color,
          fillOpacity: 1,
          strokeColor: 'white',
          strokeWeight: 3,
        },
      });

      const info = new window.google.maps.InfoWindow({
        content: `
          <div style="padding:8px;max-width:260px">
            <h3 style="margin:0 0 6px;font-weight:700;color:#111827">Zone ${idx + 1}</h3>
            <div style="font-size:13px;color:#374151">
              <div><strong>Address:</strong> ${zone.address}</div>
              <div><strong>Radius:</strong> ${zone.radius} km</div>
              <div><strong>Coverage:</strong> ~${(Math.PI * zone.radius * zone.radius).toFixed(0)} km²</div>
            </div>
          </div>
        `,
      });
      marker.addListener('click', () => info.open(map, marker));

      const circle = new window.google.maps.Circle({
        strokeColor: color,
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: color,
        fillOpacity: 0.15,
        map,
        center: pos,
        radius: zone.radius * 1000, // km -> m
      });

      markersRef.current.push(marker);
      circlesRef.current.push(circle);
      bounds.extend(pos);
    });

    if (zones.length > 1) map.fitBounds(bounds);
    else map.setCenter({ lat: zones[0].lat, lng: zones[0].long });
  }, [map, zones]);

  return (
    <div className="bg-white rounded-xl border-2 border-secondary-200 p-6">
      <div className="relative">
        {/* keep container in DOM always */}
        <div
          ref={mapRef}
          className="w-full h-[600px] rounded-lg overflow-hidden border border-secondary-200"
        />
        {loading && (
          <div className="absolute inset-0 flex items-center justify-center bg-white/70">
            <Loader2 className="animate-spin" size={40} />
          </div>
        )}
        {error && (
          <div className="absolute inset-0 flex flex-col items-center justify-center bg-white/90 p-6 text-center">
            <AlertCircle className="text-error-600 mb-2" size={28} />
            <p className="text-error-700 font-medium mb-1">Map Loading Error</p>
            <p className="text-sm text-secondary-600">{error}</p>
            <p className="text-xs text-secondary-500 mt-2">
              Ensure <code>VITE_GOOGLE_MAPS_API_KEY</code> is set.
            </p>
          </div>
        )}
      </div>

      {/* Optional legend */}
      {zones.length > 0 ? (
        <div className="mt-4 p-4 bg-secondary-50 rounded-lg">
          <p className="text-sm font-semibold text-secondary-900 mb-3">Delivery Zones</p>
          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
            {zones.map((z, i) => (
              <div key={z.id || i} className="flex items-center gap-2">
                <div
                  className="w-4 h-4 rounded-full border-2 border-white shadow-sm"
                  style={{ backgroundColor: zoneColors[i % zoneColors.length] }}
                />
                <div className="flex-1 min-w-0">
                  <p className="text-xs font-medium text-secondary-900 truncate">Zone {i + 1}</p>
                  <p className="text-xs text-secondary-600">{z.radius} km radius</p>
                </div>
              </div>
            ))}
          </div>
        </div>
      ) : (
        <div className="h-32 flex flex-col items-center justify-center text-secondary-600">
          <MapPin className="mb-2 text-secondary-400" size={20} />
          No zones to display
        </div>
      )}
    </div>
  );
};

export default DeliveryZonesMapView;

/* FILE: src/components/supplier/EditOfferModal.tsx */
// FILE PATH: src/components/supplier/EditOfferModal.tsx
import { useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { X, DollarSign, Package } from 'lucide-react';
import toast from 'react-hot-toast';

import { supplierProductsAPI } from '../../api/handlers/supplierProducts.api';
import type { MasterProduct } from '../../api/handlers/supplierProducts.api';
import type { SupplierOffer } from '../../api/handlers/supplierProducts.api';
import { updateOfferSchema } from '../../utils/validators';
import type { UpdateOfferFormData } from '../../utils/validators';
import Input2 from '../common/Input2'; // ✅ Using Input2 instead of Input
import Button from '../common/Buttons';

interface EditOfferModalProps {
  isOpen: boolean;
  onClose: () => void;
  product: MasterProduct | null;
  offer: SupplierOffer | null;
}

const EditOfferModal = ({ isOpen, onClose, product, offer }: EditOfferModalProps) => {
  const queryClient = useQueryClient();

  const {
    register,
    handleSubmit,
    formState: { errors },
    reset,
    setValue,
  } = useForm<UpdateOfferFormData>({
    resolver: zodResolver(updateOfferSchema),
  });

  // Pre-fill form when offer changes
  useEffect(() => {
    if (offer) {
      setValue('price', offer.price.toString()); // Convert number to string for input
      setValue('availability_status', offer.availability_status as any);
    }
  }, [offer, setValue]);

  const updateOfferMutation = useMutation({
    mutationFn: ({ offerId, payload }: { offerId: number; payload: any }) =>
      supplierProductsAPI.updateSupplierOffer(offerId, payload),
    onSuccess: () => {
      toast.success('Offer updated successfully!');
      queryClient.invalidateQueries({ queryKey: ['supplier-products'] });
      handleClose();
    },
    onError: (error: any) => {
      const message = error.response?.data?.message || 'Failed to update offer';
      toast.error(message);
    },
  });

  const onSubmit = (data: UpdateOfferFormData) => {
    if (!offer) return;

    updateOfferMutation.mutate({
      offerId: offer.id,
      payload: {
        price: parseFloat(data.price),
        availability_status: data.availability_status,
      },
    });
  };

  const handleClose = () => {
    reset();
    onClose();
  };

  if (!isOpen || !product || !offer) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="flex items-center justify-between p-6 border-b border-secondary-100">
          <h2 className="text-2xl font-bold text-secondary-900">Edit Your Offer</h2>
          <button
            onClick={handleClose}
            className="text-secondary-400 hover:text-secondary-600 transition-colors"
          >
            <X size={24} />
          </button>
        </div>

        {/* Product Info */}
        <div className="p-6 bg-secondary-50 border-b border-secondary-100">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
              <Package size={24} className="text-primary-600" />
            </div>
            <div>
              <h3 className="font-semibold text-secondary-900">{product.product_name}</h3>
              <p className="text-sm text-secondary-600">
                {product.category.name} • {product.unit_of_measure}
              </p>
            </div>
          </div>
        </div>

        {/* Form */}
        <form onSubmit={handleSubmit(onSubmit)} className="p-6 space-y-6">
          {/* Price Input - Using Input2 with icon as component */}
          <Input2
            label={`Price per ${product.unit_of_measure}`}
            type="text"
            placeholder="0.00"
            icon={DollarSign} // ✅ Pass component reference
            error={errors.price?.message}
            {...register('price')}
            required
          />

          {/* Availability Status */}
          <div>
            <label className="block text-sm font-medium text-secondary-700 mb-2">
              Availability Status <span className="text-error-500">*</span>
            </label>
            <select
              {...register('availability_status')}
              className={`
                w-full px-4 py-3 rounded-lg border-2 transition-all
                ${errors.availability_status 
                  ? 'border-error-500 focus:border-error-500 focus:ring-error-500' 
                  : 'border-secondary-200 focus:border-primary-500 focus:ring-primary-500'
                }
                focus:outline-none focus:ring-2 focus:ring-opacity-20
              `}
            >
              <option value="In Stock">In Stock</option>
              <option value="Out of Stock">Out of Stock</option>
              <option value="Limited">Limited Stock</option>
            </select>
            {errors.availability_status && (
              <p className="text-sm text-error-500 mt-1">{errors.availability_status.message}</p>
            )}
          </div>

          {/* Action Buttons */}
          <div className="flex gap-3 pt-4">
            <Button
              type="submit"
              isLoading={updateOfferMutation.isPending}
              disabled={updateOfferMutation.isPending}
              fullWidth={false}
              className="flex-1"
            >
              {updateOfferMutation.isPending ? 'Updating...' : 'Update Offer'}
            </Button>

            <Button
              type="button"
              variant="outline"
              onClick={handleClose}
              fullWidth={false}
              className="flex-1"
            >
              Cancel
            </Button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default EditOfferModal;
/* FILE: src/components/supplier/OrderFilters.tsx */
// src/components/supplier/OrderFilters.tsx

import React from 'react';
import { Search, X } from 'lucide-react';
import type { ProductFilter } from '../../api/handlers/supplierOrders.api';

interface OrderFiltersProps {
  filters: {
    search: string;
    product_id: string;
    supplier_confirms: string;
    supplier_delivery_date: string;
  };
  onFilterChange: (key: string, value: string) => void;
  onClearFilters: () => void;
  products: ProductFilter[];
}

const OrderFilters: React.FC<OrderFiltersProps> = ({
  filters,
  onFilterChange,
  onClearFilters,
  products,
}) => {
  const hasActiveFilters =
    filters.search ||
    filters.product_id ||
    filters.supplier_confirms !== '' ||
    filters.supplier_delivery_date;

  return (
    <div className="bg-white rounded-lg border border-gray-200 p-4 mb-4">
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {/* Search Input */}
        <div className="relative">
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Search Product
          </label>
          <div className="relative">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" />
            <input
              type="text"
              value={filters.search}
              onChange={(e) => onFilterChange('search', e.target.value)}
              placeholder="Search by product name..."
              className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
        </div>

        {/* Product Filter */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Product
          </label>
          <select
            value={filters.product_id}
            onChange={(e) => onFilterChange('product_id', e.target.value)}
            className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="">All Products</option>
            {products?.map((product) => (
              <option key={product.id} value={product.id}>
                {product.product_name}
              </option>
            ))}
          </select>
        </div>

        {/* Confirmation Status Filter */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Confirmation Status
          </label>
          <select
            value={filters.supplier_confirms}
            onChange={(e) => onFilterChange('supplier_confirms', e.target.value)}
            className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="">All Status</option>
            <option value="true">Confirmed</option>
            <option value="false">Pending</option>
          </select>
        </div>

        {/* Delivery Date Filter */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Delivery Date
          </label>
          <input
            type="date"
            value={filters.supplier_delivery_date}
            onChange={(e) => onFilterChange('supplier_delivery_date', e.target.value)}
            className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>
      </div>

      {/* Clear Filters Button */}
      {hasActiveFilters && (
        <div className="mt-4 flex justify-end">
          <button
            onClick={onClearFilters}
            className="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors"
          >
            <X className="w-4 h-4" />
            Clear Filters
          </button>
        </div>
      )}
    </div>
  );
};

export default OrderFilters;
/* FILE: src/components/supplier/OrderItemEditModal.tsx */
// src/components/supplier/OrderItemEditModal.tsx

import { useState, useEffect } from 'react';
import { X, Save, Truck, Info } from 'lucide-react';
import toast from 'react-hot-toast';
import { useUpdateOrderItem } from '../../features/supplierOrders/hooks';
import type { SupplierOrderItem, DeliveryType } from '../../api/handlers/supplierOrders.api';

interface OrderItemEditModalProps {
  item: SupplierOrderItem | null;
  isOpen: boolean;
  onClose: () => void;
  onSuccess: () => void;
}

const DELIVERY_TYPES: { value: DeliveryType; label: string; description: string }[] = [
  { value: 'Included', label: 'Included', description: 'Delivery cost included in unit price' },
  { value: 'Supplier', label: 'Supplier Delivery', description: 'Delivery handled by supplier' },
  { value: 'ThirdParty', label: 'Third Party', description: 'External delivery service' },
  { value: 'Fleet', label: 'Fleet', description: 'Company fleet delivery' },
  { value: 'None', label: 'No Delivery', description: 'Pickup only, no delivery' },
];

const OrderItemEditModal: React.FC<OrderItemEditModalProps> = ({ item, isOpen, onClose, onSuccess }) => {
  const [formData, setFormData] = useState({
    supplier_unit_cost: '',
    supplier_discount: '',
    delivery_cost: '',
    delivery_type: 'Supplier' as DeliveryType,
    supplier_delivery_date: '',
    supplier_notes: '',
    supplier_confirms: false,
  });
  const [errors, setErrors] = useState<Record<string, string>>({});

  const updateMutation = useUpdateOrderItem();

  useEffect(() => {
    if (item) {
      setFormData({
        supplier_unit_cost: item.supplier_unit_cost || '',
        delivery_cost: item.delivery_cost || '',
        delivery_type: item.delivery_type || 'Supplier',
        supplier_discount: item.supplier_discount || '0',
        supplier_delivery_date: item.supplier_delivery_date?.split('T')[0] || '',
        supplier_notes: item.supplier_notes || '',
        supplier_confirms: item.supplier_confirms || false,
      });
    }
  }, [item]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    const checked = (e.target as HTMLInputElement).checked;
    
    // If delivery type changes to None or Included, reset delivery cost
    if (name === 'delivery_type' && (value === 'None' || value === 'Included')) {
      setFormData((prev) => ({
        ...prev,
        delivery_type: value as DeliveryType,
        delivery_cost: '0',
      }));
    } else {
      setFormData((prev) => ({
        ...prev,
        [name]: type === 'checkbox' ? checked : value,
      }));
    }
    
    // Clear error for this field
    if (errors[name]) {
      setErrors((prev) => ({ ...prev, [name]: '' }));
    }
  };

  const shouldShowDeliveryCost = () => {
    return formData.delivery_type !== 'None' && formData.delivery_type !== 'Included';
  };

  const validate = () => {
    const newErrors: Record<string, string> = {};

    if (!formData.supplier_unit_cost || parseFloat(formData.supplier_unit_cost) < 0) {
      newErrors.supplier_unit_cost = 'Unit cost must be a positive number';
    }

    if (parseFloat(formData.supplier_discount) < 0) {
      newErrors.supplier_discount = 'Discount cannot be negative';
    }

    if (!formData.supplier_delivery_date) {
      newErrors.supplier_delivery_date = 'Delivery date is required';
    }

    if (!formData.delivery_type) {
      newErrors.delivery_type = 'Delivery type is required';
    }

    // Only validate delivery cost if it should be shown
    if (shouldShowDeliveryCost()) {
      if (!formData.delivery_cost || parseFloat(formData.delivery_cost) < 0) {
        newErrors.delivery_cost = 'Delivery cost must be a positive number';
      }
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();

    if (!validate()) {
      toast.error('Please fix the errors before submitting');
      return;
    }

    if (!item) return;

    // Prepare payload - set delivery_cost to 0 if delivery type is None or Included
    const deliveryCost = shouldShowDeliveryCost() ? parseFloat(formData.delivery_cost) : 0;

    updateMutation.mutate(
      {
        orderItemId: item.id,
        payload: {
          supplier_unit_cost: parseFloat(formData.supplier_unit_cost),
          supplier_discount: parseFloat(formData.supplier_discount),
          delivery_cost: deliveryCost,
          delivery_type: formData.delivery_type,
          supplier_delivery_date: formData.supplier_delivery_date,
          supplier_notes: formData.supplier_notes,
          supplier_confirms: formData.supplier_confirms,
        },
      },
      {
        onSuccess: () => {
          toast.success('Order item updated successfully');
          onSuccess();
          onClose();
        },
        onError: (error: Error) => {
          toast.error(error.message || 'Failed to update order item');
        },
      }
    );
  };

  if (!isOpen || !item) return null;

  const calculateItemTotal = () => {
    const unitCost = parseFloat(formData.supplier_unit_cost) || 0;
    const discount = parseFloat(formData.supplier_discount) || 0;
    const deliveryCost = shouldShowDeliveryCost() ? parseFloat(formData.delivery_cost) || 0 : 0;
    return unitCost * parseFloat(item.quantity) - discount + deliveryCost;
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="flex items-center justify-between p-6 border-b border-gray-200">
          <h2 className="text-2xl font-bold text-gray-900">Edit Order Item</h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* Product Info */}
        <div className="p-6 bg-gray-50 border-b border-gray-200">
          <div className="flex items-center gap-4">
            {item.product?.photo && (
              <img
                src={`${import.meta.env.VITE_IMG_URL}${item.product.photo}`}
                alt={item.product.product_name}
                className="w-16 h-16 object-cover rounded-lg"
              />
            )}
            <div>
              <h3 className="text-lg font-semibold text-gray-900">
                {item.product?.product_name}
              </h3>
              <p className="text-sm text-gray-600">
                Quantity: {item.quantity} {item.product?.unit_of_measure}
              </p>
            </div>
          </div>
        </div>

        {/* Form */}
        <form onSubmit={handleSubmit} className="p-6 space-y-4">
          {/* Unit Cost */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Supplier Unit Cost <span className="text-red-500">*</span>
            </label>
            <input
              type="number"
              name="supplier_unit_cost"
              value={formData.supplier_unit_cost}
              onChange={handleChange}
              step="0.01"
              min="0"
              className={`w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                errors.supplier_unit_cost ? 'border-red-500' : 'border-gray-300'
              }`}
              placeholder="0.00"
            />
            {errors.supplier_unit_cost && (
              <p className="text-red-500 text-sm mt-1">{errors.supplier_unit_cost}</p>
            )}
          </div>

          {/* Delivery Type */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Delivery Type <span className="text-red-500">*</span>
            </label>
            <select
              name="delivery_type"
              value={formData.delivery_type}
              onChange={handleChange}
              className={`w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                errors.delivery_type ? 'border-red-500' : 'border-gray-300'
              }`}
            >
              {DELIVERY_TYPES.map((type) => (
                <option key={type.value} value={type.value}>
                  {type.label}
                </option>
              ))}
            </select>
            {errors.delivery_type && (
              <p className="text-red-500 text-sm mt-1">{errors.delivery_type}</p>
            )}
            
            {/* Delivery Type Info */}
            <div className="mt-2 flex items-start gap-2 p-3 bg-blue-50 border border-blue-200 rounded-md">
              <Info className="w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0" />
              <p className="text-sm text-blue-800">
                {DELIVERY_TYPES.find(t => t.value === formData.delivery_type)?.description}
              </p>
            </div>
          </div>

          {/* Delivery Cost - Conditional */}
          {shouldShowDeliveryCost() && (
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Delivery Cost <span className="text-red-500">*</span>
              </label>
              <div className="relative">
                <Truck className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                <input
                  type="number"
                  name="delivery_cost"
                  value={formData.delivery_cost}
                  onChange={handleChange}
                  step="0.01"
                  min="0"
                  className={`w-full pl-10 pr-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                    errors.delivery_cost ? 'border-red-500' : 'border-gray-300'
                  }`}
                  placeholder="0.00"
                />
              </div>
              {errors.delivery_cost && (
                <p className="text-red-500 text-sm mt-1">{errors.delivery_cost}</p>
              )}
            </div>
          )}

          {/* Discount */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Discount
            </label>
            <input
              type="number"
              name="supplier_discount"
              value={formData.supplier_discount}
              onChange={handleChange}
              step="0.01"
              min="0"
              className={`w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                errors.supplier_discount ? 'border-red-500' : 'border-gray-300'
              }`}
              placeholder="0.00"
            />
            {errors.supplier_discount && (
              <p className="text-red-500 text-sm mt-1">{errors.supplier_discount}</p>
            )}
          </div>

          {/* Delivery Date */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Delivery Date <span className="text-red-500">*</span>
            </label>
            <input
              type="date"
              name="supplier_delivery_date"
              value={formData.supplier_delivery_date}
              onChange={handleChange}
              className={`w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                errors.supplier_delivery_date ? 'border-red-500' : 'border-gray-300'
              }`}
            />
            {errors.supplier_delivery_date && (
              <p className="text-red-500 text-sm mt-1">{errors.supplier_delivery_date}</p>
            )}
          </div>

          {/* Notes */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Notes
            </label>
            <textarea
              name="supplier_notes"
              value={formData.supplier_notes}
              onChange={handleChange}
              rows={3}
              maxLength={500}
              className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Add any special notes or instructions..."
            />
            <p className="text-sm text-gray-500 mt-1">
              {formData.supplier_notes.length}/500 characters
            </p>
          </div>

          {/* Item Total Preview */}
          <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div className="flex justify-between items-center">
              <span className="text-sm font-medium text-gray-700">Item Total:</span>
              <span className="text-lg font-bold text-blue-600">
                ${calculateItemTotal().toFixed(2)}
              </span>
            </div>
            <p className="text-xs text-gray-600 mt-1">
              ({item.quantity} × ${formData.supplier_unit_cost || 0}) - ${formData.supplier_discount || 0}
              {shouldShowDeliveryCost() && ` + $${formData.delivery_cost || 0} delivery`}
            </p>
          </div>

          {/* Confirmation Checkbox */}
          <div className="flex items-start gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <input
              type="checkbox"
              id="supplier_confirms"
              name="supplier_confirms"
              checked={formData.supplier_confirms}
              onChange={handleChange}
              disabled={item.supplier_confirms}
              className="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded disabled:opacity-50 disabled:cursor-not-allowed"
            />
            <label htmlFor="supplier_confirms" className="text-sm text-gray-700">
              <span className="font-medium">I confirm this item</span>
              <p className="text-gray-500 mt-1">
                {item.supplier_confirms
                  ? 'This item has been confirmed and cannot be unconfirmed.'
                  : 'Once confirmed, you will not be able to unconfirm this item.'}
              </p>
            </label>
          </div>

          {/* Action Buttons */}
          <div className="flex justify-end gap-3 pt-4 border-t border-gray-200">
            <button
              type="button"
              onClick={onClose}
              disabled={updateMutation.isPending}
              className="px-6 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors disabled:opacity-50"
            >
              Cancel
            </button>
            <button
              type="submit"
              disabled={updateMutation.isPending}
              className="flex items-center gap-2 px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50"
            >
              {updateMutation.isPending ? (
                <>
                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                  Saving...
                </>
              ) : (
                <>
                  <Save className="w-4 h-4" />
                  Save Changes
                </>
              )}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default OrderItemEditModal;
/* FILE: src/components/supplier/OrderMetricsCards.tsx */
// src/components/supplier/OrderMetricsCards.tsx

import React from 'react';
import { Package, CheckCircle, Clock, Truck } from 'lucide-react';
import type { OrderMetrics } from '../../api/handlers/supplierOrders.api';

interface OrderMetricsCardsProps {
  metrics: OrderMetrics | null;
  loading: boolean;
}

const OrderMetricsCards: React.FC<OrderMetricsCardsProps> = ({ metrics, loading }) => {
  const metricsData = [
    {
      title: 'Total Orders',
      value: metrics?.total_orders_count || 0,
      icon: Package,
      color: 'bg-blue-500',
      bgLight: 'bg-blue-50',
      textColor: 'text-blue-600',
    },
    {
      title: 'Confirmed',
      value: metrics?.supplier_confirmed_count || 0,
      icon: CheckCircle,
      color: 'bg-green-500',
      bgLight: 'bg-green-50',
      textColor: 'text-green-600',
    },
    {
      title: 'Awaiting Payment',
      value: metrics?.awaiting_payment_count || 0,
      icon: Clock,
      color: 'bg-orange-500',
      bgLight: 'bg-orange-50',
      textColor: 'text-orange-600',
    },
    {
      title: 'Delivered',
      value: metrics?.delivered_count || 0,
      icon: Truck,
      color: 'bg-purple-500',
      bgLight: 'bg-purple-50',
      textColor: 'text-purple-600',
    },
  ];

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      {metricsData.map((metric, index) => {
        const Icon = metric.icon;
        return (
          <div
            key={index}
            className={`${metric.bgLight} rounded-lg p-6 border border-gray-200 transition-all hover:shadow-md`}
          >
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600 mb-1">
                  {metric.title}
                </p>
                {loading ? (
                  <div className="h-8 w-16 bg-gray-200 animate-pulse rounded"></div>
                ) : (
                  <p className={`text-3xl font-bold ${metric.textColor}`}>
                    {metric.value}
                  </p>
                )}
              </div>
              <div className={`${metric.color} p-3 rounded-full`}>
                <Icon className="w-6 h-6 text-white" />
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
};

export default OrderMetricsCards;
/* FILE: src/components/supplier/OrdersTable.tsx */
// src/components/supplier/OrdersTable.tsx

import React from 'react';
import { Eye, Package } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { format } from 'date-fns';
import type { SupplierOrder } from '../../api/handlers/supplierOrders.api';

interface OrdersTableProps {
  orders: SupplierOrder[];
  loading: boolean;
  pagination: {
    current_page: number;
    per_page: number;
    total: number;
    last_page: number;
  } | null;
  onPageChange: (page: number) => void;
}

const OrdersTable: React.FC<OrdersTableProps> = ({ orders, loading, pagination, onPageChange }) => {
  const navigate = useNavigate();

  const handleViewOrder = (orderId: number) => {
    console.log('Navigating to order:', orderId);
    navigate(`/supplier/orders/${orderId}`);
  };

  const getStatusColor = (orderStatus: string) => {
    const statusColors: Record<string, string> = {
      'Pending': 'bg-gray-100 text-gray-800',
      'In-Progress': 'bg-blue-100 text-blue-800',
      'Confirmed': 'bg-green-100 text-green-800',
      'Awaiting-Payment': 'bg-yellow-100 text-yellow-800',
      'Paid': 'bg-green-100 text-green-800',
      'In-Transit': 'bg-purple-100 text-purple-800',
      'Delivered': 'bg-green-100 text-green-800',
      'Cancelled': 'bg-red-100 text-red-800',
      'On-Hold': 'bg-orange-100 text-orange-800',
      // Legacy workflow statuses (in case they still appear)
      'Requested': 'bg-gray-100 text-gray-800',
      'Supplier Assigned': 'bg-blue-100 text-blue-800',
      'Supplier Missing': 'bg-red-100 text-red-800',
      'Payment Requested': 'bg-yellow-100 text-yellow-800',
      'In Transit': 'bg-purple-100 text-purple-800',
    };
    return statusColors[orderStatus] || 'bg-gray-100 text-gray-800';
  };

  const formatStatusLabel = (status: string) => {
    // Convert hyphenated status to readable format
    return status.replace(/-/g, ' ');
  };

  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
    }).format(amount || 0);
  };

  const formatDate = (dateString: string) => {
    try {
      return format(new Date(dateString), 'MMM dd, yyyy');
    } catch {
      return '-';
    }
  };

  if (loading) {
    return (
      <div className="bg-white rounded-lg border border-gray-200 overflow-hidden">
        <div className="animate-pulse">
          <div className="h-12 bg-gray-100"></div>
          {[...Array(5)].map((_, index) => (
            <div key={index} className="h-16 border-t border-gray-200 bg-white"></div>
          ))}
        </div>
      </div>
    );
  }

  if (!orders || orders.length === 0) {
    return (
      <div className="bg-white rounded-lg border border-gray-200 p-12 text-center">
        <Package className="w-16 h-16 text-gray-300 mx-auto mb-4" />
        <h3 className="text-lg font-medium text-gray-900 mb-2">No Orders Found</h3>
        <p className="text-gray-500">There are no orders matching your filters.</p>
      </div>
    );
  }

  return (
    <div className="bg-white rounded-lg border border-gray-200 overflow-hidden relative">
      {/* Loading Overlay for Filtering */}
      {loading && (
        <div className="absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
          <div className="flex flex-col items-center gap-3 bg-white p-6 rounded-lg shadow-lg">
            <div className="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent"></div>
            <p className="text-base font-medium text-gray-900">Loading orders...</p>
          </div>
        </div>
      )}
      
      <div className="overflow-x-auto">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Order Number
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Status
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Items
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Total Amount
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Created Date
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Action
              </th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {orders.map((order) => (
              <tr key={order.id} className="hover:bg-gray-50 transition-colors">
                <td className="px-6 py-4 whitespace-nowrap">
                  <div className="text-sm font-medium text-gray-900">
                    {order.po_number || `ORD-${order.id}`}
                  </div>
                </td>
                <td className="px-6 py-4 whitespace-nowrap">
                  <span className={`px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(order.order_status)}`}>
                    {formatStatusLabel(order.order_status)}
                  </span>
                </td>
                <td className="px-6 py-4 whitespace-nowrap">
                  <div className="flex items-center text-sm text-gray-900">
                    <Package className="w-4 h-4 mr-2 text-gray-400" />
                    {order.supplier_items_count} {order.supplier_items_count === 1 ? 'item' : 'items'}
                  </div>
                </td>
                <td className="px-6 py-4 whitespace-nowrap">
                  <div className="text-sm font-medium text-gray-900">
                    {formatCurrency(order.total_amount)}
                  </div>
                </td>
                <td className="px-6 py-4 whitespace-nowrap">
                  <div className="text-sm text-gray-500">
                    {formatDate(order.created_at)}
                  </div>
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm">
                  <button
                    onClick={() => handleViewOrder(order.id)}
                    className="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                  >
                    <Eye className="w-4 h-4" />
                    View
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* Pagination */}
      {pagination && pagination.last_page > 1 && (
        <div className="bg-gray-50 px-6 py-4 border-t border-gray-200 flex items-center justify-between">
          <div className="text-sm text-gray-700">
            Showing page {pagination.current_page} of {pagination.last_page}
            <span className="ml-2 text-gray-500">
              ({pagination.total} total orders)
            </span>
          </div>
          <div className="flex gap-2">
            <button
              onClick={() => onPageChange(pagination.current_page - 1)}
              disabled={pagination.current_page === 1}
              className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Previous
            </button>
            <button
              onClick={() => onPageChange(pagination.current_page + 1)}
              disabled={pagination.current_page === pagination.last_page}
              className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Next
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

export default OrdersTable;
/* FILE: src/components/supplier/ProductCard.tsx */
// FILE PATH: src/components/supplier/ProductCard.tsx
import { Package, Edit, Trash2, Plus, AlertCircle, Tag, Layers, CheckCircle2 } from 'lucide-react';
import type { MasterProduct , SupplierOffer} from '../../api/handlers/supplierProducts.api';
import ApproveStatusBadge from '../common/ApproveStatusBadge';
import type { BadgeStatus } from '../common/ApproveStatusBadge';



interface ProductCardProps {
  product: MasterProduct;
  onAddOffer: (product: MasterProduct) => void;
  onEditOffer: (product: MasterProduct, offer: SupplierOffer) => void;
  onRemoveOffer: (offerId: number, productName: string) => void;
}

const toBadgeStatus = (s: string): BadgeStatus => {
  switch ((s || "").toLowerCase()) {
    case "approved": return "Approved";
    case "rejected": return "Rejected";
    case "pending": default: return "Pending";
  }
};

const ProductCard = ({ product, onAddOffer, onEditOffer, onRemoveOffer }: ProductCardProps) => {
  const imageUrl = product.photo 
    ? `${import.meta.env.VITE_IMAGE_BASE_URL}storage/${product.photo}`
    : null;

  // Find if current supplier has an offer for this product
  const myOffer = product.suppliers.find(s => s.isMe === true);
  const hasOffer = !!myOffer;

  return (
    <div className="group bg-white rounded-2xl shadow-md hover:shadow-2xl transition-all duration-300 overflow-hidden border border-secondary-100 hover:border-primary-200 relative">
      {/* Status Badge - Top Right */}
      {hasOffer && (
        <div className="absolute top-4 right-4 z-10">
          <div className="bg-green-500 text-white px-3 py-1.5 rounded-full text-xs font-semibold shadow-lg flex items-center gap-1.5">
            <CheckCircle2 size={14} />
            Active Offer
          </div>
        </div>
      )}

      {/* Approval Status - Top Left */}
      {!product.is_approved && (
        <div className="absolute top-4 left-4 z-10">
          <div className="bg-yellow-100 text-yellow-700 px-3 py-1.5 rounded-full text-xs font-semibold shadow-md flex items-center gap-1.5 border border-yellow-200">
            <AlertCircle size={14} />
            Pending Approval
          </div>
        </div>
      )}

      {/* Image Section */}
      <div className="relative h-56 bg-gradient-to-br from-secondary-100 to-secondary-50 overflow-hidden">
        {imageUrl ? (
          <img 
            src={imageUrl} 
            alt={product.product_name}
            className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
            onError={(e) => {
              e.currentTarget.src = 'https://via.placeholder.com/400x300?text=No+Image';
            }}
          />
        ) : (
          <div className="w-full h-full flex items-center justify-center">
            <div className="text-center">
              <Package size={64} className="text-secondary-300 mx-auto mb-2" />
              <p className="text-secondary-400 text-sm font-medium">No Image</p>
            </div>
          </div>
        )}
        
        {/* Gradient Overlay */}
        <div className="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300" />
      </div>

      {/* Content Section */}
      <div className="p-6 space-y-4">
        {/* Product Name & Category */}
        <div>
          <h3 className="text-xl font-bold text-secondary-900 mb-2 line-clamp-2 group-hover:text-primary-600 transition-colors">
            {product.product_name}
          </h3>
          
          <div className="flex items-center gap-2 flex-wrap">
            {/* Category Badge */}
            <span className="inline-flex items-center gap-1.5 px-3 py-1 bg-primary-50 text-primary-700 rounded-lg text-xs font-medium border border-primary-100">
              <Tag size={12} />
              {product.category?.name || 'Uncategorized'}
            </span>
            
            {/* Product Type Badge */}
            <span className="inline-flex items-center gap-1.5 px-3 py-1 bg-blue-50 text-blue-700 rounded-lg text-xs font-medium border border-blue-100">
              <Layers size={12} />
              {product.product_type}
            </span>
          </div>
        </div>

        {/* Specifications */}
        {product.specifications && (
          <div className="bg-secondary-50 rounded-xl p-4 border border-secondary-100">
            <p className="text-sm text-secondary-700 line-clamp-3 leading-relaxed">
              {product.specifications}
            </p>
          </div>
        )}

        {/* Unit of Measure */}
        <div className="flex items-center gap-2 text-sm">
          <span className="text-secondary-500 font-medium">Unit:</span>
          <span className="px-3 py-1 bg-secondary-100 text-secondary-900 rounded-lg font-semibold">
            {product.unit_of_measure}
          </span>
        </div>

        {/* My Offer Details (if exists) */}
        {hasOffer && myOffer && (
          <div className="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 border border-green-200 space-y-3">
            <div className="flex items-center justify-between">
              <span className="text-sm font-medium text-green-900">Your Offer</span>
              <ApproveStatusBadge status={toBadgeStatus(myOffer.status)} />
            </div>
            
            <div className="flex items-baseline gap-2">
              <span className="text-3xl font-bold text-green-700">
                ${parseFloat(myOffer.price).toFixed(2)}
              </span>
              <span className="text-sm text-green-600">
                per {product.unit_of_measure}
              </span>
            </div>

            {/* Action Buttons for Offer */}
            <div className="flex gap-2 pt-2">
              <button
                onClick={() => onEditOffer(product, myOffer)}
                className="flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-white border-2 border-green-300 text-green-700 rounded-lg hover:bg-green-50 transition-all font-medium shadow-sm hover:shadow-md"
              >
                <Edit size={16} />
                Edit
              </button>
              
              <button
                onClick={() => onRemoveOffer(myOffer.id, product.product_name)}
                className="flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-white border-2 border-error-300 text-error-700 rounded-lg hover:bg-error-50 transition-all font-medium shadow-sm hover:shadow-md"
              >
                <Trash2 size={16} />
                Remove
              </button>
            </div>
          </div>
        )}

        {/* Add to Offers Button (if no offer) */}
        {!hasOffer && (
          <div className="pt-2">
            <button
              onClick={() => onAddOffer(product)}
              disabled={!product.is_approved}
              className={`w-full flex items-center justify-center gap-2 px-6 py-3.5 rounded-xl font-semibold transition-all shadow-md ${
                product.is_approved
                  ? 'bg-gradient-to-r from-primary-500 to-primary-600 text-white hover:from-primary-600 hover:to-primary-700 hover:shadow-xl hover:scale-105'
                  : 'bg-secondary-200 text-secondary-500 cursor-not-allowed'
              }`}
            >
              <Plus size={20} />
              {product.is_approved ? 'Add to Offers' : 'Awaiting Approval'}
            </button>
          </div>
        )}
      </div>

      {/* Card Border Indicator */}
      <div className={`absolute bottom-0 left-0 right-0 h-1 transition-all duration-300 ${
        hasOffer ? 'bg-gradient-to-r from-green-500 to-emerald-500' : 'bg-gradient-to-r from-primary-500 to-blue-500 opacity-0 group-hover:opacity-100'
      }`} />
    </div>
  );
};

export default ProductCard;
/* FILE: src/components/supplier/RequestProductModal.tsx */
// FILE PATH: src/components/supplier/RequestProductModal.tsx
/**
 * REQUEST PRODUCT MODAL - FIXED VERSION
 * 
 * FIXES:
 * ✅ Price field now uses native input (not Input2 component)
 * ✅ Availability options match validation: "Limited" (not "Limited Stock")
 * ✅ Added debug console logs
 */

import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { X, Package, Upload, FileText, Layers, DollarSign, CheckCircle } from 'lucide-react';
import toast from 'react-hot-toast';
import type { Category } from '../../api/handlers/supplierProducts.api';
import { supplierProductsAPI } from '../../api/handlers/supplierProducts.api';
import { requestProductSchema } from '../../utils/validators';
import type { RequestProductFormData } from '../../utils/validators';
import Input2 from '../common/Input2';
import Button from '../common/Buttons';

interface RequestProductModalProps {
  isOpen: boolean;
  onClose: () => void;
  categories: Category[];
}

const RequestProductModal = ({ isOpen, onClose, categories }: RequestProductModalProps) => {
  const queryClient = useQueryClient();
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  const [previewUrl, setPreviewUrl] = useState<string | null>(null);

  const {
    register,
    handleSubmit,
    formState: { errors },
    reset,
  } = useForm<RequestProductFormData>({
    resolver: zodResolver(requestProductSchema),
    defaultValues: {
      availability_status: 'In Stock',
    },
  });

  const requestProductMutation = useMutation({
    mutationFn: supplierProductsAPI.requestMasterProduct,
    onSuccess: () => {
      toast.success('Product request submitted successfully!');
      queryClient.invalidateQueries({ queryKey: ['supplier-products'] });
      handleClose();
    },
    onError: (error: any) => {
      const message = error.response?.data?.message || 'Failed to submit request';
      toast.error(message);
      console.error('Error:', error);
    },
  });

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      if (!file.type.startsWith('image/')) {
        toast.error('Please select an image file');
        return;
      }
      if (file.size > 5 * 1024 * 1024) {
        toast.error('Image must be less than 5MB');
        return;
      }
      setSelectedFile(file);
      const reader = new FileReader();
      reader.onloadend = () => setPreviewUrl(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const removeImage = () => {
    setSelectedFile(null);
    setPreviewUrl(null);
  };

  const onSubmit = (data: RequestProductFormData) => {
    console.log('📝 Form Data:', data);
    
    const payload = {
      product_name: data.product_name,
      product_type: data.product_type,
      category_id: data.category_id,
      specifications: data.specifications || '',
      unit_of_measure: data.unit_of_measure,
      price: data.price,
      availability_status: data.availability_status,
      photo: selectedFile || null,
    };

    console.log('🚀 Sending payload:', payload);
    requestProductMutation.mutate(payload);
  };

  const handleClose = () => {
    reset();
    setSelectedFile(null);
    setPreviewUrl(null);
    onClose();
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        
        {/* Header */}
        <div className="sticky top-0 bg-white z-10 flex items-center justify-between p-6 border-b-2 border-secondary-100">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 bg-primary-100 rounded-xl flex items-center justify-center">
              <Package size={24} className="text-primary-600" />
            </div>
            <div>
              <h2 className="text-2xl font-bold text-secondary-900">Request New Product</h2>
              <p className="text-sm text-secondary-600">Submit for admin approval</p>
            </div>
          </div>
          <button
            onClick={handleClose}
            disabled={requestProductMutation.isPending}
            className="text-secondary-400 hover:text-secondary-600 hover:bg-secondary-100 rounded-lg p-2 transition-colors"
          >
            <X size={24} />
          </button>
        </div>

        {/* Form */}
        <form onSubmit={handleSubmit(onSubmit)} className="p-6 space-y-6">
          
          {/* Product Name */}
          <Input2
            label="Product Name"
            type="text"
            placeholder="e.g., Premium Blue Metal"
            icon={Package}
            error={errors.product_name?.message}
            {...register('product_name')}
            required
          />

          {/* Product Type */}
          <Input2
            label="Product Type"
            type="text"
            placeholder="e.g., Construction Material"
            icon={Layers}
            error={errors.product_type?.message}
            {...register('product_type')}
            required
          />

          {/* Category */}
          <div>
            <label className="block text-sm font-medium text-secondary-700 mb-2">
              Category <span className="text-error-500">*</span>
            </label>
            <div className="relative">
              <Layers className="absolute left-3 top-1/2 -translate-y-1/2 text-secondary-400" size={20} />
              <select
                {...register('category_id', { valueAsNumber: true })}
                className={`
                  w-full pl-11 pr-4 py-3 rounded-lg border-2 transition-all
                  ${errors.category_id 
                    ? 'border-error-500 focus:border-error-500 focus:ring-error-500' 
                    : 'border-secondary-200 focus:border-primary-500 focus:ring-primary-500'
                  }
                  focus:outline-none focus:ring-2 focus:ring-opacity-20
                `}
              >
                <option value="">Select category</option>
                {categories.map((cat) => (
                  <option key={cat.id} value={cat.id}>
                    {cat.name}
                  </option>
                ))}
              </select>
            </div>
            {errors.category_id && (
              <p className="text-sm text-error-500 mt-1">{errors.category_id.message}</p>
            )}
          </div>

          {/* Unit of Measure */}
          <Input2
            label="Unit of Measure"
            type="text"
            placeholder="e.g., ton, kg, cubic meter"
            icon={Layers}
            error={errors.unit_of_measure?.message}
            {...register('unit_of_measure')}
            required
          />

          {/* Price - FIXED: Using native input */}
          <div>
            <label className="block text-sm font-medium text-secondary-700 mb-2">
              Price per Unit <span className="text-error-500">*</span>
            </label>
            <div className="relative">
              <DollarSign className="absolute left-3 top-1/2 -translate-y-1/2 text-secondary-400" size={20} />
              <input
                type="number"
                step="0.01"
                min="0"
                placeholder="0.00"
                {...register('price')}
                className={`
                  w-full pl-11 pr-4 py-3 rounded-lg border-2 transition-all
                  ${errors.price 
                    ? 'border-error-500 focus:border-error-500 focus:ring-error-500' 
                    : 'border-secondary-200 focus:border-primary-500 focus:ring-primary-500'
                  }
                  focus:outline-none focus:ring-2 focus:ring-opacity-20
                `}
              />
            </div>
            {errors.price && (
              <p className="text-sm text-error-500 mt-1">{errors.price.message}</p>
            )}
          </div>

          {/* Availability Status - FIXED: Options match validation */}
          <div>
            <label className="block text-sm font-medium text-secondary-700 mb-2">
              Availability Status <span className="text-error-500">*</span>
            </label>
            <div className="relative">
              <CheckCircle className="absolute left-3 top-1/2 -translate-y-1/2 text-secondary-400" size={20} />
              <select
                {...register('availability_status')}
                className={`
                  w-full pl-11 pr-4 py-3 rounded-lg border-2 transition-all
                  ${errors.availability_status 
                    ? 'border-error-500 focus:border-error-500 focus:ring-error-500' 
                    : 'border-secondary-200 focus:border-primary-500 focus:ring-primary-500'
                  }
                  focus:outline-none focus:ring-2 focus:ring-opacity-20
                `}
              >
                <option value="In Stock">In Stock</option>
                <option value="Out of Stock">Out of Stock</option>
                <option value="Limited">Limited</option>
              </select>
            </div>
            {errors.availability_status && (
              <p className="text-sm text-error-500 mt-1">{errors.availability_status.message}</p>
            )}
          </div>

          {/* Specifications */}
          <div>
            <label className="block text-sm font-medium text-secondary-700 mb-2">
              Specifications
            </label>
            <textarea
              {...register('specifications')}
              rows={4}
              placeholder="Product specifications..."
              className={`
                w-full px-4 py-3 rounded-lg border-2 transition-all resize-none
                ${errors.specifications 
                  ? 'border-error-500 focus:border-error-500' 
                  : 'border-secondary-200 focus:border-primary-500'
                }
                focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-20
              `}
            />
          </div>

          {/* Image Upload */}
          <div>
            <label className="block text-sm font-medium text-secondary-700 mb-2">
              Product Image (Optional)
            </label>
            
            {previewUrl ? (
              <div className="relative">
                <img
                  src={previewUrl}
                  alt="Preview"
                  className="w-full h-48 object-cover rounded-lg border-2 border-secondary-200"
                />
                <button
                  type="button"
                  onClick={removeImage}
                  className="absolute top-2 right-2 bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 shadow-lg"
                >
                  <X size={16} />
                </button>
              </div>
            ) : (
              <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-secondary-300 rounded-lg cursor-pointer bg-secondary-50 hover:bg-secondary-100">
                <Upload size={32} className="text-secondary-400 mb-2" />
                <span className="text-sm text-secondary-600">Click to upload</span>
                <span className="text-xs text-secondary-500 mt-1">PNG, JPG up to 5MB</span>
                <input
                  type="file"
                  accept="image/*"
                  onChange={handleFileChange}
                  className="hidden"
                />
              </label>
            )}
          </div>

          {/* Info Box */}
          <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
            <div className="flex gap-3">
              <FileText className="text-blue-600 flex-shrink-0 mt-0.5" size={20} />
              <p className="text-sm text-blue-700">
                Once approved, this product will be added to the master inventory.
              </p>
            </div>
          </div>

          {/* Buttons */}
          <div className="flex gap-3 pt-4 border-t-2 border-secondary-100">
            <Button
              type="button"
              onClick={handleClose}
              variant="outline"
              fullWidth
              disabled={requestProductMutation.isPending}
            >
              Cancel
            </Button>
            <Button
              type="submit"
              variant="primary"
              fullWidth
              disabled={requestProductMutation.isPending}
              isLoading={requestProductMutation.isPending}
            >
              {requestProductMutation.isPending ? 'Submitting...' : 'Submit Request'}
            </Button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default RequestProductModal;
/* FILE: src/components/supplier/SupplierOrderDetail.tsx */
// src/pages/supplier/SupplierOrderDetail.tsx

import { useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import {
  ArrowLeft,
  MapPin,
  Calendar,
  Clock,
  Truck,
  User,
  Phone,
  Mail,
  Edit,
  CheckCircle,
  XCircle,
  Package,
  Loader2,
} from 'lucide-react';
import { format } from 'date-fns';
import { useSupplierOrderDetail } from '../../features/supplierOrders/hooks';
import DashboardLayout from '../../components/layout/DashboardLayout';
import OrderItemEditModal from '../../components/supplier/OrderItemEditModal';
import { supplierMenuItems } from '../../utils/menuItems';
import type { SupplierOrderItem } from '../../api/handlers/supplierOrders.api';

const SupplierOrderDetail = () => {
  const { orderId } = useParams();
  const navigate = useNavigate();
  
  console.log('SupplierOrderDetail - orderId from params:', orderId);
  
  const { data, isLoading, refetch, error } = useSupplierOrderDetail(Number(orderId));
  const [editingItem, setEditingItem] = useState<SupplierOrderItem | null>(null);
  const [isModalOpen, setIsModalOpen] = useState(false);

  console.log('Order detail data:', data);
  console.log('Loading state:', isLoading);
  console.log('Error:', error);

  const handleEditItem = (item: SupplierOrderItem) => {
    setEditingItem(item);
    setIsModalOpen(true);
  };

  const handleModalClose = () => {
    setIsModalOpen(false);
    setEditingItem(null);
  };

  const handleUpdateSuccess = () => {
    refetch();
  };

  const formatDate = (dateString: string) => {
    if (!dateString) return '-';
    try {
      // Handle ISO format with timezone
      const date = new Date(dateString);
      return format(date, 'MMM dd, yyyy');
    } catch {
      return '-';
    }
  };

  const formatDateTime = (dateString: string, timeString?: string) => {
    if (!dateString) return '-';
    try {
      const date = format(new Date(dateString), 'MMM dd, yyyy');
      return timeString ? `${date} at ${timeString}` : date;
    } catch {
      return '-';
    }
  };

  const getStatusColor = (workflow: string) => {
    const colors: Record<string, string> = {
      'Requested': 'bg-gray-100 text-gray-800',
      'Supplier Assigned': 'bg-blue-100 text-blue-800',
      'Supplier Missing': 'bg-red-100 text-red-800',
      'Payment Requested': 'bg-yellow-100 text-yellow-800',
      'Paid': 'bg-green-100 text-green-800',
      'In Transit': 'bg-purple-100 text-purple-800',
      'Delivered': 'bg-green-100 text-green-800',
    };
    return colors[workflow] || 'bg-gray-100 text-gray-800';
  };

  const calculateItemTotal = (item: SupplierOrderItem) => {
    const unitCost = parseFloat(item.supplier_unit_cost);
    const quantity = parseFloat(item.quantity);
    const discount = parseFloat(item.supplier_discount);
    return (unitCost * quantity) - discount;
  };

  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
    }).format(amount || 0);
  };

  if (isLoading) {
    return (
      <DashboardLayout menuItems={supplierMenuItems}>
        <div className="flex items-center justify-center py-12">
          <div className="text-center">
            <Loader2 className="w-12 h-12 animate-spin text-blue-600 mx-auto mb-4" />
            <p className="text-gray-600">Loading order details...</p>
          </div>
        </div>
      </DashboardLayout>
    );
  }

  if (!data?.data) {
    return (
      <DashboardLayout menuItems={supplierMenuItems}>
        <div className="text-center py-12">
          <Package className="w-16 h-16 text-gray-300 mx-auto mb-4" />
          <h3 className="text-lg font-medium text-gray-900 mb-2">Order Not Found</h3>
          {error && (
            <p className="text-red-600 mb-4">{(error as Error).message}</p>
          )}
          <p className="text-gray-600 mb-4">
            Order ID: {orderId} | Data: {JSON.stringify(data)}
          </p>
          <button
            onClick={() => navigate('/supplier/orders')}
            className="text-blue-600 hover:text-blue-700 inline-flex items-center gap-2"
          >
            <ArrowLeft className="w-4 h-4" />
            Back to Orders
          </button>
        </div>
      </DashboardLayout>
    );
  }

  const { order, supplier_items } = data.data;

  return (
    <DashboardLayout menuItems={supplierMenuItems}>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <button
            onClick={() => navigate('/supplier/orders')}
            className="flex items-center gap-2 text-gray-600 hover:text-blue-600 transition-colors"
          >
            <ArrowLeft className="w-5 h-5" />
            Back to Orders
          </button>
          <span className={`px-4 py-2 rounded-full text-sm font-semibold ${getStatusColor(order.workflow)}`}>
            {order.workflow}
          </span>
        </div>

        {/* Order Header */}
        <div className="bg-white rounded-lg border border-gray-200 p-6">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h1 className="text-3xl font-bold text-gray-900">Order #{order.po_number || order.id}</h1>
              <p className="text-gray-600 mt-1">Order details and your items</p>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Left Column - Order Info */}
          <div className="lg:col-span-2 space-y-6">
            {/* Delivery Information */}
            <div className="bg-white rounded-lg border border-gray-200 p-6">
              <h2 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                <Truck className="w-5 h-5 text-blue-600" />
                Delivery Information
              </h2>
              <div className="space-y-3">
                <div className="flex items-start gap-3">
                  <MapPin className="w-5 h-5 text-gray-400 mt-0.5" />
                  <div>
                    <p className="text-sm font-medium text-gray-700">Address</p>
                    <p className="text-gray-900">{order.delivery_address || 'N/A'}</p>
                  </div>
                </div>
                <div className="flex items-start gap-3">
                  <Calendar className="w-5 h-5 text-gray-400 mt-0.5" />
                  <div>
                    <p className="text-sm font-medium text-gray-700">Delivery Date</p>
                    <p className="text-gray-900">{formatDateTime(order.delivery_date, order.delivery_time)}</p>
                  </div>
                </div>
                {order.delivery_window && (
                  <div className="flex items-start gap-3">
                    <Clock className="w-5 h-5 text-gray-400 mt-0.5" />
                    <div>
                      <p className="text-sm font-medium text-gray-700">Delivery Window</p>
                      <p className="text-gray-900">{order.delivery_window}</p>
                    </div>
                  </div>
                )}
                {order.delivery_method && (
                  <div className="flex items-start gap-3">
                    <Truck className="w-5 h-5 text-gray-400 mt-0.5" />
                    <div>
                      <p className="text-sm font-medium text-gray-700">Delivery Method</p>
                      <p className="text-gray-900">{order.delivery_method}</p>
                    </div>
                  </div>
                )}
              </div>
              {order.special_notes && (
                <div className="mt-4 pt-4 border-t border-gray-200">
                  <p className="text-sm font-medium text-gray-700 mb-2">Special Notes</p>
                  <p className="text-gray-600 text-sm">{order.special_notes}</p>
                </div>
              )}
            </div>

            {/* Your Items */}
            <div className="bg-white rounded-lg border border-gray-200 p-6">
              <h2 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                <Package className="w-5 h-5 text-blue-600" />
                Your Items
              </h2>
              <div className="space-y-4">
                {supplier_items.map((item) => (
                  <div
                    key={item.id}
                    className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow"
                  >
                    <div className="flex items-start gap-4">
                      {item.product?.photo && (
                        <img
                          src={item.product.photo}
                          alt={item.product.product_name}
                          className="w-20 h-20 object-cover rounded-lg"
                        />
                      )}
                      <div className="flex-1">
                        <div className="flex items-start justify-between">
                          <div>
                            <h3 className="font-semibold text-gray-900">{item.product?.product_name}</h3>
                            <p className="text-sm text-gray-600">
                              Quantity: {item.quantity} {item.product?.unit_of_measure}
                            </p>
                          </div>
                          <div className="flex items-center gap-2">
                            {item.supplier_confirms ? (
                              <span className="flex items-center gap-1 text-green-600 text-sm">
                                <CheckCircle className="w-4 h-4" />
                                Confirmed
                              </span>
                            ) : (
                              <span className="flex items-center gap-1 text-orange-600 text-sm">
                                <XCircle className="w-4 h-4" />
                                Pending
                              </span>
                            )}
                          </div>
                        </div>
                        <div className="mt-3 grid grid-cols-2 gap-4 text-sm">
                          <div>
                            <p className="text-gray-600">Unit Cost</p>
                            <p className="font-medium text-gray-900">{formatCurrency(parseFloat(item.supplier_unit_cost))}</p>
                          </div>
                          <div>
                            <p className="text-gray-600">Discount</p>
                            <p className="font-medium text-gray-900">{formatCurrency(parseFloat(item.supplier_discount))}</p>
                          </div>
                          <div>
                            <p className="text-gray-600">Delivery Date</p>
                            <p className="font-medium text-gray-900">{formatDate(item.supplier_delivery_date)}</p>
                          </div>
                          <div>
                            <p className="text-gray-600">Item Total</p>
                            <p className="font-bold text-blue-600">{formatCurrency(calculateItemTotal(item))}</p>
                          </div>
                        </div>
                        {item.supplier_notes && (
                          <div className="mt-3 pt-3 border-t border-gray-200">
                            <p className="text-sm text-gray-600">
                              <span className="font-medium">Notes:</span> {item.supplier_notes}
                            </p>
                          </div>
                        )}
                        <div className="mt-4">
                          <button
                            onClick={() => handleEditItem(item)}
                            className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm"
                          >
                            <Edit className="w-4 h-4" />
                            Edit Item
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* Right Column - Client & Project Info */}
          <div className="space-y-6">
            {/* Client Information */}
            <div className="bg-white rounded-lg border border-gray-200 p-6">
              <h2 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                <User className="w-5 h-5 text-blue-600" />
                Client Information
              </h2>
              <div className="space-y-3">
                <div>
                  <p className="text-sm text-gray-600">Name</p>
                  <p className="font-medium text-gray-900">{order.client?.name || 'N/A'}</p>
                </div>
                <div className="flex items-center gap-2">
                  <Mail className="w-4 h-4 text-gray-400" />
                  <p className="text-sm text-gray-900">{order.client?.email || 'N/A'}</p>
                </div>
              </div>
            </div>

            {/* Project Information */}
            <div className="bg-white rounded-lg border border-gray-200 p-6">
              <h2 className="text-lg font-bold text-gray-900 mb-4">Project Information</h2>
              <div className="space-y-3">
                <div>
                  <p className="text-sm text-gray-600">Project Name</p>
                  <p className="font-medium text-gray-900">{order.project?.name || 'N/A'}</p>
                </div>
                {order.project?.site_contact_name && (
                  <div>
                    <p className="text-sm text-gray-600">Site Contact</p>
                    <p className="text-gray-900">{order.project.site_contact_name}</p>
                  </div>
                )}
                {order.project?.site_contact_phone && (
                  <div className="flex items-center gap-2">
                    <Phone className="w-4 h-4 text-gray-400" />
                    <p className="text-sm text-gray-900">{order.project.site_contact_phone}</p>
                  </div>
                )}
                {order.project?.site_instructions && (
                  <div className="pt-3 border-t border-gray-200">
                    <p className="text-sm font-medium text-gray-700 mb-1">Site Instructions</p>
                    <p className="text-sm text-gray-600">{order.project.site_instructions}</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Edit Modal */}
      <OrderItemEditModal
        item={editingItem}
        isOpen={isModalOpen}
        onClose={handleModalClose}
        onSuccess={handleUpdateSuccess}
      />
    </DashboardLayout>
  );
};

export default SupplierOrderDetail;
/* FILE: src/components/ui/tooltip.tsx */
// FILE PATH: src/components/ui/tooltip.tsx

/**
 * Simple Custom Tooltip Component (No Dependencies)
 * A lightweight alternative to Radix UI Tooltip
 */

import React, { useState, useRef, useEffect } from 'react';

interface TooltipProps {
  children: React.ReactNode;
}

interface TooltipTriggerProps {
  children: React.ReactNode;
  asChild?: boolean;
}

interface TooltipContentProps {
  children: React.ReactNode;
  side?: 'top' | 'bottom' | 'left' | 'right';
  className?: string;
}

interface TooltipProviderProps {
  children: React.ReactNode;
  delayDuration?: number;
}

// Context for tooltip state
const TooltipContext = React.createContext<{
  isOpen: boolean;
  setIsOpen: (open: boolean) => void;
  delayDuration: number;
}>({
  isOpen: false,
  setIsOpen: () => {},
  delayDuration: 200,
});

export const TooltipProvider: React.FC<TooltipProviderProps> = ({ 
  children, 
  delayDuration = 200 
}) => {
  const [isOpen, setIsOpen] = useState(false);

  return (
    <TooltipContext.Provider value={{ isOpen, setIsOpen, delayDuration }}>
      {children}
    </TooltipContext.Provider>
  );
};

export const Tooltip: React.FC<TooltipProps> = ({ children }) => {
  return <div className="relative inline-block">{children}</div>;
};

export const TooltipTrigger: React.FC<TooltipTriggerProps> = ({ 
  children, 
  asChild 
}) => {
  const { setIsOpen, delayDuration } = React.useContext(TooltipContext);
  const timeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);
  
  const handleMouseEnter = () => {
    timeoutRef.current = setTimeout(() => {
      setIsOpen(true);
    }, delayDuration);
  };

  const handleMouseLeave = () => {
    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
    }
    setIsOpen(false);
  };

  useEffect(() => {
    return () => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
    };
  }, []);

  if (asChild && React.isValidElement(children)) {
    return React.cloneElement(children as React.ReactElement<any>, {
      onMouseEnter: handleMouseEnter,
      onMouseLeave: handleMouseLeave,
    });
  }

  return (
    <div
      onMouseEnter={handleMouseEnter}
      onMouseLeave={handleMouseLeave}
      className="inline-block"
    >
      {children}
    </div>
  );
};

export const TooltipContent: React.FC<TooltipContentProps> = ({ 
  children, 
  side = 'top',
  className = '' 
}) => {
  const { isOpen } = React.useContext(TooltipContext);

  if (!isOpen) return null;

  const positionClasses = {
    top: 'bottom-full left-1/2 -translate-x-1/2 mb-2',
    bottom: 'top-full left-1/2 -translate-x-1/2 mt-2',
    left: 'right-full top-1/2 -translate-y-1/2 mr-2',
    right: 'left-full top-1/2 -translate-y-1/2 ml-2',
  };

  return (
    <div
      className={`
        absolute z-50 
        px-3 py-1.5 
        text-sm text-white 
        bg-gray-900 
        border border-gray-700 
        rounded-lg 
        shadow-lg
        whitespace-nowrap
        animate-in fade-in-0 zoom-in-95
        ${positionClasses[side]}
        ${className}
      `}
      style={{
        animation: 'fadeIn 0.15s ease-in-out',
      }}
    >
      {children}
      
      {/* Arrow */}
      <div
        className={`
          absolute w-2 h-2 bg-gray-900 border border-gray-700
          transform rotate-45
          ${side === 'top' ? 'bottom-[-5px] left-1/2 -translate-x-1/2 border-t-0 border-l-0' : ''}
          ${side === 'bottom' ? 'top-[-5px] left-1/2 -translate-x-1/2 border-b-0 border-r-0' : ''}
          ${side === 'left' ? 'right-[-5px] top-1/2 -translate-y-1/2 border-l-0 border-b-0' : ''}
          ${side === 'right' ? 'left-[-5px] top-1/2 -translate-y-1/2 border-r-0 border-t-0' : ''}
        `}
      />
    </div>
  );
};

// Add fadeIn animation to global styles or tailwind config
// If you're using Tailwind, add this to your tailwind.config.js:
// 
// module.exports = {
//   theme: {
//     extend: {
//       keyframes: {
//         fadeIn: {
//           '0%': { opacity: '0', transform: 'scale(0.95)' },
//           '100%': { opacity: '1', transform: 'scale(1)' },
//         },
//       },
//       animation: {
//         fadeIn: 'fadeIn 0.15s ease-in-out',
//       },
//     },
//   },
// }
/* FILE: src/config/permissions.ts */
// src/config/permissions.ts
// ============================================
// PERMISSION MANAGEMENT SYSTEM
// Single source of truth for all role-based permissions
// ============================================

// Available roles in the system
export type Role = 'admin' | 'support' | 'accountant' | 'supplier' | 'client';

// All available permissions in the system
export type Permission =
  // ==================== PROJECTS ====================
  | 'projects.view_all'        // View all projects (admin area)
  | 'projects.view_own'        // View own projects only
  | 'projects.edit'            // Edit project details
  | 'projects.create'          // Create new projects
  | 'projects.delete'          // Delete/archive projects

  // ==================== ORDERS ====================
  | 'orders.view_all'          // View all orders (admin area)
  | 'orders.view_own'          // View own orders only
  | 'orders.create'            // Create new orders
  | 'orders.edit'              // Edit order details
  | 'orders.mark_delivered'    // Mark order as delivered
  | 'orders.assign_supplier'   // Assign supplier to order items
  | 'orders.cancel'            // Cancel orders
  | 'orders.update_status'     // Update order workflow status

  // ==================== PRICING ====================
  | 'pricing.view_cost_price'      // View supplier cost price
  | 'pricing.view_profit_margin'   // View profit margin
  | 'pricing.edit_supplier_rates'  // Edit supplier rates/offers
  | 'pricing.enter_quoted_rates'   // Enter quoted rates & client surcharges
  | 'pricing.view_client_price'    // View client-facing price

  // ==================== USERS ====================
  | 'users.view'               // View user list
  | 'users.view_details'       // View user details
  | 'users.create'             // Create new users
  | 'users.edit'               // Edit user details
  | 'users.delete'             // Delete/deactivate users
  | 'users.manage_roles'       // Assign/change user roles

  // ==================== PRODUCTS ====================
  | 'products.view'            // View products catalog
  | 'products.create'          // Create master products
  | 'products.edit'            // Edit product details
  | 'products.delete'          // Delete products
  | 'products.approve'         // Approve/reject products & offers

  // ==================== SUPPLIERS ====================
  | 'suppliers.view'           // View suppliers list
  | 'suppliers.view_zones'     // View delivery zones
  | 'suppliers.edit_zones'     // Edit delivery zones
  | 'suppliers.approve'        // Approve supplier accounts
  | 'suppliers.view_offers'    // View supplier offers

  // ==================== CLIENTS ====================
  | 'clients.view'             // View clients list
  | 'clients.view_details'     // View client details
  | 'clients.edit'             // Edit client details
  | 'clients.manage_pricing'   // Manage client-specific pricing

  // ==================== REPORTS ====================
  | 'reports.view'             // View reports section
  | 'reports.view_revenue'     // View revenue reports
  | 'reports.view_supplier_performance' // View supplier performance
  | 'reports.view_client_spend'         // View client spending reports
  | 'reports.export'           // Export report data

  // ==================== PAYMENTS ====================
  | 'payments.view'            // View payments
  | 'payments.process'         // Process payments
  | 'payments.refund'          // Process refunds
  | 'payments.mark_paid'       // Mark supplier as paid

  // ==================== SYSTEM ====================
  | 'system.view_dashboard'    // View admin dashboard
  | 'system.manage_categories' // Manage product categories
  | 'system.view_logs'         // View system logs
  | 'system.manage_settings';  // Manage system settings


// ============================================
// ROLE PERMISSIONS MATRIX
// Maps each role to their allowed permissions
// ============================================

export const ROLE_PERMISSIONS: Record<Role, Permission[]> = {
  // ==================== ADMIN ====================
  // Full access to everything
  admin: [
    // Projects - Full Access
    'projects.view_all',
    'projects.view_own',
    'projects.edit',
    'projects.create',
    'projects.delete',

    // Orders - Full Access
    'orders.view_all',
    'orders.view_own',
    'orders.create',
    'orders.edit',
    'orders.mark_delivered',
    'orders.assign_supplier',
    'orders.cancel',
    'orders.update_status',

    // Pricing - Full Access
    'pricing.view_cost_price',
    'pricing.view_profit_margin',
    'pricing.edit_supplier_rates',
    'pricing.enter_quoted_rates',
    'pricing.view_client_price',

    // Users - Full Access
    'users.view',
    'users.view_details',
    'users.create',
    'users.edit',
    'users.delete',
    'users.manage_roles',

    // Products - Full Access
    'products.view',
    'products.create',
    'products.edit',
    'products.delete',
    'products.approve',

    // Suppliers - Full Access
    'suppliers.view',
    'suppliers.view_zones',
    'suppliers.edit_zones',
    'suppliers.approve',
    'suppliers.view_offers',

    // Clients - Full Access
    'clients.view',
    'clients.view_details',
    'clients.edit',
    'clients.manage_pricing',

    // Reports - Full Access
    'reports.view',
    'reports.view_revenue',
    'reports.view_supplier_performance',
    'reports.view_client_spend',
    'reports.export',

    // Payments - Full Access
    'payments.view',
    'payments.process',
    'payments.refund',
    'payments.mark_paid',

    // System - Full Access
    'system.view_dashboard',
    'system.manage_categories',
    'system.view_logs',
    'system.manage_settings',
  ],

  // ==================== SUPPORT (OPS SUPPORT) ====================
  // Operational support - can manage orders and basic operations
  // NO access to: cost price, profit margin, supplier rate editing
  support: [
    // Projects - View All + Edit
    'projects.view_all',
    'projects.view_own',
    'projects.edit',

    // Orders - Full operational access
    'orders.view_all',
    'orders.view_own',
    'orders.create',
    'orders.edit',
    'orders.mark_delivered',
    'orders.assign_supplier',
    'orders.update_status',

    // Pricing - Can enter quoted rates, but NOT view cost/margin
    'pricing.enter_quoted_rates',
    'pricing.view_client_price',

    // Users - View and basic management
    'users.view',
    'users.view_details',
    'users.create',
    'users.edit',

    // Products - View only
    'products.view',

    // Suppliers - View only
    'suppliers.view',
    'suppliers.view_zones',
    'suppliers.view_offers',

    // Clients - View and edit
    'clients.view',
    'clients.view_details',
    'clients.edit',

    // System
    'system.view_dashboard',
  ],

  // ==================== ACCOUNTANT ====================
  // Financial oversight - Read-only for most, but can see all financial data
  // NO access to: editing, creating, operational actions
  accountant: [
    // Projects - Read Only
    'projects.view_all',
    'projects.view_own',
    // NO edit, create, delete

    // Orders - View Only
    'orders.view_all',
    'orders.view_own',
    // NO create, edit, mark_delivered, assign

    // Pricing - Full visibility (READ ONLY)
    'pricing.view_cost_price',
    'pricing.view_profit_margin',
    'pricing.view_client_price',
    // NO editing capabilities

    // Users - View Only
    'users.view',
    'users.view_details',
    // NO create, edit, delete

    // Products - View Only
    'products.view',

    // Suppliers - View Only
    'suppliers.view',
    'suppliers.view_zones',
    'suppliers.view_offers',

    // Clients - View Only
    'clients.view',
    'clients.view_details',

    // Reports - Full Access (primary role function)
    'reports.view',
    'reports.view_revenue',
    'reports.view_supplier_performance',
    'reports.view_client_spend',
    'reports.export',

    // Payments - View and mark paid
    'payments.view',
    'payments.mark_paid',

    // System
    'system.view_dashboard',
  ],

  // ==================== SUPPLIER ====================
  // Own data only + delivery management
  supplier: [
    // Projects - None (suppliers don't see projects)
    
    // Orders - Own orders only
    'orders.view_own',
    'orders.mark_delivered', // Own orders only

    // Pricing - Can see their own cost price
    'pricing.view_cost_price',
    'pricing.view_profit_margin',

    // Products - Manage own offers
    'products.view',
    'products.create', // Request new products

    // Suppliers - Own data
    'suppliers.view_zones',
    'suppliers.edit_zones',
    'suppliers.view_offers',
  ],

  // ==================== CLIENT ====================
  // Own data only
  client: [
    // Projects - Own only
    'projects.view_own',
    'projects.create',
    'projects.edit', // Own only

    // Orders - Own only
    'orders.view_own',
    'orders.create',

    // Pricing - Client price only
    'pricing.view_client_price',

    // Products - View catalog
    'products.view',
  ],
};


// ============================================
// HELPER FUNCTIONS
// ============================================

/**
 * Check if a role has a specific permission
 */
export const roleHasPermission = (role: Role, permission: Permission): boolean => {
  return ROLE_PERMISSIONS[role]?.includes(permission) ?? false;
};

/**
 * Get all permissions for a role
 */
export const getRolePermissions = (role: Role): Permission[] => {
  return ROLE_PERMISSIONS[role] ?? [];
};

/**
 * Check if role can access admin area
 */
export const canAccessAdminArea = (role: Role): boolean => {
  return ['admin', 'support', 'accountant'].includes(role);
};

/**
 * Get display name for a role
 */
export const getRoleDisplayName = (role: Role): string => {
  const names: Record<Role, string> = {
    admin: 'Administrator',
    support: 'Ops Support',
    accountant: 'Accounts',
    supplier: 'Supplier',
    client: 'Client',
  };
  return names[role] ?? role;
};

/**
 * Get role badge color classes
 */
export const getRoleBadgeStyles = (role: Role): string => {
  const styles: Record<Role, string> = {
    admin: 'bg-error-100 text-error-700 border-error-200',
    support: 'bg-warning-100 text-warning-700 border-warning-200',
    accountant: 'bg-purple-100 text-purple-700 border-purple-200',
    supplier: 'bg-success-100 text-success-700 border-success-200',
    client: 'bg-primary-100 text-primary-700 border-primary-200',
  };
  return styles[role] ?? 'bg-secondary-100 text-secondary-700 border-secondary-200';
};

/**
 * Get role icon
 */
export const getRoleIcon = (role: Role): string => {
  const icons: Record<Role, string> = {
    admin: '👑',
    support: '🎧',
    accountant: '💼',
    supplier: '🏢',
    client: '👤',
  };
  return icons[role] ?? '👤';
};
/* FILE: src/features/adminOrders/hooks.ts */
// FILE PATH: src/features/adminOrders/hooks.ts

/**
 * React Query Hooks for Admin Orders
 */

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { adminOrdersAPI } from '../../api/handlers/adminOrders.api';
import type {
  AdminOrdersQueryParams,
  AdminOrderUpdatePayload,
} from '../../types/adminOrder.types';
import toast from 'react-hot-toast';

// ==================== QUERY KEYS ====================
export const adminOrdersKeys = {
  all: ['admin', 'orders'] as const,
  lists: () => [...adminOrdersKeys.all, 'list'] as const,
  list: (params: AdminOrdersQueryParams) => [...adminOrdersKeys.lists(), params] as const,
  details: () => [...adminOrdersKeys.all, 'detail'] as const,
  detail: (id: number) => [...adminOrdersKeys.details(), id] as const,
};

// ==================== QUERIES ====================

/**
 * Fetch orders list with filters
 */
export const useAdminOrders = (params: AdminOrdersQueryParams) => {
  return useQuery({
    queryKey: adminOrdersKeys.list(params),
    queryFn: () => adminOrdersAPI.getOrders(params),
    staleTime: 30000,
    refetchOnWindowFocus: false,
  });
};

/**
 * Fetch single order detail
 */
export const useAdminOrderDetail = (orderId: number) => {
  return useQuery({
    queryKey: adminOrdersKeys.detail(orderId),
    queryFn: () => adminOrdersAPI.getOrderDetail(orderId),
    staleTime: 30000,
    refetchOnWindowFocus: false,
    enabled: !!orderId,
  });
};

// ==================== MUTATIONS ====================

/**
 * Update order mutation
 */
export const useUpdateAdminOrder = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({
      orderId,
      payload,
    }: {
      orderId: number;
      payload: AdminOrderUpdatePayload;
    }) => adminOrdersAPI.updateOrder(orderId, payload),
    onSuccess: (_, variables) => {
      toast.success('Order updated successfully');
      queryClient.invalidateQueries({ queryKey: adminOrdersKeys.lists() });
      queryClient.invalidateQueries({ queryKey: adminOrdersKeys.detail(variables.orderId) });
    },
    onError: (error: Error) => {
      toast.error(error.message || 'Failed to update order');
    },
  });
};

/**
 * Assign supplier to item mutation
 */
export const useAssignSupplier = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (payload: {
      order_id: number;
      item_id: number;
      supplier: number;
      offer_id?: number;
    }) => adminOrdersAPI.assignSupplier(payload),
    onSuccess: (_, variables) => {
      toast.success('Supplier assigned successfully');
      queryClient.invalidateQueries({ queryKey: adminOrdersKeys.detail(variables.order_id) });
      queryClient.invalidateQueries({ queryKey: adminOrdersKeys.lists() });
    },
    onError: (error: Error) => {
      toast.error(error.message || 'Failed to assign supplier');
    },
  });
};

/**
 * Set quoted price for item mutation
 */
export const useSetQuotedPrice = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({
      orderId,
      itemId,
      quotedPrice,
    }: {
      orderId: number;
      itemId: number;
      quotedPrice: number | null;
    }) => adminOrdersAPI.setItemQuotedPrice(orderId, itemId, quotedPrice),
    onSuccess: (_, variables) => {
      toast.success(
        variables.quotedPrice === null
          ? 'Quoted price cleared'
          : 'Quoted price set successfully'
      );
      queryClient.invalidateQueries({ queryKey: adminOrdersKeys.detail(variables.orderId) });
      queryClient.invalidateQueries({ queryKey: adminOrdersKeys.lists() });
    },
    onError: (error: Error) => {
      toast.error(error.message || 'Failed to set quoted price');
    },
  });
};

/**
 * Mark item as paid mutation
 */
export const useMarkItemAsPaid = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({
      orderId,
      itemId,
      isPaid,
    }: {
      orderId: number;
      itemId: number;
      isPaid: boolean;
    }) => adminOrdersAPI.markItemAsPaid(orderId, itemId, isPaid),
    onSuccess: (_, variables) => {
      toast.success(
        variables.isPaid ? 'Item marked as paid' : 'Payment status updated'
      );
      queryClient.invalidateQueries({ queryKey: adminOrdersKeys.detail(variables.orderId) });
    },
    onError: (error: Error) => {
      toast.error(error.message || 'Failed to update payment status');
    },
  });
};


/**
 * Admin update order item mutation
 * For editing supplier pricing, delivery, and confirmation
 */
export const useAdminUpdateOrderItem = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({
      orderItemId,
      payload,
    }: {
      orderItemId: number;
      payload: {
        supplier_unit_cost?: number;
        supplier_discount?: number;
        delivery_cost?: number;
        delivery_type?: 'Included' | 'Supplier' | 'ThirdParty' | 'Fleet' | 'None';
        supplier_delivery_date?: string;
        supplier_confirms?: boolean;
        supplier_notes?: string;
        quantity:number;
      };
    }) => adminOrdersAPI.adminUpdateOrderItem(orderItemId, payload),
    onSuccess: () => {
      // Since we don't have orderId in the response, invalidate all order details
      queryClient.invalidateQueries({ queryKey: adminOrdersKeys.details() });
      queryClient.invalidateQueries({ queryKey: adminOrdersKeys.lists() });
    },
    onError: (error: Error) => {
      // Error handling is done in the component
      console.error('Failed to update order item:', error);
    },
  });
};
/* FILE: src/features/adminOrders/utils.ts */
// FILE PATH: src/features/adminOrders/utils.ts

/**
 * Utility functions for Admin Orders
 * Updated for new pricing logic
 */

import type { WorkflowStatus, PaymentStatus } from '../../types/adminOrder.types';

// ==================== STATUS BADGE COLORS ====================

export const getWorkflowBadgeClass = (workflow: WorkflowStatus): string => {
  const classes: Record<WorkflowStatus, string> = {
    'Requested': 'bg-blue-100 text-blue-800 border-2 border-blue-300',
    'Supplier Missing': 'bg-yellow-100 text-yellow-800 border-2 border-yellow-300',
    'Supplier Assigned': 'bg-indigo-100 text-indigo-800 border-2 border-indigo-300',
    'Payment Requested': 'bg-purple-100 text-purple-800 border-2 border-purple-300',
    'On Hold': 'bg-gray-100 text-gray-800 border-2 border-gray-300',
    'Delivered': 'bg-green-100 text-green-800 border-2 border-green-300',
  };
  return classes[workflow] || 'bg-gray-100 text-gray-800';
};

export const getPaymentBadgeClass = (status: PaymentStatus): string => {
  const classes: Record<PaymentStatus, string> = {
    'Pending': 'bg-gray-100 text-gray-700 border border-gray-300',
    'Requested': 'bg-yellow-100 text-yellow-700 border border-yellow-300',
    'Paid': 'bg-green-100 text-green-700 border border-green-300',
    'Partially Paid': 'bg-blue-100 text-blue-700 border border-blue-300',
    'Partial Refunded': 'bg-orange-100 text-orange-700 border border-orange-300',
    'Refunded': 'bg-red-100 text-red-700 border border-red-300',
  };
  return classes[status] || 'bg-gray-100 text-gray-700';
};

// ==================== PRICING CHECKS ====================

export const canShowPricing = (workflow: WorkflowStatus): boolean => {
  return workflow === 'Payment Requested' || workflow === 'Delivered';
};

export const canEditOrder = (workflow: WorkflowStatus): boolean => {
  return workflow !== 'Delivered';
};

// ==================== FORMATTING ====================

export const formatCurrency = (amount: number): string => {
  return new Intl.NumberFormat('en-AU', {
    style: 'currency',
    currency: 'AUD',
    minimumFractionDigits: 2,
  }).format(amount);
};

export const formatDate = (dateString: string): string => {
  return new Date(dateString).toLocaleDateString('en-AU', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
};

export const formatDateTime = (dateString: string): string => {
  return new Date(dateString).toLocaleString('en-AU', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
};

// ==================== IMAGE URL HELPER ====================

export const getProfileImageUrl = (imagePath: string | null | undefined): string | null => {
  if (!imagePath) return null;
  
  // If already a full URL, return as is
  if (imagePath.startsWith('http')) return imagePath;
  
  // Build full URL using the image base URL
  const baseUrl = import.meta.env.VITE_IMAGE_BASE_URL;
  return `${baseUrl}${imagePath}`;
};

// ==================== PROFIT/MARGIN CALCULATION ====================

export const getProfitColor = (profit: number): string => {
  if (profit > 0) return 'text-green-600';
  if (profit < 0) return 'text-red-600';
  return 'text-gray-600';
};

export const getMarginColor = (marginPercent: number): string => {
  if (marginPercent > 0) return 'text-green-600';
  if (marginPercent < 0) return 'text-red-600';
  return 'text-gray-600';
};

// Calculate profit percentage based on supplier total
export const calculateProfitPercentage = (profit: number, supplierTotal: number): string => {
  if (supplierTotal === 0) return '0%';
  const percentage = (profit / supplierTotal) * 100;
  return `${percentage.toFixed(2)}%`;
};

// ==================== ORDER STATUS HELPERS ====================

export const getOrderStatusSummary = (
  workflow: WorkflowStatus,
  paymentStatus: PaymentStatus,
  unassignedItems: number
): string => {
  if (workflow === 'Supplier Missing' && unassignedItems > 0) {
    return `Missing supplier for ${unassignedItems} item${unassignedItems > 1 ? 's' : ''}`;
  }
  if (workflow === 'Supplier Assigned') {
    return 'Awaiting supplier confirmation';
  }
  if (workflow === 'Payment Requested') {
    return `Payment ${paymentStatus.toLowerCase()}`;
  }
  if (workflow === 'Delivered') {
    return 'Order completed';
  }
  return workflow;
};

// ==================== VALIDATION ====================

export const isValidDate = (dateString: string): boolean => {
  const date = new Date(dateString);
  return date instanceof Date && !isNaN(date.getTime());
};

export const isValidPrice = (price: number): boolean => {
  return typeof price === 'number' && !isNaN(price) && price >= 0;
};
/* FILE: src/features/clientOrders/hooks.ts */
// FILE PATH: src/features/clientOrders/hooks.ts
// Updated Client Orders Hooks

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import toast from 'react-hot-toast';
import { clientOrdersAPI } from '../../api/handlers/clientOrders.api';
import type { ClientOrdersQueryParams } from '../../api/handlers/clientOrders.api';
import type {RepeatOrderPayload} from '../../types/clientOrder.types'

// Query Keys
export const clientOrdersKeys = {
  all: ['clientOrders'] as const,
  lists: () => [...clientOrdersKeys.all, 'list'] as const,
  list: (filters: ClientOrdersQueryParams) => [...clientOrdersKeys.lists(), filters] as const,
  details: () => [...clientOrdersKeys.all, 'detail'] as const,
  detail: (id: number) => [...clientOrdersKeys.details(), id] as const,
};

/**
 * Hook to fetch client orders list with filters
 */
export const useClientOrders = (params?: ClientOrdersQueryParams,) => {
  return useQuery({
    queryKey: clientOrdersKeys.list(params || {}),
    queryFn: () => clientOrdersAPI.getOrders(params),
    staleTime: 30000, // 30 seconds
  });
};

/**
 * Hook to fetch single order detail
 */
export const useClientOrderDetail = (orderId: number) => {
  return useQuery({
    queryKey: clientOrdersKeys.detail(orderId),
    queryFn: () => clientOrdersAPI.getOrderDetail(orderId),
    enabled: !!orderId,
    staleTime: 30000, // 30 seconds
  });
};

/**
 * Hook to repeat an order
 */
export const useRepeatOrder = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({ orderId, payload }: { orderId: number; payload: RepeatOrderPayload }) =>
      clientOrdersAPI.repeatOrder(orderId, payload),
    onSuccess: () => {
      // Invalidate orders list to show new order
      queryClient.invalidateQueries({ queryKey: clientOrdersKeys.lists() });
      toast.success('Order repeated successfully!');
    },
    onError: (error: Error) => {
      toast.error(error.message || 'Failed to repeat order');
    },
  });
};

/**
 * Hook to mark order as repeat
 */
export const useMarkRepeatOrder = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (orderId: number) => clientOrdersAPI.markRepeatOrder(orderId),
    onSuccess: (_, orderId) => {
      // Update both list and detail cache
      queryClient.invalidateQueries({ queryKey: clientOrdersKeys.lists() });
      queryClient.invalidateQueries({ queryKey: clientOrdersKeys.detail(orderId) });
      toast.success('Order marked as repeat');
    },
    onError: (error: Error) => {
      toast.error(error.message || 'Failed to mark as repeat order');
    },
  });
};
/* FILE: src/features/clientOrders/queryKeys.ts */
// import type { ClientOrderFilters } from '../../api/handlers/clientOrders.api';

// export const clientOrderKeys = {
//   all: ['client-orders'] as const,
//   lists: () => [...clientOrderKeys.all, 'list'] as const,

//   // Accept the actual filters type
//   list: (filters: ClientOrderFilters) =>
//     [...clientOrderKeys.lists(), { ...filters }] as const,

//   details: () => [...clientOrderKeys.all, 'detail'] as const,
//   detail: (id: number) => [...clientOrderKeys.details(), id] as const,
// };

/* FILE: src/features/clientOrders/utils.ts */
// src/features/clientOrders/utils.ts

import type { OrderStatus, PaymentStatus } from '../../types/clientOrder.types';

export const getOrderStatusBadgeClass = (status: OrderStatus): string => {
  const classes: Record<OrderStatus, string> = {
    'Draft': 'bg-gray-100 text-gray-800 border-2 border-gray-300',
    'Confirmed': 'bg-blue-100 text-blue-800 border-2 border-blue-300',
    'Scheduled': 'bg-indigo-100 text-indigo-800 border-2 border-indigo-300',
    'In Transit': 'bg-purple-100 text-purple-800 border-2 border-purple-300',
    'Delivered': 'bg-green-100 text-green-800 border-2 border-green-300',
    'Completed': 'bg-emerald-100 text-emerald-800 border-2 border-emerald-300',
    'Cancelled': 'bg-red-100 text-red-800 border-2 border-red-300',
  };
  return classes[status] || 'bg-gray-100 text-gray-800 border-2 border-gray-300';
};

export const getPaymentStatusBadgeClass = (status: PaymentStatus): string => {
  const classes: Record<PaymentStatus, string> = {
    'Pending': 'bg-gray-100 text-gray-800 border-2 border-gray-300',
    'Partially Paid': 'bg-yellow-100 text-yellow-800 border-2 border-yellow-300',
    'Paid': 'bg-green-100 text-green-800 border-2 border-green-300',
    'Partial Refunded': 'bg-orange-100 text-orange-800 border-2 border-orange-300',
    'Refunded': 'bg-blue-100 text-blue-800 border-2 border-blue-300',
    'Requested': 'bg-purple-100 text-purple-800 border-2 border-purple-300'
  };
  return classes[status] || 'bg-gray-100 text-gray-800 border-2 border-gray-300';
};

export const formatCurrency = (amount: number | string): string => {
  const num = typeof amount === 'string' ? parseFloat(amount) : amount;
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
  }).format(num);
};

export const formatDate = (dateString: string): string => {
  if (!dateString) return '-';
  try {
    const date = new Date(dateString);
    return new Intl.DateTimeFormat('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric',
    }).format(date);
  } catch {
    return dateString;
  }
};
/* FILE: src/features/components/ProjectForm.tsx */
// --- src/features/projects/components/ProjectForm.tsx ---
import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { MapPin } from 'lucide-react';
import Autocomplete from 'react-google-autocomplete';
import { projectSchema } from '../projects/validators';
import type { ProjectFormValues } from '../projects/validators';
import Input from '../../components/common/Input';
import Button from '../../components/common/Buttons';

type Props = { 
  initial?: Partial<ProjectFormValues>; 
  onSubmit: (v: ProjectFormValues) => void; 
  submitting?: boolean 
};

export default function ProjectForm({ initial, onSubmit, submitting }: Props) {
  const { 
    register, 
    handleSubmit, 
    setValue,
    formState: { errors } 
  } = useForm<ProjectFormValues>({
    resolver: zodResolver(projectSchema),
    defaultValues: { ...initial },
  });

  const [locationCoords, setLocationCoords] = useState<{ lat: number; lng: number } | null>(
    initial?.delivery_lat && initial?.delivery_long 
      ? { lat: initial.delivery_lat, lng: initial.delivery_long } 
      : null
  );
console.log(locationCoords);
  const handlePlaceSelected = (place: any) => {
    if (place.formatted_address) {
      setValue('delivery_address', place.formatted_address, { shouldValidate: true });
    }
    if (place.geometry?.location) {
      const lat = place.geometry.location.lat();
      const lng = place.geometry.location.lng();
      setValue('delivery_lat', lat, { shouldValidate: true });
      setValue('delivery_long', lng, { shouldValidate: true });
      setLocationCoords({ lat, lng });
    }
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 max-w-2xl">
      <Input 
        label="Project Name" 
        placeholder="e.g. Site A – Footings" 
        {...register('name')} 
        error={errors.name?.message} 
      />
      
      <Input 
        label="Site Contact Name" 
        placeholder="Optional" 
        {...register('site_contact_name')} 
        error={errors.site_contact_name?.message} 
      />
      
      <Input 
        label="Site Contact Phone" 
        placeholder="Optional" 
        {...register('site_contact_phone')} 
        error={errors.site_contact_phone?.message} 
      />
      
      <div>
        <label className="block text-sm font-medium mb-1">Site Instructions</label>
        <textarea 
          className="w-full border rounded px-3 py-2" 
          rows={4} 
          placeholder="Access notes, safety, gate code" 
          {...register('site_instructions')} 
        />
        {errors.site_instructions && (
          <p className="text-red-600 text-xs mt-1">{errors.site_instructions.message}</p>
        )}
      </div>

      {/* NEW: Delivery Address with Google Autocomplete */}
      <div>
        <label className="block text-sm font-medium mb-1 flex items-center gap-2">
          <MapPin size={16} className="text-primary-600" />
          Delivery Address
        </label>
        <Autocomplete
          apiKey={import.meta.env.VITE_GOOGLE_MAPS_API_KEY}
          onPlaceSelected={handlePlaceSelected}
          options={{
            types: ['address'],
            componentRestrictions: { country: 'au' }, // Adjust country as needed
          }}
          defaultValue={initial?.delivery_address || ''}
          className="w-full px-3 py-2 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          placeholder="Start typing address..."
        />
        {errors.delivery_address && (
          <p className="text-red-600 text-xs mt-1">{errors.delivery_address.message}</p>
        )}
        {locationCoords && (
          <p className="text-xs text-secondary-600 mt-1">
            📍 Location: {Number(locationCoords.lat).toFixed(6)}, {Number(locationCoords.lng).toFixed(6)}
          </p>
        )}
      </div>

      {/* Hidden fields for lat/long */}
      <input type="hidden" {...register('delivery_lat', { valueAsNumber: true })} />
      <input type="hidden" {...register('delivery_long', { valueAsNumber: true })} />

      <Button type="submit" disabled={submitting}>
        {submitting ? 'Saving...' : 'Save Project'}
      </Button>
    </form>
  );
}
/* FILE: src/features/projects/hooks.ts */
// --- src/features/projects/hooks.ts ---
import { useMutation, useQuery, useQueryClient, keepPreviousData } from '@tanstack/react-query';
import { projectsAPI } from '../../api/handlers/projects.api';
import type { ProjectDTO, ProjectCreateInput, Paginated } from '../../api/handlers/projects.api';
import { projectKeys } from './queryKeys';

export const useProjects = (params: Record<string, unknown>) =>
  useQuery<Paginated<ProjectDTO>>({
    queryKey: projectKeys.list(params),
    queryFn: () => projectsAPI.list(params),
    placeholderData: keepPreviousData,
  });

export const useProject = (id?: number) =>
  useQuery<ProjectDTO>({ queryKey: id ? projectKeys.detail(id) : ['projects','detail','idle'], queryFn: () => projectsAPI.get(id!), enabled: !!id });

export const useCreateProject = () => {
  const qc = useQueryClient();
  return useMutation({
    mutationFn: (payload: ProjectCreateInput) => projectsAPI.create(payload),
    onSuccess: () => qc.invalidateQueries({ queryKey: projectKeys.all }),
  });
};

export const useUpdateProject = (id: number) => {
  const qc = useQueryClient();
  return useMutation({
    mutationFn: (payload: ProjectCreateInput) => projectsAPI.update({ id, ...payload }),
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: projectKeys.detail(id) });
      qc.invalidateQueries({ queryKey: projectKeys.lists() });
    },
  });
};

export const useDeleteProject = () => {
  const qc = useQueryClient();
  return useMutation({
    mutationFn: (id: number) => projectsAPI.remove(id),
    onSuccess: () => qc.invalidateQueries({ queryKey: projectKeys.lists() }),
  });
};

/* FILE: src/features/projects/queryKeys.ts */
// --- src/features/projects/queryKeys.ts ---
export const projectKeys = {
  all: ['projects'] as const,
  lists: () => [...projectKeys.all, 'list'] as const,
  list: (params: Record<string, unknown>) => [...projectKeys.lists(), params] as const,
  details: () => [...projectKeys.all, 'detail'] as const,
  detail: (id: number) => [...projectKeys.details(), id] as const,
};

/* FILE: src/features/projects/validators.ts */
// --- src/features/projects/validators.ts ---
import { z } from 'zod';

export const projectSchema = z.object({
  name: z.string().min(1, 'Project name is required'),
  site_contact_name: z.string().max(255, 'Max 255 characters').optional().or(z.literal('').transform(() => undefined)),
  site_contact_phone: z.string().max(50, 'Max 50 characters').optional().or(z.literal('').transform(() => undefined)),
  site_instructions: z.string().optional().or(z.literal('').transform(() => undefined)),
  delivery_address: z.string().min(1, 'Delivery address is required').max(500, 'Address is too long'),
  delivery_lat: z.number().min(-90, 'Invalid latitude').max(90, 'Invalid latitude'),
  delivery_long: z.number().min(-180, 'Invalid longitude').max(180, 'Invalid longitude'),
});
export type ProjectFormValues = z.infer<typeof projectSchema>;
/* FILE: src/features/supplierOrders/hooks.ts */
// src/features/supplierOrders/hooks.ts

import { useQuery, useMutation, useQueryClient, keepPreviousData } from '@tanstack/react-query';
import { supplierOrdersAPI } from '../../api/handlers/supplierOrders.api';
import type {
  SupplierOrdersResponse,
  OrderDetailResponse,
  UpdateOrderItemPayload,
  SupplierOrderFilters,
} from '../../api/handlers/supplierOrders.api';
import { supplierOrderKeys } from './queryKeys';

/**
 * Hook to fetch supplier orders list with filters
 */
export const useSupplierOrders = (filters: SupplierOrderFilters, includeDetails: boolean = false) =>
  useQuery<SupplierOrdersResponse>({
    queryKey: supplierOrderKeys.list(filters as Record<string, unknown>),
    queryFn: () => supplierOrdersAPI.getOrders(filters, includeDetails),
    placeholderData: keepPreviousData,
  });

/**
 * Hook to fetch single order details
 */
export const useSupplierOrderDetail = (orderId?: number) => {
  console.log('useSupplierOrderDetail called with orderId:', orderId, 'type:', typeof orderId);
  
  const isValidId = orderId !== undefined && !isNaN(orderId) && orderId > 0;
  console.log('Is valid ID:', isValidId);
  
  return useQuery<OrderDetailResponse>({
    queryKey: isValidId ? supplierOrderKeys.detail(orderId) : ['supplierOrders', 'detail', 'idle'],
    queryFn: async () => {
      console.log('Fetching order details for ID:', orderId);
      const result = await supplierOrdersAPI.getOrderDetails(orderId!);
      console.log('API result:', result);
      return result;
    },
    enabled: isValidId,
  });
};

/**
 * Hook to update order item
 */
export const useUpdateOrderItem = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ orderItemId, payload }: { orderItemId: number; payload: UpdateOrderItemPayload }) =>
      supplierOrdersAPI.updateOrderItem(orderItemId, payload),
    onSuccess: (_) => {
      // Invalidate both list and detail queries
      queryClient.invalidateQueries({ queryKey: supplierOrderKeys.lists() });
      // We don't have direct access to orderId here, so invalidate all details
      queryClient.invalidateQueries({ queryKey: supplierOrderKeys.details() });
    },
  });
};
/* FILE: src/features/supplierOrders/queryKeys.ts */
// src/features/supplierOrders/queryKeys.ts

export const supplierOrderKeys = {
  all: ['supplierOrders'] as const,
  lists: () => [...supplierOrderKeys.all, 'list'] as const,
  list: (params: Record<string, unknown>) => [...supplierOrderKeys.lists(), params] as const,
  details: () => [...supplierOrderKeys.all, 'detail'] as const,
  detail: (id: number) => [...supplierOrderKeys.details(), id] as const,
};
/* FILE: src/hooks/useGoogleMaps.ts */
// src/hooks/useGoogleMaps.ts
import { useEffect, useState } from 'react';

interface UseGoogleMapsResult {
  isLoaded: boolean;
  loadError: Error | null;
}

let isScriptLoaded = false;
let isScriptLoading = false;
let scriptLoadPromise: Promise<void> | null = null;

export const useGoogleMaps = (apiKey: string): UseGoogleMapsResult => {
  const [isLoaded, setIsLoaded] = useState(isScriptLoaded);
  const [loadError, setLoadError] = useState<Error | null>(null);

  useEffect(() => {
    // If already loaded, return immediately
    if (isScriptLoaded) {
      setIsLoaded(true);
      return;
    }

    // If currently loading, wait for existing promise
    if (isScriptLoading && scriptLoadPromise) {
      scriptLoadPromise
        .then(() => setIsLoaded(true))
        .catch((err) => setLoadError(err));
      return;
    }

    // Check if script already exists in DOM
    const existingScript = document.querySelector(
      'script[src*="maps.googleapis.com"]'
    );

    if (existingScript) {
      // Script exists, wait for it to load
      if ((window as any).google?.maps?.places) {
        isScriptLoaded = true;
        setIsLoaded(true);
        return;
      }

      existingScript.addEventListener('load', () => {
        isScriptLoaded = true;
        setIsLoaded(true);
      });

      existingScript.addEventListener('error', () => {
        setLoadError(new Error('Failed to load Google Maps script'));
      });

      return;
    }

    // Load new script
    isScriptLoading = true;
    scriptLoadPromise = new Promise<void>((resolve, reject) => {
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places`;
      script.async = true;
      script.defer = true;

      script.onload = () => {
        isScriptLoaded = true;
        isScriptLoading = false;
        setIsLoaded(true);
        resolve();
      };

      script.onerror = () => {
        isScriptLoading = false;
        const error = new Error('Failed to load Google Maps script');
        setLoadError(error);
        reject(error);
      };

      document.head.appendChild(script);
    });
  }, [apiKey]);

  return { isLoaded, loadError };
};
/* FILE: src/hooks/usePermissions.ts */
// src/hooks/usePermissions.ts
// ============================================
// PERMISSION HOOK
// Use this hook to check permissions anywhere in the app
// ============================================

import { useMemo } from 'react';
import { useAuthStore } from '../store/authStore';
import {
  ROLE_PERMISSIONS,
  canAccessAdminArea,
  getRoleDisplayName,
  getRoleBadgeStyles,
  getRoleIcon,
} from '../config/permissions';
import type { Permission,Role } from '../config/permissions';

interface UsePermissionsReturn {
  // Current user role
  role: Role | null;
  roleDisplayName: string;
  roleBadgeStyles: string;
  roleIcon: string;

  // Permission checking functions
  hasPermission: (permission: Permission) => boolean;
  hasAnyPermission: (permissions: Permission[]) => boolean;
  hasAllPermissions: (permissions: Permission[]) => boolean;

  // Quick access checks
  canAccessAdmin: boolean;
  isReadOnly: boolean; // For accountant role

  // ==================== PROJECT PERMISSIONS ====================
  canViewAllProjects: boolean;
  canViewOwnProjects: boolean;
  canEditProjects: boolean;
  canCreateProjects: boolean;
  canDeleteProjects: boolean;

  // ==================== ORDER PERMISSIONS ====================
  canViewAllOrders: boolean;
  canViewOwnOrders: boolean;
  canCreateOrders: boolean;
  canEditOrders: boolean;
  canMarkDelivered: boolean;
  canAssignSupplier: boolean;
  canCancelOrders: boolean;
  canUpdateOrderStatus: boolean;

  // ==================== PRICING PERMISSIONS ====================
  canViewCostPrice: boolean;
  canViewProfitMargin: boolean;
  canEditSupplierRates: boolean;
  canEnterQuotedRates: boolean;
  canViewClientPrice: boolean;

  // ==================== USER PERMISSIONS ====================
  canViewUsers: boolean;
  canViewUserDetails: boolean;
  canCreateUsers: boolean;
  canEditUsers: boolean;
  canDeleteUsers: boolean;
  canManageRoles: boolean;

  // ==================== PRODUCT PERMISSIONS ====================
  canViewProducts: boolean;
  canCreateProducts: boolean;
  canEditProducts: boolean;
  canDeleteProducts: boolean;
  canApproveProducts: boolean;

  // ==================== SUPPLIER PERMISSIONS ====================
  canViewSuppliers: boolean;
  canViewSupplierZones: boolean;
  canEditSupplierZones: boolean;
  canApproveSuppliers: boolean;
  canViewSupplierOffers: boolean;

  // ==================== CLIENT PERMISSIONS ====================
  canViewClients: boolean;
  canViewClientDetails: boolean;
  canEditClients: boolean;
  canManageClientPricing: boolean;

  // ==================== REPORT PERMISSIONS ====================
  canViewReports: boolean;
  canViewRevenueReports: boolean;
  canViewSupplierPerformance: boolean;
  canViewClientSpend: boolean;
  canExportReports: boolean;

  // ==================== PAYMENT PERMISSIONS ====================
  canViewPayments: boolean;
  canProcessPayments: boolean;
  canRefundPayments: boolean;
  canMarkSupplierPaid: boolean;

  // ==================== SYSTEM PERMISSIONS ====================
  canViewDashboard: boolean;
  canManageCategories: boolean;
  canViewLogs: boolean;
  canManageSettings: boolean;
}

export const usePermissions = (): UsePermissionsReturn => {
  const user = useAuthStore((state) => state.user);
  const role = (user?.role as Role) ?? null;

  // Memoize permission checks to avoid recalculating on every render
  return useMemo(() => {
    // Core permission check function
    const hasPermission = (permission: Permission): boolean => {
      if (!role) return false;
      return ROLE_PERMISSIONS[role]?.includes(permission) ?? false;
    };

    // Check if user has ANY of the provided permissions
    const hasAnyPermission = (permissions: Permission[]): boolean => {
      return permissions.some((p) => hasPermission(p));
    };

    // Check if user has ALL of the provided permissions
    const hasAllPermissions = (permissions: Permission[]): boolean => {
      return permissions.every((p) => hasPermission(p));
    };

    // Quick access values
    const canAccessAdmin = role ? canAccessAdminArea(role) : false;
    const isReadOnly = role === 'accountant';

    return {
      // Role info
      role,
      roleDisplayName: role ? getRoleDisplayName(role) : '',
      roleBadgeStyles: role ? getRoleBadgeStyles(role) : '',
      roleIcon: role ? getRoleIcon(role) : '',

      // Permission checking functions
      hasPermission,
      hasAnyPermission,
      hasAllPermissions,

      // Quick access
      canAccessAdmin,
      isReadOnly,

      // ==================== PROJECT PERMISSIONS ====================
      canViewAllProjects: hasPermission('projects.view_all'),
      canViewOwnProjects: hasPermission('projects.view_own'),
      canEditProjects: hasPermission('projects.edit'),
      canCreateProjects: hasPermission('projects.create'),
      canDeleteProjects: hasPermission('projects.delete'),

      // ==================== ORDER PERMISSIONS ====================
      canViewAllOrders: hasPermission('orders.view_all'),
      canViewOwnOrders: hasPermission('orders.view_own'),
      canCreateOrders: hasPermission('orders.create'),
      canEditOrders: hasPermission('orders.edit'),
      canMarkDelivered: hasPermission('orders.mark_delivered'),
      canAssignSupplier: hasPermission('orders.assign_supplier'),
      canCancelOrders: hasPermission('orders.cancel'),
      canUpdateOrderStatus: hasPermission('orders.update_status'),

      // ==================== PRICING PERMISSIONS ====================
      canViewCostPrice: hasPermission('pricing.view_cost_price'),
      canViewProfitMargin: hasPermission('pricing.view_profit_margin'),
      canEditSupplierRates: hasPermission('pricing.edit_supplier_rates'),
      canEnterQuotedRates: hasPermission('pricing.enter_quoted_rates'),
      canViewClientPrice: hasPermission('pricing.view_client_price'),

      // ==================== USER PERMISSIONS ====================
      canViewUsers: hasPermission('users.view'),
      canViewUserDetails: hasPermission('users.view_details'),
      canCreateUsers: hasPermission('users.create'),
      canEditUsers: hasPermission('users.edit'),
      canDeleteUsers: hasPermission('users.delete'),
      canManageRoles: hasPermission('users.manage_roles'),

      // ==================== PRODUCT PERMISSIONS ====================
      canViewProducts: hasPermission('products.view'),
      canCreateProducts: hasPermission('products.create'),
      canEditProducts: hasPermission('products.edit'),
      canDeleteProducts: hasPermission('products.delete'),
      canApproveProducts: hasPermission('products.approve'),

      // ==================== SUPPLIER PERMISSIONS ====================
      canViewSuppliers: hasPermission('suppliers.view'),
      canViewSupplierZones: hasPermission('suppliers.view_zones'),
      canEditSupplierZones: hasPermission('suppliers.edit_zones'),
      canApproveSuppliers: hasPermission('suppliers.approve'),
      canViewSupplierOffers: hasPermission('suppliers.view_offers'),

      // ==================== CLIENT PERMISSIONS ====================
      canViewClients: hasPermission('clients.view'),
      canViewClientDetails: hasPermission('clients.view_details'),
      canEditClients: hasPermission('clients.edit'),
      canManageClientPricing: hasPermission('clients.manage_pricing'),

      // ==================== REPORT PERMISSIONS ====================
      canViewReports: hasPermission('reports.view'),
      canViewRevenueReports: hasPermission('reports.view_revenue'),
      canViewSupplierPerformance: hasPermission('reports.view_supplier_performance'),
      canViewClientSpend: hasPermission('reports.view_client_spend'),
      canExportReports: hasPermission('reports.export'),

      // ==================== PAYMENT PERMISSIONS ====================
      canViewPayments: hasPermission('payments.view'),
      canProcessPayments: hasPermission('payments.process'),
      canRefundPayments: hasPermission('payments.refund'),
      canMarkSupplierPaid: hasPermission('payments.mark_paid'),

      // ==================== SYSTEM PERMISSIONS ====================
      canViewDashboard: hasPermission('system.view_dashboard'),
      canManageCategories: hasPermission('system.manage_categories'),
      canViewLogs: hasPermission('system.view_logs'),
      canManageSettings: hasPermission('system.manage_settings'),
    };
  }, [role]);
};

export default usePermissions;
/* FILE: src/index.css */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
@tailwind base;
@tailwind components;
@tailwind utilities;

/* Optional: Add Inter font */


* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
/* FILE: src/main.tsx */
// src/main.tsx
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App'

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <App />
  </StrictMode>,
)
/* FILE: src/pages/admin/AdminSupplierDeliveryZones.tsx */
// src/pages/admin/AdminSupplierDeliveryZones.tsx
import  { useState, useMemo } from 'react';
import { useQuery, keepPreviousData  } from '@tanstack/react-query';
import {
  Search,
  Grid3X3,
  Map as MapIcon,
  Loader2,
  AlertCircle,
  ChevronLeft,
  ChevronRight,
  MapPin,
} from 'lucide-react';

import DashboardLayout from '../../components/layout/DashboardLayout';
import AdminSupplierZonesStats from '../../components/admin/AdminSupplierZonesStats';
import SupplierZoneCard from '../../components/admin/SupplierZoneCard';
import AdminSupplierZonesMapView from '../../components/admin/AdminSupplierZonesMapView';
import { adminSupplierZonesAPI } from '../../api/handlers/adminSupplierZones.api';
import { adminMenuItems } from '../../utils/menuItems';
import type {PaginatedSuppliersResponse,SupplierWithZones} from '../../api/handlers/adminSupplierZones.api';

// Generate consistent random color per supplier
const generateSupplierColor = (supplierId: number): string => {
  const colors = [
    '#10B981', '#3B82F6', '#8B5CF6', '#F59E0B',
    '#EF4444', '#EC4899', '#14B8A6', '#F97316',
    '#6366F1', '#84CC16', '#F43F5E', '#06B6D4',
    '#8B5CF6', '#F59E0B', '#10B981', '#EF4444',
  ];
  return colors[supplierId % colors.length];
};

const AdminSupplierDeliveryZones = () => {
  const [activeView, setActiveView] = useState<'card' | 'map'>('card');
  const [searchTerm, setSearchTerm] = useState('');
  const [page, setPage] = useState(1);
  const [perPage, setPerPage] = useState(10);


  // Fetch suppliers with zones
  const { data, isLoading, error } = useQuery<PaginatedSuppliersResponse>({
    queryKey: ['admin-supplier-zones', page, perPage, searchTerm],
    queryFn: () => adminSupplierZonesAPI.getSuppliersWithZones({
      page,
      per_page: perPage,
      search: searchTerm || undefined,
    }),
    placeholderData: keepPreviousData,
  });

  // Generate color map for suppliers
  const supplierColors = useMemo(() => {
    const colorMap = new Map<number, string>();
    data?.data.forEach((supplier: SupplierWithZones) => {
      colorMap.set(supplier.id, generateSupplierColor(supplier.id));
    });
    return colorMap;
  }, [data]);

  const suppliers: SupplierWithZones[] = data?.data ?? [];
  const pagination = {
    currentPage: data?.current_page ?? 1,
    lastPage: data?.last_page ?? 1,
    total: data?.total ?? 0,
    from: data?.from ?? 0,
    to: data?.to ?? 0,
  };

  const handleSearch = (value: string) => {
    setSearchTerm(value);
    setPage(1); // Reset to first page on search
  };

  const handlePerPageChange = (value: number) => {
    setPerPage(value);
    setPage(1); // Reset to first page
  };

  return (
    <DashboardLayout menuItems={adminMenuItems}>
      <div className="min-h-screen bg-secondary-50 p-6">
        <div className="max-w-7xl mx-auto space-y-6">
          {/* Header */}
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-3xl font-bold text-secondary-900 flex items-center gap-3">
                <MapPin size={32} className="text-primary-600" />
                Supplier Delivery Zones
              </h1>
              <p className="text-secondary-600 mt-2">
                View and analyze supplier service areas across the platform
              </p>
            </div>
          </div>

          {/* Stats Card */}
          {!isLoading && !error && (
            <AdminSupplierZonesStats 
              suppliers={suppliers} 
              totalSuppliers={pagination.total} 
            />
          )}

          {/* Search & View Toggle */}
          <div className="bg-white rounded-xl border-2 border-secondary-200 p-4">
            <div className="flex flex-col md:flex-row gap-4 items-stretch md:items-center">
              {/* Search */}
              <div className="flex-1 relative">
                <Search 
                  className="absolute left-3 top-1/2 -translate-y-1/2 text-secondary-400" 
                  size={20} 
                />
                <input
                  type="text"
                  placeholder="Search suppliers by name or email..."
                  value={searchTerm}
                  onChange={(e) => handleSearch(e.target.value)}
                  className="w-full pl-10 pr-4 py-3 border-2 border-secondary-200 rounded-lg focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-20"
                />
              </div>

              {/* View Toggle */}
              <div className="bg-white rounded-xl border-2 border-secondary-200 p-2 inline-flex gap-2">
                <button
                  onClick={() => setActiveView('card')}
                  className={`flex items-center gap-2 px-6 py-2.5 rounded-lg font-medium transition-all ${
                    activeView === 'card'
                      ? 'bg-primary-500 text-white shadow-lg'
                      : 'text-secondary-600 hover:bg-secondary-50'
                  }`}
                >
                  <Grid3X3 size={20} />
                  Card View
                </button>
                <button
                  onClick={() => setActiveView('map')}
                  className={`flex items-center gap-2 px-6 py-2.5 rounded-lg font-medium transition-all ${
                    activeView === 'map'
                      ? 'bg-primary-500 text-white shadow-lg'
                      : 'text-secondary-600 hover:bg-secondary-50'
                  }`}
                >
                  <MapIcon size={20} />
                  Map View
                </button>
              </div>
            </div>
          </div>

          {/* Loading State */}
          {isLoading && (
            <div className="flex flex-col items-center justify-center py-20">
              <Loader2 size={48} className="text-primary-600 animate-spin mb-4" />
              <p className="text-secondary-600">Loading supplier delivery zones...</p>
            </div>
          )}

          {/* Error State */}
          {error && (
            <div className="bg-error-50 border border-error-200 rounded-xl p-6 text-center">
              <AlertCircle size={48} className="text-error-500 mx-auto mb-4" />
              <p className="text-error-700 font-medium">Failed to load supplier zones</p>
              <p className="text-error-600 text-sm mt-2">{(error as Error).message}</p>
            </div>
          )}

          {/* Empty State */}
          {!isLoading && !error && suppliers.length === 0 && (
            <div className="bg-white rounded-xl border-2 border-dashed border-secondary-300 p-12 text-center">
              <div className="w-24 h-24 rounded-full bg-primary-50 flex items-center justify-center mx-auto mb-6">
                <MapPin size={48} className="text-primary-400" />
              </div>
              <h3 className="text-xl font-bold text-secondary-900 mb-2">
                No Suppliers Found
              </h3>
              <p className="text-secondary-600 mb-6 max-w-md mx-auto">
                {searchTerm 
                  ? `No suppliers match "${searchTerm}"`
                  : 'No suppliers with delivery zones found in the system'}
              </p>
            </div>
          )}

          {/* Card View */}
          {!isLoading && !error && activeView === 'card' && suppliers.length > 0 && (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {suppliers.map((supplier: SupplierWithZones) => (
                <SupplierZoneCard
                  key={supplier.id}
                  supplier={supplier}
                  color={supplierColors.get(supplier.id) || '#3B82F6'}
                />
              ))}
            </div>
          )}

          {/* Map View */}
          {!isLoading && !error && activeView === 'map' && suppliers.length > 0 && (
            <AdminSupplierZonesMapView 
              suppliers={suppliers} 
              supplierColors={supplierColors}
            />
          )}

          {/* Pagination */}
          {!isLoading && !error && suppliers.length > 0 && (
            <div className="bg-white rounded-xl border-2 border-secondary-200 p-4 flex items-center justify-between">
              <div className="flex items-center gap-2">
                <span className="text-sm text-secondary-600">
                  Showing {pagination.from} to {pagination.to} of {pagination.total} suppliers
                </span>
              </div>

              <div className="flex items-center gap-4">
                {/* Per Page Selector */}
                <select
                  value={perPage}
                  onChange={(e) => handlePerPageChange(Number(e.target.value))}
                  className="px-3 py-2 border border-secondary-300 rounded-lg text-sm focus:outline-none focus:border-primary-500"
                >
                  <option value={10}>10 per page</option>
                  <option value={25}>25 per page</option>
                  <option value={50}>50 per page</option>
                  <option value={100}>100 per page</option>
                </select>

                {/* Page Navigation */}
                <div className="flex items-center gap-2">
                  <button
                    onClick={() => setPage(page - 1)}
                    disabled={page === 1}
                    className="p-2 border border-secondary-300 rounded-lg hover:bg-secondary-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                  >
                    <ChevronLeft size={18} />
                  </button>

                  <span className="text-sm text-secondary-700 px-3">
                    Page {pagination.currentPage} of {pagination.lastPage}
                  </span>

                  <button
                    onClick={() => setPage(page + 1)}
                    disabled={page === pagination.lastPage}
                    className="p-2 border border-secondary-300 rounded-lg hover:bg-secondary-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                  >
                    <ChevronRight size={18} />
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </DashboardLayout>
  );
};

export default AdminSupplierDeliveryZones;
/* FILE: src/pages/admin/Dashboard.tsx */
// FILE PATH: src/pages/admin/Dashboard.tsx
// ============================================
// ADMIN DASHBOARD WITH PERMISSION-BASED VISIBILITY
// ============================================

/**
 * Admin Dashboard Page
 * Main dashboard showing KPIs, charts, tables, and alerts
 * Revenue/Profit widgets hidden for Support role
 */

import { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import { BarChart3, Eye, Lock } from 'lucide-react';
import DashboardLayout from '../../components/layout/DashboardLayout';
import { getMenuItemsByRole } from '../../utils/menuItems';
import { usePermissions } from '../../hooks/usePermissions';
import { 
  adminDashboardAPI, 
  type DashboardFilters 
} from '../../api/handlers/adminDashboard.api';
import KPICards from '../../components/admin/Dashboard/KPICards';
import DashboardFiltersBar from '../../components/admin/Dashboard/DashboardFilters';
import ChartsSection from '../../components/admin/Dashboard/ChartsSection';
import TablesSection from '../../components/admin/Dashboard/TablesSection';
import AlertsSection from '../../components/admin/Dashboard/AlertsSection';

const AdminDashboard = () => {
  // ==================== PERMISSIONS ====================
  const { 
    role, 
    isReadOnly,
    canViewCostPrice,
    canViewProfitMargin,
  } = usePermissions();
  
  const menuItems = getMenuItemsByRole(role);
  
  // Determine if financial data should be shown
  const showFinancialData = canViewCostPrice || canViewProfitMargin;

  // Initialize filters with default date range (current month)
  const [filters, setFilters] = useState<DashboardFilters>(() => {
    const today = new Date();
    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    
    return {
      from: firstDayOfMonth.toISOString().split('T')[0],
      to: today.toISOString().split('T')[0],
      granularity: 'day',
      charts: 'date,status,supplier,product,price_bucket',
      tz: 'Australia/Sydney',
    };
  });

  const [dismissedAlerts, setDismissedAlerts] = useState<number[]>([]);

  // Fetch dashboard data
  const { 
    data, 
    isLoading, 
    isFetching,
    refetch 
  } = useQuery({
    queryKey: ['admin-dashboard', filters],
    queryFn: () => adminDashboardAPI.getSummary(filters),
    refetchOnWindowFocus: false,
    staleTime: 5 * 60 * 1000, // 5 minutes
  });

  // Handle filter changes
  const handleFilterChange = (newFilters: Partial<DashboardFilters>) => {
    setFilters((prev) => ({ ...prev, ...newFilters }));
  };

  // Handle alert dismiss
  const handleDismissAlert = (index: number) => {
    setDismissedAlerts((prev) => [...prev, index]);
  };

  // Filter out dismissed alerts
  const activeAlerts = data?.alerts?.filter((_, idx) => !dismissedAlerts.includes(idx)) || [];

  return (
    <DashboardLayout menuItems={menuItems}>
      <div className="space-y-6">
        {/* Page Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold text-gray-900 flex items-center gap-3">
              <BarChart3 className="w-8 h-8 text-blue-600" />
              Admin Dashboard
            </h1>
            <p className="text-gray-600 mt-1">System overview and analytics</p>
          </div>

          <div className="flex items-center gap-4">
            {/* Read-Only Badge for Accountant */}
            {isReadOnly && (
              <span className="px-4 py-2 bg-yellow-100 text-yellow-800 text-sm font-bold rounded-lg border-2 border-yellow-300 flex items-center gap-2">
                <Eye size={16} />
                Read Only Mode
              </span>
            )}
            
            {/* Data Freshness Indicator */}
            {data?.metadata && (
              <div className="text-right">
                <p className="text-sm text-gray-600">
                  Last updated: {new Date(data.metadata.generated_at).toLocaleString()}
                </p>
                <p className="text-xs text-gray-500">
                  Analyzing {data.metadata.total_records_analyzed} records over {Math.round(data.metadata.period_days)} days
                </p>
              </div>
            )}
          </div>
        </div>

        {/* Permission Notice Banner for Support */}
        {!showFinancialData && (
          <div className="px-4 py-3 bg-yellow-50 border border-yellow-200 rounded-lg flex items-center gap-2">
            <Lock size={16} className="text-yellow-600" />
            <span className="text-sm text-yellow-800">
              Financial metrics (revenue, profit) are hidden based on your role permissions
            </span>
          </div>
        )}

        {/* Alerts Section */}
        {activeAlerts.length > 0 && (
          <AlertsSection
            alerts={activeAlerts}
            loading={isLoading}
            onDismiss={handleDismissAlert}
          />
        )}

        {/* Filters */}
        <DashboardFiltersBar
          filters={filters}
          onFilterChange={handleFilterChange}
          onRefresh={() => refetch()}
          isRefreshing={isFetching}
        />

        {/* KPI Cards - Pass permission flag */}
        <KPICards
          kpis={data?.kpis || null}
          loading={isLoading}
          currency={data?.filters.currency}
          showFinancialData={showFinancialData}
        />

        {/* Charts Section */}
        <div>
          <h2 className="text-xl font-semibold text-gray-900 mb-4">Analytics</h2>
          <ChartsSection
            charts={data?.charts || []}
            loading={isLoading}
          />
        </div>

        {/* Tables Section - Pass permission flag */}
        <div>
          <h2 className="text-xl font-semibold text-gray-900 mb-4">Top Performers & Activity</h2>
          <TablesSection
            topClients={data?.tables.top_clients_by_spend || []}
            topSuppliers={data?.tables.top_suppliers_by_revenue || []}
            recentActivity={data?.tables.recent_activity || []}
            loading={isLoading}
            currency={data?.filters.currency}
            showFinancialData={showFinancialData}
          />
        </div>

        {/* Additional Insights - Only show financial insights to authorized users */}
        {data?.kpis && (
          <div className={`grid grid-cols-1 ${showFinancialData ? 'md:grid-cols-3' : 'md:grid-cols-2'} gap-6`}>
            {/* Performance Metrics - Always visible (non-financial) */}
            <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200">
              <h3 className="text-sm font-medium text-blue-900 mb-2">Performance Metrics</h3>
              <div className="space-y-2">
                <div className="flex justify-between items-center">
                  <span className="text-sm text-blue-700">Cancellation Rate</span>
                  <span className="text-lg font-bold text-blue-900">{data.kpis.cancellation_rate}%</span>
                </div>
                <div className="flex justify-between items-center">
                  <span className="text-sm text-blue-700">Repeat Client Rate</span>
                  <span className="text-lg font-bold text-blue-900">{data.kpis.repeat_client_rate}%</span>
                </div>
              </div>
            </div>

            {/* System Health - Always visible (non-financial) */}
            <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border border-green-200">
              <h3 className="text-sm font-medium text-green-900 mb-2">System Health</h3>
              <div className="space-y-2">
                <div className="flex justify-between items-center">
                  <span className="text-sm text-green-700">Total Clients</span>
                  <span className="text-lg font-bold text-green-900">{data.kpis.total_clients}</span>
                </div>
                <div className="flex justify-between items-center">
                  <span className="text-sm text-green-700">Total Suppliers</span>
                  <span className="text-lg font-bold text-green-900">{data.kpis.total_suppliers}</span>
                </div>
              </div>
            </div>

            {/* Current Period - Only for users who can see financial data */}
            {showFinancialData && (
              <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 border border-purple-200">
                <h3 className="text-sm font-medium text-purple-900 mb-2">Current Period</h3>
                <div className="space-y-2">
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-purple-700">Active Clients</span>
                    <span className="text-lg font-bold text-purple-900">{data.kpis.active_clients}</span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-purple-700">Active Suppliers</span>
                    <span className="text-lg font-bold text-purple-900">{data.kpis.active_suppliers}</span>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}
      </div>
    </DashboardLayout>
  );
};

export default AdminDashboard;
/* FILE: src/pages/admin/MasterProducts/AddMasterProduct.tsx */
// FILE PATH: src/pages/admin/MasterProducts/AddMasterProduct.tsx

import { useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { useForm } from 'react-hook-form';
import { useMutation, useQuery } from '@tanstack/react-query';
import toast from 'react-hot-toast';
import { ChevronRight, Upload, X, FileText, Image as ImageIcon } from 'lucide-react';

import DashboardLayout from '../../../components/layout/DashboardLayout';
import { adminMenuItems } from '../../../utils/menuItems';
import { 
  masterProductsAPI, 
  type CreateMasterProductPayload 
} from '../../../api/handlers/masterProducts.api';

type FormData = {
  product_name: string;
  product_type: string;
  specifications: string;
  unit_of_measure: string;
  category: number;
  photo?: FileList;
  tech_doc?: FileList;
};

const AddMasterProduct = () => {
  const navigate = useNavigate();
  const [photoPreview, setPhotoPreview] = useState<string | null>(null);
  const [techDocName, setTechDocName] = useState<string | null>(null);

  const {
    register,
    handleSubmit,
    formState: { errors },
    setValue,
  } = useForm<FormData>();


  // Fetch categories
  const { data: categoriesData, isLoading: categoriesLoading } = useQuery({
    queryKey: ['categories'],
    queryFn: () => masterProductsAPI.getCategories(),
  });

  // Create product mutation
  const createMutation = useMutation({
    mutationFn: (data: CreateMasterProductPayload) => masterProductsAPI.create(data),
    onSuccess: () => {
      toast.success('Product created successfully!');
      navigate('/admin/master-products');
    },
    onError: (error: Error) => {
      toast.error(error.message || 'Failed to create product');
    },
  });

  // Handle photo preview
  const handlePhotoChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      if (file.size > 2 * 1024 * 1024) {
        toast.error('Image size should not exceed 2MB');
        setValue('photo', undefined);
        return;
      }
      const reader = new FileReader();
      reader.onloadend = () => {
        setPhotoPreview(reader.result as string);
      };
      reader.readAsDataURL(file);
    }
  };

  // Handle tech doc change
  const handleTechDocChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      if (file.size > 5 * 1024 * 1024) {
        toast.error('Document size should not exceed 5MB');
        setValue('tech_doc', undefined);
        return;
      }
      setTechDocName(file.name);
    }
  };

  // Remove photo
  const removePhoto = () => {
    setPhotoPreview(null);
    setValue('photo', undefined);
  };

  // Remove tech doc
  const removeTechDoc = () => {
    setTechDocName(null);
    setValue('tech_doc', undefined);
  };

  // Form submit
  const onSubmit = (data: FormData) => {
    const payload: CreateMasterProductPayload = {
      product_name: data.product_name,
      product_type: data.product_type,
      specifications: data.specifications,
      unit_of_measure: data.unit_of_measure,
      category: Number(data.category),
      photo: data.photo?.[0] || null,
      tech_doc: data.tech_doc?.[0] || null,
    };

    createMutation.mutate(payload);
  };

  return (
    <DashboardLayout menuItems={adminMenuItems}>
      <div className="max-w-4xl mx-auto">
        {/* Breadcrumb */}
        <nav className="mb-8">
          <ol className="flex items-center space-x-2 text-sm text-secondary-500">
            <li>
              <Link to="/admin/master-products" className="hover:text-primary-600 transition-colors">
                Master Products
              </Link>
            </li>
            <li>
              <ChevronRight size={16} />
            </li>
            <li className="text-secondary-900 font-medium">Add Product</li>
          </ol>
        </nav>

        {/* Page Header */}
        <div className="mb-8">
          <h1 className="text-3xl font-bold text-secondary-900">Add New Product</h1>
          <p className="text-secondary-600 mt-2">
            Create a new master product in the catalog
          </p>
        </div>

        {/* Form Card */}
        <form onSubmit={handleSubmit(onSubmit)} className="bg-white rounded-2xl shadow-card p-8">
          <div className="space-y-6">
            {/* Product Name */}
            <div>
              <label className="block text-sm font-medium text-secondary-700 mb-2">
                Product Name <span className="text-red-500">*</span>
              </label>
              <input
                type="text"
                {...register('product_name', { required: 'Product name is required' })}
                className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors ${
                  errors.product_name ? 'border-red-500' : 'border-secondary-300'
                }`}
                placeholder="Enter product name"
              />
              {errors.product_name && (
                <p className="mt-1 text-sm text-red-500">{errors.product_name.message}</p>
              )}
            </div>

            {/* Product Type */}
            <div>
              <label className="block text-sm font-medium text-secondary-700 mb-2">
                Product Type <span className="text-red-500">*</span>
              </label>
              <input
                type="text"
                {...register('product_type', { required: 'Product type is required' })}
                className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors ${
                  errors.product_type ? 'border-red-500' : 'border-secondary-300'
                }`}
                placeholder="e.g., Gravel, Sand, Concrete"
              />
              {errors.product_type && (
                <p className="mt-1 text-sm text-red-500">{errors.product_type.message}</p>
              )}
            </div>

            {/* Category */}
            <div>
              <label className="block text-sm font-medium text-secondary-700 mb-2">
                Category <span className="text-red-500">*</span>
              </label>
              <select
                {...register('category', { required: 'Category is required' })}
                disabled={categoriesLoading}
                className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors ${
                  errors.category ? 'border-red-500' : 'border-secondary-300'
                }`}
              >
                <option value="">Select category</option>
                {categoriesData?.data.map((category) => (
                  <option key={category.id} value={category.id}>
                    {category.name}
                  </option>
                ))}
              </select>
              {errors.category && (
                <p className="mt-1 text-sm text-red-500">{errors.category.message}</p>
              )}
            </div>

            {/* Unit of Measure */}
            <div>
              <label className="block text-sm font-medium text-secondary-700 mb-2">
                Unit of Measure <span className="text-red-500">*</span>
              </label>
              <input
                type="text"
                {...register('unit_of_measure', { required: 'Unit of measure is required' })}
                className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors ${
                  errors.unit_of_measure ? 'border-red-500' : 'border-secondary-300'
                }`}
                placeholder="e.g., ton, kg, Cubic Meter"
              />
              {errors.unit_of_measure && (
                <p className="mt-1 text-sm text-red-500">{errors.unit_of_measure.message}</p>
              )}
            </div>

            {/* Specifications */}
            <div>
              <label className="block text-sm font-medium text-secondary-700 mb-2">
                Specifications <span className="text-red-500">*</span>
              </label>
              <textarea
                {...register('specifications', { required: 'Specifications are required' })}
                rows={4}
                className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors resize-none ${
                  errors.specifications ? 'border-red-500' : 'border-secondary-300'
                }`}
                placeholder="Enter detailed product specifications"
              />
              {errors.specifications && (
                <p className="mt-1 text-sm text-red-500">{errors.specifications.message}</p>
              )}
            </div>

            {/* Photo Upload */}
            <div>
              <label className="block text-sm font-medium text-secondary-700 mb-2">
                Product Photo
              </label>
              
              {photoPreview ? (
                <div className="relative w-48 h-48 rounded-lg overflow-hidden border-2 border-secondary-200">
                  <img 
                    src={photoPreview} 
                    alt="Preview" 
                    className="w-full h-full object-cover"
                  />
                  <button
                    type="button"
                    onClick={removePhoto}
                    className="absolute top-2 right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors"
                  >
                    <X size={16} />
                  </button>
                </div>
              ) : (
                <label className="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-secondary-300 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                  <div className="flex flex-col items-center justify-center pt-5 pb-6">
                    <ImageIcon size={40} className="text-secondary-400 mb-3" />
                    <p className="mb-2 text-sm text-secondary-500">
                      <span className="font-semibold">Click to upload</span> or drag and drop
                    </p>
                    <p className="text-xs text-secondary-500">PNG, JPG or GIF (MAX. 2MB)</p>
                  </div>
                  <input
                    type="file"
                    accept="image/jpeg,image/png,image/jpg,image/gif"
                    {...register('photo')}
                    onChange={handlePhotoChange}
                    className="hidden"
                  />
                </label>
              )}
            </div>

            {/* Tech Doc Upload */}
            <div>
              <label className="block text-sm font-medium text-secondary-700 mb-2">
                Technical Document
              </label>
              
              {techDocName ? (
                <div className="flex items-center justify-between p-4 border-2 border-secondary-200 rounded-lg">
                  <div className="flex items-center space-x-3">
                    <FileText size={24} className="text-primary-500" />
                    <span className="text-sm text-secondary-700">{techDocName}</span>
                  </div>
                  <button
                    type="button"
                    onClick={removeTechDoc}
                    className="p-1 text-red-500 hover:bg-red-50 rounded transition-colors"
                  >
                    <X size={20} />
                  </button>
                </div>
              ) : (
                <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-secondary-300 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                  <div className="flex flex-col items-center justify-center">
                    <Upload size={32} className="text-secondary-400 mb-2" />
                    <p className="text-sm text-secondary-500">
                      <span className="font-semibold">Upload document</span>
                    </p>
                    <p className="text-xs text-secondary-500">PDF, DOCX or XLSX (MAX. 5MB)</p>
                  </div>
                  <input
                    type="file"
                    accept=".pdf,.docx,.xlsx"
                    {...register('tech_doc')}
                    onChange={handleTechDocChange}
                    className="hidden"
                  />
                </label>
              )}
            </div>
          </div>

          {/* Form Actions */}
          <div className="flex items-center justify-end space-x-4 mt-8 pt-6 border-t border-secondary-200">
            <Link
              to="/admin/master-products"
              className="px-6 py-3 text-secondary-700 bg-secondary-100 rounded-lg hover:bg-secondary-200 transition-colors font-medium"
            >
              Cancel
            </Link>
            <button
              type="submit"
              disabled={createMutation.isPending}
              className="px-6 py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium"
            >
              {createMutation.isPending ? 'Creating...' : 'Create Product'}
            </button>
          </div>
        </form>
      </div>
    </DashboardLayout>
  );
};

export default AddMasterProduct;
/* FILE: src/pages/admin/MasterProducts/EditMasterProduct.tsx */
// FILE PATH: src/pages/admin/MasterProducts/EditMasterProduct.tsx

import { useState, useEffect } from 'react';
import { Link, useNavigate, useParams } from 'react-router-dom';
import { useForm } from 'react-hook-form';
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
import toast from 'react-hot-toast';
import { ChevronRight, Upload, X, FileText, Image as ImageIcon, Loader2 } from 'lucide-react';

import DashboardLayout from '../../../components/layout/DashboardLayout';
import { adminMenuItems } from '../../../utils/menuItems';
import { 
  masterProductsAPI, 
  type UpdateMasterProductPayload 
} from '../../../api/handlers/masterProducts.api';

type FormData = {
  product_name: string;
  product_type: string;
  specifications: string;
  unit_of_measure: string;
  category: number;
  photo?: FileList;
  tech_doc?: FileList;
};

const EditMasterProduct = () => {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  
  const [photoPreview, setPhotoPreview] = useState<string | null>(null);
  const [techDocName, setTechDocName] = useState<string | null>(null);
  const [existingPhoto, setExistingPhoto] = useState<string | null>(null);
  const [existingTechDoc, setExistingTechDoc] = useState<string | null>(null);

  const {
    register,
    handleSubmit,
    formState: { errors },
    setValue,
    reset,
  } = useForm<FormData>();

  // Fetch product details
  const { data: product, isLoading: productLoading } = useQuery({
    queryKey: ['masterProduct', id],
    queryFn: () => masterProductsAPI.getById(Number(id)),
    enabled: !!id,
  });

  // Fetch categories
  const { data: categoriesData } = useQuery({
    queryKey: ['categories'],
    queryFn: () => masterProductsAPI.getCategories(),
  });

  // Pre-fill form when product data loads
  useEffect(() => {
    if (product) {
      reset({
        product_name: product.product_name,
        product_type: product.product_type,
        specifications: product.specifications,
        unit_of_measure: product.unit_of_measure,
        category: product.category.id,
      });

      // Set existing files
      if (product.photo) {
        const baseURL = import.meta.env.VITE_API_BASE_URL?.replace('/api', '') || '';
        setExistingPhoto(`${baseURL}/storage/${product.photo}`);
      }
      if (product.tech_doc) {
        setExistingTechDoc(product.tech_doc.split('/').pop() || null);
      }
    }
  }, [product, reset]);

  // Update product mutation (for form fields only)
  const updateMutation = useMutation({
    mutationFn: (data: UpdateMasterProductPayload) => 
      masterProductsAPI.update(Number(id), data),
    onSuccess: () => {
      toast.success('Product updated successfully!');
      queryClient.invalidateQueries({ queryKey: ['masterProducts'] });
      queryClient.invalidateQueries({ queryKey: ['masterProduct', id] });
      navigate('/admin/master-products');
    },
    onError: (error: Error) => {
      toast.error(error.message || 'Failed to update product');
    },
  });

  // Toggle approval mutation (separate from update)
  const toggleApprovalMutation = useMutation({
    mutationFn: () => masterProductsAPI.toggleApproval(Number(id)),
    onSuccess: () => {
      toast.success('Product approval status updated successfully!');
      queryClient.invalidateQueries({ queryKey: ['masterProduct', id] });
      queryClient.invalidateQueries({ queryKey: ['masterProducts'] });
    },
    onError: (error: Error) => {
      toast.error(error.message || 'Failed to update approval status');
    },
  });

  // Handle photo change
  const handlePhotoChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      if (file.size > 2 * 1024 * 1024) {
        toast.error('Image size should not exceed 2MB');
        setValue('photo', undefined);
        return;
      }
      const reader = new FileReader();
      reader.onloadend = () => {
        setPhotoPreview(reader.result as string);
        setExistingPhoto(null);
      };
      reader.readAsDataURL(file);
    }
  };

  // Handle tech doc change
  const handleTechDocChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      if (file.size > 5 * 1024 * 1024) {
        toast.error('Document size should not exceed 5MB');
        setValue('tech_doc', undefined);
        return;
      }
      setTechDocName(file.name);
      setExistingTechDoc(null);
    }
  };

  // Remove photo
  const removePhoto = () => {
    setPhotoPreview(null);
    setExistingPhoto(null);
    setValue('photo', undefined);
  };

  // Remove tech doc
  const removeTechDoc = () => {
    setTechDocName(null);
    setExistingTechDoc(null);
    setValue('tech_doc', undefined);
  };

  // Form submit (for product details only)
  const onSubmit = (data: FormData) => {
    const payload: UpdateMasterProductPayload = {
      product_name: data.product_name,
      product_type: data.product_type,
      specifications: data.specifications,
      unit_of_measure: data.unit_of_measure,
      category: Number(data.category),
    };

    // Only include files if new ones are uploaded
    if (data.photo?.[0]) {
      payload.photo = data.photo[0];
    }
    if (data.tech_doc?.[0]) {
      payload.tech_doc = data.tech_doc[0];
    }

    updateMutation.mutate(payload);
  };

  if (productLoading) {
    return (
      <DashboardLayout menuItems={adminMenuItems}>
        <div className="flex items-center justify-center h-96">
          <Loader2 size={48} className="animate-spin text-blue-500" />
        </div>
      </DashboardLayout>
    );
  }

  if (!product) {
    return (
      <DashboardLayout menuItems={adminMenuItems}>
        <div className="text-center py-12">
          <p className="text-gray-600">Product not found</p>
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout menuItems={adminMenuItems}>
      <div className="min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8">
        <div className="max-w-4xl mx-auto">
          {/* Breadcrumb */}
          <nav className="mb-8">
            <ol className="flex items-center space-x-2 text-sm text-gray-500">
              <li>
                <Link to="/admin/master-products" className="hover:text-blue-600 transition-colors">
                  Master Products
                </Link>
              </li>
              <li>
                <ChevronRight size={16} />
              </li>
              <li className="text-gray-900 font-medium">Edit Product</li>
            </ol>
          </nav>

          {/* Page Header */}
          <div className="mb-8">
            <h1 className="text-3xl font-bold text-gray-900">Edit Product</h1>
            <p className="text-gray-600 mt-2">
              Update product information
            </p>
          </div>

          {/* Form Card */}
          <form onSubmit={handleSubmit(onSubmit)} className="bg-white rounded-lg shadow p-8">
            <div className="space-y-6">
              {/* Product Name */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Product Name <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  {...register('product_name', { required: 'Product name is required' })}
                  className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors ${
                    errors.product_name ? 'border-red-500' : 'border-gray-300'
                  }`}
                  placeholder="Enter product name"
                />
                {errors.product_name && (
                  <p className="mt-1 text-sm text-red-500">{errors.product_name.message}</p>
                )}
              </div>

              {/* Product Type */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Product Type <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  {...register('product_type', { required: 'Product type is required' })}
                  className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors ${
                    errors.product_type ? 'border-red-500' : 'border-gray-300'
                  }`}
                  placeholder="e.g., Gravel, Sand, Concrete"
                />
                {errors.product_type && (
                  <p className="mt-1 text-sm text-red-500">{errors.product_type.message}</p>
                )}
              </div>

              {/* Category */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Category <span className="text-red-500">*</span>
                </label>
                <select
                  {...register('category', { required: 'Category is required' })}
                  className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors ${
                    errors.category ? 'border-red-500' : 'border-gray-300'
                  }`}
                >
                  <option value="">Select category</option>
                  {categoriesData?.data.map((category) => (
                    <option key={category.id} value={category.id}>
                      {category.name}
                    </option>
                  ))}
                </select>
                {errors.category && (
                  <p className="mt-1 text-sm text-red-500">{errors.category.message}</p>
                )}
              </div>

              {/* Unit of Measure */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Unit of Measure <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  {...register('unit_of_measure', { required: 'Unit of measure is required' })}
                  className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors ${
                    errors.unit_of_measure ? 'border-red-500' : 'border-gray-300'
                  }`}
                  placeholder="e.g., ton, kg, Cubic Meter"
                />
                {errors.unit_of_measure && (
                  <p className="mt-1 text-sm text-red-500">{errors.unit_of_measure.message}</p>
                )}
              </div>

              {/* Specifications */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Specifications <span className="text-red-500">*</span>
                </label>
                <textarea
                  {...register('specifications', { required: 'Specifications are required' })}
                  rows={4}
                  className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none ${
                    errors.specifications ? 'border-red-500' : 'border-gray-300'
                  }`}
                  placeholder="Enter detailed product specifications"
                />
                {errors.specifications && (
                  <p className="mt-1 text-sm text-red-500">{errors.specifications.message}</p>
                )}
              </div>

              {/* Photo Upload */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Product Photo
                </label>
                
                {photoPreview || existingPhoto ? (
                  <div className="relative w-48 h-48 rounded-lg overflow-hidden border-2 border-gray-200">
                    <img 
                      src={photoPreview || existingPhoto || ''} 
                      alt="Preview" 
                      className="w-full h-full object-cover"
                    />
                    <button
                      type="button"
                      onClick={removePhoto}
                      className="absolute top-2 right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors"
                    >
                      <X size={16} />
                    </button>
                  </div>
                ) : (
                  <label className="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                    <div className="flex flex-col items-center justify-center pt-5 pb-6">
                      <ImageIcon size={40} className="text-gray-400 mb-3" />
                      <p className="mb-2 text-sm text-gray-500">
                        <span className="font-semibold">Click to upload</span> or drag and drop
                      </p>
                      <p className="text-xs text-gray-500">PNG, JPG or GIF (MAX. 2MB)</p>
                    </div>
                    <input
                      type="file"
                      accept="image/jpeg,image/png,image/jpg,image/gif"
                      {...register('photo')}
                      onChange={handlePhotoChange}
                      className="hidden"
                    />
                  </label>
                )}
              </div>

              {/* Tech Doc Upload */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Technical Document
                </label>
                
                {techDocName || existingTechDoc ? (
                  <div className="flex items-center justify-between p-4 border-2 border-gray-200 rounded-lg">
                    <div className="flex items-center space-x-3">
                      <FileText size={24} className="text-blue-500" />
                      <span className="text-sm text-gray-700">
                        {techDocName || existingTechDoc}
                      </span>
                    </div>
                    <button
                      type="button"
                      onClick={removeTechDoc}
                      className="p-1 text-red-500 hover:bg-red-50 rounded transition-colors"
                    >
                      <X size={20} />
                    </button>
                  </div>
                ) : (
                  <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                    <div className="flex flex-col items-center justify-center">
                      <Upload size={32} className="text-gray-400 mb-2" />
                      <p className="text-sm text-gray-500">
                        <span className="font-semibold">Upload document</span>
                      </p>
                      <p className="text-xs text-gray-500">PDF, DOCX or XLSX (MAX. 5MB)</p>
                    </div>
                    <input
                      type="file"
                      accept=".pdf,.docx,.xlsx"
                      {...register('tech_doc')}
                      onChange={handleTechDocChange}
                      className="hidden"
                    />
                  </label>
                )}
              </div>
            </div>

            {/* Approval Status Section */}
            <div className="mt-8 pt-6 border-t border-gray-200">
              <div className="flex items-center justify-between">
                <div>
                  <h3 className="text-lg font-semibold text-gray-900">Product Approval Status</h3>
                  <p className="text-sm text-gray-500 mt-1">
                    Control whether this product is active and visible to clients
                  </p>
                </div>
                <button
                  type="button"
                  onClick={() => toggleApprovalMutation.mutate()}
                  disabled={toggleApprovalMutation.isPending}
                  className={`px-6 py-3 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed ${
                    product.is_approved === 1
                      ? 'bg-red-500 text-white hover:bg-red-600'
                      : 'bg-green-500 text-white hover:bg-green-600'
                  }`}
                >
                  {toggleApprovalMutation.isPending ? 'Updating...' : (product.is_approved === 1 ? 'Mark as Inactive' : 'Mark as Active')}
                </button>
              </div>
              <div className="mt-4">
                <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${
                  product.is_approved === 1 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                }`}>
                  Current Status: {product.is_approved === 1 ? 'Active' : 'Inactive'}
                </span>
              </div>
            </div>

            {/* Form Actions */}
            <div className="flex items-center justify-end space-x-4 mt-8 pt-6 border-t border-gray-200">
              <Link
                to="/admin/master-products"
                className="px-6 py-3 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors font-medium"
              >
                Cancel
              </Link>
              <button
                type="submit"
                disabled={updateMutation.isPending}
                className="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium"
              >
                {updateMutation.isPending ? 'Updating...' : 'Update Product'}
              </button>
            </div>
          </form>
        </div>
      </div>
    </DashboardLayout>
  );
};

export default EditMasterProduct;
/* FILE: src/pages/admin/MasterProducts/MasterProductsList.tsx */
// FILE PATH: src/pages/admin/MasterProducts/MasterProductsList.tsx
import { useState, useEffect } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { useQuery, useMutation, useQueryClient, keepPreviousData } from '@tanstack/react-query';
import toast from 'react-hot-toast';

import {
  masterProductsAPI,
} from '../../../api/handlers/masterProducts.api';
 import type {
   MasterProductsFilters,
   PaginatedMasterProductsResponse,
   MasterProduct,
 } from '../../../api/handlers/masterProducts.api';
import DashboardLayout from '../../../components/layout/DashboardLayout';
import StatusBadge from '../../../components/common/StatusBadge';
import Pagination from '../../../components/common/Pagination';
import ConfirmModal from '../../../components/common/ConfirmModal';
import { adminMenuItems } from '../../../utils/menuItems';

const PER_PAGE = 10;

// Inline SVG placeholder to prevent image loading errors
const PLACEHOLDER_IMAGE = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2UzZTNlMyIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5ObyBJbWFnZTwvdGV4dD48L3N2Zz4=';

const MasterProductsList = () => {
  const navigate = useNavigate();
  const queryClient = useQueryClient();

  // State - Simple filter management
  const [filters, setFilters] = useState<MasterProductsFilters>({
    page: 1,
    per_page: PER_PAGE,
  });
  
  const [searchQuery, setSearchQuery] = useState<string>('');
  const [debouncedSearch, setDebouncedSearch] = useState('');

  // Modal
  const [confirmModal, setConfirmModal] = useState<{
    isOpen: boolean;
    productId: number | null;
    currentStatus: boolean | null;
    loading: boolean;
  }>({
    isOpen: false,
    productId: null,
    currentStatus: null,
    loading: false,
  });

  // Debounce search
  useEffect(() => {
    const timer = setTimeout(() => {
      setDebouncedSearch(searchQuery);
      setFilters(prev => ({ ...prev, page: 1 }));
    }, 500);
    return () => clearTimeout(timer);
  }, [searchQuery]);

  // Build query params
  const queryParams: MasterProductsFilters = {
    ...filters,
    search: debouncedSearch || undefined,
  };

  // Fetch Products using React Query
  const { data: productsData, isLoading, error } = useQuery<PaginatedMasterProductsResponse>({
    queryKey: ['masterProducts', queryParams],
    queryFn: () => masterProductsAPI.getAll(queryParams),
    placeholderData: keepPreviousData,
  });

  // Fetch Categories for filter
  const { data: categoriesData } = useQuery({
    queryKey: ['categories'],
    queryFn: () => masterProductsAPI.getCategories(),
  });

  // Toggle Approval Mutation
  const toggleApprovalMutation = useMutation({
    mutationFn: (id: number) => masterProductsAPI.toggleApproval(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['masterProducts'] });
      toast.success('Product status updated successfully');
      setConfirmModal({ isOpen: false, productId: null, currentStatus: null, loading: false });
    },
    onError: (error: Error) => {
      toast.error(error.message || 'Failed to update product status');
      setConfirmModal(prev => ({ ...prev, loading: false }));
    },
  });

  // Handlers
  const handleFilterChange = (key: keyof MasterProductsFilters, value: any) => {
    setFilters(prev => ({ ...prev, [key]: value, page: 1 }));
  };

  const handleStatusToggle = (productId: number, currentStatus: boolean) => {
    setConfirmModal({ isOpen: true, productId, currentStatus, loading: false });
  };

  const confirmStatusChange = () => {
    const { productId } = confirmModal;
    if (!productId) return;

    setConfirmModal(prev => ({ ...prev, loading: true }));
    toggleApprovalMutation.mutate(productId);
  };

  const handleDelete = (_productId: number) => {
    toast('Delete functionality coming soon', { icon: '🚧' });
  };

  // Clear all filters
  const clearFilters = () => {
    setFilters({
      page: 1,
      per_page: PER_PAGE,
    });
    setSearchQuery('');
  };

  // Check if any filters are active
  const hasActiveFilters = searchQuery || filters.category || filters.is_approved !== undefined;

  // Fixed image handler - prevents infinite loop
  const handleImageError = (e: React.SyntheticEvent<HTMLImageElement>) => {
    const target = e.currentTarget;
    // Only set placeholder if not already set to prevent loop
    if (target.src !== PLACEHOLDER_IMAGE) {
      target.src = PLACEHOLDER_IMAGE;
      // Remove onError to prevent further triggers
      target.onerror = null;
    }
  };

  const getImageUrl = (photoPath: string | null): string => {
    if (!photoPath) return PLACEHOLDER_IMAGE;
    const baseUrl = import.meta.env.VITE_API_BASE_URL?.replace('/api', '') || 'http://127.0.0.1:8000';
    return `${baseUrl}/storage/${photoPath}`;
  };

  // Extract data
  const products: MasterProduct[] = productsData?.data ?? [];
  const pagination = {
    currentPage: productsData?.current_page || 1,
    lastPage: productsData?.last_page || 1,
    total: productsData?.total || 0,
    perPage: PER_PAGE,
  };

  // Calculate stats
  const stats = {
    total: pagination.total,
    approved: products.filter((p: MasterProduct) => p.is_approved === 1).length,
    pending: products.filter((p: MasterProduct) => p.is_approved === 0).length,
  };

  return (
    <DashboardLayout menuItems={adminMenuItems}>
      <div className="min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8">
        <div className="max-w-7xl mx-auto">
          {/* Header */}
          <div className="mb-8">
            <div className="flex justify-between items-center">
              <div>
                <h1 className="text-3xl font-bold text-gray-900">Master Products</h1>
                <p className="mt-1 text-sm text-gray-600">
                  Manage all master products and their supplier offers
                </p>
              </div>
              <Link
                to="/admin/master-products/add"
                className="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-sm transition-colors"
              >
                <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Product
              </Link>
            </div>
          </div>

          {/* Stats Cards */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div className="bg-white rounded-lg shadow p-6">
              <div className="flex items-center">
                <div className="flex-shrink-0 bg-blue-100 rounded-md p-3">
                  <svg className="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                  </svg>
                </div>
                <div className="ml-4">
                  <p className="text-sm font-medium text-gray-500">Total Products</p>
                  <p className="text-2xl font-semibold text-gray-900">{stats.total}</p>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-lg shadow p-6">
              <div className="flex items-center">
                <div className="flex-shrink-0 bg-green-100 rounded-md p-3">
                  <svg className="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
                <div className="ml-4">
                  <p className="text-sm font-medium text-gray-500">Approved</p>
                  <p className="text-2xl font-semibold text-gray-900">{stats.approved}</p>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-lg shadow p-6">
              <div className="flex items-center">
                <div className="flex-shrink-0 bg-yellow-100 rounded-md p-3">
                  <svg className="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
                <div className="ml-4">
                  <p className="text-sm font-medium text-gray-500">Pending Approval</p>
                  <p className="text-2xl font-semibold text-gray-900">{stats.pending}</p>
                </div>
              </div>
            </div>
          </div>

          {/* Filters */}
          <div className="bg-white rounded-lg shadow p-4 mb-6">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              {/* Search */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Search Products
                </label>
                <input
                  type="text"
                  placeholder="Search by name or type..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>

              {/* Status Filter */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Status
                </label>
                <select
                  value={filters.is_approved !== undefined ? (filters.is_approved === 1 ? 'approved' : 'pending') : ''}
                  onChange={(e) => handleFilterChange('is_approved', e.target.value ? (e.target.value === 'approved' ? 1 : 0) : undefined)}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="">All Status</option>
                  <option value="approved">Active</option>
                  <option value="pending">Inactive</option>
                </select>
              </div>

              {/* Category Filter */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Category
                </label>
                <select
                  value={filters.category || ''}
                  onChange={(e) => handleFilterChange('category', e.target.value || undefined)}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="">All Categories</option>
                  {categoriesData?.data.map((category) => (
                    <option key={category.id} value={category.id}>
                      {category.name}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            {/* Clear Filters Button */}
            {hasActiveFilters && (
              <button
                onClick={clearFilters}
                className="mt-4 text-sm text-blue-600 hover:text-blue-700 font-medium"
              >
                Clear all filters
              </button>
            )}
          </div>

          {/* Table */}
          <div className="bg-white rounded-lg shadow overflow-hidden">
            {isLoading ? (
              <div className="flex justify-center items-center py-12">
                <div className="flex flex-col items-center gap-3">
                  <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                  <p className="text-gray-500">Loading products...</p>
                </div>
              </div>
            ) : error ? (
              <div className="flex flex-col items-center justify-center py-12 text-red-500">
                <p className="mb-2">Failed to load products</p>
                <button 
                  onClick={() => queryClient.invalidateQueries({queryKey: ['masterProducts']})}
                  className="text-sm text-blue-600 hover:underline"
                >
                  Try again
                </button>
              </div>
            ) : products.length === 0 ? (
              <div className="flex flex-col items-center justify-center py-12 text-gray-500">
                <svg className="mx-auto h-12 w-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                <p className="mb-2">No products found</p>
                {hasActiveFilters && (
                  <button 
                    onClick={clearFilters}
                    className="text-sm text-blue-600 hover:underline"
                  >
                    Clear filters
                  </button>
                )}
              </div>
            ) : (
              <>
                <div className="overflow-x-auto">
                  <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Product
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Type
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Category
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Added By
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Supplier Offers
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Status
                        </th>
                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Actions
                        </th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                      {products.map((product : MasterProduct) => (
                        <tr key={product.id} className="hover:bg-gray-50 transition-colors">
                          {/* Product Info */}
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="flex items-center">
                              <div className="flex-shrink-0 h-12 w-12">
                                <img
                                  className="h-12 w-12 rounded-lg object-cover border border-gray-200"
                                  src={getImageUrl(product.photo)}
                                  alt={product.product_name}
                                  onError={handleImageError}
                                />
                              </div>
                              <div className="ml-4">
                                <div className="text-sm font-medium text-gray-900">
                                  {product.product_name}
                                </div>
                                <div className="text-sm text-gray-500">
                                  {product.unit_of_measure}
                                </div>
                              </div>
                            </div>
                          </td>

                          {/* Type */}
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="text-sm text-gray-900">{product.product_type}</div>
                          </td>

                          {/* Category */}
                          <td className="px-6 py-4 whitespace-nowrap">
                            <span className="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">
                              {product.category?.name || 'N/A'}
                            </span>
                          </td>

                          {/* Added By */}
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="text-sm text-gray-900">{product.added_by?.name}</div>
                            <div className="text-sm text-gray-500">{product.added_by?.email}</div>
                          </td>

                          {/* Supplier Offers Count */}
                          <td className="px-6 py-4 whitespace-nowrap text-center">
                            <span className="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                              {product.supplierOffersCount || 0}
                            </span>
                          </td>

                          {/* Status */}
                          <td className="px-6 py-4 whitespace-nowrap">
                            <StatusBadge
                              isApproved={product.is_approved === 1}
                              onToggle={() => handleStatusToggle(product.id, product.is_approved === 1)}
                            />
                          </td>

                          {/* Actions */}
                          <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div className="flex justify-end gap-2">
                              <button
                                onClick={() => navigate(`/admin/master-products/view/${product.id}`)}
                                className="text-blue-600 hover:text-blue-900 p-2 hover:bg-blue-50 rounded transition-colors"
                                title="View Details"
                              >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                              </button>
                              <button
                                onClick={() => navigate(`/admin/master-products/edit/${product.id}`)}
                                className="text-green-600 hover:text-green-900 p-2 hover:bg-green-50 rounded transition-colors"
                                title="Edit Product"
                              >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                              </button>
                              <button
                                onClick={() => handleDelete(product.id)}
                                className="text-red-600 hover:text-red-900 p-2 hover:bg-red-50 rounded transition-colors"
                                title="Delete Product (Coming Soon)"
                              >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                {/* Pagination */}
                <Pagination
                  currentPage={pagination.currentPage}
                  lastPage={pagination.lastPage}
                  total={pagination.total}
                  perPage={pagination.perPage}
                  onPageChange={(next) => setFilters(prev => ({ ...prev, page: next }))}
                  loading={isLoading}
                />
              </>
            )}
          </div>

          {/* Confirmation Modal */}
          <ConfirmModal
            isOpen={confirmModal.isOpen}
            onClose={() => setConfirmModal({ isOpen: false, productId: null, currentStatus: null, loading: false })}
            onConfirm={confirmStatusChange}
            title={`${confirmModal.currentStatus ? 'Deactivate' : 'Activate'} Product`}
            message={`Are you sure you want to ${confirmModal.currentStatus ? 'deactivate' : 'activate'} this product? This will change its approval status.`}
            confirmText={confirmModal.currentStatus ? 'Deactivate' : 'Activate'}
            cancelText="Cancel"
            isDanger={confirmModal.currentStatus === true}
            loading={confirmModal.loading || toggleApprovalMutation.isPending}
          />
        </div>
      </div>
    </DashboardLayout>
  );
};

export default MasterProductsList;
/* FILE: src/pages/admin/MasterProducts/ViewMasterProduct.tsx */
// FILE PATH: src/pages/admin/MasterProducts/ViewMasterProduct.tsx

import { useState } from 'react';
import { Link, useParams, useNavigate } from 'react-router-dom';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import toast from 'react-hot-toast';
import { 
  ChevronRight, 
  Edit, 
  Trash2, 
  Loader2, 
  Package, 
  FileText,
  User,
  MapPin,
  CheckCircle,
  XCircle,
  Clock
} from 'lucide-react';

import DashboardLayout from '../../../components/layout/DashboardLayout';
import ConfirmModal from '../../../components/common/ConfirmModal';
import { adminMenuItems } from '../../../utils/menuItems';
import { masterProductsAPI } from '../../../api/handlers/masterProducts.api';

const ViewMasterProduct = () => {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const queryClient = useQueryClient();

  const [deleteModal, setDeleteModal] = useState(false);
  const [offerModal, setOfferModal] = useState<{
    isOpen: boolean;
    offerId: number | null;
    action: 'Approved' | 'Rejected' | 'Pending' | null;
    loading: boolean;
  }>({
    isOpen: false,
    offerId: null,
    action: null,
    loading: false,
  });

  // Fetch product details
  const { data: product, isLoading } = useQuery({
    queryKey: ['masterProduct', id],
    queryFn: () => masterProductsAPI.getById(Number(id)),
    enabled: !!id,
  });

  // Delete product mutation
  const deleteMutation = useMutation({
    mutationFn: () => masterProductsAPI.delete(Number(id)),
    onSuccess: () => {
      toast.success('Product deleted successfully');
      navigate('/admin/master-products');
    },
    onError: (error: Error) => {
      toast.error(error.message || 'Failed to delete product');
    },
  });

  // Approve/Reject offer mutation
  const offerStatusMutation = useMutation({
    mutationFn: ({ offerId, status }: { offerId: number; status: 'Approved' | 'Rejected' | 'Pending' }) =>
      masterProductsAPI.approveRejectOffer(offerId, { status }),
    onSuccess: () => {
      toast.success('Offer status updated successfully');
      queryClient.invalidateQueries({ queryKey: ['masterProduct', id] });
      setOfferModal({ isOpen: false, offerId: null, action: null, loading: false });
    },
    onError: (error: Error) => {
      toast.error(error.message || 'Failed to update offer status');
      setOfferModal(prev => ({ ...prev, loading: false }));
    },
  });

  const handleOfferAction = (offerId: number, action: 'Approved' | 'Rejected' | 'Pending') => {
    setOfferModal({ isOpen: true, offerId, action, loading: false });
  };

  const confirmOfferAction = () => {
    if (offerModal.offerId && offerModal.action) {
      setOfferModal(prev => ({ ...prev, loading: true }));
      offerStatusMutation.mutate({ 
        offerId: offerModal.offerId, 
        status: offerModal.action 
      });
    }
  };

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'Approved':
        return <CheckCircle size={18} className="text-green-500" />;
      case 'Rejected':
        return <XCircle size={18} className="text-red-500" />;
      default:
        return <Clock size={18} className="text-yellow-500" />;
    }
  };

  const getStatusBadgeColor = (status: string) => {
    switch (status) {
      case 'Approved':
        return 'bg-green-100 text-green-800';
      case 'Rejected':
        return 'bg-red-100 text-red-800';
      default:
        return 'bg-yellow-100 text-yellow-800';
    }
  };

  if (isLoading) {
    return (
      <DashboardLayout menuItems={adminMenuItems}>
        <div className="flex items-center justify-center h-96">
          <Loader2 size={48} className="animate-spin text-blue-500" />
        </div>
      </DashboardLayout>
    );
  }

  if (!product) {
    return (
      <DashboardLayout menuItems={adminMenuItems}>
        <div className="text-center py-12">
          <p className="text-gray-600">Product not found</p>
        </div>
      </DashboardLayout>
    );
  }

  const baseURL = import.meta.env.VITE_API_BASE_URL?.replace('/api', '') || '';

  return (
    <DashboardLayout menuItems={adminMenuItems}>
      <div className="min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8">
        <div className="max-w-6xl mx-auto">
          {/* Breadcrumb */}
          <nav className="mb-8">
            <ol className="flex items-center space-x-2 text-sm text-gray-500">
              <li>
                <Link to="/admin/master-products" className="hover:text-blue-600 transition-colors">
                  Master Products
                </Link>
              </li>
              <li>
                <ChevronRight size={16} />
              </li>
              <li className="text-gray-900 font-medium">{product.product_name}</li>
            </ol>
          </nav>

          {/* Header */}
          <div className="flex items-start justify-between mb-8">
            <div>
              <h1 className="text-3xl font-bold text-gray-900">{product.product_name}</h1>
              <p className="text-gray-600 mt-2">Product Details & Supplier Offers</p>
            </div>
            <div className="flex items-center space-x-3">
              <Link
                to={`/admin/master-products/edit/${id}`}
                className="flex items-center space-x-2 px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors"
              >
                <Edit size={18} />
                <span>Edit</span>
              </Link>
              <button
                onClick={() => setDeleteModal(true)}
                className="flex items-center space-x-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
              >
                <Trash2 size={18} />
                <span>Delete</span>
              </button>
            </div>
          </div>

          {/* Product Details Card */}
          <div className="bg-white rounded-lg shadow p-8 mb-8">
            <h2 className="text-xl font-bold text-gray-900 mb-6">Product Information</h2>
            
            <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
              {/* Product Image */}
              <div className="md:col-span-1">
                {product.photo ? (
                  <img
                    src={`${baseURL}/storage/${product.photo}`}
                    alt={product.product_name}
                    className="w-full h-64 object-cover rounded-lg border-2 border-gray-200"
                  />
                ) : (
                  <div className="w-full h-64 bg-gray-100 rounded-lg flex items-center justify-center">
                    <Package size={64} className="text-gray-400" />
                  </div>
                )}
              </div>

              {/* Product Details */}
              <div className="md:col-span-2 space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-sm font-medium text-gray-500">Product Type</label>
                    <p className="text-gray-900 mt-1">{product.product_type}</p>
                  </div>
                  <div>
                    <label className="text-sm font-medium text-gray-500">Category</label>
                    <p className="text-gray-900 mt-1">{product.category.name}</p>
                  </div>
                  <div>
                    <label className="text-sm font-medium text-gray-500">Unit of Measure</label>
                    <p className="text-gray-900 mt-1">{product.unit_of_measure}</p>
                  </div>
                  <div>
                    <label className="text-sm font-medium text-gray-500">Approval Status</label>
                    <div className="mt-1">
                      <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                        product.is_approved === 1 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                      }`}>
                        {product.is_approved === 1 ? 'Active' : 'Inactive'}
                      </span>
                    </div>
                  </div>
                </div>

                <div>
                  <label className="text-sm font-medium text-gray-500">Specifications</label>
                  <p className="text-gray-900 mt-1">{product.specifications}</p>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-sm font-medium text-gray-500">Added By</label>
                    <div className="flex items-center space-x-2 mt-1">
                      <User size={16} className="text-gray-400" />
                      <p className="text-gray-900">{product.added_by.name}</p>
                    </div>
                  </div>
                  {product.approved_by && (
                    <div>
                      <label className="text-sm font-medium text-gray-500">Approved By</label>
                      <div className="flex items-center space-x-2 mt-1">
                        <User size={16} className="text-gray-400" />
                        <p className="text-gray-900">{product.approved_by.name}</p>
                      </div>
                    </div>
                  )}
                </div>

                {product.tech_doc && (
                  <div>
                    <label className="text-sm font-medium text-gray-500">Technical Document</label>
                    <a
                      href={`${baseURL}/storage/${product.tech_doc}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex items-center space-x-2 mt-2 text-blue-600 hover:text-blue-700 transition-colors"
                    >
                      <FileText size={18} />
                      <span>View Document</span>
                    </a>
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Supplier Offers Section */}
          <div className="bg-white rounded-lg shadow p-8">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-xl font-bold text-gray-900">
                Supplier Offers ({product.supplierOffers?.length || 0})
              </h2>
            </div>

            {product.supplierOffers && product.supplierOffers.length > 0 ? (
              <div className="space-y-4">
                {product.supplierOffers.map((offer) => (
                  <div
                    key={offer.id}
                    className="border border-gray-200 rounded-lg p-6 hover:border-blue-300 transition-colors"
                  >
                    <div className="flex items-start justify-between">
                      {/* Supplier Info */}
                      <div className="flex items-start space-x-4 flex-1">
                        <div className="w-16 h-16 rounded-full overflow-hidden bg-gray-100 flex-shrink-0">
                          {offer.supplier.profile_image ? (
                            <img
                              src={`${baseURL}/${offer.supplier.profile_image}`}
                              alt={offer.supplier.name}
                              className="w-full h-full object-cover"
                            />
                          ) : (
                            <div className="w-full h-full flex items-center justify-center">
                              <User size={32} className="text-gray-400" />
                            </div>
                          )}
                        </div>

                        <div className="flex-1">
                          <h3 className="font-semibold text-gray-900">{offer.supplier.name}</h3>
                          <p className="text-sm text-gray-500">{offer.supplier.email}</p>
                          
                          <div className="grid grid-cols-3 gap-4 mt-4">
                            <div>
                              <label className="text-xs font-medium text-gray-500">Price</label>
                              <p className="text-lg font-bold text-blue-600">${offer.price}</p>
                            </div>
                            <div>
                              <label className="text-xs font-medium text-gray-500">Availability</label>
                              <p className="text-sm text-gray-900">{offer.availability_status}</p>
                            </div>
                            <div>
                              <label className="text-xs font-medium text-gray-500">Status</label>
                              <div className="flex items-center space-x-2 mt-1">
                                {getStatusIcon(offer.status)}
                                <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusBadgeColor(offer.status)}`}>
                                  {offer.status}
                                </span>
                              </div>
                            </div>
                          </div>

                          {/* Delivery Zones */}
                          {offer.supplier.delivery_zones && offer.supplier.delivery_zones.length > 0 && (
                            <div className="mt-4">
                              <label className="text-xs font-medium text-gray-500 flex items-center space-x-1">
                                <MapPin size={14} />
                                <span>Delivery Zones</span>
                              </label>
                              <div className="mt-2 space-y-2">
                                {offer.supplier.delivery_zones.map((zone, idx) => (
                                  <div key={idx} className="text-sm text-gray-700 bg-gray-50 px-3 py-2 rounded">
                                    <p className="font-medium">{zone.address}</p>
                                    <p className="text-xs text-gray-500 mt-1">
                                      Radius: {zone.radius} km
                                    </p>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>

                      {/* Action Buttons */}
                      <div className="flex flex-col space-y-2 ml-4">
                        <button
                          onClick={() => handleOfferAction(offer.id, 'Approved')}
                          disabled={offer.status === 'Approved'}
                          className="px-4 py-2 bg-green-500 text-white text-sm rounded-lg hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                        >
                          Approve
                        </button>
                        <button
                          onClick={() => handleOfferAction(offer.id, 'Rejected')}
                          disabled={offer.status === 'Rejected'}
                          className="px-4 py-2 bg-red-500 text-white text-sm rounded-lg hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                        >
                          Reject
                        </button>
                        <button
                          onClick={() => handleOfferAction(offer.id, 'Pending')}
                          disabled={offer.status === 'Pending'}
                          className="px-4 py-2 bg-yellow-500 text-white text-sm rounded-lg hover:bg-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                        >
                          Pending
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-center py-12 bg-gray-50 rounded-lg">
                <Package size={48} className="mx-auto text-gray-400 mb-4" />
                <p className="text-gray-600">No supplier offers available</p>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Delete Confirmation Modal */}
      <ConfirmModal
        isOpen={deleteModal}
        onClose={() => setDeleteModal(false)}
        onConfirm={() => deleteMutation.mutate()}
        title="Delete Product"
        message={`Are you sure you want to delete "${product.product_name}"? This action cannot be undone.`}
        confirmText="Delete"
        loading={deleteMutation.isPending}
      />

      {/* Offer Status Confirmation Modal */}
      <ConfirmModal
        isOpen={offerModal.isOpen}
        onClose={() => setOfferModal({ isOpen: false, offerId: null, action: null, loading: false })}
        onConfirm={confirmOfferAction}
        title={`${offerModal.action} Supplier Offer`}
        message={`Are you sure you want to set this supplier offer to ${offerModal.action?.toLowerCase()}?`}
        confirmText={offerModal.action || 'Confirm'}
        loading={offerModal.loading}
      />
    </DashboardLayout>
  );
};

export default ViewMasterProduct;
/* FILE: src/pages/admin/Orders/AdminOrdersList.tsx */
// FILE PATH: src/pages/admin/Orders/AdminOrdersList.tsx

/**
 * Admin Orders List Page - WITH PERMISSION-BASED VISIBILITY
 * Main page with metrics, filters panel, active chips, and comprehensive table
 * Uses role-based menu items
 */

import React, { useState, useEffect } from 'react';
import { useSearchParams } from 'react-router-dom';
import { RefreshCw, Filter, Search, Eye } from 'lucide-react';
import DashboardLayout from '../../../components/layout/DashboardLayout';
import OrderMetricsCards from '../../../components/admin/Orders/OrderMetricsCards';
import OrderFiltersPanel from '../../../components/admin/Orders/OrderFiltersPanel';
import ActiveFilterChips from '../../../components/admin/Orders/ActiveFilterChips';
import OrdersTable from '../../../components/admin/Orders/OrdersTable';
import { useAdminOrders } from '../../../features/adminOrders/hooks';
import { getMenuItemsByRole } from '../../../utils/menuItems';
import { usePermissions } from '../../../hooks/usePermissions';

const AdminOrdersList: React.FC = () => {
  const [searchParams, setSearchParams] = useSearchParams();
  const [isFirstLoad, setIsFirstLoad] = useState(true);
  const [availableFilters, setAvailableFilters] = useState<any>(null);
  const [isFilterPanelOpen, setIsFilterPanelOpen] = useState(false);

  // Get permissions and role-based menu
  const { role, isReadOnly } = usePermissions();
  const menuItems = getMenuItemsByRole(role);

  // Initialize filters from URL params
  const [filters, setFilters] = useState({
    search: searchParams.get('search') || '',
    client_id: searchParams.get('client_id') || '',
    project_id: searchParams.get('project_id') || '',
    supplier_id: searchParams.get('supplier_id') || '',
    workflow: searchParams.get('workflow') || '',
    payment_status: searchParams.get('payment_status') || '',
    delivery_method: searchParams.get('delivery_method') || '',
    delivery_date_from: searchParams.get('delivery_date_from') || '',
    delivery_date_to: searchParams.get('delivery_date_to') || '',
    repeat_order: searchParams.get('repeat_order') || '',
    has_missing_supplier: searchParams.get('has_missing_supplier') || '',
    supplier_confirms: searchParams.get('supplier_confirms') || '',
    min_total: searchParams.get('min_total') || '',
    max_total: searchParams.get('max_total') || '',
    sort: searchParams.get('sort') || 'created_at',
    dir: searchParams.get('dir') || 'desc',
    page: parseInt(searchParams.get('page') || '1'),
    per_page: 10,
  });

  // Fetch orders with includeDetails on first load
  const { data, isLoading, isFetching, refetch } = useAdminOrders({
    ...filters,
    details: isFirstLoad,
  });

  // Store filters from first load
  useEffect(() => {
    if (isFirstLoad && data?.filters) {
      setAvailableFilters(data.filters);
      setIsFirstLoad(false);
    }
  }, [data, isFirstLoad]);

  // Update URL params when filters change
  useEffect(() => {
    const params: Record<string, string> = {};
    Object.entries(filters).forEach(([key, value]) => {
      if (value !== '' && key !== 'per_page') {
        params[key] = String(value);
      }
    });
    setSearchParams(params, { replace: true });
  }, [filters, setSearchParams]);

  const handleFilterChange = (key: string, value: string) => {
    setFilters((prev) => ({
      ...prev,
      [key]: value,
      page: key !== 'page' ? 1 : prev.page, // Reset to page 1 when filter changes
    }));
  };

  const handleClearFilters = () => {
    setFilters({
      search: '',
      client_id: '',
      project_id: '',
      supplier_id: '',
      workflow: '',
      payment_status: '',
      delivery_method: '',
      delivery_date_from: '',
      delivery_date_to: '',
      repeat_order: '',
      has_missing_supplier: '',
      supplier_confirms: '',
      min_total: '',
      max_total: '',
      sort: 'created_at',
      dir: 'desc',
      page: 1,
      per_page: 10,
    });
  };

  const handlePageChange = (page: number) => {
    setFilters((prev) => ({ ...prev, page }));
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  return (
    <DashboardLayout menuItems={menuItems}>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold text-gray-900 bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
              Orders Management
            </h1>
            <p className="text-gray-600 mt-1">
              Comprehensive view of all orders with full cost insights
            </p>
          </div>
          <div className="flex items-center gap-3">
            {/* Read-Only Badge for Accountant */}
            {isReadOnly && (
              <span className="px-4 py-2 bg-yellow-100 text-yellow-800 text-sm font-bold rounded-lg border-2 border-yellow-300 flex items-center gap-2">
                <Eye size={16} />
                Read Only Mode
              </span>
            )}
            <button
              onClick={() => refetch()}
              disabled={isFetching}
              className="flex items-center gap-2 px-5 py-2.5 bg-white border-2 border-gray-300 rounded-lg hover:bg-gray-50 transition-all disabled:opacity-50 font-medium shadow-sm hover:shadow-md"
            >
              <RefreshCw size={18} className={isFetching ? 'animate-spin' : ''} />
              Refresh
            </button>
          </div>
        </div>

        {/* Metrics Cards */}
        <OrderMetricsCards metrics={data?.metrics || null} loading={isLoading} />

        {/* Search Bar and Filter Toggle */}
        <div className="bg-white rounded-xl border border-gray-200 p-4 shadow-sm">
          <div className="flex flex-col sm:flex-row gap-3">
            {/* Search Input */}
            <div className="flex-1 relative">
              <Search
                className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"
                size={20}
              />
              <input
                type="text"
                value={filters.search}
                onChange={(e) => handleFilterChange('search', e.target.value)}
                placeholder="Search by PO number..."
                className="w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium"
              />
            </div>

            {/* Filter Toggle Button */}
            <button
              onClick={() => setIsFilterPanelOpen(true)}
              className="flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all font-bold shadow-md hover:shadow-lg whitespace-nowrap"
            >
              <Filter size={20} />
              Advanced Filters
              {Object.values(filters).filter(
                (v, i) =>
                  v !== '' &&
                  Object.keys(filters)[i] !== 'sort' &&
                  Object.keys(filters)[i] !== 'dir' &&
                  Object.keys(filters)[i] !== 'page' &&
                  Object.keys(filters)[i] !== 'per_page' &&
                  Object.keys(filters)[i] !== 'search'
              ).length > 0 && (
                <span className="px-2 py-0.5 bg-white text-blue-600 rounded-full text-xs font-bold">
                  {
                    Object.values(filters).filter(
                      (v, i) =>
                        v !== '' &&
                        Object.keys(filters)[i] !== 'sort' &&
                        Object.keys(filters)[i] !== 'dir' &&
                        Object.keys(filters)[i] !== 'page' &&
                        Object.keys(filters)[i] !== 'per_page' &&
                        Object.keys(filters)[i] !== 'search'
                    ).length
                  }
                </span>
              )}
            </button>
          </div>

          {/* Active Filter Chips */}
          {availableFilters && (
            <div className="mt-4">
              <ActiveFilterChips
                filters={filters}
                onFilterChange={handleFilterChange}
                availableFilters={availableFilters}
              />
            </div>
          )}
        </div>

        {/* Orders Table */}
        <OrdersTable
          orders={data?.data || []}
          loading={isLoading || isFetching}
          pagination={data?.pagination || null}
          onPageChange={handlePageChange}
        />
      </div>

      {/* Filter Panel (Slide-in) */}
      <OrderFiltersPanel
        isOpen={isFilterPanelOpen}
        onClose={() => setIsFilterPanelOpen(false)}
        filters={filters}
        onFilterChange={handleFilterChange}
        onClearFilters={handleClearFilters}
        availableFilters={availableFilters || data?.filters || null}
      />
    </DashboardLayout>
  );
};

export default AdminOrdersList;
/* FILE: src/pages/admin/Orders/AdminOrderView.tsx */
// FILE PATH: src/pages/admin/Orders/AdminOrderView.tsx

/**
 * Admin Order View - WITH PERMISSION-BASED VISIBILITY
 * Hides cost/margin data from Support role
 * Shows read-only mode for Accountant role
 */

import React, { useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import {
  ArrowLeft,
  FileText,
  Package,
  Calculator,
  MapPin,
  Settings,
  Loader2,
  AlertCircle,
  Eye,
} from 'lucide-react';
import DashboardLayout from '../../../components/layout/DashboardLayout';
import OrderOverviewTab from '../../../components/admin/Orders/OrderOverviewTab';
import OrderItemsTab from '../../../components/admin/Orders/OrderItemsTab';
import OrderCostingTab from '../../../components/admin/Orders/OrderCostingTab';
import OrderMapTab from '../../../components/admin/Orders/OrderMapTab';
import OrderAdminUpdateTab from '../../../components/admin/Orders/OrderAdminUpdateTab';
import { useAdminOrderDetail } from '../../../features/adminOrders/hooks';
import { getMenuItemsByRole } from '../../../utils/menuItems';
import { usePermissions } from '../../../hooks/usePermissions';

type TabType = 'overview' | 'items' | 'costing' | 'map' | 'admin';

const AdminOrderView: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const [activeTab, setActiveTab] = useState<TabType>('overview');

  // Get permissions
  const {
    role,
    canViewCostPrice,
    canViewProfitMargin,
    canEditOrders,
    canUpdateOrderStatus,
    isReadOnly,
  } = usePermissions();

  // Get role-based menu items
  const menuItems = getMenuItemsByRole(role);

  const { data, isLoading, error } = useAdminOrderDetail(parseInt(id || '0'));

  // Loading State
  if (isLoading) {
    return (
      <DashboardLayout menuItems={menuItems}>
        <div className="flex items-center justify-center h-96">
          <div className="text-center">
            <Loader2 className="animate-spin text-blue-600 mx-auto mb-4" size={48} />
            <p className="text-gray-600 font-medium">Loading order details...</p>
          </div>
        </div>
      </DashboardLayout>
    );
  }

  // Error State
  if (error || !data?.data) {
    return (
      <DashboardLayout menuItems={menuItems}>
        <div className="bg-white rounded-xl border-2 border-red-200 p-8 text-center shadow-lg">
          <AlertCircle className="mx-auto text-red-600 mb-4" size={48} />
          <p className="text-red-600 font-bold text-lg mb-4">
            {(error as Error)?.message || 'Order not found'}
          </p>
          <button
            onClick={() => navigate('/admin/orders')}
            className="text-blue-600 hover:text-blue-700 inline-flex items-center gap-2 font-bold transition-colors"
          >
            <ArrowLeft size={18} />
            Back to Orders
          </button>
        </div>
      </DashboardLayout>
    );
  }

  const order = data.data;

  // Get workflow badge color
  const getWorkflowColor = (workflow: string) => {
    const colorMap: Record<string, string> = {
      'Requested': 'bg-blue-100 text-blue-700 border-blue-300',
      'Supplier Missing': 'bg-yellow-100 text-yellow-700 border-yellow-300',
      'Supplier Assigned': 'bg-indigo-100 text-indigo-700 border-indigo-300',
      'Payment Requested': 'bg-purple-100 text-purple-700 border-purple-300',
      'On Hold': 'bg-gray-200 text-gray-700 border-gray-400',
      'Delivered': 'bg-green-100 text-green-700 border-green-300',
    };
    return colorMap[workflow] || 'bg-gray-100 text-gray-700 border-gray-300';
  };

  // Get payment status badge color
  const getPaymentColor = (status: string) => {
    const colorMap: Record<string, string> = {
      'Pending': 'bg-gray-200 text-gray-700 border-gray-400',
      'Requested': 'bg-yellow-100 text-yellow-700 border-yellow-300',
      'Paid': 'bg-green-100 text-green-700 border-green-300',
      'Partially Paid': 'bg-indigo-100 text-indigo-700 border-indigo-300',
      'Partial Refunded': 'bg-purple-100 text-purple-700 border-purple-300',
      'Refunded': 'bg-red-100 text-red-700 border-red-300',
    };
    return colorMap[status] || 'bg-gray-100 text-gray-700 border-gray-300';
  };

  // ============================================
  // BUILD TABS BASED ON PERMISSIONS
  // ============================================
  const tabs: Array<{
    id: TabType;
    label: string;
    icon: React.ElementType;
    badge?: number;
    activeClass: string;
    inactiveClass: string;
  }> = [
    {
      id: 'overview' as TabType,
      label: 'Overview',
      icon: FileText,
      activeClass: 'bg-blue-600 text-white border-blue-700 shadow-md',
      inactiveClass: 'text-blue-700 hover:bg-blue-50 border-blue-200',
    },
    {
      id: 'items' as TabType,
      label: 'Items',
      icon: Package,
      badge: order.items.length,
      activeClass: 'bg-purple-600 text-white border-purple-700 shadow-md',
      inactiveClass: 'text-purple-700 hover:bg-purple-50 border-purple-200',
    },
  ];

  // Only show Costing tab if user can view cost price OR profit margin
  if (canViewCostPrice || canViewProfitMargin) {
    tabs.push({
      id: 'costing' as TabType,
      label: 'Costing',
      icon: Calculator,
      activeClass: 'bg-green-600 text-white border-green-700 shadow-md',
      inactiveClass: 'text-green-700 hover:bg-green-50 border-green-200',
    });
  }

  // Map tab is always visible
  tabs.push({
    id: 'map' as TabType,
    label: 'Map',
    icon: MapPin,
    activeClass: 'bg-orange-600 text-white border-orange-700 shadow-md',
    inactiveClass: 'text-orange-700 hover:bg-orange-50 border-orange-200',
  });

  // Only show Admin Controls if user can edit orders or update status
  if (canEditOrders || canUpdateOrderStatus) {
    tabs.push({
      id: 'admin' as TabType,
      label: 'Admin Controls',
      icon: Settings,
      activeClass: 'bg-indigo-600 text-white border-indigo-700 shadow-md',
      inactiveClass: 'text-indigo-700 hover:bg-indigo-50 border-indigo-200',
    });
  }

  return (
    <DashboardLayout menuItems={menuItems}>
      <div className="space-y-6">
        {/* Back Button + Read-Only Badge */}
        <div className="flex items-center justify-between">
          <button
            onClick={() => navigate('/admin/orders')}
            className="flex items-center gap-2 text-gray-600 hover:text-blue-600 transition-colors font-medium group"
          >
            <ArrowLeft size={20} className="group-hover:-translate-x-1 transition-transform" />
            Back to Orders
          </button>
          
          <div className="flex items-center gap-3">
            {/* Read-Only Badge for Accountant */}
            {isReadOnly && (
              <span className="px-4 py-2 bg-yellow-100 text-yellow-800 text-sm font-bold rounded-lg border-2 border-yellow-300 flex items-center gap-2">
                <Eye size={16} />
                Read Only Mode
              </span>
            )}
            
            {/* Status Badges */}
            <span className={`px-4 py-2 text-sm font-bold rounded-lg border-2 ${getWorkflowColor(order.workflow)} transition-colors`}>
              {order.workflow}
            </span>
            <span className={`px-4 py-2 text-sm font-bold rounded-lg border-2 ${getPaymentColor(order.payment_status)} transition-colors`}>
              {order.payment_status}
            </span>
          </div>
        </div>

        {/* Order Header Card */}
        <div className="bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 rounded-xl p-8 text-white shadow-xl">
          <div className="flex items-center justify-between">
            <div>
              <div className="flex items-center gap-3 mb-3">
                <div className="p-2 bg-white/10 rounded-lg backdrop-blur-sm">
                  <Package size={32} />
                </div>
                <h1 className="text-4xl font-bold">Order #{order.po_number}</h1>
              </div>
              <div className="flex items-center gap-4 text-blue-100">
                <div className="flex items-center gap-2">
                  <div className="w-2 h-2 bg-white rounded-full"></div>
                  <span className="font-medium">{order.client}</span>
                </div>
                <span>•</span>
                <div className="flex items-center gap-2">
                  <div className="w-2 h-2 bg-white rounded-full"></div>
                  <span className="font-medium">{order.project}</span>
                </div>
              </div>
            </div>
            
            {/* Quick Stats */}
            <div className="flex gap-4">
              <div className="bg-white/10 backdrop-blur-sm rounded-lg p-4 border border-white/20">
                <p className="text-xs text-blue-100 mb-1">Total Items</p>
                <p className="text-2xl font-bold">{order.items.length}</p>
              </div>
              <div className="bg-white/10 backdrop-blur-sm rounded-lg p-4 border border-white/20">
                <p className="text-xs text-blue-100 mb-1">Total Value</p>
                <p className="text-2xl font-bold">
                  ${(order.total_price || order.customer_cost || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* Tab Navigation */}
        <div className="bg-white rounded-xl border-2 border-gray-200 p-2 shadow-sm">
          <div className="flex gap-2 overflow-x-auto">
            {tabs.map((tab) => {
              const Icon = tab.icon;
              const isActive = activeTab === tab.id;

              return (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id)}
                  className={`
                    flex items-center gap-2 px-6 py-3 rounded-lg font-bold transition-all border-2 whitespace-nowrap
                    ${isActive ? tab.activeClass : tab.inactiveClass}
                  `}
                >
                  <Icon size={20} />
                  <span>{tab.label}</span>
                  {tab.badge !== undefined && (
                    <span
                      className={`
                        px-2 py-0.5 rounded-full text-xs font-bold
                        ${isActive ? 'bg-white/20' : 'bg-gray-200 text-gray-700'}
                      `}
                    >
                      {tab.badge}
                    </span>
                  )}
                </button>
              );
            })}
          </div>
        </div>

        {/* Tab Content */}
        <div className="bg-white rounded-xl border-2 border-gray-200 p-6 shadow-sm min-h-[400px]">
          {activeTab === 'overview' && <OrderOverviewTab order={order} />}
          {activeTab === 'items' && (
            <OrderItemsTab 
              items={order.items} 
              workflow={order.workflow} 
              orderId={order.id}
            />
          )}
          {activeTab === 'costing' && (canViewCostPrice || canViewProfitMargin) && (
            <OrderCostingTab order={order} />
          )}
          {activeTab === 'map' && (
            <OrderMapTab
              deliveryLat={order.delivery_lat}
              deliveryLong={order.delivery_long}
              items={order.items}
            />
          )}
          {activeTab === 'admin' && (canEditOrders || canUpdateOrderStatus) && (
            <OrderAdminUpdateTab order={order} />
          )}
        </div>
      </div>
    </DashboardLayout>
  );
};

export default AdminOrderView;
/* FILE: src/pages/admin/UserCreate.tsx */
// src/pages/admin/UserCreate.tsx
import { useState, useCallback } from 'react';
import { useNavigate } from 'react-router-dom';
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { 
  ArrowLeft,
  Save,
  User as UserIcon,
  Mail,
  Phone,
  Building2,
  MapPin,
  Truck,
  CreditCard,
  Lock
} from 'lucide-react';
import toast from 'react-hot-toast';
import Autocomplete from 'react-google-autocomplete';

import DashboardLayout from '../../components/layout/DashboardLayout';
import Button from '../../components/common/Buttons';
import Input from '../../components/common/Input';
import ImageUpload from '../../components/common/ImageUpload';
import { usersAPI } from '../../api/handlers/users.api';
import { adminMenuItems } from '../../utils/menuItems';

// Validation Schema
const userCreateSchema = z.object({
  name: z.string().min(1, 'Name is required'),
  email: z.string().email('Invalid email address'),
  password: z.string().min(6, 'Password must be at least 6 characters'),
  role: z.enum(['admin', 'client', 'supplier', 'accountant','support']),
  contact_name: z.string().optional(),
  contact_number: z.string().optional(),
  company_name: z.string().optional(),
  location: z.string().optional(),
  delivery_radius: z.number().optional(),
  shipping_address: z.string().optional(),
  billing_address: z.string().optional(),
  lat: z.number().optional(),
  long: z.number().optional(),
  notes: z.string().optional(),
});

type UserCreateFormData = z.infer<typeof userCreateSchema>;

const UserCreate = () => {
  const navigate = useNavigate();
  const queryClient = useQueryClient();

  const [profileImage, setProfileImage] = useState<File | null>(null);
  const [locationCoords, setLocationCoords] = useState<{ lat: number; lng: number } | null>(null);


  const {
    register,
    handleSubmit,
    formState: { errors },
    setValue,
    watch,
  } = useForm<UserCreateFormData>({
    resolver: zodResolver(userCreateSchema),
    defaultValues: {
      role: 'client',
    },
  });

  const watchedRole = watch('role');

 

  // Create User Mutation
  const createUserMutation = useMutation({
    mutationFn: (formData: FormData) => usersAPI.createUser(formData),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['users'] });
      toast.success('✅ User created successfully!');
      navigate('/admin/users');
    },
    onError: (error: any) => {
      toast.error(error?.message || 'Failed to create user');
    },
  });

  const handleShippingAddressSelect = useCallback((place: any) => {
    if (place.formatted_address) {
      setValue('shipping_address', place.formatted_address);
    }
    if (place.geometry?.location) {
      const lat = place.geometry.location.lat();
      const lng = place.geometry.location.lng();
      setLocationCoords({ lat, lng });
      setValue('lat', lat);
      setValue('long', lng);
      toast.success(`📍 Location set: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
    }
  }, [setValue]);

  const handleSupplierLocationSelect = useCallback((place: any) => {
    if (place.formatted_address) {
      setValue('location', place.formatted_address);
    }
  }, [setValue]);

  const onSubmit = (data: UserCreateFormData) => {
    const formData = new FormData();

    // Append all fields
    Object.entries(data).forEach(([key, value]) => {
      if (value !== undefined && value !== '') {
        if (typeof value === 'number') {
          formData.append(key, String(value));
        } else {
          formData.append(key, value);
        }
      }
    });

    // Append profile image
    if (profileImage) {
      formData.append('profile_image', profileImage);
    }

    // Append coordinates for clients
    if (data.role === 'client' && locationCoords) {
      formData.append('lat', String(locationCoords.lat));
      formData.append('long', String(locationCoords.lng));
    }

    createUserMutation.mutate(formData);
  };

  return (
    <DashboardLayout menuItems={adminMenuItems}>
      <div className="max-w-4xl mx-auto space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <button
            onClick={() => navigate('/admin/users')}
            className="flex items-center gap-2 text-secondary-600 hover:text-primary-600 transition-colors"
          >
            <ArrowLeft size={20} />
            Back to Users
          </button>
        </div>

        {/* Form Card */}
        <div className="bg-white rounded-2xl shadow-card p-8">
          <h1 className="text-3xl font-bold text-secondary-900 mb-2">Create New User</h1>
          <p className="text-secondary-600 mb-8">Add a new user to the system</p>

          <form onSubmit={handleSubmit(onSubmit)} className="space-y-8">
            {/* Profile Image */}
            <ImageUpload
              label="Profile Image (Optional)"
              onChange={setProfileImage}
            />

            {/* Basic Information */}
            <div className="space-y-5">
              <h3 className="text-lg font-semibold text-secondary-900 border-b pb-3">
                Basic Information
              </h3>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                <Input
                  label="Full Name"
                  type="text"
                  placeholder="John Doe"
                  icon={UserIcon}
                  register={register('name')}
                  error={errors.name?.message}
                  required
                />

                <Input
                  label="Email Address"
                  type="email"
                  placeholder="john@example.com"
                  icon={Mail}
                  register={register('email')}
                  error={errors.email?.message}
                  required
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div>
                  <label className="block text-sm font-medium text-secondary-700 mb-2">
                    Role <span className="text-error-500">*</span>
                  </label>
                  <select
                    {...register('role')}
                    className="w-full px-4 py-3 rounded-lg border-2 border-secondary-200 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-20"
                  >
                    <option value="admin">Admin</option>
                    <option value="client">Client</option>
                    <option value="supplier">Supplier</option>
                    <option value="accountant">Accountant</option>
                    <option value="support">Support</option>
                  </select>
                  {errors.role && (
                    <p className="text-sm text-error-500 mt-1">{errors.role.message}</p>
                  )}
                </div>

                <Input
                  label="Password"
                  type="password"
                  placeholder="Minimum 6 characters"
                  icon={Lock}
                  register={register('password')}
                  error={errors.password?.message}
                  required
                />
              </div>
            </div>

            {/* Contact Details */}
            {(watchedRole === 'client' || watchedRole === 'supplier')  && (
            <div className="space-y-5">
              <h3 className="text-lg font-semibold text-secondary-900 border-b pb-3">
                Contact Information
              </h3>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                <Input
                  label="Contact Person"
                  type="text"
                  placeholder="Jane Smith"
                  icon={UserIcon}
                  register={register('contact_name')}
                  error={errors.contact_name?.message}
                />

                <Input
                  label="Contact Number"
                  type="tel"
                  placeholder="+92 300 1234567"
                  icon={Phone}
                  register={register('contact_number')}
                  error={errors.contact_number?.message}
                />
              </div>

              <Input
                label="Company Name"
                type="text"
                placeholder="ABC Construction Ltd"
                icon={Building2}
                register={register('company_name')}
                error={errors.company_name?.message}
              />
            </div>
            )}
            {/* Client-Specific Fields */}
            {watchedRole === 'client' && (
              <div className="space-y-5 border-t pt-6">
                <h3 className="text-lg font-semibold text-secondary-900 border-b pb-3 flex items-center gap-2">
                  <MapPin size={20} className="text-primary-600" />
                  Address Information (Client)
                </h3>

                <div className="space-y-2">
                  <label className="block text-sm font-medium text-secondary-700">
                    Shipping Address
                  </label>
                  <div className="relative">
                    <MapPin className="absolute left-3 top-3.5 text-secondary-400 z-10" size={20} />
                    <Autocomplete
                      apiKey={import.meta.env.VITE_GOOGLE_MAPS_API_KEY}
                      onPlaceSelected={handleShippingAddressSelect}
                      options={{ types: ['address'], componentRestrictions: { country: 'au' } }}
                      className="w-full pl-10 pr-4 py-3 rounded-lg border-2 border-secondary-200 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-20"
                      placeholder="Start typing address..."
                    />
                  </div>
                  {errors.shipping_address && (
                    <p className="text-sm text-error-500">{errors.shipping_address.message}</p>
                  )}
                  {locationCoords && (
                    <div className="bg-success-50 border border-success-200 rounded-lg p-3">
                      <p className="text-xs text-success-700 font-medium flex items-center gap-2">
                        <MapPin size={14} />
                        Location: {locationCoords.lat.toFixed(6)}, {locationCoords.lng.toFixed(6)}
                      </p>
                    </div>
                  )}
                </div>

                <Input
                  label="Billing Address"
                  type="text"
                  placeholder="Same as shipping or different"
                  icon={CreditCard}
                  register={register('billing_address')}
                  error={errors.billing_address?.message}
                />
              </div>
            )}

            {/* Supplier-Specific Fields */}
            {watchedRole === 'supplier' && (
              <div className="space-y-5 border-t pt-6">
                <h3 className="text-lg font-semibold text-secondary-900 border-b pb-3 flex items-center gap-2">
                  <Truck size={20} className="text-success-600" />
                  Business Information (Supplier)
                </h3>

                <div className="space-y-2">
                  <label className="block text-sm font-medium text-secondary-700">
                    Business Location
                  </label>
                  <div className="relative">
                    <MapPin className="absolute left-3 top-3.5 text-secondary-400 z-10" size={20} />
                    <Autocomplete
                      apiKey={import.meta.env.VITE_GOOGLE_MAPS_API_KEY}
                      onPlaceSelected={handleSupplierLocationSelect}
                      options={{ types: ['address'], componentRestrictions: { country: 'au' } }}
                      className="w-full pl-10 pr-4 py-3 rounded-lg border-2 border-secondary-200 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-20"
                      placeholder="Start typing business address..."
                    />
                  </div>
                  {errors.location && (
                    <p className="text-sm text-error-500">{errors.location.message}</p>
                  )}
                </div>

                <Input
                  label="Delivery Radius (km)"
                  type="number"
                  placeholder="50"
                  icon={Truck}
                  register={register('delivery_radius', { valueAsNumber: true })}
                  error={errors.delivery_radius?.message}
                />
              </div>
            )}

            {/* Notes */}
            <div className="space-y-2">
              <label className="block text-sm font-medium text-secondary-700">
                Notes (Optional)
              </label>
              <textarea
                {...register('notes')}
                rows={4}
                placeholder="Add any additional notes about this user..."
                className="w-full px-4 py-3 rounded-lg border-2 border-secondary-200 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-20"
              />
              {errors.notes && (
                <p className="text-sm text-error-500">{errors.notes.message}</p>
              )}
            </div>

            {/* Action Buttons */}
            <div className="flex gap-4 pt-6 border-t border-secondary-200">
              <Button
                type="submit"
                isLoading={createUserMutation.isPending}
                disabled={createUserMutation.isPending}
                fullWidth={false}
                className="flex-1"
              >
                <Save size={20} />
                {createUserMutation.isPending ? 'Creating User...' : 'Create User'}
              </Button>

              <Button
                type="button"
                variant="outline"
                onClick={() => navigate('/admin/users')}
                fullWidth={false}
                className="flex-1"
              >
                Cancel
              </Button>
            </div>
          </form>
        </div>
      </div>
    </DashboardLayout>
  );
};

export default UserCreate;
/* FILE: src/pages/admin/UserDetail.tsx */
// src/pages/admin/UserDetail.tsx
import { useParams, useNavigate } from 'react-router-dom';
import { useQuery } from '@tanstack/react-query';
import { 
  ArrowLeft,
  Edit2,
  Mail,
  Phone,
  Building2,
  MapPin,
  User as UserIcon,
  Calendar,
  Shield,
  Truck,
  Home,
  CreditCard
} from 'lucide-react';
import DashboardLayout from '../../components/layout/DashboardLayout';
import Button from '../../components/common/Buttons';
import { usersAPI } from '../../api/handlers/users.api';
import { adminMenuItems } from '../../utils/menuItems';

// Role Badge Component
const RoleBadge = ({ role }: { role: 'admin' | 'client' | 'supplier' | 'accountant' | 'support' }) => {
  const styles = {
    admin: 'bg-error-100 text-error-700 border-error-200',
    client: 'bg-primary-100 text-primary-700 border-primary-200',
    supplier: 'bg-success-100 text-success-700 border-success-200',
    support: 'bg-warning-100 text-warning-700 border-warning-200',
    accountant: 'bg-purple-100 text-purple-700 border-purple-200',
  };

  const icons = {
    admin: '👑',
    client: '👤',
    supplier: '🏢',
    support: '🎧',
    accountant: '💼',
  };

  return (
    <span className={`inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium border ${styles[role]}`}>
      <span className="text-lg">{icons[role]}</span>
      {role.charAt(0).toUpperCase() + role.slice(1)}
    </span>
  );
};

// Info Row Component
const InfoRow = ({ icon: Icon, label, value }: any) => (
  <div className="flex items-start gap-4 py-4 border-b border-secondary-100 last:border-0">
    <div className="w-10 h-10 rounded-lg bg-primary-50 flex items-center justify-center flex-shrink-0">
      <Icon size={20} className="text-primary-600" />
    </div>
    <div className="flex-1">
      <p className="text-sm text-secondary-500 mb-1">{label}</p>
      <p className="text-base font-medium text-secondary-900">{value || 'N/A'}</p>
    </div>
  </div>
);

const UserDetail = () => {
  const { id } = useParams();
  const navigate = useNavigate();



  // Fetch User Details
  const { data: user, isLoading, error } = useQuery({
    queryKey: ['user', id],
    queryFn: () => usersAPI.getUser(Number(id)),
    enabled: !!id,
  });

  if (isLoading) {
    return (
      <DashboardLayout menuItems={adminMenuItems}>
        <div className="flex items-center justify-center py-12">
          <div className="w-10 h-10 border-4 border-primary-200 border-t-primary-600 rounded-full animate-spin" />
        </div>
      </DashboardLayout>
    );
  }

  if (error || !user) {
    return (
      <DashboardLayout menuItems={adminMenuItems}>
        <div className="text-center py-12">
          <p className="text-error-500 mb-4">Failed to load user details</p>
          <Button onClick={() => navigate('/admin/users')} variant="outline" fullWidth={false}>
            <ArrowLeft size={20} />
            Back to Users
          </Button>
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout menuItems={adminMenuItems}>
      <div className="max-w-5xl mx-auto space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <button
            onClick={() => navigate('/admin/users')}
            className="flex items-center gap-2 text-secondary-600 hover:text-primary-600 transition-colors"
          >
            <ArrowLeft size={20} />
            Back to Users
          </button>
          <Button
            onClick={() => navigate(`/admin/users/${id}/edit`)}
            variant="primary"
            fullWidth={false}
          >
            <Edit2 size={20} />
            Edit User
          </Button>
        </div>

        {/* Profile Card */}
        <div className="bg-white rounded-2xl shadow-card overflow-hidden">
          {/* Header Section with Profile Image */}
          <div className="bg-gradient-to-r from-primary-500 to-primary-600 px-8 py-12">
            <div className="flex items-center gap-6">
              <div className="w-24 h-24 rounded-full bg-white flex items-center justify-center shadow-lg">
                {user.profile_image ? (
                  <img
                    src={`${import.meta.env.VITE_IMAGE_BASE_URL}${user.profile_image}`}
                    alt={user.name}
                    className="w-full h-full rounded-full object-cover"
                  />
                ) : (
                  <span className="text-4xl font-bold text-primary-600">
                    {user.name.charAt(0).toUpperCase()}
                  </span>
                )}
              </div>
              <div className="flex-1">
                <h1 className="text-3xl font-bold text-white mb-2">{user.name}</h1>
                <div className="flex items-center gap-4">
                  <RoleBadge role={user.role} />
                  {user.client_public_id && (
                    <span className="px-3 py-1 bg-white/20 text-white rounded-lg text-sm font-medium">
                      ID: {user.client_public_id}
                    </span>
                  )}
                </div>
              </div>
            </div>
          </div>

          {/* Contact Information */}
          <div className="p-8">
            <h2 className="text-xl font-bold text-secondary-900 mb-6 flex items-center gap-2">
              <UserIcon size={24} className="text-primary-600" />
              Contact Information
            </h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="space-y-4">
                <InfoRow icon={Mail} label="Email Address" value={user.email} />
                <InfoRow icon={Phone} label="Contact Number" value={user.contact_number} />
                <InfoRow icon={UserIcon} label="Contact Person" value={user.contact_name} />
              </div>
              <div className="space-y-4">
                <InfoRow icon={Building2} label="Company" value={user.company?.name} />
                <InfoRow icon={Calendar} label="Joined Date" value={new Date(user.created_at).toLocaleDateString()} />
                <InfoRow 
                  icon={Shield} 
                  label="Status" 
                  value={
                    <span className={`px-3 py-1 rounded-full text-xs font-medium ${
                      user.isDeleted 
                        ? 'bg-error-100 text-error-700' 
                        : 'bg-success-100 text-success-700'
                    }`}>
                      {user.isDeleted ? 'Deleted' : 'Active'}
                    </span>
                  } 
                />
              </div>
            </div>
          </div>

          {/* Client-Specific Information */}
          {user.role === 'client' && (
            <div className="border-t border-secondary-200 p-8">
              <h2 className="text-xl font-bold text-secondary-900 mb-6 flex items-center gap-2">
                <MapPin size={24} className="text-primary-600" />
                Address Information
              </h2>
              <div className="space-y-4">
                <InfoRow icon={Home} label="Shipping Address" value={user.shipping_address} />
                <InfoRow icon={CreditCard} label="Billing Address" value={user.billing_address} />
                {user.lat && user.long && (
                  <InfoRow 
                    icon={MapPin} 
                    label="Coordinates" 
                    value={`${user.lat.toFixed(6)}, ${user.long.toFixed(6)}`} 
                  />
                )}
              </div>
            </div>
          )}

          {/* Supplier-Specific Information */}
          {user.role === 'supplier' && (
            <div className="border-t border-secondary-200 p-8">
              <h2 className="text-xl font-bold text-secondary-900 mb-6 flex items-center gap-2">
                <Truck size={24} className="text-primary-600" />
                Business Information
              </h2>
              <div className="space-y-4">
                <InfoRow icon={MapPin} label="Business Location" value={user.location} />
                <InfoRow 
                  icon={Truck} 
                  label="Delivery Radius" 
                  value={user.delivery_radius ? `${user.delivery_radius} km` : 'N/A'} 
                />
              </div>
            </div>
          )}

          {/* Notes Section (if exists) */}
          {user.notes && (
            <div className="border-t border-secondary-200 p-8 bg-secondary-50">
              <h2 className="text-xl font-bold text-secondary-900 mb-4">Notes</h2>
              <p className="text-secondary-700 whitespace-pre-wrap">{user.notes}</p>
            </div>
          )}
        </div>
      </div>
    </DashboardLayout>
  );
};

export default UserDetail;
/* FILE: src/pages/admin/UserEdit.tsx */
// src/pages/admin/UserEdit.tsx - WORKING VERSION
import { useState, useEffect, useCallback } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { 
  ArrowLeft,
  Save,
  User as UserIcon,
  Loader2
} from 'lucide-react';
import toast from 'react-hot-toast';
import Autocomplete from 'react-google-autocomplete';

// ✅ IMPORT YOUR ACTUAL API HANDLERS
import { usersAPI } from '../../api/handlers/users.api';
import DashboardLayout from '../../components/layout/DashboardLayout';
import { adminMenuItems } from '../../utils/menuItems';

// Validation Schema
const userEditSchema = z.object({
  name: z.string().min(1, 'Name is required'),
  email: z.string().email('Invalid email address'),
  password: z.string().min(6, 'Password must be at least 6 characters').optional().or(z.literal('')),
  role: z.enum(['admin', 'client', 'supplier','support','accountant']),
  contact_name: z.string().optional(),
  contact_number: z.string().optional(),
  company_name: z.string().optional(),
  location: z.string().optional(),
  delivery_radius: z.number().optional(),
  shipping_address: z.string().optional(),
  billing_address: z.string().optional(),
  lat: z.number().optional(),
  long: z.number().optional(),
  notes: z.string().optional(),
});

type UserEditFormData = z.infer<typeof userEditSchema>;

const UserEdit = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const queryClient = useQueryClient();

  const [profileImage, setProfileImage] = useState<File | null>(null);
  const [currentImageUrl, setCurrentImageUrl] = useState<string | null>(null);
  const [locationCoords, setLocationCoords] = useState<{ lat: number; lng: number } | null>(null);


  const {
    register,
    handleSubmit,
    formState: { errors },
    setValue,
    watch,
    reset,
  } = useForm<UserEditFormData>({
    resolver: zodResolver(userEditSchema),
  });

  const watchedRole = watch('role');

  // ✅ FIXED: Fetch User Data using your actual API
  const { data: user, isLoading, isError, error } = useQuery({
    queryKey: ['user', id],
    queryFn: () => usersAPI.getUser(Number(id)),
    enabled: !!id,
    retry: 1, // Only retry once
  });

  // ✅ Debug: Log the response
  useEffect(() => {
    if (user) {
      console.log('✅ User data loaded:', user);
    }
    if (error) {
      console.error('❌ Error loading user:', error);
    }
  }, [user, error]);

  // ✅ FIXED: Use useEffect to populate form when user data loads
  useEffect(() => {
    if (user) {
      console.log('📥 Populating form with user data');
      
      // Reset form with user data
      reset({
        name: user.name || '',
        email: user.email || '',
        role: user.role || 'client',
        contact_name: user.contact_name || '',
        contact_number: user.contact_number || '',
        company_name: user.company?.name || '', // ✅ Get from nested company object
        location: user.location || '',
        delivery_radius: user.delivery_radius || undefined,
        shipping_address: user.shipping_address || '',
        billing_address: user.billing_address || '',
        notes: user.notes || '',
      });

      // Set location coordinates
      if (user.lat && user.long) {
        setLocationCoords({ lat: user.lat, lng: user.long });
      }

      // Set profile image URL
      if (user.profile_image) {
        const imageUrl = `${import.meta.env.VITE_IMAGE_BASE_URL}${user.profile_image}`;
        setCurrentImageUrl(imageUrl);
        console.log('🖼️ Profile image URL:', imageUrl);
      }
    }
  }, [user, reset]);

 

  // Update User Mutation
  const updateUserMutation = useMutation({
    mutationFn: (formData: FormData) => usersAPI.updateUser(Number(id), formData),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['user', id] });
      queryClient.invalidateQueries({ queryKey: ['users'] });
      toast.success('✅ User updated successfully!');
      navigate(`/admin/users/${id}`);
    },
    onError: (error: any) => {
      console.error('❌ Update error:', error);
      toast.error(error?.message || 'Failed to update user');
    },
  });

  const handleShippingAddressSelect = useCallback((place: any) => {
    if (place.formatted_address) {
      setValue('shipping_address', place.formatted_address);
    }
    if (place.geometry?.location) {
      const lat = place.geometry.location.lat();
      const lng = place.geometry.location.lng();
      setLocationCoords({ lat, lng });
      setValue('lat', lat);
      setValue('long', lng);
      toast.success(`📍 Location updated: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
    }
  }, [setValue]);

  const handleSupplierLocationSelect = useCallback((place: any) => {
    if (place.formatted_address) {
      setValue('location', place.formatted_address);
    }
  }, [setValue]);

  const handleImageChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      if (!file.type.startsWith('image/')) {
        toast.error('Please select an image file');
        return;
      }
      if (file.size > 2 * 1024 * 1024) {
        toast.error('Image size should be less than 2MB');
        return;
      }
      setProfileImage(file);
      const reader = new FileReader();
      reader.onloadend = () => setCurrentImageUrl(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const onSubmit = (data: UserEditFormData) => {
    console.log('📤 Submitting form data:', data);
    
    const formData = new FormData();

    // Append all fields
    Object.entries(data).forEach(([key, value]) => {
      if (value !== undefined && value !== '' && value !== null) {
        if (typeof value === 'number') {
          formData.append(key, String(value));
        } else {
          formData.append(key, value);
        }
      }
    });

    // Append profile image if changed
    if (profileImage) {
      formData.append('profile_image', profileImage);
      console.log('🖼️ Including new profile image');
    }

    // Append coordinates for clients
    if (data.role === 'client' && locationCoords) {
      formData.append('lat', String(locationCoords.lat));
      formData.append('long', String(locationCoords.lng));
      console.log('📍 Including coordinates:', locationCoords);
    }

    updateUserMutation.mutate(formData);
  };

  // Loading State
  if (isLoading) {
    return (
      <DashboardLayout menuItems={adminMenuItems}>
        <div className="flex items-center justify-center py-12">
          <div className="text-center">
            <Loader2 className="w-12 h-12 animate-spin text-primary-600 mx-auto mb-4" />
            <p className="text-secondary-600">Loading user data...</p>
          </div>
        </div>
      </DashboardLayout>
    );
  }

  // Error State
  if (isError || !user) {
    return (
      <DashboardLayout menuItems={adminMenuItems}>
        <div className="text-center py-12">
          <p className="text-error-500 mb-4 text-xl">❌ Failed to load user data</p>
          <p className="text-secondary-600 mb-4">
            {error instanceof Error ? error.message : 'Unknown error occurred'}
          </p>
          <button
            onClick={() => navigate('/admin/users')}
            className="px-6 py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors inline-flex items-center gap-2"
          >
            <ArrowLeft size={20} />
            Back to Users
          </button>
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout menuItems={adminMenuItems}>
      <div className="max-w-4xl mx-auto space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <button
            onClick={() => navigate(`/admin/users/${id}`)}
            className="flex items-center gap-2 text-secondary-600 hover:text-primary-600 transition-colors"
          >
            <ArrowLeft size={20} />
            Back to User Details
          </button>
        </div>

        {/* Form Card */}
        <div className="bg-white rounded-2xl shadow-card p-8">
          <div className="mb-8">
            <h1 className="text-3xl font-bold text-secondary-900">Edit User</h1>
            <p className="text-secondary-600 mt-2">Update user information and settings</p>
          </div>

          <form onSubmit={handleSubmit(onSubmit)} className="space-y-8">
            {/* Profile Image */}
            <div className="space-y-2">
              <label className="block text-sm font-medium text-secondary-700">
                Profile Photo
              </label>
              <div className="flex items-center gap-6">
                <div className="relative">
                  {currentImageUrl ? (
                    <img
                      src={currentImageUrl}
                      alt="Profile"
                      className="w-24 h-24 rounded-full object-cover border-4 border-secondary-200"
                    />
                  ) : (
                    <div className="w-24 h-24 rounded-full bg-secondary-200 flex items-center justify-center">
                      <UserIcon size={40} className="text-secondary-400" />
                    </div>
                  )}
                </div>
                <div>
                  <label className="cursor-pointer inline-block px-4 py-2 bg-primary-50 text-primary-600 rounded-lg hover:bg-primary-100 transition-colors">
                    <input
                      type="file"
                      accept="image/*"
                      onChange={handleImageChange}
                      className="hidden"
                    />
                    Change Photo
                  </label>
                  <p className="text-xs text-secondary-500 mt-2">PNG, JPG, GIF up to 2MB</p>
                </div>
              </div>
            </div>

            {/* Basic Information */}
            <div className="space-y-5">
              <h3 className="text-lg font-semibold text-secondary-900 border-b pb-3">
                Basic Information
              </h3>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div>
                  <label className="block text-sm font-medium text-secondary-700 mb-2">
                    Full Name <span className="text-error-500">*</span>
                  </label>
                  <input
                    type="text"
                    {...register('name')}
                    className="w-full px-4 py-3 rounded-lg border-2 border-secondary-200 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-20"
                  />
                  {errors.name && (
                    <p className="text-sm text-error-500 mt-1">{errors.name.message}</p>
                  )}
                </div>

                <div>
                  <label className="block text-sm font-medium text-secondary-700 mb-2">
                    Email <span className="text-error-500">*</span>
                  </label>
                  <input
                    type="email"
                    {...register('email')}
                    className="w-full px-4 py-3 rounded-lg border-2 border-secondary-200 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-20"
                  />
                  {errors.email && (
                    <p className="text-sm text-error-500 mt-1">{errors.email.message}</p>
                  )}
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div>
                  <label className="block text-sm font-medium text-secondary-700 mb-2">
                    Role <span className="text-error-500">*</span>
                  </label>
                  <select
                    {...register('role')}
                    className="w-full px-4 py-3 rounded-lg border-2 border-secondary-200 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-20"
                  >
                    <option value="admin">Admin</option>
                    <option value="client">Client</option>
                    <option value="supplier">Supplier</option>
                    <option value="accountant">Accountant</option>
                    <option value="support">Support</option>
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-secondary-700 mb-2">
                    Password (leave blank to keep current)
                  </label>
                  <input
                    type="password"
                    {...register('password')}
                    placeholder="Enter new password"
                    className="w-full px-4 py-3 rounded-lg border-2 border-secondary-200 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-20"
                  />
                  {errors.password && (
                    <p className="text-sm text-error-500 mt-1">{errors.password.message}</p>
                  )}
                </div>
              </div>
            </div>

            {/* Contact Information */}
            {(watchedRole === 'client' || watchedRole === 'supplier')  && (
            <div className="space-y-5">
              <h3 className="text-lg font-semibold text-secondary-900 border-b pb-3">
                Contact Information
              </h3>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div>
                  <label className="block text-sm font-medium text-secondary-700 mb-2">
                    Contact Person
                  </label>
                  <input
                    type="text"
                    {...register('contact_name')}
                    className="w-full px-4 py-3 rounded-lg border-2 border-secondary-200 focus:outline-none focus:border-primary-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-secondary-700 mb-2">
                    Contact Number
                  </label>
                  <input
                    type="tel"
                    {...register('contact_number')}
                    className="w-full px-4 py-3 rounded-lg border-2 border-secondary-200 focus:outline-none focus:border-primary-500"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-secondary-700 mb-2">
                  Company Name
                </label>
                <input
                  type="text"
                  {...register('company_name')}
                  className="w-full px-4 py-3 rounded-lg border-2 border-secondary-200 focus:outline-none focus:border-primary-500"
                />
              </div>
            </div>
            )}
            {/* Client-Specific Fields */}
            {watchedRole === 'client' && (
              <div className="space-y-5 border-t pt-6">
                <h3 className="text-lg font-semibold text-secondary-900 pb-3">
                  Address Information (Client)
                </h3>

                <div>
                  <label className="block text-sm font-medium text-secondary-700 mb-2">
                    Shipping Address
                  </label>
                  <Autocomplete
                    apiKey={import.meta.env.VITE_GOOGLE_MAPS_API_KEY}
                    onPlaceSelected={handleShippingAddressSelect}
                    options={{ types: ['address'], componentRestrictions: { country: 'au' } }}
                    defaultValue={user?.shipping_address || ''}
                    className="w-full px-4 py-3 rounded-lg border-2 border-secondary-200 focus:border-primary-500"
                    placeholder="Start typing address..."
                  />
                  {locationCoords && (
                    <p className="text-xs text-success-600 mt-2">
                      📍 Location: {locationCoords.lat.toFixed(6)}, {locationCoords.lng.toFixed(6)}
                    </p>
                  )}
                </div>

                <div>
                  <label className="block text-sm font-medium text-secondary-700 mb-2">
                    Billing Address
                  </label>
                  <input
                    type="text"
                    {...register('billing_address')}
                    className="w-full px-4 py-3 rounded-lg border-2 border-secondary-200 focus:outline-none focus:border-primary-500"
                  />
                </div>
              </div>
            )}

            {/* Supplier-Specific Fields */}
            {watchedRole === 'supplier' && (
              <div className="space-y-5 border-t pt-6">
                <h3 className="text-lg font-semibold text-secondary-900 pb-3">
                  Business Information (Supplier)
                </h3>

                <div>
                  <label className="block text-sm font-medium text-secondary-700 mb-2">
                    Business Location
                  </label>
                  <Autocomplete
                    apiKey={import.meta.env.VITE_GOOGLE_MAPS_API_KEY}
                    onPlaceSelected={handleSupplierLocationSelect}
                    options={{ types: ['address'], componentRestrictions: { country: 'au' } }}
                    defaultValue={user?.location || ''}
                    className="w-full px-4 py-3 rounded-lg border-2 border-secondary-200 focus:border-primary-500"
                    placeholder="Start typing business address..."
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-secondary-700 mb-2">
                    Delivery Radius (km)
                  </label>
                  <input
                    type="number"
                    {...register('delivery_radius', { valueAsNumber: true })}
                    className="w-full px-4 py-3 rounded-lg border-2 border-secondary-200 focus:outline-none focus:border-primary-500"
                  />
                </div>
              </div>
            )}

            {/* Notes */}
            <div>
              <label className="block text-sm font-medium text-secondary-700 mb-2">
                Notes (Optional)
              </label>
              <textarea
                {...register('notes')}
                rows={4}
                className="w-full px-4 py-3 rounded-lg border-2 border-secondary-200 focus:outline-none focus:border-primary-500"
                placeholder="Add any additional notes..."
              />
            </div>

            {/* Action Buttons */}
            <div className="flex gap-4 pt-6 border-t border-secondary-200">
              <button
                type="submit"
                disabled={updateUserMutation.isPending}
                className="flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm hover:shadow-md"
              >
                {updateUserMutation.isPending ? (
                  <>
                    <Loader2 className="w-5 h-5 animate-spin" />
                    Saving...
                  </>
                ) : (
                  <>
                    <Save size={20} />
                    Save Changes
                  </>
                )}
              </button>

              <button
                type="button"
                onClick={() => navigate(`/admin/users/${id}`)}
                className="flex-1 px-6 py-3 border-2 border-secondary-300 text-secondary-700 rounded-lg hover:bg-secondary-50 transition-colors"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </DashboardLayout>
  );
};

export default UserEdit;
/* FILE: src/pages/admin/UserManagement.tsx */
// src/pages/admin/UserManagement.tsx
// ============================================
// USER MANAGEMENT WITH PERMISSION-BASED ACTIONS
// ============================================

import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useQuery, useMutation, useQueryClient, keepPreviousData } from '@tanstack/react-query';
import type { PaginatedUsers, User, UserFilters } from '../../api/handlers/users.api';
import { 
  Search, 
  Eye, 
  Edit2, 
  Trash2, 
  RotateCcw,
  ChevronLeft,
  ChevronRight,
  UserPlus,
  Building2,
  Mail,
  Phone,
  MapPin,
  Lock,
} from 'lucide-react';
import toast from 'react-hot-toast';

import DashboardLayout from '../../components/layout/DashboardLayout';
import Button from '../../components/common/Buttons';
import { usersAPI, companiesAPI } from '../../api/handlers/users.api';
import { getMenuItemsByRole } from '../../utils/menuItems';
import { usePermissions } from '../../hooks/usePermissions';

// Role Badge Component
const RoleBadge = ({ role }: { role: 'admin' | 'client' | 'supplier' | 'support' | 'accountant' }) => {
  const styles: Record<string, string> = {
    admin: 'bg-error-100 text-error-700 border-error-200',
    client: 'bg-primary-100 text-primary-700 border-primary-200',
    supplier: 'bg-success-100 text-success-700 border-success-200',
    support: 'bg-warning-100 text-warning-700 border-warning-200',
    accountant: 'bg-purple-100 text-purple-700 border-purple-200',
  };

  const icons: Record<string, string> = {
    admin: '👑',
    client: '👤',
    supplier: '🏢',
    support: '🎧',
    accountant: '💼',
  };

  return (
    <span className={`inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium border ${styles[role] || styles.client}`}>
      <span>{icons[role] || '👤'}</span>
      {role.charAt(0).toUpperCase() + role.slice(1)}
    </span>
  );
};

const UserManagement = () => {
  const navigate = useNavigate();
  const queryClient = useQueryClient();

  // ==================== PERMISSIONS ====================
  const { 
    role, 
    isReadOnly, 
    canCreateUsers,
    canEditUsers,
    canDeleteUsers,
  } = usePermissions();
  
  const menuItems = getMenuItemsByRole(role);

  // State
  const [activeTab, setActiveTab] = useState<'active' | 'deleted'>('active');
  const [filters, setFilters] = useState<UserFilters>({
    role: '',
    company_id: '',
    page: 1,
    per_page: 10,
  });
  const [searchTerm, setSearchTerm] = useState('');
  const [debouncedSearch, setDebouncedSearch] = useState('');

  // Debounce search input
  useEffect(() => {
    const timer = setTimeout(() => {
      setDebouncedSearch(searchTerm);
      setFilters(prev => ({ ...prev, page: 1 }));
    }, 500);
    return () => clearTimeout(timer);
  }, [searchTerm]);

  // Fetch Companies
  const { data: companies = [] } = useQuery({
    queryKey: ['companies'],
    queryFn: companiesAPI.getAll,
  });

  // Build query params
  const queryParams: UserFilters = {
    ...filters,
    isDeleted: activeTab === 'deleted',
    contact_name: debouncedSearch || undefined,
  };

  // Fetch users
  const { data: usersData, isLoading, error } = useQuery<PaginatedUsers>({
    queryKey: ['users', queryParams],
    queryFn: () => usersAPI.getUsers(queryParams),
    placeholderData: keepPreviousData,
  });

  // Delete/Restore Mutation
  const deleteRestoreMutation = useMutation({
    mutationFn: usersAPI.deleteRestoreUser,
    onSuccess: (data) => {
      queryClient.invalidateQueries({ queryKey: ['users'] });
      toast.success(data.message || 'User status updated successfully');
    },
    onError: (error: Error) => {
      toast.error(error.message || 'Failed to update user status');
    },
  });

  // Handlers
  const handleFilterChange = (key: keyof UserFilters, value: any) => {
    setFilters(prev => ({ ...prev, [key]: value, page: 1 }));
  };

  const handleTabChange = (tab: 'active' | 'deleted') => {
    setActiveTab(tab);
    setFilters(prev => ({ ...prev, page: 1 }));
  };

  const handleDeleteRestore = (userId: number, isDeleted: boolean) => {
    const action = isDeleted ? 'restore' : 'delete';
    if (window.confirm(`Are you sure you want to ${action} this user?`)) {
      deleteRestoreMutation.mutate(userId);
    }
  };

  const clearFilters = () => {
    setFilters({
      role: '',
      company_id: '',
      page: 1,
      per_page: 10,
    });
    setSearchTerm('');
  };

  const users = usersData?.data || [];
  const pagination = {
    currentPage: usersData?.current_page || 1,
    lastPage: usersData?.last_page || 1,
    total: usersData?.total || 0,
    from: usersData?.from || 0,
    to: usersData?.to || 0,
  };

  return (
    <DashboardLayout menuItems={menuItems}>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold text-secondary-900">User Management</h1>
            <p className="text-secondary-600 mt-1">Manage system users and permissions</p>
          </div>
          <div className="flex items-center gap-3">
            {/* Read-Only Badge for Accountant */}
            {isReadOnly && (
              <span className="px-4 py-2 bg-yellow-100 text-yellow-800 text-sm font-bold rounded-lg border-2 border-yellow-300 flex items-center gap-2">
                <Eye size={16} />
                Read Only Mode
              </span>
            )}
            
            {/* Add User Button - Only for Admin */}
            {canCreateUsers && (
              <Button
                onClick={() => navigate('/admin/users/create')}
                variant="primary"
                fullWidth={false}
              >
                <UserPlus size={20} />
                Add User
              </Button>
            )}
          </div>
        </div>

        {/* Permission Notice Banner */}
        {!canEditUsers && !isReadOnly && (
          <div className="px-4 py-3 bg-blue-50 border border-blue-200 rounded-lg flex items-center gap-2">
            <Lock size={16} className="text-blue-600" />
            <span className="text-sm text-blue-800">
              You have view-only access to user management. Contact an admin for changes.
            </span>
          </div>
        )}

        {/* Card Container */}
        <div className="bg-white rounded-2xl shadow-card overflow-hidden">
          {/* Tabs */}
          <div className="border-b border-secondary-200">
            <div className="flex gap-1 p-1">
              <button
                onClick={() => handleTabChange('active')}
                className={`flex-1 px-4 py-3 rounded-lg font-medium transition-all ${
                  activeTab === 'active'
                    ? 'bg-primary-50 text-primary-600 shadow-sm'
                    : 'text-secondary-600 hover:bg-secondary-50'
                }`}
              >
                Active Users
                {activeTab === 'active' && pagination.total > 0 && (
                  <span className="ml-2 px-2 py-0.5 bg-primary-100 text-primary-700 rounded-full text-xs">
                    {pagination.total}
                  </span>
                )}
              </button>
              <button
                onClick={() => handleTabChange('deleted')}
                className={`flex-1 px-4 py-3 rounded-lg font-medium transition-all ${
                  activeTab === 'deleted'
                    ? 'bg-primary-50 text-primary-600 shadow-sm'
                    : 'text-secondary-600 hover:bg-secondary-50'
                }`}
              >
                Deleted Users
                {activeTab === 'deleted' && pagination.total > 0 && (
                  <span className="ml-2 px-2 py-0.5 bg-secondary-100 text-secondary-700 rounded-full text-xs">
                    {pagination.total}
                  </span>
                )}
              </button>
            </div>
          </div>

          {/* Filters */}
          <div className="border-b border-secondary-200 p-6">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              {/* Search */}
              <div className="md:col-span-2">
                <div className="relative">
                  <Search 
                    className="absolute left-3 top-1/2 -translate-y-1/2 text-secondary-400" 
                    size={20} 
                  />
                  <input
                    type="text"
                    placeholder="Search by name, contact..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="w-full pl-10 pr-4 py-3 border-2 border-secondary-200 rounded-lg focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-20"
                  />
                </div>
              </div>

              {/* Role Filter */}
              <select
                value={filters.role}
                onChange={(e) => handleFilterChange('role', e.target.value)}
                className="px-4 py-3 border-2 border-secondary-200 rounded-lg focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-20"
              >
                <option value="">All Roles</option>
                <option value="admin">Admin</option>
                <option value="client">Client</option>
                <option value="supplier">Supplier</option>
                <option value="accountant">Accountant</option>
                <option value="support">Support</option>
              </select>

              {/* Company Filter */}
              <select
                value={filters.company_id}
                onChange={(e) => handleFilterChange('company_id', e.target.value)}
                className="px-4 py-3 border-2 border-secondary-200 rounded-lg focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-20"
              >
                <option value="">All Companies</option>
                {companies.map((company: any) => (
                  <option key={company.id} value={company.id}>
                    {company.name}
                  </option>
                ))}
              </select>
            </div>

            {/* Clear Filters Button */}
            {(filters.role || filters.company_id || searchTerm) && (
              <button
                onClick={clearFilters}
                className="mt-4 text-sm text-primary-600 hover:text-primary-700 font-medium"
              >
                Clear all filters
              </button>
            )}
          </div>

          {/* Table */}
          <div className="overflow-x-auto">
            {isLoading ? (
              <div className="flex items-center justify-center py-12">
                <div className="flex flex-col items-center gap-3">
                  <div className="w-10 h-10 border-4 border-primary-200 border-t-primary-600 rounded-full animate-spin" />
                  <p className="text-secondary-500">Loading users...</p>
                </div>
              </div>
            ) : error ? (
              <div className="flex flex-col items-center justify-center py-12 text-error-500">
                <p className="mb-2">Failed to load users</p>
                <button 
                  onClick={() => queryClient.invalidateQueries({ queryKey: ['users'] })}
                  className="text-sm text-primary-600 hover:underline"
                >
                  Try again
                </button>
              </div>
            ) : users.length === 0 ? (
              <div className="flex flex-col items-center justify-center py-12 text-secondary-500">
                <p className="mb-2">No users found</p>
                {(filters.role || filters.company_id || searchTerm) && (
                  <button 
                    onClick={clearFilters}
                    className="text-sm text-primary-600 hover:underline"
                  >
                    Clear filters
                  </button>
                )}
              </div>
            ) : (
              <table className="w-full">
                <thead className="bg-secondary-50 border-b border-secondary-200">
                  <tr>
                    <th className="px-6 py-4 text-left text-xs font-semibold text-secondary-600 uppercase tracking-wider">
                      User
                    </th>
                    <th className="px-6 py-4 text-left text-xs font-semibold text-secondary-600 uppercase tracking-wider">
                      Role
                    </th>
                    <th className="px-6 py-4 text-left text-xs font-semibold text-secondary-600 uppercase tracking-wider">
                      Company
                    </th>
                    <th className="px-6 py-4 text-left text-xs font-semibold text-secondary-600 uppercase tracking-wider">
                      Contact
                    </th>
                    <th className="px-6 py-4 text-left text-xs font-semibold text-secondary-600 uppercase tracking-wider">
                      Location
                    </th>
                    <th className="px-6 py-4 text-right text-xs font-semibold text-secondary-600 uppercase tracking-wider">
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-secondary-100">
                  {users.map((user: User) => (
                    <tr key={user.id} className="hover:bg-secondary-50 transition-colors">
                      {/* User Info */}
                      <td className="px-6 py-4">
                        <div className="flex items-center gap-3">
                          <div className="w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center flex-shrink-0">
                            {user.profile_image ? (
                              <img
                                src={`${import.meta.env.VITE_IMAGE_BASE_URL}${user.profile_image}`}
                                alt={user.name}
                                className="w-full h-full rounded-full object-cover"
                              />
                            ) : (
                              <span className="text-primary-600 font-semibold text-sm">
                                {user.name.charAt(0).toUpperCase()}
                              </span>
                            )}
                          </div>
                          <div>
                            <p className="font-medium text-secondary-900">{user.name}</p>
                            <p className="text-sm text-secondary-500 flex items-center gap-1">
                              <Mail size={12} />
                              {user.email}
                            </p>
                          </div>
                        </div>
                      </td>

                      {/* Role */}
                      <td className="px-6 py-4">
                        <RoleBadge role={user.role} />
                      </td>

                      {/* Company */}
                      <td className="px-6 py-4">
                        {user.company ? (
                          <div className="flex items-center gap-2 text-sm text-secondary-700">
                            <Building2 size={14} className="text-secondary-400" />
                            {user.company.name}
                          </div>
                        ) : (
                          <span className="text-secondary-400 text-sm">N/A</span>
                        )}
                      </td>

                      {/* Contact */}
                      <td className="px-6 py-4">
                        <div className="text-sm">
                          <p className="text-secondary-900">{user.contact_name || 'N/A'}</p>
                          {user.contact_number && (
                            <p className="text-secondary-500 flex items-center gap-1 mt-1">
                              <Phone size={12} />
                              {user.contact_number}
                            </p>
                          )}
                        </div>
                      </td>

                      {/* Location */}
                      <td className="px-6 py-4">
                        {user.location ? (
                          <div className="flex items-center gap-1 text-sm text-secondary-700">
                            <MapPin size={14} className="text-secondary-400" />
                            <span className="truncate max-w-[150px]">{user.location}</span>
                          </div>
                        ) : (
                          <span className="text-secondary-400 text-sm">N/A</span>
                        )}
                      </td>

                      {/* Actions */}
                      <td className="px-6 py-4">
                        <div className="flex items-center justify-end gap-2">
                          {/* View - Always visible */}
                          <button
                            onClick={() => navigate(`/admin/users/${user.id}`)}
                            className="p-2 text-primary-600 hover:bg-primary-50 rounded-lg transition-colors"
                            title="View Details"
                          >
                            <Eye size={18} />
                          </button>
                          
                          {/* Edit - Only if canEditUsers */}
                          {canEditUsers && (
                            <button
                              onClick={() => navigate(`/admin/users/${user.id}/edit`)}
                              className="p-2 text-secondary-600 hover:bg-secondary-100 rounded-lg transition-colors"
                              title="Edit User"
                            >
                              <Edit2 size={18} />
                            </button>
                          )}
                          
                          {/* Delete/Restore - Only if canDeleteUsers */}
                          {canDeleteUsers && (
                            <button
                              onClick={() => handleDeleteRestore(user.id, user.isDeleted)}
                              disabled={deleteRestoreMutation.isPending}
                              className={`p-2 rounded-lg transition-colors disabled:opacity-50 ${
                                user.isDeleted
                                  ? 'text-success-600 hover:bg-success-50'
                                  : 'text-error-600 hover:bg-error-50'
                              }`}
                              title={user.isDeleted ? 'Restore User' : 'Delete User'}
                            >
                              {user.isDeleted ? <RotateCcw size={18} /> : <Trash2 size={18} />}
                            </button>
                          )}
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}
          </div>

          {/* Pagination */}
          {!isLoading && users.length > 0 && (
            <div className="flex items-center justify-between px-6 py-4 border-t border-secondary-200">
              <div className="flex items-center gap-2">
                <span className="text-sm text-secondary-600">
                  Showing {pagination.from} to {pagination.to} of {pagination.total} users
                </span>
              </div>

              <div className="flex items-center gap-4">
                {/* Per Page Selector */}
                <select
                  value={filters.per_page}
                  onChange={(e) => handleFilterChange('per_page', Number(e.target.value))}
                  className="px-3 py-2 border border-secondary-300 rounded-lg text-sm focus:outline-none focus:border-primary-500"
                >
                  <option value={10}>10 per page</option>
                  <option value={25}>25 per page</option>
                  <option value={50}>50 per page</option>
                  <option value={100}>100 per page</option>
                </select>

                {/* Page Navigation */}
                <div className="flex items-center gap-2">
                  <button
                    onClick={() => handleFilterChange('page', pagination.currentPage - 1)}
                    disabled={pagination.currentPage === 1}
                    className="p-2 border border-secondary-300 rounded-lg hover:bg-secondary-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                  >
                    <ChevronLeft size={18} />
                  </button>
                  
                  <span className="text-sm text-secondary-700 px-3">
                    Page {pagination.currentPage} of {pagination.lastPage}
                  </span>

                  <button
                    onClick={() => handleFilterChange('page', pagination.currentPage + 1)}
                    disabled={pagination.currentPage === pagination.lastPage}
                    className="p-2 border border-secondary-300 rounded-lg hover:bg-secondary-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                  >
                    <ChevronRight size={18} />
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </DashboardLayout>
  );
};

export default UserManagement;
/* FILE: src/pages/client/ClientOrders.tsx */
// src/pages/client/Orders/ClientOrdersList.tsx

import React, { useState, useEffect } from 'react';
import { useSearchParams, useNavigate } from 'react-router-dom';
import { RefreshCw, Search } from 'lucide-react';
import DashboardLayout from '../../components/layout/DashboardLayout';
import ClientOrderMetricsCards from '../../components/client/ClientOrderMetricsCards';
import ClientOrderFilters from '../../components/client/ClientOrderFilters';
import ClientActiveFilterChips from '../../components/client/ClientActiveFilterChips';
import ClientOrdersTable from '../../components/client/ClientOrdersTable';
import { useClientOrders } from '../../features/clientOrders/hooks';
import { clientMenuItems } from '../../utils/menuItems';

const ClientOrdersList: React.FC = () => {
  const navigate = useNavigate();
  const [searchParams, setSearchParams] = useSearchParams();
  const [isFirstLoad, setIsFirstLoad] = useState(true);
  const [projects, setProjects] = useState<any[]>([]);
  const [availableFilters, setAvailableFilters] = useState<any>(null);

  const [filters, setFilters] = useState({
    search: searchParams.get('search') || '',
    project_id: searchParams.get('project_id') || '',
    order_status: searchParams.get('order_status') || '',
    payment_status: searchParams.get('payment_status') || '',
    delivery_date: searchParams.get('delivery_date') || '',
    delivery_method: searchParams.get('delivery_method') || '',
    repeat_order: searchParams.get('repeat_order') || '',
    sort: searchParams.get('sort') || 'created_at',
    dir: searchParams.get('dir') || 'desc',
    page: parseInt(searchParams.get('page') || '1'),
    per_page: 10,
  });

  const { data, isLoading, isFetching, refetch } = useClientOrders({
    ...filters,
    details: isFirstLoad,
  });

  useEffect(() => {
    if (isFirstLoad && data) {
      if (data.projects) setProjects(data.projects);
      if (data.order_statuses || data.payment_statuses || data.delivery_methods) {
        setAvailableFilters({
          order_statuses: data.order_statuses,
          payment_statuses: data.payment_statuses,
          delivery_methods: data.delivery_methods,
        });
      }
      setIsFirstLoad(false);
    }
  }, [data, isFirstLoad]);

  useEffect(() => {
    const params: Record<string, string> = {};
    Object.entries(filters).forEach(([key, value]) => {
      if (value !== '' && key !== 'per_page') {
        params[key] = String(value);
      }
    });
    setSearchParams(params, { replace: true });
  }, [filters, setSearchParams]);

  const handleFilterChange = (key: string, value: string) => {
    setFilters((prev) => ({
      ...prev,
      [key]: value,
      page: key !== 'page' ? 1 : prev.page,
    }));
  };

  const handleClearFilters = () => {
    setFilters({
      search: '',
      project_id: '',
      order_status: '',
      payment_status: '',
      delivery_date: '',
      delivery_method: '',
      repeat_order: '',
      sort: 'created_at',
      dir: 'desc',
      page: 1,
      per_page: 10,
    });
  };

  const handlePageChange = (page: number) => {
    setFilters((prev) => ({ ...prev, page }));
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const handleViewOrder = (orderId: number) => {
    navigate(`/client/orders/${orderId}`);
  };

  return (
    <DashboardLayout menuItems={clientMenuItems}>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold text-gray-900 bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
              My Orders
            </h1>
            <p className="text-gray-600 mt-1">Track and manage your orders</p>
          </div>
          <button
            onClick={() => refetch()}
            disabled={isFetching}
            className="flex items-center gap-2 px-5 py-2.5 bg-white border-2 border-gray-300 rounded-lg hover:bg-gray-50 transition-all disabled:opacity-50 font-medium shadow-sm hover:shadow-md"
          >
            <RefreshCw size={18} className={isFetching ? 'animate-spin' : ''} />
            Refresh
          </button>
        </div>

        {/* Metrics Cards */}
        <ClientOrderMetricsCards metrics={data?.metrics || null} loading={isLoading} />

        {/* Search Bar */}
        <div className="bg-white rounded-xl border border-gray-200 p-4 shadow-sm">
          <div className="relative">
            <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
            <input
              type="text"
              value={filters.search}
              onChange={(e) => handleFilterChange('search', e.target.value)}
              placeholder="Search by PO number..."
              className="w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium"
            />
          </div>
        </div>

        {/* Filters */}
        <ClientOrderFilters
          filters={filters}
          onFilterChange={handleFilterChange}
          onClearFilters={handleClearFilters}
          projects={projects}
          availableFilters={availableFilters}
        />

        {/* Active Filter Chips */}
        <ClientActiveFilterChips
          filters={filters}
          onFilterChange={handleFilterChange}
          projects={projects}
        />

        {/* Orders Table */}
        <ClientOrdersTable
          orders={data?.data || []}
          loading={isLoading || isFetching}
          pagination={data?.pagination || null}
          onPageChange={handlePageChange}
          onViewOrder={handleViewOrder}
        />
      </div>
    </DashboardLayout>
  );
};

export default ClientOrdersList;
/* FILE: src/pages/client/ClientOrderView.tsx */
// src/pages/client/Orders/ClientOrderView.tsx

import { useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import {
  ArrowLeft,
  MapPin,
  Calendar,
  Truck,
  Package,
  RefreshCw,
  RotateCcw,
  Building2,
  Info,
  DollarSign,
  User,
  Phone,
  ClipboardList,
  AlertCircle,
} from 'lucide-react';
import { format } from 'date-fns';
import toast from 'react-hot-toast';
import { useClientOrderDetail, useRepeatOrder } from '../../features/clientOrders/hooks';
import DashboardLayout from '../../components/layout/DashboardLayout';
import RepeatOrderModal from '../../components/client/RepeatOrderModal';
import StripePayment from '../../components/client/StripePayment';
import { clientMenuItems } from '../../utils/menuItems';

const ClientOrderView = () => {
  const { orderId } = useParams();
  const navigate = useNavigate();
  const { data, isLoading, refetch } = useClientOrderDetail(Number(orderId));
  const repeatOrderMutation = useRepeatOrder();
  const [repeatOrderModalOpen, setRepeatOrderModalOpen] = useState(false);

  const formatDate = (dateString: string) => {
    if (!dateString) return '-';
    try {
      const date = new Date(dateString);
      return format(date, 'MMM dd, yyyy');
    } catch {
      return '-';
    }
  };

  const formatDateTime = (dateString: string, timeString?: string) => {
    if (!dateString) return '-';
    try {
      const date = format(new Date(dateString), 'MMM dd, yyyy');
      return timeString ? `${date} at ${timeString}` : date;
    } catch {
      return '-';
    }
  };

  const formatCurrency = (amount: number | string) => {
    const num = typeof amount === 'string' ? parseFloat(amount) : amount;
    if (isNaN(num)) return '$0.00';
    return `$${num.toFixed(2)}`;
  };

  const getOrderStatusColor = (orderStatus: string) => {
    const statusColors: Record<string, string> = {
      'Draft': 'bg-gray-100 text-gray-800 border-gray-300',
      'Confirmed': 'bg-blue-100 text-blue-800 border-blue-300',
      'Scheduled': 'bg-indigo-100 text-indigo-800 border-indigo-300',
      'In Transit': 'bg-purple-100 text-purple-800 border-purple-300',
      'Delivered': 'bg-green-100 text-green-800 border-green-300',
      'Completed': 'bg-emerald-100 text-emerald-800 border-emerald-300',
      'Cancelled': 'bg-red-100 text-red-800 border-red-300',
    };
    return statusColors[orderStatus] || 'bg-gray-100 text-gray-800 border-gray-300';
  };

  const getPaymentStatusColor = (paymentStatus: string) => {
    const colors: Record<string, string> = {
      'Unpaid': 'bg-red-100 text-red-800 border-red-300',
      'Pending': 'bg-yellow-100 text-yellow-800 border-yellow-300',
      'Paid': 'bg-green-100 text-green-800 border-green-300',
      'Partially Paid': 'bg-orange-100 text-orange-800 border-orange-300',
      'Failed': 'bg-red-100 text-red-800 border-red-300',
    };
    return colors[paymentStatus] || 'bg-gray-100 text-gray-800 border-gray-300';
  };

  const handleRefresh = () => {
    refetch();
    toast.success('Order refreshed');
  };

  const handleRepeatOrder = () => {
    if (data?.data) {
      setRepeatOrderModalOpen(true);
    }
  };

  const handleRepeatOrderSubmit = async (items: any[]) => {
    if (!orderId) return;

    try {
      await repeatOrderMutation.mutateAsync({
        orderId: Number(orderId),
        payload: { items },
      });
      toast.success('Order repeated successfully!');
      setRepeatOrderModalOpen(false);
      navigate('/client/orders');
    } catch (error: any) {
      toast.error(error.message || 'Failed to repeat order');
    }
  };

  const handlePaymentSuccess = () => {
    toast.success('Payment completed successfully!');
    refetch();
  };

  if (isLoading) {
    return (
      <DashboardLayout menuItems={clientMenuItems}>
        <div className="flex items-center justify-center min-h-screen">
          <div className="flex flex-col items-center gap-4">
            <div className="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <p className="text-gray-600">Loading order details...</p>
          </div>
        </div>
      </DashboardLayout>
    );
  }

  if (!data?.data) {
    return (
      <DashboardLayout menuItems={clientMenuItems}>
        <div className="flex items-center justify-center min-h-screen">
          <div className="text-center">
            <h2 className="text-2xl font-bold text-gray-900 mb-2">Order not found</h2>
            <p className="text-gray-600 mb-4">The order you're looking for doesn't exist.</p>
            <button
              onClick={() => navigate('/client/orders')}
              className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
            >
              Back to Orders
            </button>
          </div>
        </div>
      </DashboardLayout>
    );
  }

  const { order, items } = data.data;
  const showPayment =
    order.workflow === 'Payment Requested';

  return (
    <DashboardLayout menuItems={clientMenuItems}>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between flex-wrap gap-4">
          <div className="flex items-center gap-4">
            <button
              onClick={() => navigate('/client/orders')}
              className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
            >
              <ArrowLeft className="w-5 h-5 text-gray-600" />
            </button>
            <div>
              <div className="flex items-center gap-3 flex-wrap">
                <h1 className="text-2xl font-bold text-gray-900">Order #{order.po_number}</h1>
                <span
                  className={`px-3 py-1 text-sm font-semibold rounded-full border-2 ${getOrderStatusColor(
                    order.order_status
                  )}`}
                >
                  {order.order_status}
                </span>
                {order.repeat_order && (
                  <span className="px-3 py-1 bg-purple-100 text-purple-700 text-sm font-semibold rounded-full border-2 border-purple-300 flex items-center gap-1">
                    <RefreshCw size={14} />
                    Repeat Order
                  </span>
                )}
              </div>
              {order.order_info && (
                <div className="flex items-center gap-2 mt-2">
                  <Info className="w-4 h-4 text-blue-600" />
                  <p className="text-sm text-blue-600 font-medium">{order.order_info}</p>
                </div>
              )}
            </div>
          </div>
          <div className="flex items-center gap-3">
            <button
              onClick={handleRefresh}
              className="flex items-center gap-2 px-4 py-2 border-2 border-gray-300 rounded-lg hover:bg-gray-50 transition-colors font-medium"
            >
              <RefreshCw className="w-4 h-4" />
              Refresh
            </button>
            <button
              onClick={handleRepeatOrder}
              className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium shadow-md hover:shadow-lg"
            >
              <RotateCcw className="w-4 h-4" />
              Repeat Order
            </button>
          </div>
        </div>

        {/* Payment Section */}
        {showPayment && order.total_price && (
          <StripePayment
            orderId={Number(orderId)}
            totalAmount={Number(order.total_price) || 0}
            onSuccess={handlePaymentSuccess}
          />
        )}

        {/* Status & Basic Info Grid */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Order Status Card */}
          <div className="bg-white rounded-xl border-2 border-gray-200 p-6 shadow-sm">
            <h2 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
              <ClipboardList className="w-5 h-5 text-blue-600" />
              Order Status
            </h2>
            <div className="space-y-4">
              <div>
                <span className="text-sm text-gray-600 block mb-2">Current Status</span>
                <span
                  className={`inline-flex px-4 py-2 rounded-full text-sm font-bold border-2 ${getOrderStatusColor(
                    order.order_status
                  )}`}
                >
                  {order.order_status}
                </span>
              </div>
              <div>
                <span className="text-sm text-gray-600 block mb-2">Payment Status</span>
                <span
                  className={`inline-flex px-4 py-2 rounded-full text-sm font-bold border-2 ${getPaymentStatusColor(
                    order.payment_status
                  )}`}
                >
                  {order.payment_status}
                </span>
              </div>
              <div>
                <span className="text-sm text-gray-600 block mb-2">Order Date</span>
                <span className="text-sm font-semibold text-gray-900">
                  {formatDate(order.created_at)}
                </span>
              </div>
              {order.updated_at && order.updated_at !== order.created_at && (
                <div>
                  <span className="text-sm text-gray-600 block mb-2">Last Updated</span>
                  <span className="text-sm font-semibold text-gray-900">
                    {formatDate(order.updated_at)}
                  </span>
                </div>
              )}
            </div>
          </div>

          {/* Project Details Card */}
          <div className="bg-white rounded-xl border-2 border-gray-200 p-6 shadow-sm">
            <h2 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
              <Building2 className="w-5 h-5 text-blue-600" />
              Project Details
            </h2>
            <div className="space-y-4">
              <div>
                <span className="text-sm text-gray-600 block mb-2">Project Name</span>
                <span className="text-sm font-semibold text-gray-900">{order.project?.name || '-'}</span>
              </div>
              {order.project?.site_contact_name && (
                <div>
                  <span className="text-sm text-gray-600 block mb-2">Site Contact</span>
                  <div className="flex items-center gap-2">
                    <User className="w-4 h-4 text-gray-400" />
                    <span className="text-sm font-semibold text-gray-900">
                      {order.project.site_contact_name}
                    </span>
                  </div>
                </div>
              )}
              {order.project?.site_contact_phone && (
                <div>
                  <span className="text-sm text-gray-600 block mb-2">Phone</span>
                  <div className="flex items-center gap-2">
                    <Phone className="w-4 h-4 text-gray-400" />
                    <span className="text-sm font-semibold text-gray-900">
                      {order.project.site_contact_phone}
                    </span>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Delivery Information */}
        <div className="bg-white rounded-xl border-2 border-gray-200 p-6 shadow-sm">
          <h2 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
            <Truck className="w-5 h-5 text-blue-600" />
            Delivery Information
          </h2>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <span className="text-sm text-gray-600 block mb-2">Delivery Address</span>
              <div className="flex items-start gap-2">
                <MapPin className="w-4 h-4 text-blue-600 mt-0.5" />
                <span className="text-sm font-semibold text-gray-900">{order.delivery_address}</span>
              </div>
            </div>
            <div>
              <span className="text-sm text-gray-600 block mb-2">Delivery Date & Time</span>
              <div className="flex items-center gap-2">
                <Calendar className="w-4 h-4 text-blue-600" />
                <span className="text-sm font-semibold text-gray-900">
                  {formatDateTime(order.delivery_date, order.delivery_time)}
                </span>
              </div>
            </div>
            {order.delivery_method && (
              <div>
                <span className="text-sm text-gray-600 block mb-2">Delivery Method</span>
                <span className="text-sm font-semibold text-gray-900 px-3 py-1 bg-blue-50 rounded-full border border-blue-200">
                  {order.delivery_method}
                </span>
              </div>
            )}
          </div>
          {order.project?.site_instructions && (
            <div className="mt-4 pt-4 border-t border-gray-200">
              <span className="text-sm text-gray-600 block mb-2">Site Instructions</span>
              <p className="text-sm text-gray-900 whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">
                {order.project.site_instructions}
              </p>
            </div>
          )}
          {order.reason && (
            <div className="mt-4 pt-4 border-t border-gray-200">
              <span className="text-sm text-gray-600 block mb-2">Special Notes</span>
              <p className="text-sm text-gray-900 whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{order.reason}</p>
            </div>
          )}
        </div>

        {/* Order Items */}
        <div className="bg-white rounded-xl border-2 border-gray-200 p-6 shadow-sm">
          <h2 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
            <Package className="w-5 h-5 text-blue-600" />
            Order Items ({items?.length || 0})
          </h2>
          <div className="space-y-4">
            {items && items.length > 0 ? (
              items.map((item: any, index: number) => {
                const displayPrice = item.is_quoted === 1 && item.quoted_price
                  ? parseFloat(item.quoted_price) || 0
                  : parseFloat(item.supplier_unit_cost || 0) || 0;

                const itemTotal = displayPrice * (parseInt(item.quantity || 0) || 0);

                return (
                  <div
                    key={index}
                    className="border-2 border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors bg-gray-50"
                  >
                    <div className="flex items-start justify-between mb-3">
                      <div className="flex-1">
                        <h3 className="font-bold text-gray-900 mb-2">
                          {item.product?.product_name || 'Product'}
                        </h3>
                        {item.product?.specifications && (
                          <p className="text-xs text-gray-600 mb-2">{item.product.specifications}</p>
                        )}
                        {item.supplier && (
                          <div className="flex items-center gap-2 text-sm text-gray-600">
                            {item.supplier_confirms === 1 && (
                              <span className="px-2 py-1 bg-green-100 text-green-700 text-xs font-bold rounded-full border-2 border-green-300">
                                ✓ Confirmed
                              </span>
                            )}
                            {item.supplier_confirms === 0 && (
                              <span className="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs font-bold rounded-full border-2 border-yellow-300">
                                ⏱ Pending Confirmation
                              </span>
                            )}
                          </div>
                        )}
                        {!item.supplier && (
                          <div className="flex items-center gap-2 text-sm text-red-600">
                            <AlertCircle className="w-4 h-4" />
                            <span className="font-medium">Awaiting for confirmation</span>
                          </div>
                        )}
                      </div>
                      <div className="text-right bg-white rounded-lg p-3 border-2 border-gray-200">
                        <div className="text-xs text-gray-600 mb-1">Quantity</div>
                        <div className="text-xl font-bold text-gray-900">{item.quantity}</div>
                        <div className="text-xs text-gray-500 mt-1">{item.product?.unit_of_measure || 'units'}</div>
                      </div>
                    </div>

                    <div className="border-t border-gray-300 pt-3 space-y-2 bg-white rounded-lg p-3">
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600 font-medium">
                          {item.is_quoted === 1 ? 'Quoted Price:' : 'Unit Price:'}
                        </span>
                        <span className="font-bold text-gray-900">
                          {formatCurrency(displayPrice)}
                          {item.is_quoted === 1 && (
                            <span className="ml-2 px-2 py-0.5 bg-blue-100 text-blue-700 text-xs font-bold rounded border-2 border-blue-300">
                              Custom Quote
                            </span>
                          )}
                        </span>
                      </div>
                      <div className="flex justify-between text-base font-bold border-t pt-2">
                        <span className="text-gray-700">Item Total:</span>
                        <span className="text-blue-600">{formatCurrency(itemTotal)}</span>
                      </div>
                      {item.supplier_discount && parseFloat(item.supplier_discount) > 0 && (
                        <div className="flex justify-between text-sm text-green-600 font-semibold">
                          <span>Discount Applied:</span>
                          <span>-{formatCurrency(item.supplier_discount)}</span>
                        </div>
                      )}
                      {item.delivery_type && (
                        <div className="flex justify-between text-sm text-gray-600">
                          <span>Delivery Type:</span>
                          <span className="font-semibold">{item.delivery_type}</span>
                        </div>
                      )}
                    </div>
                  </div>
                );
              })
            ) : (
              <div className="text-center py-8 text-gray-500">No items found</div>
            )}
          </div>
        </div>

        {/* Order Summary */}
        {order.total_price && (
          <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-300 p-6 shadow-lg">
            <h2 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
              <DollarSign className="w-5 h-5 text-blue-600" />
              Order Summary
            </h2>
            <div className="space-y-3 bg-white rounded-lg p-4">
              <div className="flex justify-between text-sm">
                <span className="text-gray-600">Items Cost:</span>
                <span className="font-semibold text-gray-900">
                  {formatCurrency(order.customer_item_cost || 0)}
                </span>
              </div>
              <div className="flex justify-between text-sm">
                <span className="text-gray-600">Delivery Cost:</span>
                <span className="font-semibold text-gray-900">
                  {formatCurrency(order.customer_delivery_cost || 0)}
                </span>
              </div>
              <div className="flex justify-between text-sm">
                <span className="text-gray-600">GST (10%):</span>
                <span className="font-semibold text-gray-900">
                  {formatCurrency(order.gst_tax || 0)}
                </span>
              </div>
              {order.discount && parseFloat(order.discount.toString()) > 0 && (
                <div className="flex justify-between text-sm text-green-600 font-semibold">
                  <span>Discount:</span>
                  <span>-{formatCurrency(order.discount)}</span>
                </div>
              )}
              {order.other_charges && parseFloat(order.other_charges.toString()) > 0 && (
                <div className="flex justify-between text-sm">
                  <span className="text-gray-600">Other Charges:</span>
                  <span className="font-semibold text-gray-900">
                    {formatCurrency(order.other_charges)}
                  </span>
                </div>
              )}
              <div className="border-t-2 border-blue-300 pt-3 mt-3">
                <div className="flex justify-between items-center">
                  <span className="text-lg font-bold text-gray-900">Total Amount:</span>
                  <span className="text-3xl font-bold text-blue-600">
                    {formatCurrency(order.total_price || 0)}
                  </span>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Repeat Order Modal */}
        <RepeatOrderModal
          isOpen={repeatOrderModalOpen}
          onClose={() => setRepeatOrderModalOpen(false)}
          order={order && items ? { ...order, items } : null}
          onSubmit={handleRepeatOrderSubmit}
          isSubmitting={repeatOrderMutation.isPending}
        />
      </div>
    </DashboardLayout>
  );
};

export default ClientOrderView;
/* FILE: src/pages/client/Dashboard.tsx */
// src/pages/client/Dashboard.tsx
import DashboardLayout from '../../components/layout/DashboardLayout';
import { clientMenuItems } from '../../utils/menuItems';

const ClientDashboard = () => {

  return (
    <DashboardLayout menuItems={clientMenuItems}>
      <div className="bg-white rounded-xl shadow-card p-8">
        <h1 className="text-3xl font-bold text-secondary-900">Client Dashboard</h1>
        <p className="text-secondary-600 mt-2">Welcome to your client portal</p>
      </div>
    </DashboardLayout>
  );
};

export default ClientDashboard;
/* FILE: src/pages/client/OrderCreate.tsx */
// src/pages/client/OrderCreate.tsx
/**
 * REDESIGNED ORDER CREATE PAGE - MULTI-STEP WIZARD
 * 
 * Architecture:
 * - Step 1: Product Selection (with floating cart + product detail modal)
 * - Step 2: Project & Delivery Details (smart form with auto-fill)
 * - Step 3: Review & Confirm (order summary before submission)
 * 
 * Key Features:
 * ✅ Multi-step wizard with progress indicator
 * ✅ Product detail modal for full specifications
 * ✅ Floating cart badge with slide-in sidebar
 * ✅ Smart project selection with search
 * ✅ Mobile-first responsive design
 * ✅ LocalStorage cart persistence
 * ✅ Professional UX matching e-commerce standards
 */

import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Search, X, Filter, Loader2, AlertCircle, Package } from 'lucide-react';
import toast from 'react-hot-toast';

import DashboardLayout from '../../components/layout/DashboardLayout';
import OrderWizard from '../../components/order/OrderWizard';
import ProductCard from '../../components/order/ProductCard';
import ProductDetailModal from '../../components/order/ProductDetailModal';
import FloatingCartBadge from '../../components/order/FloatingCartBadge';
import Step2_ProjectDelivery from '../../components/order/Step2_ProjectDelivery';
import Step3_ReviewOrder from '../../components/order/Step3_ReviewOrder';
import Button from '../../components/common/Buttons';
import { ordersAPI } from '../../api/handlers/orders.api';
import { projectsAPI } from '../../api/handlers/projects.api';
import { cartUtils } from '../../utils/cartUtils';
import type { CartItem, Product, Project } from '../../types/order.types';
import type { OrderFormValues } from '../../utils/validators';
import { clientMenuItems } from '../../utils/menuItems';

const OrderCreate = () => {
  const navigate = useNavigate();
  const queryClient = useQueryClient();

  // Wizard State
  const [currentStep, setCurrentStep] = useState(1);
  
  // Step 2 & 3 State
  const [orderFormData, setOrderFormData] = useState<OrderFormValues | null>(null);
  const [selectedProject, setSelectedProject] = useState<Project | null>(null);

  // Product Selection State
  const [cartItems, setCartItems] = useState<CartItem[]>([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedCategory, setSelectedCategory] = useState<number | undefined>();
  const [currentPage, setCurrentPage] = useState(1);
  const [showCategoryDropdown, setShowCategoryDropdown] = useState(false);

  // Product Detail Modal
  const [selectedProduct, setSelectedProduct] = useState<Product | null>(null);
  const [showProductModal, setShowProductModal] = useState(false);

  // Load cart from localStorage on mount
  useEffect(() => {
    setCartItems(cartUtils.getCart());
  }, []);

  // ==================== DATA FETCHING ====================

  // Fetch Categories
  const { data: categoriesData } = useQuery({
    queryKey: ['product-categories'],
    queryFn: () => ordersAPI.getCategories(),
    staleTime: 5 * 60 * 1000, // Cache for 5 minutes
  });

  // Fetch Products
  const { data: productsData, isLoading: loadingProducts, error: productsError } = useQuery({
    queryKey: ['client-products', currentPage, searchTerm, selectedCategory],
    queryFn: () => ordersAPI.getClientProducts({
      page: currentPage,
      per_page: 12,
      search: searchTerm || undefined,
      category: selectedCategory,
    }),
    enabled: currentStep === 1, // Only fetch when on product selection step
  });

  // Fetch Projects
  const { data: projectsData } = useQuery({
    queryKey: ['client-projects'],
    queryFn: () => projectsAPI.list({}),
    enabled: currentStep === 2, // Only fetch when on project/delivery step
  });

  // Create Order Mutation
  const createOrderMutation = useMutation({
    mutationFn: ordersAPI.createOrder,
    onSuccess: () => {
      toast.success('✅ Order created successfully!');
      cartUtils.clearCart();
      setCartItems([]);
      queryClient.invalidateQueries({ queryKey: ['client-orders'] });
      
      // Redirect to dashboard
      navigate('/client/dashboard');
    },
    onError: (error: any) => {
      const errorMsg = error?.response?.data?.message || error?.message || 'Failed to create order';
      toast.error('❌ ' + errorMsg);
    },
  });

  // ==================== CART ACTIONS ====================

  const handleAddToCart = (product: Product) => {
    const updated = cartUtils.addItem({
      id: product.id,
      product_name: product.product_name,
      photo: product.photo,
      product_type: product.product_type,
      unit_of_measure: product.unit_of_measure,
    });
    setCartItems(updated);
    toast.success(`✅ ${product.product_name} added to cart`);
  };

  const handleUpdateQuantity = (productId: number, quantity: number) => {
    const updated = cartUtils.updateQuantity(productId, quantity);
    setCartItems(updated);
  };

  const handleRemoveItem = (productId: number) => {
    const updated = cartUtils.removeItem(productId);
    setCartItems(updated);
    toast.success('Item removed from cart');
  };

  

  // ==================== WIZARD NAVIGATION ====================

  const handleProceedToStep2 = () => {
    if (cartItems.length === 0) {
      toast.error('Your cart is empty. Please add some products.');
      return;
    }
    setCurrentStep(2);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const handleBackToStep1 = () => {
    setCurrentStep(1);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const handleBackToStep2 = () => {
    setCurrentStep(2);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const handleStep2Submit = (formData: OrderFormValues) => {
    // Save form data and move to review step (Step 3)
    setOrderFormData(formData);
    
    // Find and save selected project
    const project = projects.find(p => p.id === formData.project_id);
    setSelectedProject(project || null);
    
    // Move to Step 3 (Review)
    setCurrentStep(3);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const handleFinalOrderSubmit = () => {
    if (!orderFormData) return;
    
    const orderPayload = {
      ...orderFormData,
      items: cartItems.map(item => ({
        product_id: item.product_id,
        quantity: item.quantity,
        custom_blend_mix: item.custom_blend_mix || null,
      })),
    };
    createOrderMutation.mutate(orderPayload);
  };

  // ==================== FILTERS ====================

  const handleCategorySelect = (categoryId: number | undefined) => {
    setSelectedCategory(categoryId);
    setCurrentPage(1);
    setShowCategoryDropdown(false);
  };

  // ==================== PRODUCT MODAL ====================

  const handleViewProductDetails = (product: Product) => {
    setSelectedProduct(product);
    setShowProductModal(true);
  };

  const handleCloseProductModal = () => {
    setShowProductModal(false);
    setSelectedProduct(null);
  };

  // ==================== DATA PREPARATION ====================

  const products = productsData?.data || [];
  const meta = productsData?.meta;
  const projects = projectsData?.data || [];

  // Get categories from API
  const categories = categoriesData?.data || [];

  const totalCartItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);

  // ==================== RENDER ====================

  return (
    <DashboardLayout menuItems={clientMenuItems}>
      <div className="space-y-6">
        {/* Header */}
        <div>
          <h1 className="text-3xl font-bold text-secondary-900">Create Order</h1>
          <p className="text-secondary-600 mt-1">
            {currentStep === 1 && 'Select products and add them to your cart'}
            {currentStep === 2 && 'Enter project and delivery details'}
            {currentStep === 3 && 'Review your order before final submission'}
          </p>
        </div>

        {/* Wizard Progress */}
        <OrderWizard currentStep={currentStep} onStepChange={setCurrentStep}>
          
          {/* ==================== STEP 1: PRODUCT SELECTION ==================== */}
          {currentStep === 1 && (
            <div className="space-y-6">
              {/* Search & Filters */}
              <div className="bg-white rounded-xl shadow-sm border border-secondary-200 p-6">
                <div className="flex flex-col md:flex-row gap-4">
                  {/* Search Input */}
                  <div className="flex-1 relative">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-secondary-400" size={20} />
                    <input
                      type="text"
                      placeholder="Search products by name or type..."
                      value={searchTerm}
                      onChange={(e) => {
                        setSearchTerm(e.target.value);
                        setCurrentPage(1);
                      }}
                      className="w-full pl-10 pr-10 py-3 rounded-lg border-2 border-secondary-200 focus:border-primary-500 focus:outline-none transition-colors"
                    />
                    {searchTerm && (
                      <button
                        onClick={() => {
                          setSearchTerm('');
                          setCurrentPage(1);
                        }}
                        className="absolute right-3 top-1/2 -translate-y-1/2 text-secondary-400 hover:text-secondary-600 transition-colors"
                      >
                        <X size={20} />
                      </button>
                    )}
                  </div>

                  {/* Category Filter Dropdown */}
                  <div className="relative">
                    <Button
                      variant="outline"
                      onClick={() => setShowCategoryDropdown(!showCategoryDropdown)}
                      className="w-full md:w-auto"
                    >
                      <Filter size={18} />
                      {selectedCategory 
                        ? categories.find(c => c.id === selectedCategory)?.name 
                        : 'All Categories'}
                    </Button>

                    {showCategoryDropdown && (
                      <div className="absolute right-0 mt-2 w-56 bg-white border border-secondary-200 rounded-lg shadow-lg z-50">
                        <button
                          onClick={() => handleCategorySelect(undefined)}
                          className={`w-full text-left px-4 py-2 hover:bg-secondary-50 transition-colors ${
                            !selectedCategory ? 'bg-primary-50 text-primary-700 font-semibold' : ''
                          }`}
                        >
                          All Categories
                        </button>
                        {categories.map((category) => (
                          <button
                            key={category.id}
                            onClick={() => handleCategorySelect(category.id)}
                            className={`w-full text-left px-4 py-2 hover:bg-secondary-50 transition-colors border-t border-secondary-100 ${
                              selectedCategory === category.id ? 'bg-primary-50 text-primary-700 font-semibold' : ''
                            }`}
                          >
                            {category.name}
                          </button>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>

              {/* Products Grid */}
              {loadingProducts ? (
                <div className="flex flex-col items-center justify-center py-16">
                  <Loader2 className="animate-spin text-primary-600 mb-4" size={48} />
                  <p className="text-secondary-600">Loading products...</p>
                </div>
              ) : productsError ? (
                <div className="bg-red-50 border border-red-200 rounded-xl p-6 flex items-center gap-3">
                  <AlertCircle className="text-red-600 flex-shrink-0" size={24} />
                  <div>
                    <p className="font-semibold text-red-900">Failed to load products</p>
                    <p className="text-sm text-red-700 mt-1">
                      {(productsError as any)?.message || 'Please try refreshing the page'}
                    </p>
                  </div>
                </div>
              ) : products.length === 0 ? (
                <div className="bg-white rounded-xl shadow-sm border border-secondary-200 p-12">
                  <div className="text-center space-y-4">
                    <div className="inline-flex items-center justify-center w-16 h-16 bg-secondary-100 rounded-full">
                      <Package className="text-secondary-400" size={32} />
                    </div>
                    <div>
                      <h3 className="text-lg font-semibold text-secondary-900">No products found</h3>
                      <p className="text-sm text-secondary-600 mt-1">
                        {searchTerm || selectedCategory 
                          ? 'Try adjusting your search or filters' 
                          : 'No products available at the moment'}
                      </p>
                    </div>
                    {(searchTerm || selectedCategory) && (
                      <Button
                        onClick={() => {
                          setSearchTerm('');
                          setSelectedCategory(undefined);
                        }}
                        variant="outline"
                      >
                        Clear Filters
                      </Button>
                    )}
                  </div>
                </div>
              ) : (
                <>
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    {products.map((product) => (
                      <ProductCard
                        key={product.id}
                        product={product}
                        isInCart={cartUtils.isInCart(product.id)}
                        onAddToCart={handleAddToCart}
                        onViewDetails={handleViewProductDetails}
                      />
                    ))}
                  </div>

                  {/* Pagination */}
                  {meta && meta.last_page > 1 && (
                    <div className="flex justify-center mt-8">
                      <div className="flex items-center gap-2">
                        <Button
                          variant="outline"
                          onClick={() => setCurrentPage(prev => Math.max(1, prev - 1))}
                          disabled={currentPage === 1}
                        >
                          Previous
                        </Button>
                        <span className="px-4 py-2 text-sm text-secondary-600">
                          Page {currentPage} of {meta.last_page}
                        </span>
                        <Button
                          variant="outline"
                          onClick={() => setCurrentPage(prev => Math.min(meta.last_page, prev + 1))}
                          disabled={currentPage === meta.last_page}
                        >
                          Next
                        </Button>
                      </div>
                    </div>
                  )}
                </>
              )}

              {/* Proceed to Next Step Button (Fixed at bottom on mobile) */}
              {cartItems.length > 0 && (
                <div className="fixed bottom-0 left-0 right-0 lg:relative bg-white border-t border-secondary-200 p-4 shadow-xl lg:shadow-none z-30">
                  <div className="max-w-7xl mx-auto">
                    <Button
                      onClick={handleProceedToStep2}
                      variant="primary"
                      fullWidth
                      className="py-4 text-lg font-semibold"
                    >
                      Continue to Delivery Details ({totalCartItems} items) →
                    </Button>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* ==================== STEP 2: PROJECT & DELIVERY ==================== */}
          {currentStep === 2 && (
            <Step2_ProjectDelivery
              cartItems={cartItems}
              projects={projects}
              onSubmit={handleStep2Submit}
              onBack={handleBackToStep1}
              isSubmitting={false}
              onCreateProject={undefined}
              
              // ADD THESE THREE LINES:
              onUpdateQuantity={handleUpdateQuantity}
              onRemoveItem={handleRemoveItem}
              onUpdateCustomBlend={(productId, blend) => {
                const updated = cartUtils.updateCustomBlend(productId, blend);
                setCartItems(updated);
              }}
            />
          )}

          {/* ==================== STEP 3: REVIEW ORDER ==================== */}
          {currentStep === 3 && orderFormData && (
            <Step3_ReviewOrder
              cartItems={cartItems}
              orderDetails={orderFormData}
              selectedProject={selectedProject}
              onBack={handleBackToStep2}
              onConfirm={handleFinalOrderSubmit}
              isSubmitting={createOrderMutation.isPending}
            />
          )}

        </OrderWizard>

        {/* Floating Cart Badge (Only on Step 1) */}
        {currentStep === 1 && (
          <FloatingCartBadge
            itemCount={totalCartItems}
            cartItems={cartItems}
            onUpdateQuantity={handleUpdateQuantity}
            onRemoveItem={handleRemoveItem}
            onProceedToCheckout={handleProceedToStep2}
          />
        )}

        {/* Product Detail Modal */}
        <ProductDetailModal
          isOpen={showProductModal}
          onClose={handleCloseProductModal}
          product={selectedProduct}
          isInCart={selectedProduct ? cartUtils.isInCart(selectedProduct.id) : false}
          onAddToCart={handleAddToCart}
        />
      </div>
    </DashboardLayout>
  );
};

export default OrderCreate;
/* FILE: src/pages/client/projects/ProjectCreate.tsx */
// src/pages/client/projects/ProjectCreate.tsx
import { useNavigate } from 'react-router-dom';
import { ArrowLeft } from 'lucide-react';
import toast from 'react-hot-toast';

import { useCreateProject } from '../../../features/projects/hooks';
import ProjectForm from '../../../features/components/ProjectForm';
import DashboardLayout from '../../../components/layout/DashboardLayout';
import { clientMenuItems } from '../../../utils/menuItems';

export default function ProjectCreate() {
  const navigate = useNavigate();
  const mut = useCreateProject();

  return (
    <DashboardLayout menuItems={clientMenuItems}>
      <div className="max-w-4xl mx-auto space-y-6">
        {/* Header with Back Button */}
        <div className="flex items-center justify-between">
          <button
            onClick={() => navigate('/client/projects')}
            className="flex items-center gap-2 text-secondary-600 hover:text-primary-600 transition-colors"
          >
            <ArrowLeft size={20} />
            Back to Projects
          </button>
        </div>

        {/* Form Card */}
        <div className="bg-white rounded-2xl shadow-card p-8">
          <div className="mb-8">
            <h1 className="text-3xl font-bold text-secondary-900">Create New Project</h1>
            <p className="text-secondary-600 mt-2">Add a new construction project with delivery location</p>
          </div>

          <ProjectForm
            onSubmit={(v) => mut.mutate(v, {
              onSuccess: () => {
                toast.success('✅ Project created successfully!');
                navigate('/client/projects');
              },
              onError: (e: any) => {
                toast.error(e?.message || 'Failed to create project');
              },
            })}
            submitting={mut.isPending}
          />
        </div>
      </div>
    </DashboardLayout>
  );
}
/* FILE: src/pages/client/projects/ProjectDetail.tsx */
/* FILE: src/pages/client/projects/ProjectDetails.tsx */
// src/pages/client/projects/ProjectDetails.tsx
import { useState } from 'react';
import { useParams, useNavigate, useSearchParams } from 'react-router-dom';
import { useQuery, useQueryClient } from '@tanstack/react-query';
import { 
  ArrowLeft,
  Calendar,
  DollarSign,
  ShoppingCart,
  Package,
  MapPin,
  User,
  Phone,
  FileText,
  TrendingUp,
  Loader2,
  X,
} from 'lucide-react';
import toast from 'react-hot-toast';

import DashboardLayout from '../../../components/layout/DashboardLayout';
import { projectsAPI } from '../../../api/handlers/projects.api';
import type { ProjectDetailsResponse } from '../../../api/handlers/projects.api';
import { clientMenuItems } from '../../../utils/menuItems';

// Helper to format date
const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
};

// Helper to format currency
const formatCurrency = (amount: number) => {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
  }).format(amount);
};

// Helper to get order status badge color
const getOrderStatusColor = (status: string) => {
  const colors: Record<string, string> = {
    'Payment Requested': 'bg-amber-50 text-amber-700 border-amber-200',
    'Delivered': 'bg-emerald-50 text-emerald-700 border-emerald-200',
    'Cancelled': 'bg-rose-50 text-rose-700 border-rose-200',
    'Supplier Missing': 'bg-orange-50 text-orange-700 border-orange-200',
    'Supplier Assigned': 'bg-blue-50 text-blue-700 border-blue-200',
    'Requested': 'bg-violet-50 text-violet-700 border-violet-200',
    'Confirmed': 'bg-emerald-50 text-emerald-700 border-emerald-200',
    'On Hold': 'bg-slate-50 text-slate-700 border-slate-200',
    'In Transit': 'bg-indigo-50 text-indigo-700 border-indigo-200',
  };
  return colors[status] || 'bg-gray-50 text-gray-700 border-gray-200';
};

// Helper to get payment status badge color
const getPaymentStatusColor = (status: string) => {
  const colors: Record<string, string> = {
    'Pending': 'bg-amber-50 text-amber-700 border-amber-200',
    'Paid': 'bg-emerald-50 text-emerald-700 border-emerald-200',
    'Failed': 'bg-rose-50 text-rose-700 border-rose-200',
  };
  return colors[status] || 'bg-gray-50 text-gray-700 border-gray-200';
};

const ProjectDetails = () => {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  
  const queryClient = useQueryClient();
  const [activeTab, setActiveTab] = useState<'orders' | 'products'>('orders');
  const [showOrderModal, setShowOrderModal] = useState(false);
  const [selectedProduct, setSelectedProduct] = useState<any>(null);
  const [orderDetails, setOrderDetails] = useState({
    quantity: '',
    delivery_date: '',
    delivery_time: '',
    po_number: '',
    delivery_method: 'Other',
    special_notes: '',
  });

  // Filters
  const order_status = searchParams.get('order_status') || '';
  const delivery_date_from = searchParams.get('delivery_date_from') || '';
  const delivery_date_to = searchParams.get('delivery_date_to') || '';

  // Fetch project details
  const { data, isLoading, error } = useQuery<ProjectDetailsResponse>({
    queryKey: ['project-details', id, { order_status, delivery_date_from, delivery_date_to }],
    queryFn: () => projectsAPI.getDetails(Number(id), { order_status, delivery_date_from, delivery_date_to }),
    enabled: !!id,
  });

  // Handle order now click
  const handleOrderNow = (product: any) => {
    setSelectedProduct(product);
    setOrderDetails({
      quantity: '',
      delivery_date: '',
      delivery_time: '',
      po_number: '',
      delivery_method: 'Other',
      special_notes: '',
    });
    setShowOrderModal(true);
  };

  // Handle order submission
  const handleSubmitOrder = async () => {
    if (!orderDetails.quantity || parseFloat(orderDetails.quantity) <= 0) {
      toast.error('Please enter a valid quantity');
      return;
    }

    if (!orderDetails.delivery_date) {
      toast.error('Please select a delivery date');
      return;
    }

    try {
      const payload = {
        project_id: Number(id),
        product_id: selectedProduct.product_id,
        order_item_id: selectedProduct.last_order_item_id, // NEW - Use the last order's pricing
        quantity: parseFloat(orderDetails.quantity),
        delivery_date: orderDetails.delivery_date,
        delivery_time: orderDetails.delivery_time || undefined,
        po_number: orderDetails.po_number || undefined,
        delivery_method: orderDetails.delivery_method,
        special_notes: orderDetails.special_notes || undefined,
      };

      await projectsAPI.reorderFromProject(payload);
      
      toast.success(`Order placed successfully for ${orderDetails.quantity} units of ${selectedProduct?.product_name}`);
      setShowOrderModal(false);
      setSelectedProduct(null);
      
      // Refresh project details
      queryClient.invalidateQueries({ queryKey: ['project-details', id] });
    } catch (error: any) {
      toast.error(error.message || 'Failed to create order');
    }
  };

  if (isLoading) {
    return (
      <DashboardLayout menuItems={clientMenuItems}>
        <div className="flex items-center justify-center h-96">
          <Loader2 className="w-10 h-10 animate-spin text-blue-600" />
        </div>
      </DashboardLayout>
    );
  }

  if (error || !data) {
    return (
      <DashboardLayout menuItems={clientMenuItems}>
        <div className="text-center py-12">
          <p className="text-red-600 mb-4">Failed to load project details</p>
          <button
            onClick={() => navigate('/client/projects')}
            className="text-blue-600 hover:underline"
          >
            Back to Projects
          </button>
        </div>
      </DashboardLayout>
    );
  }

  const { project, analytics, orders, project_products } = data;

  return (
    <DashboardLayout menuItems={clientMenuItems}>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <button
              onClick={() => navigate('/client/projects')}
              className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
            >
              <ArrowLeft size={20} />
            </button>
            <div>
              <h1 className="text-3xl font-bold text-gray-900">{project.name}</h1>
              <p className="text-gray-600 mt-1">Project Details & Orders</p>
            </div>
          </div>
        </div>

        {/* Project Info Card */}
        <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            {project.delivery_address && (
              <div className="flex items-start gap-3">
                <MapPin size={20} className="text-gray-400 mt-0.5 flex-shrink-0" />
                <div>
                  <p className="text-sm text-gray-500">Address</p>
                  <p className="text-sm font-medium text-gray-900">{project.delivery_address}</p>
                </div>
              </div>
            )}
            {project.site_contact_name && (
              <div className="flex items-start gap-3">
                <User size={20} className="text-gray-400 mt-0.5 flex-shrink-0" />
                <div>
                  <p className="text-sm text-gray-500">Contact</p>
                  <p className="text-sm font-medium text-gray-900">{project.site_contact_name}</p>
                </div>
              </div>
            )}
            {project.site_contact_phone && (
              <div className="flex items-start gap-3">
                <Phone size={20} className="text-gray-400 mt-0.5 flex-shrink-0" />
                <div>
                  <p className="text-sm text-gray-500">Phone</p>
                  <p className="text-sm font-medium text-gray-900">{project.site_contact_phone}</p>
                </div>
              </div>
            )}
            <div className="flex items-start gap-3">
              <Calendar size={20} className="text-gray-400 mt-0.5 flex-shrink-0" />
              <div>
                <p className="text-sm text-gray-500">Created</p>
                <p className="text-sm font-medium text-gray-900">{formatDate(project.created_at)}</p>
              </div>
            </div>
          </div>
          {project.site_instructions && (
            <div className="mt-4 pt-4 border-t border-gray-200">
              <div className="flex items-start gap-3">
                <FileText size={20} className="text-gray-400 mt-0.5 flex-shrink-0" />
                <div>
                  <p className="text-sm text-gray-500">Instructions</p>
                  <p className="text-sm text-gray-700 mt-1">{project.site_instructions}</p>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Analytics Cards */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <div className="flex items-center gap-3 mb-2">
              <div className="p-2 bg-blue-50 rounded-lg">
                <ShoppingCart size={20} className="text-blue-600" />
              </div>
              <span className="text-sm font-medium text-gray-600">Total Orders</span>
            </div>
            <p className="text-3xl font-bold text-gray-900">{analytics.total_orders}</p>
          </div>

          <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <div className="flex items-center gap-3 mb-2">
              <div className="p-2 bg-emerald-50 rounded-lg">
                <DollarSign size={20} className="text-emerald-600" />
              </div>
              <span className="text-sm font-medium text-gray-600">Total Amount</span>
            </div>
            <p className="text-3xl font-bold text-gray-900">
              {formatCurrency(analytics.total_order_amount)}
            </p>
          </div>

          <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <div className="flex items-center gap-3 mb-2">
              <div className="p-2 bg-violet-50 rounded-lg">
                <TrendingUp size={20} className="text-violet-600" />
              </div>
              <span className="text-sm font-medium text-gray-600">Average Order</span>
            </div>
            <p className="text-3xl font-bold text-gray-900">
              {formatCurrency(analytics.avg_order_value)}
            </p>
          </div>

          <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <div className="flex items-center gap-3 mb-2">
              <div className="p-2 bg-purple-50 rounded-lg">
                <Package size={20} className="text-purple-600" />
              </div>
              <span className="text-sm font-medium text-gray-600">Products</span>
            </div>
            <p className="text-3xl font-bold text-gray-900">{project_products.length}</p>
          </div>
        </div>

        {/* Order Status Breakdown */}
        {Object.keys(analytics.by_order_status).length > 0 && (
          <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <h3 className="text-sm font-semibold text-gray-700 mb-3">Order Status Breakdown</h3>
            <div className="flex flex-wrap gap-2">
              {Object.entries(analytics.by_order_status).map(([status, count]) => (
                <span
                  key={status}
                  className={`px-3 py-1.5 rounded-full text-sm font-medium border ${getOrderStatusColor(status)}`}
                >
                  {status}: {count}
                </span>
              ))}
            </div>
          </div>
        )}

        {/* Tabs */}
        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          {/* Tab Headers */}
          <div className="border-b border-gray-200 px-6">
            <div className="flex gap-8">
              <button
                onClick={() => setActiveTab('orders')}
                className={`py-4 border-b-2 font-medium text-sm transition-colors ${
                  activeTab === 'orders'
                    ? 'border-blue-600 text-blue-600'
                    : 'border-transparent text-gray-600 hover:text-gray-900'
                }`}
              >
                Orders ({orders.length})
              </button>
              <button
                onClick={() => setActiveTab('products')}
                className={`py-4 border-b-2 font-medium text-sm transition-colors ${
                  activeTab === 'products'
                    ? 'border-blue-600 text-blue-600'
                    : 'border-transparent text-gray-600 hover:text-gray-900'
                }`}
              >
                Products ({project_products.length})
              </button>
            </div>
          </div>

          {/* Tab Content */}
          <div className="p-6">
            {activeTab === 'orders' ? (
              // Orders Table
              <div className="overflow-x-auto">
                {orders.length === 0 ? (
                  <div className="text-center py-12 text-gray-500">
                    <Package size={48} className="mx-auto mb-4 text-gray-300" />
                    <p>No orders found for this project</p>
                  </div>
                ) : (
                  <table className="w-full">
                    <thead className="bg-gray-50 border-b border-gray-200">
                      <tr>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">
                          PO Number
                        </th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">
                          Delivery Date
                        </th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">
                          Status
                        </th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">
                          Payment
                        </th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">
                          Items
                        </th>
                        <th className="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">
                          Total
                        </th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                      {orders.map((order) => (
                        <tr key={order.id} className="hover:bg-gray-50 transition-colors">
                          <td className="px-4 py-4">
                            <span className="font-medium text-gray-900">{order.po_number}</span>
                          </td>
                          <td className="px-4 py-4">
                            <div className="text-sm text-gray-700">{formatDate(order.delivery_date)}</div>
                          </td>
                          <td className="px-4 py-4">
                            <span className={`px-2.5 py-1 rounded-full text-xs font-medium border ${getOrderStatusColor(order.order_status)}`}>
                              {order.order_status}
                            </span>
                          </td>
                          <td className="px-4 py-4">
                            <span className={`px-2.5 py-1 rounded-full text-xs font-medium border ${getPaymentStatusColor(order.payment_status)}`}>
                              {order.payment_status}
                            </span>
                          </td>
                          <td className="px-4 py-4">
                            <div className="space-y-1">
                              {order.items.map((item) => (
                                <div key={item.id} className="text-sm text-gray-700">
                                  {item.product_name} × {item.quantity}
                                </div>
                              ))}
                            </div>
                          </td>
                          <td className="px-4 py-4 text-right">
                            <span className="font-semibold text-gray-900">
                              {formatCurrency(order.total_price)}
                            </span>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                )}
              </div>
            ) : (
              // Products Grid
              <div>
                {project_products.length === 0 ? (
                  <div className="text-center py-12 text-gray-500">
                    <Package size={48} className="mx-auto mb-4 text-gray-300" />
                    <p>No products found for this project</p>
                  </div>
                ) : (
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                    {project_products.map((product) => (
                      <div
                        key={product.product_id}
                        className="border border-gray-200 rounded-lg overflow-hidden hover:shadow-md transition-all"
                      >
                        {/* Product Image */}
                        <div className="aspect-video bg-gray-100 flex items-center justify-center">
                          {product.product_image ? (
                            <img
                              src={`${import.meta.env.VITE_API_BASE_URL?.replace('/api', '')}storage/${product.product_image}`}
                              alt={product.product_name}
                              className="w-full h-full object-cover"
                            />
                          ) : (
                            <Package size={48} className="text-gray-300" />
                          )}
                        </div>

                        {/* Product Info */}
                        <div className="p-4">
                          <div className="mb-3">
                            <h3 className="font-semibold text-gray-900 mb-1">
                              {product.product_name}
                            </h3>
                            <p className="text-xs text-gray-500">{product.product_type}</p>
                          </div>

                          {product.product_specifications && (
                            <p className="text-sm text-gray-600 mb-3 line-clamp-2">
                              {product.product_specifications}
                            </p>
                          )}

                          <div className="space-y-2 mb-4">
                            <div className="flex items-center justify-between text-sm">
                              <span className="text-gray-600">Unit Price:</span>
                              <span className="font-semibold text-gray-900">
                                {formatCurrency(product.unit_price)}
                              </span>
                            </div>
                            {product.delivery_cost > 0 && (
                              <div className="flex items-center justify-between text-sm">
                                <span className="text-gray-600">Delivery:</span>
                                <span className="font-semibold text-gray-900">
                                  {formatCurrency(product.delivery_cost)}
                                </span>
                              </div>
                            )}
                            <div className="flex items-center justify-between text-sm pt-2 border-t border-gray-200">
                              <span className="text-gray-600">Total Ordered:</span>
                              <span className="font-semibold text-blue-600">
                                {product.total_quantity} units
                              </span>
                            </div>
                            <div className="flex items-center justify-between text-xs text-gray-500">
                              <span>Used in {product.orders_count} order{product.orders_count !== 1 ? 's' : ''}</span>
                            </div>
                          </div>

                          <button
                            onClick={() => handleOrderNow(product)}
                            className="w-full px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium text-sm"
                          >
                            Order Now
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Order Modal */}
      {showOrderModal && selectedProduct && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-xl font-bold text-gray-900">Order Product</h3>
              <button
                onClick={() => setShowOrderModal(false)}
                className="p-1 hover:bg-gray-100 rounded-lg transition-colors"
              >
                <X size={20} />
              </button>
            </div>

            <div className="space-y-4">
              {/* Product Info */}
              <div className="flex items-center gap-3 pb-4 border-b border-gray-200">
                {selectedProduct.product_image ? (
                  <img
                    src={`${import.meta.env.VITE_API_BASE_URL?.replace('/api', '')}storage/${selectedProduct.product_image}`}
                    alt={selectedProduct.product_name}
                    className="w-16 h-16 rounded object-cover"
                  />
                ) : (
                  <div className="w-16 h-16 rounded bg-gray-100 flex items-center justify-center">
                    <Package size={32} className="text-gray-400" />
                  </div>
                )}
                <div>
                  <h4 className="font-semibold text-gray-900">{selectedProduct.product_name}</h4>
                  <p className="text-sm text-gray-500">{selectedProduct.product_type}</p>
                </div>
              </div>

              {/* Pricing Info */}
              <div className="bg-gray-50 rounded-lg p-3">
                <div className="flex items-center justify-between text-sm mb-1">
                  <span className="text-gray-600">Unit Price:</span>
                  <span className="font-semibold text-gray-900">
                    {formatCurrency(selectedProduct.unit_price)}
                  </span>
                </div>
                {selectedProduct.delivery_cost > 0 && (
                  <div className="flex items-center justify-between text-sm">
                    <span className="text-gray-600">Delivery Cost:</span>
                    <span className="font-semibold text-gray-900">
                      {formatCurrency(selectedProduct.delivery_cost)}
                    </span>
                  </div>
                )}
              </div>

              {/* Order Form */}
              <div className="space-y-4">
                 {/* Info Banner */}
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                  <p className="text-xs text-blue-700">
                    💡 This order will use the same pricing and supplier as your last order for this product.
                  </p>
                </div>
                {/* Quantity */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Quantity *
                  </label>
                  <input
                    type="number"
                    min="1"
                    step="1"
                    value={orderDetails.quantity}
                    onChange={(e) => setOrderDetails({ ...orderDetails, quantity: e.target.value })}
                    placeholder="Enter quantity"
                    className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                  />
                </div>

                {/* Delivery Date */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Delivery Date *
                  </label>
                  <input
                    type="date"
                    value={orderDetails.delivery_date}
                    onChange={(e) => setOrderDetails({ ...orderDetails, delivery_date: e.target.value })}
                    min={new Date().toISOString().split('T')[0]}
                    className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                  />
                </div>

                {/* Delivery Time */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Delivery Time (Optional)
                  </label>
                  <input
                    type="time"
                    value={orderDetails.delivery_time}
                    onChange={(e) => setOrderDetails({ ...orderDetails, delivery_time: e.target.value })}
                    className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                  />
                </div>

                {/* PO Number */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    PO Number (Optional)
                  </label>
                  <input
                    type="text"
                    value={orderDetails.po_number}
                    onChange={(e) => setOrderDetails({ ...orderDetails, po_number: e.target.value })}
                    placeholder="Enter PO number"
                    className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                  />
                </div>

                {/* Delivery Method */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Delivery Method
                  </label>
                  <select
                    value={orderDetails.delivery_method}
                    onChange={(e) => setOrderDetails({ ...orderDetails, delivery_method: e.target.value })}
                    className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                  >
                    <option value="Other">Other</option>
                    <option value="Tipper">Tipper</option>
                    <option value="Agitator">Agitator</option>
                    <option value="Pump">Pump</option>
                    <option value="Ute">Ute</option>
                  </select>
                </div>

                {/* Special Notes */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Special Notes (Optional)
                  </label>
                  <textarea
                    value={orderDetails.special_notes}
                    onChange={(e) => setOrderDetails({ ...orderDetails, special_notes: e.target.value })}
                    placeholder="Any special instructions..."
                    rows={3}
                    className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                  />
                </div>
              </div>

              {/* Estimated Total */}
              {orderDetails.quantity && parseFloat(orderDetails.quantity) > 0 && (
                <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm font-medium text-blue-900">Item Cost:</span>
                    <span className="text-lg font-bold text-blue-700">
                      {formatCurrency(selectedProduct.unit_price * parseFloat(orderDetails.quantity))}
                    </span>
                  </div>
                  {selectedProduct.delivery_cost > 0 && (
                    <div className="flex items-center justify-between text-sm text-blue-800">
                      <span>+ Delivery:</span>
                      <span>{formatCurrency(selectedProduct.delivery_cost)}</span>
                    </div>
                  )}
                  <div className="flex items-center justify-between mt-2 pt-2 border-t border-blue-200">
                    <span className="text-sm font-medium text-blue-900">Estimated Total:</span>
                    <span className="text-xl font-bold text-blue-700">
                      {formatCurrency(
                        (selectedProduct.unit_price * parseFloat(orderDetails.quantity)) + 
                        selectedProduct.delivery_cost
                      )}
                    </span>
                  </div>
                  <p className="text-xs text-blue-700 mt-2">
                    * Final price will be calculated with margins and taxes
                  </p>
                </div>
              )}
            </div>

            {/* Action Buttons */}
            <div className="flex gap-3 mt-6">
              <button
                onClick={() => setShowOrderModal(false)}
                className="flex-1 px-4 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium"
              >
                Cancel
              </button>
              <button
                onClick={handleSubmitOrder}
                className="flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
              >
                Place Order
              </button>
            </div>
          </div>
        </div>
      )}
    </DashboardLayout>
  );
};

export default ProjectDetails;
/* FILE: src/pages/client/projects/ProjectEdit.tsx */
// src/pages/client/projects/ProjectEdit.tsx
import { useParams, useNavigate } from 'react-router-dom';
import { ArrowLeft, Loader2 } from 'lucide-react';
import toast from 'react-hot-toast';

import { useProject, useUpdateProject } from '../../../features/projects/hooks';
import ProjectForm from '../../../features/components/ProjectForm';
import DashboardLayout from '../../../components/layout/DashboardLayout';
import { clientMenuItems } from '../../../utils/menuItems';

export default function ProjectEdit() {
  const { id } = useParams();
  const navigate = useNavigate();
  const projectId = id ? parseInt(id, 10) : undefined;
  
  const { data, isLoading, error } = useProject(projectId);
  const mut = useUpdateProject(projectId!);

  if (isLoading) {
    return (
      <DashboardLayout menuItems={clientMenuItems}>
        <div className="flex items-center justify-center h-64">
          <Loader2 className="animate-spin text-primary-600" size={48} />
        </div>
      </DashboardLayout>
    );
  }

  if (error || !data) {
    return (
      <DashboardLayout menuItems={clientMenuItems}>
        <div className="text-center text-red-600 py-8">
          Failed to load project
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout menuItems={clientMenuItems}>
      <div className="max-w-4xl mx-auto space-y-6">
        {/* Header with Back Button */}
        <div className="flex items-center justify-between">
          <button
            onClick={() => navigate(`/client/projects/${id}`)}
            className="flex items-center gap-2 text-secondary-600 hover:text-primary-600 transition-colors"
          >
            <ArrowLeft size={20} />
            Back to Project Details
          </button>
        </div>

        {/* Form Card */}
        <div className="bg-white rounded-2xl shadow-card p-8">
          <div className="mb-8">
            <h1 className="text-3xl font-bold text-secondary-900">Edit Project</h1>
            <p className="text-secondary-600 mt-2">Update project information and delivery location</p>
          </div>

          <ProjectForm
            initial={{
              name: data.name,
              site_contact_name: data.site_contact_name || undefined,
              site_contact_phone: data.site_contact_phone || undefined,
              site_instructions: data.site_instructions || undefined,
              delivery_address: data.delivery_address || undefined,
              delivery_lat: data.delivery_lat || undefined,
              delivery_long: data.delivery_long || undefined,
            }}
            onSubmit={(v) => mut.mutate(v, {
              onSuccess: () => {
                toast.success('✅ Project updated successfully!');
                navigate(`/client/projects/${id}`);
              },
              onError: (e: any) => {
                toast.error(e?.message || 'Failed to update project');
              },
            })}
            submitting={mut.isPending}
          />
        </div>
      </div>
    </DashboardLayout>
  );
}
/* FILE: src/pages/client/projects/ProjectsList.tsx */
/* FILE: src/pages/client/projects/ProjectsList.tsx */
// src/pages/client/projects/ProjectsList.tsx
import { useState, useEffect } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';
import { useQuery, useMutation, useQueryClient, keepPreviousData } from '@tanstack/react-query';
import { 
  Search, 
  Eye, 
  Edit2, 
  Trash2,
  ChevronLeft,
  ChevronRight,
  Plus,
  Calendar,
  User,
  Phone,
  Filter,
  X,
  Loader2,
  Package,
  DollarSign,
  ShoppingCart,
  MapPin,
} from 'lucide-react';
import toast from 'react-hot-toast';

import DashboardLayout from '../../../components/layout/DashboardLayout';
import Button from '../../../components/common/Buttons';
import type { Paginated, ProjectDTO } from '../../../api/handlers/projects.api';
import { projectsAPI } from '../../../api/handlers/projects.api';
import { clientMenuItems } from '../../../utils/menuItems';

// Helper function to format date
const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
};

// Helper to format currency
const formatCurrency = (amount: number) => {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
  }).format(amount);
};

// Helper to get order status badge color
const getOrderStatusColor = (status: string) => {
  const colors: Record<string, string> = {
    'Payment Requested': 'bg-amber-50 text-amber-700 border-amber-200',
    'Delivered': 'bg-emerald-50 text-emerald-700 border-emerald-200',
    'Cancelled': 'bg-rose-50 text-rose-700 border-rose-200',
    'Supplier Missing': 'bg-orange-50 text-orange-700 border-orange-200',
    'Supplier Assigned': 'bg-blue-50 text-blue-700 border-blue-200',
    'Requested': 'bg-violet-50 text-violet-700 border-violet-200',
    'On Hold': 'bg-slate-50 text-slate-700 border-slate-200',
    'In Transit': 'bg-indigo-50 text-indigo-700 border-indigo-200',
  };
  return colors[status] || 'bg-gray-50 text-gray-700 border-gray-200';
};

const ProjectsList = () => {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const [searchParams, setSearchParams] = useSearchParams();

  // State
  const [showFilters, setShowFilters] = useState(false);
  const [localSearch, setLocalSearch] = useState(searchParams.get('search') || '');
  
  // Filters from URL
  const page = Number(searchParams.get('page')) || 1;
  const per_page = Number(searchParams.get('per_page')) || 10;
  const search = searchParams.get('search') || '';
  const sort = searchParams.get('sort') || 'created_at';
  const dir = searchParams.get('dir') || 'desc';
  const order_status = searchParams.get('order_status') || '';
  const delivery_date_from = searchParams.get('delivery_date_from') || '';
  const delivery_date_to = searchParams.get('delivery_date_to') || '';

  // Debounce search
  useEffect(() => {
    const timer = setTimeout(() => {
      if (localSearch !== search) {
        updateParams({ search: localSearch, page: '1' });
      }
    }, 500);
    return () => clearTimeout(timer);
  }, [localSearch]);

  // Fetch projects
  const { data, isLoading, error } = useQuery<Paginated<ProjectDTO>>({
    queryKey: ['projects', { page, per_page, search, sort, dir, order_status, delivery_date_from, delivery_date_to }],
    queryFn: () => projectsAPI.list({ page, per_page, search, sort, dir, order_status, delivery_date_from, delivery_date_to }),
    placeholderData: keepPreviousData,
  });

    // Delete mutation
  const deleteMutation = useMutation({
    mutationFn: projectsAPI.remove,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['projects'] });
      toast.success('✅ Project deleted successfully');
    },
    onError: (error: any) => {
      toast.error(error.message || 'Failed to delete project');
    },
  });

  // Helper to update URL params
  const updateParams = (newParams: Record<string, string>) => {
    const current = Object.fromEntries(searchParams);
    const updated = { ...current, ...newParams };
    
    // Remove empty params
    Object.keys(updated).forEach(key => {
      if (!updated[key]) delete updated[key];
    });
    
    setSearchParams(updated);
  };

  // Clear all filters
  const clearFilters = () => {
    setLocalSearch('');
    setSearchParams({ page: '1', per_page: String(per_page) });
  };

  // Handle delete
  const handleDelete = (id: number, name: string) => {
    if (window.confirm(`Are you sure you want to delete "${name}"?`)) {
      deleteMutation.mutate(id);
    }
  };

  const projects = data?.data ?? [];
  const pagination = {
    currentPage: data?.meta?.page ?? 1,
    lastPage: Math.ceil((data?.meta?.total ?? 0) / (data?.meta?.per_page ?? per_page)),
    total: data?.meta?.total ?? 0,
    from: ((page - 1) * per_page) + 1,
    to: Math.min(page * per_page, data?.meta?.total ?? 0),
  };

  const hasActiveFilters = search || order_status || delivery_date_from || delivery_date_to || sort !== 'created_at' || dir !== 'desc';

  return (
    <DashboardLayout menuItems={clientMenuItems}>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold text-gray-900">Projects</h1>
            <p className="text-gray-600 mt-1">Manage your construction projects</p>
          </div>
          <Button
            onClick={() => navigate('/client/projects/create')}
            variant="primary"
            fullWidth={false}
          >
            <Plus size={20} />
            New Project
          </Button>
        </div>

        {/* Main Card */}
        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          {/* Filters Bar */}
          <div className="border-b border-gray-200 p-6">
            <div className="flex items-center gap-4 mb-4">
              {/* Search */}
              <div className="flex-1 relative">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
                <input
                  type="text"
                  placeholder="Search projects..."
                  value={localSearch}
                  onChange={(e) => setLocalSearch(e.target.value)}
                  className="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                />
              </div>

              {/* Sort */}
              <select
                value={`${sort}-${dir}`}
                onChange={(e) => {
                  const [newSort, newDir] = e.target.value.split('-');
                  updateParams({ sort: newSort, dir: newDir, page: '1' });
                }}
                className="px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
              >
                <option value="created_at-desc">Newest First</option>
                <option value="created_at-asc">Oldest First</option>
                <option value="name-asc">Name (A-Z)</option>
                <option value="name-desc">Name (Z-A)</option>
              </select>

              {/* Filter Toggle */}
              <button
                onClick={() => setShowFilters(!showFilters)}
                className={`px-4 py-2.5 rounded-lg border flex items-center gap-2 transition-all ${
                  showFilters || hasActiveFilters
                    ? 'bg-blue-50 border-blue-300 text-blue-700'
                    : 'border-gray-300 text-gray-700 hover:bg-gray-50'
                }`}
              >
                <Filter size={20} />
                Filters
                {hasActiveFilters && (
                  <span className="w-2 h-2 bg-blue-500 rounded-full"></span>
                )}
              </button>
            </div>

            {/* Advanced Filters */}
            {showFilters && (
              <div className="pt-4 border-t border-gray-200 space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Order Status
                    </label>
                    <select
                      value={order_status}
                      onChange={(e) => updateParams({ order_status: e.target.value, page: '1' })}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                    >
                      <option value="">All Statuses</option>
                      <option value="Requested">Requested</option>
                      <option value="Supplier Assigned">Supplier Assigned</option>
                      <option value="Payment Requested">Payment Requested</option>
                      <option value="On Hold">On Hold</option>
                      <option value="In Transit">In Transit</option>
                      <option value="Delivered">Delivered</option>
                      <option value="Cancelled">Cancelled</option>
                      <option value="Supplier Missing">Supplier Missing</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Delivery Date From
                    </label>
                    <input
                      type="date"
                      value={delivery_date_from}
                      onChange={(e) => updateParams({ delivery_date_from: e.target.value, page: '1' })}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Delivery Date To
                    </label>
                    <input
                      type="date"
                      value={delivery_date_to}
                      onChange={(e) => updateParams({ delivery_date_to: e.target.value, page: '1' })}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                    />
                  </div>
                </div>

                {hasActiveFilters && (
                  <button
                    onClick={clearFilters}
                    className="flex items-center gap-2 text-sm text-red-600 hover:text-red-700 font-medium"
                  >
                    <X size={16} />
                    Clear all filters
                  </button>
                )}
              </div>
            )}
          </div>

          {/* Content */}
          <div className="p-6">
            {isLoading ? (
              <div className="flex flex-col items-center justify-center py-16">
                <Loader2 className="w-10 h-10 animate-spin text-blue-600 mb-3" />
                <p className="text-gray-500">Loading projects...</p>
              </div>
            ) : error ? (
              <div className="flex flex-col items-center justify-center py-12 text-red-500">
                <p className="mb-2">Failed to load projects</p>
                <button 
                  onClick={() => queryClient.invalidateQueries({queryKey:['projects']})}
                  className="text-sm text-blue-600 hover:underline"
                >
                  Try again
                </button>
              </div>
            ) : projects.length === 0 ? (
              <div className="flex flex-col items-center justify-center py-12 text-gray-500">
                <p className="mb-2">No projects found</p>
                {hasActiveFilters ? (
                  <button 
                    onClick={clearFilters}
                    className="text-sm text-blue-600 hover:underline"
                  >
                    Clear filters
                  </button>
                ) : (
                  <Button
                    onClick={() => navigate('/client/projects/create')}
                    variant="outline"
                    fullWidth={false}
                    className="mt-4"
                  >
                    <Plus size={18} />
                    Create Your First Project
                  </Button>
                )}
              </div>
            ) : (
              <div className="grid grid-cols-1 gap-5">
                {projects.map((project) => {
                  // Calculate avg order value on frontend
                  const avgOrderValue = project.total_orders > 0 
                    ? project.total_order_amount / project.total_orders 
                    : 0;

                  return (
                    <div
                      key={project.id}
                      className="border border-gray-200 rounded-lg hover:shadow-md hover:border-gray-300 transition-all duration-200 overflow-hidden bg-white"
                    >
                      {/* Project Header */}
                      <div className="bg-gradient-to-r from-slate-50 to-slate-100 p-5 border-b border-gray-200">
                        <div className="flex items-start justify-between gap-4">
                          <div className="flex-1 min-w-0">
                            <h3 className="text-lg font-semibold text-gray-900 mb-2">
                              {project.name}
                            </h3>
                            
                            <div className="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-gray-600">
                              {project.delivery_address && (
                                <div className="flex items-center gap-1.5">
                                  <MapPin size={15} className="text-gray-400 flex-shrink-0" />
                                  <span className="truncate">{project.delivery_address}</span>
                                </div>
                              )}
                              {project.site_contact_name && (
                                <div className="flex items-center gap-1.5">
                                  <User size={15} className="text-gray-400 flex-shrink-0" />
                                  <span>{project.site_contact_name}</span>
                                </div>
                              )}
                              {project.site_contact_phone && (
                                <div className="flex items-center gap-1.5">
                                  <Phone size={15} className="text-gray-400 flex-shrink-0" />
                                  <span>{project.site_contact_phone}</span>
                                </div>
                              )}
                            </div>
                          </div>

                          {/* Action Buttons */}
                          <div className="flex items-center gap-2 flex-shrink-0">
                            <button
                              onClick={() => navigate(`/client/projects/${project.id}`)}
                              className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 font-medium text-sm"
                              title="View Details"
                            >
                              <Eye size={16} />
                              View
                            </button>
                            <button
                              onClick={() => navigate(`/client/projects/${project.id}/edit`)}
                              className="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
                              title="Edit Project"
                            >
                              <Edit2 size={18} />
                            </button>
                            <button
                              onClick={() => handleDelete(project.id, project.name)}
                              disabled={deleteMutation.isPending}
                              className="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors disabled:opacity-50"
                              title="Delete Project"
                            >
                              <Trash2 size={18} />
                            </button>
                          </div>
                        </div>
                      </div>

                      {/* Stats Section */}
                      <div className="p-5">
                        <div className="grid grid-cols-3 gap-4">
                          {/* Total Orders */}
                          <div className="text-center p-4 bg-blue-50 rounded-lg border border-blue-100">
                            <div className="flex items-center justify-center gap-2 mb-1">
                              <ShoppingCart size={16} className="text-blue-600" />
                              <span className="text-xs font-medium text-blue-900">Orders</span>
                            </div>
                            <p className="text-2xl font-bold text-blue-700">{project.total_orders}</p>
                          </div>

                          {/* Total Amount */}
                          <div className="text-center p-4 bg-emerald-50 rounded-lg border border-emerald-100">
                            <div className="flex items-center justify-center gap-2 mb-1">
                              <DollarSign size={16} className="text-emerald-600" />
                              <span className="text-xs font-medium text-emerald-900">Total</span>
                            </div>
                            <p className="text-2xl font-bold text-emerald-700">
                              {formatCurrency(project.total_order_amount)}
                            </p>
                          </div>

                          {/* Average Order */}
                          <div className="text-center p-4 bg-violet-50 rounded-lg border border-violet-100">
                            <div className="flex items-center justify-center gap-2 mb-1">
                              <Package size={16} className="text-violet-600" />
                              <span className="text-xs font-medium text-violet-900">Average</span>
                            </div>
                            <p className="text-2xl font-bold text-violet-700">
                              {formatCurrency(avgOrderValue)}
                            </p>
                          </div>
                        </div>

                        {/* Order Status Breakdown - Only show if data exists */}
                        {project.order_status_breakdown && Object.keys(project.order_status_breakdown).length > 0 && (
                          <div className="mt-4 pt-4 border-t border-gray-200">
                            <div className="flex flex-wrap gap-2">
                              {Object.entries(project.order_status_breakdown).map(([status, count]) => (
                                <span
                                  key={status}
                                  className={`px-3 py-1 rounded-full text-xs font-medium border ${getOrderStatusColor(status)}`}
                                >
                                  {status}: {count}
                                </span>
                              ))}
                            </div>
                          </div>
                        )}

                        {/* Footer Info */}
                        <div className="mt-4 pt-4 border-t border-gray-200 flex items-center justify-between text-xs text-gray-500">
                          <div className="flex items-center gap-1.5">
                            <Calendar size={14} className="text-gray-400" />
                            <span>Created {formatDate(project.created_at)}</span>
                          </div>
                          
                          {project.last_order_date && (
                            <div className="flex items-center gap-1.5">
                              <span>Last order: {formatDate(project.last_order_date)}</span>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>

          {/* Pagination */}
          {!isLoading && projects.length > 0 && (
            <div className="flex items-center justify-between px-6 py-4 border-t border-gray-200 bg-gray-50">
              <div className="flex items-center gap-2">
                <span className="text-sm text-gray-600">
                  Showing {pagination.from} to {pagination.to} of {pagination.total} projects
                </span>
              </div>

              <div className="flex items-center gap-4">
                {/* Per Page */}
                <select
                  value={per_page}
                  onChange={(e) => updateParams({ per_page: e.target.value, page: '1' })}
                  className="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                >
                  <option value={10}>10 per page</option>
                  <option value={25}>25 per page</option>
                  <option value={50}>50 per page</option>
                  <option value={100}>100 per page</option>
                </select>

                {/* Page Navigation */}
                <div className="flex items-center gap-2">
                  <button
                    onClick={() => updateParams({ page: String(page - 1) })}
                    disabled={page === 1}
                    className="p-2 border border-gray-300 rounded-lg hover:bg-white disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                  >
                    <ChevronLeft size={18} />
                  </button>
                  
                  <span className="text-sm text-gray-700 px-3">
                    Page {pagination.currentPage} of {pagination.lastPage}
                  </span>

                  <button
                    onClick={() => updateParams({ page: String(page + 1) })}
                    disabled={page === pagination.lastPage}
                    className="p-2 border border-gray-300 rounded-lg hover:bg-white disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                  >
                    <ChevronRight size={18} />
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </DashboardLayout>
  );
};

export default ProjectsList;
/* FILE: src/pages/public/Login.tsx */
// src/pages/public/Login.tsx
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { useNavigate, Link } from 'react-router-dom';
import { useMutation } from '@tanstack/react-query';
import { Mail, Lock, ArrowRight } from 'lucide-react';
import toast from 'react-hot-toast';
import { useEffect, useRef } from 'react';
import { authAPI } from '../../api/handlers/auth.api';
import { useAuthStore } from '../../store/authStore';
import { loginSchema } from '../../utils/validators';
import type { LoginFormData } from '../../utils/validators';
import Input from '../../components/common/Input';
import Button from '../../components/common/Buttons'; // Changed from Buttons

const Login = () => {
  const navigate = useNavigate();

  // 1) Select stable primitives only. Do NOT do ({ ... }) without shallow.
  const token = useAuthStore((s) => s.token);
  const login = useAuthStore((s) => s.login);

  // 2) Read functions directly when needed to avoid extra deps re-renders.
  const checkAuth = useAuthStore.getState().checkAuth;

  // 3) Prevent re-entrant checks in Strict Mode and during rapid re-renders.
  const checkingRef = useRef(false);

  useEffect(() => {
    if (!token || checkingRef.current) return;

    checkingRef.current = true;
    (async () => {
      const ok = await checkAuth();
      if (ok) {
        const { user } = useAuthStore.getState(); // fresh snapshot after check
        const map: Record<string, string> = {
          admin: '/admin/dashboard',
          client: '/client/dashboard',
          supplier: '/supplier/dashboard',
          accountant: '/admin/dashboard',
          support:'/admin/dashboard'
        };
        navigate(map[user?.role ?? 'client'] || '/login', { replace: true });
      }
      checkingRef.current = false;
    })();
  }, [token, navigate]);

  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<LoginFormData>({
    resolver: zodResolver(loginSchema),
  });

  const loginMutation = useMutation({
  mutationFn: authAPI.login,
  retry: false,
  onSuccess: (data: any) => {
    login(data.user, data.token);
    toast.success(`Welcome back, ${data.user.name}!`);
    const map: Record<string,string> = {
      admin: '/admin/dashboard',
      client: '/client/dashboard',
      supplier: '/supplier/dashboard',
    };
    navigate(map[data.user.role] || '/login');
  },
  onError: (error: any) => {
    toast.error(error?.message || 'Invalid credentials');
  },
});

  const onSubmit = (data: LoginFormData) => {
    loginMutation.mutate(data);
  };

  return (
    <div className="min-h-screen flex">
      {/* Left Side - Branding */}
      <div className="hidden lg:flex lg:w-1/2 bg-gradient-to-br from-primary-500 via-primary-600 to-primary-700 p-12 flex-col justify-between relative overflow-hidden">
        {/* Decorative circles */}
        <div className="absolute top-20 left-20 w-72 h-72 bg-white/10 rounded-full blur-3xl"></div>
        <div className="absolute bottom-20 right-20 w-96 h-96 bg-white/10 rounded-full blur-3xl"></div>
        
        <div className="relative z-10">
          <img
            src="https://demowebportals.com/material_connect/public/assets/img/logo-text.png"
            alt="Material Connect"
            className="h-10 mb-8 brightness-0 invert"
          />
          <h1 className="text-5xl font-bold text-white mb-6 leading-tight">
            Welcome to<br />Material Connect
          </h1>
          <p className="text-xl text-white/90 leading-relaxed">
            Streamline your construction material procurement with intelligent supplier matching and automated ordering.
          </p>
        </div>

        <div className="relative z-10 space-y-6">
          <div className="flex items-start gap-4">
            <div className="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center flex-shrink-0">
              <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <div>
              <h3 className="text-white font-semibold text-lg">Smart Supplier Matching</h3>
              <p className="text-white/80">AI-powered location-based supplier selection</p>
            </div>
          </div>
          <div className="flex items-start gap-4">
            <div className="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center flex-shrink-0">
              <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
            </div>
            <div>
              <h3 className="text-white font-semibold text-lg">Real-time Tracking</h3>
              <p className="text-white/80">Monitor orders from placement to delivery</p>
            </div>
          </div>
        </div>
      </div>

      {/* Right Side - Login Form */}
      <div className="flex-1 flex items-center justify-center p-8 bg-secondary-50">
        <div className="w-full max-w-md">
          {/* Mobile Logo */}
          <div className="lg:hidden text-center mb-8">
            <img
              src="https://demowebportals.com/material_connect/public/assets/img/logo-text.png"
              alt="Material Connect"
              className="h-10 mx-auto mb-4"
            />
          </div>

          <div className="bg-white rounded-2xl shadow-xl p-8 border border-secondary-100">
            <div className="mb-8">
              <h2 className="text-3xl font-bold text-secondary-900 mb-2">Sign In</h2>
              <p className="text-secondary-600">Access your Material Connect account</p>
            </div>

            <form onSubmit={handleSubmit(onSubmit)} className="space-y-5">
              <Input
                label="Email Address"
                type="email"
                placeholder="you@company.com"
                icon={Mail}
                register={register('email')}
                error={errors.email?.message}
                required
              />

              <Input
                label="Password"
                type="password"
                placeholder="Enter your password"
                icon={Lock}
                register={register('password')}
                error={errors.password?.message}
                required
              />

              <div className="flex items-center justify-between text-sm">
                <label className="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" className="w-4 h-4 text-primary-500 rounded border-secondary-300 focus:ring-primary-500" />
                  <span className="text-secondary-600">Remember me</span>
                </label>
                <a href="#" className="text-primary-600 hover:text-primary-700 font-medium">
                  Forgot password?
                </a>
              </div>

              <Button
                type="submit"
                isLoading={loginMutation.isPending}
                disabled={loginMutation.isPending}
              >
                {loginMutation.isPending ? 'Signing in...' : (
                  <>
                    Sign In
                    <ArrowRight size={20} />
                  </>
                )}
              </Button>
            </form>

            <div className="mt-8 pt-6 border-t border-secondary-200">
              <p className="text-center text-sm text-secondary-600 mb-4">
                New to Material Connect?
              </p>
              <div className="grid grid-cols-2 gap-3">
                <Link
                  to="/register/client"
                  className="px-4 py-3 text-sm font-medium text-center text-primary-600 bg-primary-50 rounded-lg hover:bg-primary-100 transition-all hover:scale-105"
                >
                  Register as Client
                </Link>
                <Link
                  to="/register/supplier"
                  className="px-4 py-3 text-sm font-medium text-center text-primary-600 bg-primary-50 rounded-lg hover:bg-primary-100 transition-all hover:scale-105"
                >
                  Register as Supplier
                </Link>
              </div>
            </div>
          </div>

          <p className="text-center text-xs text-secondary-500 mt-6">
            By signing in, you agree to our{' '}
            <a href="#" className="text-primary-600 hover:underline">Terms of Service</a>
            {' '}and{' '}
            <a href="#" className="text-primary-600 hover:underline">Privacy Policy</a>
          </p>
        </div>
      </div>
    </div>
  );
};

export default Login;
/* FILE: src/pages/public/RegisterClient.tsx */
// src/pages/public/RegisterClient.tsx
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { useNavigate, Link } from 'react-router-dom';
import { useMutation } from '@tanstack/react-query';
import { 
  Mail, 
  Lock, 
  User, 
  Phone, 
  Building2, 
  UserPlus,
  ArrowLeft,
  Upload,
  X,
  Check,
  MapPin,
  CreditCard
} from 'lucide-react';
import toast from 'react-hot-toast';
import Autocomplete from 'react-google-autocomplete';

import { authAPI } from '../../api/handlers/auth.api';
import { useAuthStore } from '../../store/authStore';
import type { ClientRegistrationFormData } from '../../utils/validators';
import { clientRegistrationSchema } from '../../utils/validators';
import Input from '../../components/common/Input';
import Button from '../../components/common/Buttons';
import { useState } from 'react';

const RegisterClient = () => {
  const navigate = useNavigate();
  const { login } = useAuthStore();
  const [profileImage, setProfileImage] = useState<File | null>(null);
  const [preview, setPreview] = useState<string | null>(null);
  const [currentStep, setCurrentStep] = useState(1);

  const {
    register,
    handleSubmit,
    formState: { errors },
    setError,
    setValue,
    trigger,
  } = useForm<ClientRegistrationFormData>({
    resolver: zodResolver(clientRegistrationSchema),
  });

  const registerMutation = useMutation({
    mutationFn: authAPI.registerClient,
    onSuccess: (data: any) => {
      login(data.user, data.token);
      toast.success('🎉 Registration successful! Welcome to Material Connect');
      navigate('/client/dashboard');
    },
    onError: (error: any) => {
      if (error.errors && typeof error.errors === 'object') {
        Object.keys(error.errors).forEach((field) => {
          const messages = error.errors[field];
          const message = Array.isArray(messages) ? messages[0] : messages;
          setError(field as any, { type: 'manual', message });
        });
        toast.error('Please fix the errors in the form');
      } else {
        toast.error(error.message || 'Registration failed');
      }
    },
  });

  const handleImageChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      if (!file.type.startsWith('image/')) {
        toast.error('Please select an image file');
        return;
      }
      if (file.size > 2 * 1024 * 1024) {
        toast.error('Image size should be less than 2MB');
        return;
      }
      setProfileImage(file);
      const reader = new FileReader();
      reader.onloadend = () => setPreview(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const clearImage = () => {
    setProfileImage(null);
    setPreview(null);
  };

  const nextStep = async () => {
    const fields = steps[currentStep - 1].fields as Array<keyof ClientRegistrationFormData>;
    const isValid = await trigger(fields);
    if (isValid) {
      setCurrentStep(currentStep + 1);
    }
  };

  const onSubmit = (data: ClientRegistrationFormData) => {
  const submitData = {
    ...data,
    profile_image: profileImage || undefined,
  };
  
  console.log('📤 Submitting client data:', submitData);
  registerMutation.mutate(submitData);
};

  const steps = [
    { number: 1, title: 'Personal Info', fields: ['name', 'email', 'password'] },
    { number: 2, title: 'Contact Details', fields: ['contact_name', 'contact_number', 'company_name'] },
    { number: 3, title: 'Addresses', fields: ['shipping_address', 'billing_address'] },
  ];

  return (
    <div className="min-h-screen bg-gradient-to-br from-secondary-50 to-primary-50/30 py-12 px-4">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <div className="text-center mb-8">
          <Link
            to="/login"
            className="inline-flex items-center gap-2 text-secondary-600 hover:text-primary-600 mb-6 transition-colors"
          >
            <ArrowLeft size={20} />
            Back to Login
          </Link>
          <img
            src="https://demowebportals.com/material_connect/public/assets/img/logo-text.png"
            alt="Material Connect"
            className="h-12 mx-auto mb-4"
          />
          <h1 className="text-4xl font-bold text-secondary-900 mb-2">Create Client Account</h1>
          <p className="text-lg text-secondary-600">Join Material Connect to manage your construction projects</p>
        </div>

        {/* Progress Steps */}
        <div className="mb-8">
          <div className="flex items-center justify-center gap-4">
            {steps.map((step, index) => (
              <div key={step.number} className="flex items-center">
                <div className="flex flex-col items-center">
                  <div className={`
                    w-12 h-12 rounded-full flex items-center justify-center font-semibold transition-all
                    ${currentStep >= step.number 
                      ? 'bg-primary-500 text-white shadow-lg shadow-primary-500/50' 
                      : 'bg-white text-secondary-400 border-2 border-secondary-200'
                    }
                  `}>
                    {currentStep > step.number ? <Check size={20} /> : step.number}
                  </div>
                  <span className={`text-sm mt-2 font-medium ${currentStep >= step.number ? 'text-primary-600' : 'text-secondary-400'}`}>
                    {step.title}
                  </span>
                </div>
                {index < steps.length - 1 && (
                  <div className={`w-16 h-1 mx-4 rounded-full ${currentStep > step.number ? 'bg-primary-500' : 'bg-secondary-200'}`} />
                )}
              </div>
            ))}
          </div>
        </div>

        {/* Form Card */}
        <div className="bg-white rounded-3xl shadow-2xl p-8 border border-secondary-100">
          <form onSubmit={handleSubmit(onSubmit)} className="space-y-8">
            <input type="hidden" {...register('lat', { valueAsNumber: true })} />
  <input type="hidden" {...register('long', { valueAsNumber: true })} />
            {/* Profile Image Upload */}
            {currentStep === 1 && (
              <div className="flex justify-center">
                <div className="relative">
                  {preview ? (
                    <div className="relative">
                      <img 
                        src={preview} 
                        alt="Preview" 
                        className="w-32 h-32 rounded-full object-cover border-4 border-primary-100 shadow-xl"
                      />
                      <button
                        type="button"
                        onClick={clearImage}
                        className="absolute -top-2 -right-2 p-2 bg-error-500 text-white rounded-full hover:bg-error-600 transition-colors shadow-lg"
                      >
                        <X size={16} />
                      </button>
                    </div>
                  ) : (
                    <label className="cursor-pointer group">
                      <input
                        type="file"
                        accept="image/*"
                        onChange={handleImageChange}
                        className="hidden"
                      />
                      <div className="w-32 h-32 rounded-full border-4 border-dashed border-secondary-300 bg-secondary-50 flex flex-col items-center justify-center hover:border-primary-500 hover:bg-primary-50 transition-all group-hover:scale-105">
                        <Upload size={32} className="text-secondary-400 group-hover:text-primary-500 mb-2" />
                        <span className="text-xs text-secondary-500 group-hover:text-primary-600 font-medium">Upload Photo</span>
                      </div>
                    </label>
                  )}
                </div>
              </div>
            )}

            {/* Step 1: Personal Information */}
            {currentStep === 1 && (
              <div className="space-y-5">
                <div className="flex items-center gap-3 mb-6">
                  <div className="w-10 h-10 rounded-lg bg-primary-100 flex items-center justify-center">
                    <User size={20} className="text-primary-600" />
                  </div>
                  <h3 className="text-xl font-bold text-secondary-900">Personal Information</h3>
                </div>

                <Input
                  label="Full Name"
                  type="text"
                  placeholder="John Doe"
                  icon={User}
                  register={register('name')}
                  error={errors.name?.message}
                  required
                />

                <Input
                  label="Email Address"
                  type="email"
                  placeholder="john@company.com"
                  icon={Mail}
                  register={register('email')}
                  error={errors.email?.message}
                  required
                />

                <Input
                  label="Password"
                  type="password"
                  placeholder="Minimum 6 characters"
                  icon={Lock}
                  register={register('password')}
                  error={errors.password?.message}
                  required
                />
              </div>
            )}

            {/* Step 2: Contact Information */}
            {currentStep === 2 && (
              <div className="space-y-5">
                <div className="flex items-center gap-3 mb-6">
                  <div className="w-10 h-10 rounded-lg bg-primary-100 flex items-center justify-center">
                    <Phone size={20} className="text-primary-600" />
                  </div>
                  <h3 className="text-xl font-bold text-secondary-900">Contact Information</h3>
                </div>

                <Input
                  label="Contact Person Name"
                  type="text"
                  placeholder="Jane Smith"
                  icon={User}
                  register={register('contact_name')}
                  error={errors.contact_name?.message}
                  required
                />

                <Input
                  label="Contact Number"
                  type="tel"
                  placeholder="+92 300 1234567"
                  icon={Phone}
                  register={register('contact_number')}
                  error={errors.contact_number?.message}
                  required
                />

                <Input
                  label="Company Name (Optional)"
                  type="text"
                  placeholder="ABC Construction Ltd."
                  icon={Building2}
                  register={register('company_name')}
                  error={errors.company_name?.message}
                />
              </div>
            )}

            {/* Step 3: Address Information with Google Autocomplete */}
            {currentStep === 3 && (
              <div className="space-y-5">
                <div className="flex items-center gap-3 mb-6">
                  <div className="w-10 h-10 rounded-lg bg-primary-100 flex items-center justify-center">
                    <MapPin size={20} className="text-primary-600" />
                  </div>
                  <h3 className="text-xl font-bold text-secondary-900">Address Information</h3>
                </div>

                {/* Shipping Address + coords */}
                <div className="space-y-2">
                  <label className="block text-sm font-medium text-secondary-700">
                    Shipping Address <span className="text-error-500">*</span>
                  </label>
                  <div className="relative">
                    <MapPin className="absolute left-3 top-3.5 text-secondary-400 z-10" size={20} />
                    <Autocomplete
                      apiKey={import.meta.env.VITE_GOOGLE_MAPS_API_KEY}
                      onPlaceSelected={(place: any) => {
                        if (place.formatted_address) {
                          setValue('shipping_address', place.formatted_address);
                          trigger('shipping_address');
                        }
                        if (place.geometry?.location) {
                          const lat = place.geometry.location.lat();
                          const lng = place.geometry.location.lng();
                          setValue('lat', lat);
                          setValue('long', lng);
                          trigger(['lat', 'long']);
                        }
                      }}
                      options={{ types: ['address'], componentRestrictions: { country: 'au' } }}
                      className={`
                        w-full pl-10 pr-4 py-3 rounded-lg border-2 transition-all
                        ${errors.shipping_address
                          ? 'border-error-500 focus:border-error-500 focus:ring-error-500'
                          : 'border-secondary-200 focus:border-primary-500 focus:ring-primary-500'}
                        focus:outline-none focus:ring-2 focus:ring-opacity-20
                      `}
                      placeholder="Start typing your address..."
                      {...register('shipping_address')}
                    />
                  </div>
                  {errors.shipping_address && (
                    <p className="text-sm text-error-500">{errors.shipping_address.message}</p>
                  )}
                </div>

                {/* Billing Address input (plain text or use another Autocomplete if you prefer) */}
                <div className="space-y-2">
                  <label className="block text-sm font-medium text-secondary-700">
                    Billing Address <span className="text-error-500">*</span>
                  </label>
                  <Input
                    label=""            // hidden label, we already show above
                    type="text"
                    placeholder="Same as shipping or enter a different address"
                    icon={CreditCard}
                    register={register('billing_address')}
                    error={errors.billing_address?.message}
                    required
                  />
                </div>
              </div>
            )}

            {/* Navigation Buttons */}
            <div className="flex gap-4 pt-6 border-t border-secondary-200">
              {currentStep > 1 && (
                <Button
                  type="button"
                  variant="outline"
                  onClick={() => setCurrentStep(currentStep - 1)}
                  fullWidth={false}
                  className="flex-1"
                >
                  <ArrowLeft size={20} />
                  Previous
                </Button>
              )}
              
              {currentStep < 3 ? (
                <Button
                  type="button"
                  onClick={nextStep}
                  fullWidth={currentStep === 1}
                  className={currentStep > 1 ? 'flex-1' : ''}
                >
                  Continue
                  <Check size={20} />
                </Button>
              ) : (
                <Button
                  type="submit"
                  isLoading={registerMutation.isPending}
                  disabled={registerMutation.isPending}
                  className="flex-1"
                >
                  <UserPlus size={20} />
                  {registerMutation.isPending ? 'Creating Account...' : 'Create Account'}
                </Button>
              )}
            </div>

            {/* Login Link */}
            <p className="text-center text-sm text-secondary-600 pt-4">
              Already have an account?{' '}
              <Link to="/login" className="text-primary-600 hover:text-primary-700 font-semibold">
                Sign In
              </Link>
            </p>
          </form>
        </div>
      </div>
    </div>
  );
};

export default RegisterClient;
/* FILE: src/pages/public/RegisterSupplier.tsx */
// src/pages/public/RegisterSupplier.tsx
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { useNavigate, Link } from 'react-router-dom';
import { useMutation } from '@tanstack/react-query';
import { 
  Mail, 
  Lock, 
  User, 
  Phone, 
  Building2, 
  MapPin, 
  UserPlus,
  ArrowLeft
} from 'lucide-react';
import toast from 'react-hot-toast';
import Autocomplete from 'react-google-autocomplete';
import { useState } from 'react';

import { authAPI } from '../../api/handlers/auth.api';
import { useAuthStore } from '../../store/authStore';
import { supplierRegistrationSchema } from '../../utils/validators';
import type { SupplierRegistrationFormData } from '../../utils/validators';
import Input from '../../components/common/Input';
import Button from '../../components/common/Buttons';
import ImageUpload from '../../components/common/ImageUpload';

const RegisterSupplier = () => {
  const navigate = useNavigate();
  const { login } = useAuthStore();
  const [profileImage, setProfileImage] = useState<File | null>(null);

  const {
    register,
    handleSubmit,

    formState: { errors },
    setError,
    setValue,
  } = useForm<SupplierRegistrationFormData>({
    resolver: zodResolver(supplierRegistrationSchema),
  });



  const registerMutation = useMutation({
    mutationFn: authAPI.registerSupplier,
    onSuccess: (data: any) => {
      login(data.user, data.token);
      toast.success('🎉 Registration successful! Welcome to Material Connect');
      navigate('/supplier/dashboard');
    },
    onError: (error: any) => {
      if (error.errors && typeof error.errors === 'object') {
        Object.keys(error.errors).forEach((field) => {
          const messages = error.errors[field];
          const message = Array.isArray(messages) ? messages[0] : messages;
          setError(field as any, {
            type: 'manual',
            message: message,
          });
        });
        toast.error('Please fix the errors in the form');
      } else {
        toast.error(error.message || 'Registration failed');
      }
    },
  });

  // ✅ FIXED: Pass data directly to API (FormData creation happens in API handler)
  const onSubmit = (data: SupplierRegistrationFormData) => {
    const submitData = {
      ...data,
      profile_image: profileImage || undefined,
    };
    
    console.log('📤 Submitting data:', submitData);
    registerMutation.mutate(submitData);
  };


  const profileImageError =
  typeof errors.profile_image?.message === 'string'
    ? errors.profile_image.message
    : undefined;

  return (
    <div className="min-h-screen bg-gradient-to-br from-primary-50 via-white to-secondary-50 py-12 px-4">
      <div className="max-w-2xl mx-auto">
        {/* Back Button */}
        <Link
          to="/login"
          className="inline-flex items-center gap-2 text-secondary-600 hover:text-primary-600 mb-6 transition-colors"
        >
          <ArrowLeft size={20} />
          Back to Login
        </Link>

        {/* Header */}
        <div className="text-center mb-8">
          <img
            src="https://demowebportals.com/material_connect/public/assets/img/logo-text.png"
            alt="Material Connect"
            className="h-12 mx-auto mb-4"
          />
          <h1 className="text-3xl font-bold text-secondary-900">Create Supplier Account</h1>
          <p className="text-secondary-600 mt-2">Join our network and start supplying materials</p>
        </div>

        {/* Registration Form */}
        <div className="bg-white rounded-2xl shadow-card p-8">
          <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
            {/* Profile Image */}
            
            <ImageUpload
              label="Profile Image (Optional)"
              onChange={setProfileImage}
              error={profileImageError}
            />

            {/* Personal Information Section */}
            <div className="space-y-4">
              <h3 className="text-lg font-semibold text-secondary-900 border-b pb-2">
                Personal Information
              </h3>

              <Input
                label="Full Name"
                type="text"
                placeholder="John Doe"
                icon={User}
                register={register('name')}
                error={errors.name?.message}
                required
              />

              <Input
                label="Email Address"
                type="email"
                placeholder="supplier@example.com"
                icon={Mail}
                register={register('email')}
                error={errors.email?.message}
                required
              />

              <Input
                label="Password"
                type="password"
                placeholder="••••••••"
                icon={Lock}
                register={register('password')}
                error={errors.password?.message}
                required
              />
            </div>

            {/* Business Information Section */}
            <div className="space-y-4">
              <h3 className="text-lg font-semibold text-secondary-900 border-b pb-2">
                Business Information
              </h3>

              <Input
                label="Company Name"
                type="text"
                placeholder="ABC Materials Supplier"
                icon={Building2}
                register={register('company_name')}
                error={errors.company_name?.message}
                required
              />

              <Input
                label="Contact Person Name"
                type="text"
                placeholder="Jane Smith"
                icon={User}
                register={register('contact_name')}
                error={errors.contact_name?.message}
                required
              />

              <Input
                label="Contact Number"
                type="tel"
                placeholder="+61 400 123 456" 
                icon={Phone}
                register={register('contact_number')}
                error={errors.contact_number?.message}
                required
              />
            </div>

            {/* Location (Google Autocomplete) */}
            <div className="space-y-4">
              <h3 className="text-lg font-semibold text-secondary-900 border-b pb-2">
                Business Location
              </h3>

              {/* hidden field bound to RHF */}
              <input type="hidden" {...register('location')} />

              <label className="block text-sm font-medium text-secondary-700">
                Location <span className="text-error-500">*</span>
              </label>
              <div className="relative">
                <MapPin className="absolute left-3 top-3.5 text-secondary-400 z-10" size={20} />
                <Autocomplete
                  apiKey={import.meta.env.VITE_GOOGLE_MAPS_API_KEY}
                  onPlaceSelected={(place: any) => {
                    const addr = place?.formatted_address ?? '';
                    setValue('location', addr, { shouldValidate: true, shouldDirty: true });
                  }}
                  options={{ types: ['address'], componentRestrictions: { country: 'au' } }}
                  className={`
                    w-full pl-10 pr-4 py-3 rounded-lg border-2 transition-all
                    ${errors.location
                      ? 'border-error-500 focus:border-error-500 focus:ring-error-500'
                      : 'border-secondary-200 focus:border-primary-500 focus:ring-primary-500'}
                    focus:outline-none focus:ring-2 focus:ring-opacity-20
                  `}
                  placeholder="Start typing your business address..."
                />
              </div>
              {errors.location && <p className="text-sm text-error-500">{errors.location.message}</p>}
            </div>

            {/* Submit Button */}
            <Button
              type="submit"
              isLoading={registerMutation.isPending}
              disabled={registerMutation.isPending}
            >
              <UserPlus size={20} />
              {registerMutation.isPending ? 'Creating Account...' : 'Create Supplier Account'}
            </Button>

            {/* Login Link */}
            <p className="text-center text-sm text-secondary-600">
              Already have an account?{' '}
              <Link to="/login" className="text-primary-600 hover:text-primary-700 font-medium">
                Sign In
              </Link>
            </p>
          </form>
        </div>
      </div>
    </div>
  );
};

export default RegisterSupplier;
/* FILE: src/pages/shared/ProfileSettings.tsx */
// src/pages/shared/ProfileSettings.tsx
import { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { useMutation } from '@tanstack/react-query';
import { 
  User, 
  Mail, 
  Phone, 
  Building2, 
  MapPin, 
  Save,
  Camera,
  X,
  Truck,
} from 'lucide-react';
import toast from 'react-hot-toast';
import Autocomplete from 'react-google-autocomplete';

import { profileAPI } from '../../api/handlers/profile.api';
import { useAuthStore } from '../../store/authStore';
import { profileUpdateSchema } from '../../utils/validators';
import type { ProfileUpdateFormData } from '../../utils/validators';
import Input from '../../components/common/Input';
import Button from '../../components/common/Buttons';
import ChangePasswordSection from '../../components/profile/ChangePasswordSection';
import DashboardLayout from '../../components/layout/DashboardLayout';
import { supplierMenuItems, clientMenuItems, adminMenuItems} from '../../utils/menuItems';

const ProfileSettings = () => {
  const { user, updateUser } = useAuthStore();
  const [previewImage, setPreviewImage] = useState<string | null>(
    user?.profile_image ? `${import.meta.env.VITE_IMAGE_BASE_URL}${user.profile_image}` : null
  );
  const [imageFile, setImageFile] = useState<File | null>(null);
  const [locationCoords, setLocationCoords] = useState<{ lat: number; lng: number } | null>(
    user?.lat && user?.long ? { lat: user.lat, lng: user.long } : null
  );

  const {
    register,
    handleSubmit,
    formState: { errors, dirtyFields },
    setValue,
    reset,
  } = useForm<ProfileUpdateFormData>({
    resolver: zodResolver(profileUpdateSchema),
  });

  // // Refetch user data on mount to ensure fresh data
  // const { refetch } = useQuery({
  //   queryKey: ['currentUser'],
  //   queryFn: profileAPI.getCurrentUser,
  //   onSuccess: (data: any) => {
  //     updateUser(data.user);
  //   },
  // });

  // ✅ Update form values whenever user data changes (including company)
  useEffect(() => {
    if (user) {
      reset({
        name: user.name || '',
        email: user.email || '',
        contact_name: user.contact_name || '',
        contact_number: user.contact_number || '',
        company_name: user.company?.name || '',
        shipping_address: user.shipping_address || '',
        billing_address: user.billing_address || '',
        location: user.location || '',
        delivery_radius: user.delivery_radius || undefined,
      });

      // Update location coords if available
      if (user.lat && user.long) {
        setLocationCoords({ lat: user.lat, lng: user.long });
      }

      // Update preview image if available
      if (user.profile_image) {
        setPreviewImage(`${import.meta.env.VITE_IMAGE_BASE_URL}${user.profile_image}`);
      }
    }
  }, [user, reset]);

  const updateProfileMutation = useMutation({
    mutationFn: profileAPI.updateProfile,
    onSuccess: (data) => {
      updateUser(data.user);
      toast.success('✅ Profile updated successfully!');
      
      // Update preview image if new one was uploaded
      if (data.user.profile_image) {
        setPreviewImage(`${import.meta.env.VITE_IMAGE_BASE_URL}${data.user.profile_image}`);
      }
      
      // ✅ Reset form with updated values including company name
      reset({
        name: data.user.name,
        email: data.user.email,
        contact_name: data.user.contact_name,
        contact_number: data.user.contact_number,
        company_name: data.user.company?.name || '', // ✅ Fixed: Get from company
        shipping_address: data.user.shipping_address,
        billing_address: data.user.billing_address,
        location: data.user.location,
        delivery_radius: data.user.delivery_radius,
      });
      
      setImageFile(null);
    },
    onError: (error: Error) => {
      toast.error(error.message || 'Failed to update profile');
    },
  });

  const handleImageChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      // Validate file type
      if (!file.type.startsWith('image/')) {
        toast.error('Please select an image file');
        return;
      }

      // Validate file size (max 2MB)
      if (file.size > 2 * 1024 * 1024) {
        toast.error('Image size should be less than 2MB');
        return;
      }

      setImageFile(file);
      const reader = new FileReader();
      reader.onloadend = () => {
        setPreviewImage(reader.result as string);
      };
      reader.readAsDataURL(file);
    }
  };

  const clearImage = () => {
    setPreviewImage(user?.profile_image ? `${import.meta.env.VITE_IMAGE_BASE_URL}${user.profile_image}` : null);
    setImageFile(null);
  };

  const handleShippingAddressSelect = (place: any) => {
    if (place.formatted_address) {
      setValue('shipping_address', place.formatted_address, { shouldDirty: true });
    }

    if (place.geometry?.location) {
      const lat = place.geometry.location.lat();
      const lng = place.geometry.location.lng();

      setLocationCoords({ lat, lng });
      setValue('lat', lat, { shouldDirty: true });
      setValue('long', lng, { shouldDirty: true });

      toast.success(`📍 Location updated: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
    }
  };

  const handleSupplierLocationSelect = (place: any) => {
    if (place.formatted_address) {
      setValue('location', place.formatted_address, { shouldDirty: true });
    }
  };

  const onSubmit = (data: ProfileUpdateFormData) => {
    // Build payload with only dirty fields
    const changedData: any = {};

    Object.keys(dirtyFields).forEach((key) => {
      const typedKey = key as keyof ProfileUpdateFormData;
      changedData[key] = data[typedKey];
    });

    // Add image if changed
    if (imageFile) {
      changedData.profile_image = imageFile;
    }

    // Validate: if shipping_address changed for client, lat/lng must be included
    if (
      user?.role === 'client' &&
      dirtyFields.shipping_address &&
      (!changedData.lat || !changedData.long)
    ) {
      toast.error('Please select a valid address with location coordinates');
      return;
    }

    // Check if there are any changes
    if (Object.keys(changedData).length === 0) {
      toast('No changes detected', { icon: 'ℹ️' });
      return;
    }

    updateProfileMutation.mutate(changedData);
  };

  // ✅ Define menu items based on user role
  const getMenuItems = () => {
    if (user?.role === 'client') {
      return clientMenuItems;
    } else if (user?.role === 'supplier') {
      return supplierMenuItems;
    } else if (user?.role === 'admin') {
      return adminMenuItems;
    }
    return [];
  };

  return (
    <DashboardLayout menuItems={getMenuItems()}>
      <div className="max-w-4xl mx-auto">{/* Header */}
        <div className="mb-8">
          <h1 className="text-3xl font-bold text-secondary-900">Profile Settings</h1>
          <p className="text-secondary-600 mt-2">
            Manage your account information and preferences
          </p>
        </div>

        {/* Main Form Card */}
        <div className="bg-white rounded-2xl shadow-card p-8 mb-6">
          <form onSubmit={handleSubmit(onSubmit)} className="space-y-8">
            {/* Profile Image Section */}
            <div>
              <label className="block text-sm font-medium text-secondary-700 mb-4">
                Profile Photo
              </label>
              <div className="flex items-center gap-6">
                {/* Image Preview */}
                <div className="relative">
                  {previewImage ? (
                    <div className="relative w-24 h-24 rounded-full overflow-hidden border-4 border-secondary-200">
                      <img
                        src={previewImage}
                        alt="Profile"
                        className="w-full h-full object-cover"
                      />
                      {imageFile && (
                        <button
                          type="button"
                          onClick={clearImage}
                          className="absolute -top-2 -right-2 p-1.5 bg-error-500 text-white rounded-full hover:bg-error-600 transition-colors shadow-lg"
                        >
                          <X size={14} />
                        </button>
                      )}
                    </div>
                  ) : (
                    <div className="w-24 h-24 rounded-full border-4 border-dashed border-secondary-300 bg-secondary-50 flex items-center justify-center">
                      <User size={32} className="text-secondary-400" />
                    </div>
                  )}
                </div>

                {/* Upload Button */}
                <div className="flex-1">
                  <label className="cursor-pointer">
                    <input
                      type="file"
                      accept="image/*"
                      onChange={handleImageChange}
                      className="hidden"
                    />
                    <div className="inline-flex items-center gap-2 px-4 py-2.5 bg-primary-50 text-primary-600 rounded-lg hover:bg-primary-100 transition-all font-medium">
                      <Camera size={18} />
                      {previewImage ? 'Change Photo' : 'Upload Photo'}
                    </div>
                  </label>
                  <p className="text-xs text-secondary-500 mt-2">
                    PNG, JPG, GIF up to 2MB
                  </p>
                </div>
              </div>
            </div>

            {/* Personal Information */}
            <div className="space-y-5">
              <div className="flex items-center gap-3 pb-3 border-b border-secondary-200">
                <div className="w-10 h-10 rounded-lg bg-primary-100 flex items-center justify-center">
                  <User size={20} className="text-primary-600" />
                </div>
                <h3 className="text-lg font-semibold text-secondary-900">
                  Personal Information
                </h3>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                <Input
                  label="Full Name"
                  type="text"
                  placeholder="John Doe"
                  icon={User}
                  register={register('name')}
                  error={errors.name?.message}
                />

                <Input
                  label="Email Address"
                  type="email"
                  placeholder="john@example.com"
                  icon={Mail}
                  register={register('email')}
                  error={errors.email?.message}
                />
              </div>
            </div>

            {/* Contact Details */}
            <div className="space-y-5">
              <div className="flex items-center gap-3 pb-3 border-b border-secondary-200">
                <div className="w-10 h-10 rounded-lg bg-primary-100 flex items-center justify-center">
                  <Phone size={20} className="text-primary-600" />
                </div>
                <h3 className="text-lg font-semibold text-secondary-900">
                  Contact Details
                </h3>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                <Input
                  label="Contact Person"
                  type="text"
                  placeholder="Jane Smith"
                  icon={User}
                  register={register('contact_name')}
                  error={errors.contact_name?.message}
                />

                <Input
                  label="Contact Number"
                  type="tel"
                  placeholder="+92 300 1234567"
                  icon={Phone}
                  register={register('contact_number')}
                  error={errors.contact_number?.message}
                />
              </div>

              <Input
                label="Company Name"
                type="text"
                placeholder="ABC Construction Ltd."
                icon={Building2}
                register={register('company_name')}
                error={errors.company_name?.message}
              />
            </div>

            {/* Client-Specific: Address Information */}
            {user?.role === 'client' && (
              <div className="space-y-5">
                <div className="flex items-center gap-3 pb-3 border-b border-secondary-200">
                  <div className="w-10 h-10 rounded-lg bg-primary-100 flex items-center justify-center">
                    <MapPin size={20} className="text-primary-600" />
                  </div>
                  <h3 className="text-lg font-semibold text-secondary-900">
                    Address Information
                  </h3>
                </div>

                {/* Shipping Address with Google Autocomplete */}
                <div className="space-y-2">
                  <label className="block text-sm font-medium text-secondary-700">
                    Shipping Address
                  </label>
                  <div className="relative">
                    <MapPin className="absolute left-3 top-3.5 text-secondary-400 z-10" size={20} />
                    <Autocomplete
                      apiKey={import.meta.env.VITE_GOOGLE_MAPS_API_KEY}
                      onPlaceSelected={handleShippingAddressSelect}
                      options={{ types: ['address'], componentRestrictions: { country: 'au' } }}
                      defaultValue={user?.shipping_address || ''}
                      className={`
                        w-full pl-10 pr-4 py-3 rounded-lg border-2 transition-all
                        ${errors.shipping_address
                          ? 'border-error-500 focus:border-error-500 focus:ring-error-500'
                          : 'border-secondary-200 focus:border-primary-500 focus:ring-primary-500'}
                        focus:outline-none focus:ring-2 focus:ring-opacity-20
                      `}
                      placeholder="Start typing your address..."
                    />
                  </div>
                  {errors.shipping_address && (
                    <p className="text-sm text-error-500">{errors.shipping_address.message}</p>
                  )}

                  {/* Location Coordinates Display */}
                  {locationCoords && (
                    <div className="bg-success-50 border border-success-200 rounded-lg p-3 mt-2">
                      <p className="text-xs text-success-700 font-medium flex items-center gap-2">
                        <MapPin size={14} />
                        Selected Location: {locationCoords.lat.toFixed(6)}, {locationCoords.lng.toFixed(6)}
                      </p>
                    </div>
                  )}
                </div>

                <Input
                  label="Billing Address"
                  type="text"
                  placeholder="Same as shipping or different address"
                  icon={Building2}
                  register={register('billing_address')}
                  error={errors.billing_address?.message}
                />
              </div>
            )}

            {/* Supplier-Specific: Business Location */}
            {user?.role === 'supplier' && (
              <div className="space-y-5">
                <div className="flex items-center gap-3 pb-3 border-b border-secondary-200">
                  <div className="w-10 h-10 rounded-lg bg-primary-100 flex items-center justify-center">
                    <MapPin size={20} className="text-primary-600" />
                  </div>
                  <h3 className="text-lg font-semibold text-secondary-900">
                    Business Location
                  </h3>
                </div>

                <div className="space-y-2">
                  <label className="block text-sm font-medium text-secondary-700">
                    Business Location
                  </label>
                  <div className="relative">
                    <MapPin className="absolute left-3 top-3.5 text-secondary-400 z-10" size={20} />
                    <Autocomplete
                      apiKey={import.meta.env.VITE_GOOGLE_MAPS_API_KEY}
                      onPlaceSelected={handleSupplierLocationSelect}
                      options={{ types: ['address'], componentRestrictions: { country: 'au' } }}
                      defaultValue={user?.location || ''}
                      className={`
                        w-full pl-10 pr-4 py-3 rounded-lg border-2 transition-all
                        ${errors.location
                          ? 'border-error-500 focus:border-error-500 focus:ring-error-500'
                          : 'border-secondary-200 focus:border-primary-500 focus:ring-primary-500'}
                        focus:outline-none focus:ring-2 focus:ring-opacity-20
                      `}
                      placeholder="Start typing your business address..."
                    />
                  </div>
                  {errors.location && (
                    <p className="text-sm text-error-500">{errors.location.message}</p>
                  )}
                </div>

                <Input
                  label="Delivery Radius (km)"
                  type="number"
                  placeholder="50"
                  icon={Truck}
                  register={register('delivery_radius', { valueAsNumber: true })}
                  error={errors.delivery_radius?.message}
                />
              </div>
            )}

            {/* Submit Button */}
            <div className="flex gap-4 pt-6 border-t border-secondary-200">
              <Button
                type="submit"
                isLoading={updateProfileMutation.isPending}
                disabled={updateProfileMutation.isPending}
                fullWidth={false}
                className="flex-1"
              >
                <Save size={20} />
                {updateProfileMutation.isPending ? 'Saving Changes...' : 'Save Changes'}
              </Button>

              <Button
                type="button"
                variant="outline"
                onClick={() => {
                  reset();
                  clearImage();
                  setLocationCoords(
                    user?.lat && user?.long ? { lat: user.lat, lng: user.long } : null
                  );
                }}
                fullWidth={false}
                className="flex-1"
              >
                Cancel
              </Button>
            </div>
          </form>
        </div>

        {/* Change Password Section - Separate Card */}
        <div className="bg-white rounded-2xl shadow-card p-8">
          <ChangePasswordSection />
        </div>
      </div>
    </DashboardLayout>
  );
};

export default ProfileSettings;
/* FILE: src/pages/supplier/Dashboard.tsx */
// src/pages/supplier/Dashboard.tsx
import DashboardLayout from '../../components/layout/DashboardLayout';
import {supplierMenuItems} from '../../utils/menuItems';

const SupplierDashboard = () => {

  return (
    <DashboardLayout menuItems={supplierMenuItems}>
      <div className="bg-white rounded-xl shadow-card p-8">
        <h1 className="text-3xl font-bold text-secondary-900">Supplier Dashboard</h1>
        <p className="text-secondary-600 mt-2">Manage your products and orders</p>
      </div>
    </DashboardLayout>
  );
};

export default SupplierDashboard;
/* FILE: src/pages/supplier/DeliveryZones.tsx */
// src/pages/supplier/DeliveryZones.tsx
import DashboardLayout from '../../components/layout/DashboardLayout';
import DeliveryZonesManagement from '../../components/supplier/DeliveryZonesManagement';
import {supplierMenuItems} from '../../utils/menuItems';

const DeliveryZonesPage = () => {

  return (
    <DashboardLayout menuItems={supplierMenuItems}>
      <DeliveryZonesManagement />
    </DashboardLayout>
  );
};

export default DeliveryZonesPage;
/* FILE: src/pages/supplier/ProductManagement.tsx */
// FILE PATH: src/pages/supplier/ProductManagement.tsx
import { useState, useMemo, useEffect } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { 
  Package, 
  Search,
  Plus,
  Filter,
  Loader2,
  AlertCircle,
  X,
  TrendingUp,
  CheckCircle,
  XCircle
} from 'lucide-react';
import toast from 'react-hot-toast';

import { 
  supplierProductsAPI, 
   
} from '../../api/handlers/supplierProducts.api';
import type { SupplierOffer, MasterProduct } from '../../api/handlers/supplierProducts.api';
import DashboardLayout from '../../components/layout/DashboardLayout';
import ProductCard from '../../components/supplier/ProductCard';
import AddOfferModal from '../../components/supplier/AddOfferModal';
import EditOfferModal from '../../components/supplier/EditOfferModal';
import RequestProductModal from '../../components/supplier/RequestProductModal';
import Pagination from '../../components/common/Pagination';
import Button from '../../components/common/Buttons';
import ConfirmModal from '../../components/common/ConfirmModal';
import {supplierMenuItems} from '../../utils/menuItems';

const PER_PAGE = 10;

const ProductManagement = () => {
  const queryClient = useQueryClient();

  // State
  const [page, setPage] = useState(1);
  const [searchQuery, setSearchQuery] = useState('');
  const [localSearch, setLocalSearch] = useState('');
  const [selectedCategory, setSelectedCategory] = useState<number | undefined>();
  const [statusFilter, setStatusFilter] = useState<'all' | 'my_offers' | 'not_added'>('all');
  
  // Modal states
  const [showAddModal, setShowAddModal] = useState(false);
  const [showEditModal, setShowEditModal] = useState(false);
  const [showRequestModal, setShowRequestModal] = useState(false);
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  
  // Selected items
  const [selectedProduct, setSelectedProduct] = useState<MasterProduct | null>(null);
  const [selectedOffer, setSelectedOffer] = useState<SupplierOffer | null>(null);
  const [deleteTarget, setDeleteTarget] = useState<{ id: number; name: string } | null>(null);

  // Debounce search
  useEffect(() => {
    const timer = setTimeout(() => {
      setSearchQuery(localSearch);
      setPage(1);
    }, 500);
    return () => clearTimeout(timer);
  }, [localSearch]);

  // Fetch products
  const { data: productsData, isLoading: isLoadingProducts } = useQuery({
    queryKey: ['supplier-products', page, searchQuery, selectedCategory],
    queryFn: () => supplierProductsAPI.getProducts({
      page,
      per_page: PER_PAGE,
      search: searchQuery || undefined,
      category_id: selectedCategory,
    }),
  });

  // Fetch categories
  const { data: categoriesData } = useQuery({
    queryKey: ['categories'],
    queryFn: supplierProductsAPI.getCategories,
  });

  // Delete mutation
  const deleteMutation = useMutation({
    mutationFn: supplierProductsAPI.deleteSupplierOffer,
    onSuccess: () => {
      toast.success('Product removed from your offers');
      queryClient.invalidateQueries({ queryKey: ['supplier-products'] });
      setShowDeleteModal(false);
      setDeleteTarget(null);
    },
    onError: (error: any) => {
      toast.error(error.response?.data?.message || 'Failed to remove product');
    },
  });

  // Filter products
  const filteredProducts = useMemo(() => {
    if (!productsData?.data) return [];
    
    let filtered = productsData.data;

    if (statusFilter === 'my_offers') {
      filtered = filtered.filter(p => p.suppliers.some(s => s.isMe));
    } else if (statusFilter === 'not_added') {
      filtered = filtered.filter(p => !p.suppliers.some(s => s.isMe));
    }

    return filtered;
  }, [productsData?.data, statusFilter]);

  // Calculate stats
  const stats = useMemo(() => {
    const total = filteredProducts.length;
    const myOffers = filteredProducts.filter(p => p.suppliers.some(s => s.isMe)).length;
    const notAdded = filteredProducts.filter(p => !p.suppliers.some(s => s.isMe)).length;

    return { total, myOffers, notAdded };
  }, [filteredProducts]);

  // Modal handlers
  const handleAddOffer = (product: MasterProduct) => {
    setSelectedProduct(product);
    setShowAddModal(true);
  };

  const handleEditOffer = (product: MasterProduct, offer: SupplierOffer) => {
    setSelectedProduct(product);
    setSelectedOffer(offer);
    setShowEditModal(true);
  };

  const handleRemoveOffer = (offerId: number, productName: string) => {
    setDeleteTarget({ id: offerId, name: productName });
    setShowDeleteModal(true);
  };

  const confirmDelete = () => {
    if (deleteTarget) {
      deleteMutation.mutate(deleteTarget.id);
    }
  };

  const clearFilters = () => {
    setLocalSearch('');
    setSearchQuery('');
    setSelectedCategory(undefined);
    setStatusFilter('all');
    setPage(1);
  };

  const hasFilters = searchQuery || selectedCategory || statusFilter !== 'all';

  const pagination = {
    currentPage: productsData?.current_page || 1,
    lastPage: productsData?.last_page || 1,
    total: productsData?.total || 0,
    perPage: productsData?.per_page || PER_PAGE,
    from: productsData?.from || 0,
    to: productsData?.to || 0,
  };

  return (
    <DashboardLayout menuItems={supplierMenuItems}>
      <div className="space-y-8 pb-8">
        {/* Header */}
        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h1 className="text-4xl font-bold text-secondary-900 mb-2">Product Management</h1>
            <p className="text-secondary-600 text-lg">
              Manage your product offers and request new products
            </p>
          </div>
          <Button
            onClick={() => setShowRequestModal(true)}
            variant="primary"
            fullWidth={false}
            className="shadow-lg hover:shadow-xl transition-shadow"
          >
            <Plus size={20} />
            Request Product
          </Button>
        </div>

        {/* Stats Cards */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          {/* Total Products */}
          <div className="relative bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden group">
            <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16 group-hover:scale-110 transition-transform duration-300" />
            <div className="relative p-6">
              <div className="flex items-start justify-between mb-4">
                <div className="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center">
                  <Package size={28} className="text-white" />
                </div>
                <TrendingUp size={20} className="text-white/60" />
              </div>
              <p className="text-blue-100 text-sm font-medium mb-1">Total Products</p>
              <p className="text-white text-4xl font-bold">{stats.total}</p>
            </div>
          </div>

          {/* My Offers */}
          <div className="relative bg-gradient-to-br from-green-500 to-green-600 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden group">
            <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16 group-hover:scale-110 transition-transform duration-300" />
            <div className="relative p-6">
              <div className="flex items-start justify-between mb-4">
                <div className="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center">
                  <CheckCircle size={28} className="text-white" />
                </div>
                <TrendingUp size={20} className="text-white/60" />
              </div>
              <p className="text-green-100 text-sm font-medium mb-1">My Active Offers</p>
              <p className="text-white text-4xl font-bold">{stats.myOffers}</p>
            </div>
          </div>

          {/* Not Added */}
          <div className="relative bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden group">
            <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16 group-hover:scale-110 transition-transform duration-300" />
            <div className="relative p-6">
              <div className="flex items-start justify-between mb-4">
                <div className="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center">
                  <XCircle size={28} className="text-white" />
                </div>
                <TrendingUp size={20} className="text-white/60" />
              </div>
              <p className="text-orange-100 text-sm font-medium mb-1">Available to Add</p>
              <p className="text-white text-4xl font-bold">{stats.notAdded}</p>
            </div>
          </div>
        </div>

        {/* Filters Section */}
        <div className="bg-white rounded-2xl shadow-md border border-secondary-100">
          <div className="p-6 space-y-6">
            {/* Search and Category */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {/* Search */}
              <div className="relative group">
                <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-secondary-400 group-focus-within:text-primary-500 transition-colors" size={20} />
                <input
                  type="text"
                  placeholder="Search products by name, type, or specifications..."
                  value={localSearch}
                  onChange={(e) => setLocalSearch(e.target.value)}
                  className="w-full pl-12 pr-4 py-3.5 bg-secondary-50 border-2 border-transparent rounded-xl focus:outline-none focus:border-primary-500 focus:bg-white transition-all text-secondary-900 placeholder-secondary-400"
                />
              </div>

              {/* Category Filter */}
              <div className="relative">
                <Filter className="absolute left-4 top-1/2 -translate-y-1/2 text-secondary-400 pointer-events-none" size={20} />
                <select
                  value={selectedCategory || ''}
                  onChange={(e) => {
                    setSelectedCategory(e.target.value ? Number(e.target.value) : undefined);
                    setPage(1);
                  }}
                  className="w-full pl-12 pr-4 py-3.5 bg-secondary-50 border-2 border-transparent rounded-xl focus:outline-none focus:border-primary-500 focus:bg-white transition-all text-secondary-900 appearance-none cursor-pointer"
                >
                  <option value="">All Categories</option>
                  {categoriesData?.data.map((cat) => (
                    <option key={cat.id} value={cat.id}>
                      {cat.name}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            {/* Status Filter Pills */}
            <div className="flex flex-wrap items-center gap-3">
              <span className="text-sm font-medium text-secondary-700">Filter by:</span>
              
              <button
                onClick={() => { setStatusFilter('all'); setPage(1); }}
                className={`px-6 py-2.5 rounded-full font-medium transition-all duration-200 ${
                  statusFilter === 'all'
                    ? 'bg-primary-500 text-white shadow-lg shadow-primary-500/30 scale-105'
                    : 'bg-secondary-100 text-secondary-700 hover:bg-secondary-200'
                }`}
              >
                All Products
              </button>
              
              <button
                onClick={() => { setStatusFilter('my_offers'); setPage(1); }}
                className={`px-6 py-2.5 rounded-full font-medium transition-all duration-200 ${
                  statusFilter === 'my_offers'
                    ? 'bg-green-500 text-white shadow-lg shadow-green-500/30 scale-105'
                    : 'bg-secondary-100 text-secondary-700 hover:bg-secondary-200'
                }`}
              >
                My Offers
              </button>
              
              <button
                onClick={() => { setStatusFilter('not_added'); setPage(1); }}
                className={`px-6 py-2.5 rounded-full font-medium transition-all duration-200 ${
                  statusFilter === 'not_added'
                    ? 'bg-orange-500 text-white shadow-lg shadow-orange-500/30 scale-105'
                    : 'bg-secondary-100 text-secondary-700 hover:bg-secondary-200'
                }`}
              >
                Not Added
              </button>
              
              {hasFilters && (
                <button
                  onClick={clearFilters}
                  className="px-6 py-2.5 rounded-full font-medium bg-error-100 text-error-700 hover:bg-error-200 transition-all duration-200 flex items-center gap-2"
                >
                  <X size={16} />
                  Clear All
                </button>
              )}
            </div>
          </div>
        </div>

        {/* Products Grid */}
        <div className="bg-white rounded-2xl shadow-md border border-secondary-100 p-6">
          {isLoadingProducts ? (
            <div className="flex items-center justify-center py-20">
              <div className="text-center">
                <Loader2 className="animate-spin text-primary-500 mx-auto mb-4" size={48} />
                <p className="text-secondary-600 font-medium">Loading products...</p>
              </div>
            </div>
          ) : filteredProducts.length === 0 ? (
            <div className="text-center py-20">
              <div className="w-24 h-24 bg-secondary-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <AlertCircle className="text-secondary-400" size={48} />
              </div>
              <h3 className="text-2xl font-bold text-secondary-900 mb-2">No products found</h3>
              <p className="text-secondary-600 text-lg mb-6">
                {hasFilters 
                  ? 'Try adjusting your filters or search term'
                  : 'No products available at the moment'}
              </p>
              {hasFilters && (
                <Button onClick={clearFilters} variant="outline">
                  Clear Filters
                </Button>
              )}
            </div>
          ) : (
            <>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {filteredProducts.map((product) => (
                  <ProductCard
                    key={product.id}
                    product={product}
                    onAddOffer={handleAddOffer}
                    onEditOffer={handleEditOffer}
                    onRemoveOffer={handleRemoveOffer}
                  />
                ))}
              </div>

              {/* Pagination */}
              {pagination.total > 0 && (
                <div className="mt-8 pt-6 border-t border-secondary-200">
                  <Pagination
                    currentPage={pagination.currentPage}
                    lastPage={pagination.lastPage}
                    total={pagination.total}
                    perPage={pagination.perPage}
                    onPageChange={(newPage) => setPage(newPage)}
                    loading={isLoadingProducts}
                  />
                </div>
              )}
            </>
          )}
        </div>
      </div>

      {/* Modals */}
      <AddOfferModal
        isOpen={showAddModal}
        onClose={() => {
          setShowAddModal(false);
          setSelectedProduct(null);
        }}
        product={selectedProduct}
      />

      <EditOfferModal
        isOpen={showEditModal}
        onClose={() => {
          setShowEditModal(false);
          setSelectedProduct(null);
          setSelectedOffer(null);
        }}
        product={selectedProduct}
        offer={selectedOffer}
      />

      <RequestProductModal
        isOpen={showRequestModal}
        onClose={() => setShowRequestModal(false)}
        categories={categoriesData?.data || []}
      />

      <ConfirmModal
        isOpen={showDeleteModal}
        onClose={() => {
          setShowDeleteModal(false);
          setDeleteTarget(null);
        }}
        onConfirm={confirmDelete}
        title="Remove Product from Offers"
        message={`Are you sure you want to remove "${deleteTarget?.name}" from your offers? This action cannot be undone.`}
        confirmText="Remove"
        loading={deleteMutation.isPending}
      />
    </DashboardLayout>
  );
};

export default ProductManagement;
/* FILE: src/pages/supplier/SupplierOrderDetail.tsx */
// src/pages/supplier/SupplierOrderDetail.tsx

import { useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import {
  ArrowLeft,
  MapPin,
  Calendar,
  Clock,
  Truck,
  User,
  Phone,
  Mail,
  Edit,
  CheckCircle,
  XCircle,
  Package,
  Loader2,
} from 'lucide-react';
import { format } from 'date-fns';
import { useSupplierOrderDetail } from '../../features/supplierOrders/hooks';
import DashboardLayout from '../../components/layout/DashboardLayout';
import OrderItemEditModal from '../../components/supplier/OrderItemEditModal';
import { supplierMenuItems } from '../../utils/menuItems';
import type { SupplierOrderItem } from '../../api/handlers/supplierOrders.api';

const SupplierOrderDetail = () => {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  
  // Parse orderId properly - useParams returns string
  const orderIdNumber = id  ? parseInt(id , 10) : undefined;
  
  console.log('SupplierOrderDetail - orderId from params (string):', id);
  console.log('SupplierOrderDetail - parsed to number:', orderIdNumber);
  
  const { data, isLoading, refetch, error } = useSupplierOrderDetail(orderIdNumber);
  const [editingItem, setEditingItem] = useState<SupplierOrderItem | null>(null);
  const [isModalOpen, setIsModalOpen] = useState(false);

  console.log('Order detail data:', data);
  console.log('Loading state:', isLoading);
  console.log('Error:', error);

  const handleEditItem = (item: SupplierOrderItem) => {
    setEditingItem(item);
    setIsModalOpen(true);
  };

  const handleModalClose = () => {
    setIsModalOpen(false);
    setEditingItem(null);
  };

  const handleUpdateSuccess = () => {
    refetch();
  };

  const formatDate = (dateString: string) => {
    if (!dateString) return '-';
    try {
      // Handle ISO format with timezone
      const date = new Date(dateString);
      return format(date, 'MMM dd, yyyy');
    } catch {
      return '-';
    }
  };

  const formatDateTime = (dateString: string, timeString?: string) => {
    if (!dateString) return '-';
    try {
      const date = format(new Date(dateString), 'MMM dd, yyyy');
      return timeString ? `${date} at ${timeString}` : date;
    } catch {
      return '-';
    }
  };


  const calculateItemTotal = (item: SupplierOrderItem) => {
    const unitCost = parseFloat(item.supplier_unit_cost);
    const quantity = parseFloat(item.quantity);
    const discount = parseFloat(item.supplier_discount);
    const deliveryCost = parseFloat(item.delivery_cost);
    return (unitCost * quantity) - discount + deliveryCost;
  };

  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
    }).format(amount || 0);
  };

  if (isLoading) {
    return (
      <DashboardLayout menuItems={supplierMenuItems}>
        <div className="flex items-center justify-center py-12">
          <div className="text-center">
            <Loader2 className="w-12 h-12 animate-spin text-blue-600 mx-auto mb-4" />
            <p className="text-gray-600">Loading order details...</p>
          </div>
        </div>
      </DashboardLayout>
    );
  }

  if (!data?.data) {
    return (
      <DashboardLayout menuItems={supplierMenuItems}>
        <div className="text-center py-12">
          <Package className="w-16 h-16 text-gray-300 mx-auto mb-4" />
          <h3 className="text-lg font-medium text-gray-900 mb-2">Order Not Found</h3>
          {error && (
            <p className="text-red-600 mb-4">{(error as Error).message}</p>
          )}
          <p className="text-gray-600 mb-4">
            Order ID: {id} | Data: {JSON.stringify(data)}
          </p>
          <button
            onClick={() => navigate('/supplier/orders')}
            className="text-blue-600 hover:text-blue-700 inline-flex items-center gap-2"
          >
            <ArrowLeft className="w-4 h-4" />
            Back to Orders
          </button>
        </div>
      </DashboardLayout>
    );
  }

  const { order, supplier_items } = data.data;

  return (
    <DashboardLayout menuItems={supplierMenuItems}>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <button
            onClick={() => navigate('/supplier/orders')}
            className="flex items-center gap-2 text-gray-600 hover:text-blue-600 transition-colors"
          >
            <ArrowLeft className="w-5 h-5" />
            Back to Orders
          </button>
        </div>

        {/* Order Header */}
        <div className="bg-white rounded-lg border border-gray-200 p-6">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h1 className="text-3xl font-bold text-gray-900">Order #{order.po_number || order.id}</h1>
              <p className="text-gray-600 mt-1">Order details and your items</p>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Left Column - Order Info */}
          <div className="lg:col-span-2 space-y-6">
            {/* Delivery Information */}
            <div className="bg-white rounded-lg border border-gray-200 p-6">
              <h2 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                <Truck className="w-5 h-5 text-blue-600" />
                Delivery Information
              </h2>
              <div className="space-y-3">
                <div className="flex items-start gap-3">
                  <MapPin className="w-5 h-5 text-gray-400 mt-0.5" />
                  <div>
                    <p className="text-sm font-medium text-gray-700">Address</p>
                    <p className="text-gray-900">{order.delivery_address || 'N/A'}</p>
                  </div>
                </div>
                <div className="flex items-start gap-3">
                  <Calendar className="w-5 h-5 text-gray-400 mt-0.5" />
                  <div>
                    <p className="text-sm font-medium text-gray-700">Delivery Date</p>
                    <p className="text-gray-900">{formatDateTime(order.delivery_date, order.delivery_time)}</p>
                  </div>
                </div>
                {order.delivery_window && (
                  <div className="flex items-start gap-3">
                    <Clock className="w-5 h-5 text-gray-400 mt-0.5" />
                    <div>
                      <p className="text-sm font-medium text-gray-700">Delivery Window</p>
                      <p className="text-gray-900">{order.delivery_window}</p>
                    </div>
                  </div>
                )}
                {order.delivery_method && (
                  <div className="flex items-start gap-3">
                    <Truck className="w-5 h-5 text-gray-400 mt-0.5" />
                    <div>
                      <p className="text-sm font-medium text-gray-700">Delivery Method</p>
                      <p className="text-gray-900">{order.delivery_method}</p>
                    </div>
                  </div>
                )}
              </div>
              {order.special_notes && (
                <div className="mt-4 pt-4 border-t border-gray-200">
                  <p className="text-sm font-medium text-gray-700 mb-2">Special Notes</p>
                  <p className="text-gray-600 text-sm">{order.special_notes}</p>
                </div>
              )}
            </div>

            {/* Your Items */}
            <div className="bg-white rounded-lg border border-gray-200 p-6">
              <h2 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                <Package className="w-5 h-5 text-blue-600" />
                Your Items
              </h2>
              <div className="space-y-4">
                {supplier_items.map((item) => (
                  <div
                    key={item.id}
                    className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow"
                  >
                    <div className="flex items-start gap-4">
                      {item.product?.photo && (
                        <img
                           src={`${import.meta.env.VITE_IMG_URL}${item.product.photo}`}
                          alt={item.product.product_name}
                          className="w-20 h-20 object-cover rounded-lg"
                        />
                      )}
                      <div className="flex-1">
                        <div className="flex items-start justify-between">
                          <div>
                            <h3 className="font-semibold text-gray-900">{item.product?.product_name}</h3>
                            <p className="text-sm text-gray-600">
                              Quantity: {item.quantity} {item.product?.unit_of_measure}
                            </p>
                          </div>
                          <div className="flex items-center gap-2">
                            {item.supplier_confirms ? (
                              <span className="flex items-center gap-1 text-green-600 text-sm">
                                <CheckCircle className="w-4 h-4" />
                                Confirmed
                              </span>
                            ) : (
                              <span className="flex items-center gap-1 text-orange-600 text-sm">
                                <XCircle className="w-4 h-4" />
                                Pending
                              </span>
                            )}
                          </div>
                        </div>
                        <div className="mt-3 grid grid-cols-2 gap-4 text-sm">
                          <div>
                            <p className="text-gray-600">Unit Cost</p>
                            <p className="font-medium text-gray-900">{formatCurrency(parseFloat(item.supplier_unit_cost))}</p>
                          </div>
                          <div>
                            <p className="text-gray-600">Delivery Cost</p>
                            <p className="font-medium text-gray-900">{formatCurrency(parseFloat(item.delivery_cost))}</p>
                          </div>
                          <div>
                            <p className="text-gray-600">Discount</p>
                            <p className="font-medium text-gray-900">{formatCurrency(parseFloat(item.supplier_discount))}</p>
                          </div>
                          <div>
                            <p className="text-gray-600">Delivery Date</p>
                            <p className="font-medium text-gray-900">{formatDate(item.supplier_delivery_date)}</p>
                          </div>
                          <div>
                            <p className="text-gray-600">Item Total</p>
                            <p className="font-bold text-blue-600">{formatCurrency(calculateItemTotal(item))}</p>
                          </div>
                          <div>
                            <p className="text-gray-600">Delivery Type</p>
                            <p className="font-medium text-gray-900">{item.delivery_type ? item.delivery_type : '--'}</p>
                          </div>
                        </div>
                        {item.supplier_notes && (
                          <div className="mt-3 pt-3 border-t border-gray-200">
                            <p className="text-sm text-gray-600">
                              <span className="font-medium">Notes:</span> {item.supplier_notes}
                            </p>
                          </div>
                        )}
                        <div className="mt-4">
                          {!item.supplier_confirms ? (
                            <button
                              onClick={() => handleEditItem(item)}
                              className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm"
                            >
                              <Edit className="w-4 h-4" />
                              Edit Item
                            </button>
                          ) : null}
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* Right Column - Client & Project Info */}
          <div className="space-y-6">
            {/* Client Information */}
            <div className="bg-white rounded-lg border border-gray-200 p-6">
              <h2 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                <User className="w-5 h-5 text-blue-600" />
                Client Information
              </h2>
              <div className="space-y-3">
                <div>
                  <p className="text-sm text-gray-600">Name</p>
                  <p className="font-medium text-gray-900">{order.client?.name || 'N/A'}</p>
                </div>
                <div className="flex items-center gap-2">
                  <Mail className="w-4 h-4 text-gray-400" />
                  <p className="text-sm text-gray-900">{order.client?.email || 'N/A'}</p>
                </div>
              </div>
            </div>

            {/* Project Information */}
            <div className="bg-white rounded-lg border border-gray-200 p-6">
              <h2 className="text-lg font-bold text-gray-900 mb-4">Project Information</h2>
              <div className="space-y-3">
                <div>
                  <p className="text-sm text-gray-600">Project Name</p>
                  <p className="font-medium text-gray-900">{order.project?.name || 'N/A'}</p>
                </div>
                {order.project?.site_contact_name && (
                  <div>
                    <p className="text-sm text-gray-600">Site Contact</p>
                    <p className="text-gray-900">{order.project.site_contact_name}</p>
                  </div>
                )}
                {order.project?.site_contact_phone && (
                  <div className="flex items-center gap-2">
                    <Phone className="w-4 h-4 text-gray-400" />
                    <p className="text-sm text-gray-900">{order.project.site_contact_phone}</p>
                  </div>
                )}
                {order.project?.site_instructions && (
                  <div className="pt-3 border-t border-gray-200">
                    <p className="text-sm font-medium text-gray-700 mb-1">Site Instructions</p>
                    <p className="text-sm text-gray-600">{order.project.site_instructions}</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Edit Modal */}
      <OrderItemEditModal
        item={editingItem}
        isOpen={isModalOpen}
        onClose={handleModalClose}
        onSuccess={handleUpdateSuccess}
      />
    </DashboardLayout>
  );
};

export default SupplierOrderDetail;
/* FILE: src/pages/supplier/SupplierOrders.tsx */
// src/pages/supplier/SupplierOrders.tsx

import { useState, useEffect } from 'react';
import { RefreshCw } from 'lucide-react';
import { useSearchParams } from 'react-router-dom';
import toast from 'react-hot-toast';
import { useSupplierOrders } from '../../features/supplierOrders/hooks';
import DashboardLayout from '../../components/layout/DashboardLayout';
import OrderMetricsCards from '../../components/supplier/OrderMetricsCards';
import OrderFilters from '../../components/supplier/OrderFilters';
import OrdersTable from '../../components/supplier/OrdersTable';
import { supplierMenuItems } from '../../utils/menuItems';
import type { ProductFilter } from '../../api/handlers/supplierOrders.api';

const SupplierOrders = () => {
  const [searchParams, setSearchParams] = useSearchParams();
  const [isFirstLoad, setIsFirstLoad] = useState(true);
  const [products, setProducts] = useState<ProductFilter[]>([]);

  // Initialize filters from URL params
  const [filters, setFilters] = useState({
    search: searchParams.get('search') || '',
    product_id: searchParams.get('product_id') || '',
    supplier_confirms: searchParams.get('supplier_confirms') || '',
    supplier_delivery_date: searchParams.get('supplier_delivery_date') || '',
    page: parseInt(searchParams.get('page') || '1'),
    per_page: 10,
  });

  // Fetch orders with includeDetails on first load
  const { data, isLoading, isFetching, refetch } = useSupplierOrders(filters, isFirstLoad);

  // Store products from first load
  useEffect(() => {
    if (isFirstLoad && data?.data?.filters?.products) {
      setProducts(data.data.filters.products);
      setIsFirstLoad(false);
    }
  }, [data, isFirstLoad]);

  // Update URL params when filters change
  useEffect(() => {
    const params: Record<string, string> = {};
    if (filters.search) params.search = filters.search;
    if (filters.product_id) params.product_id = filters.product_id;
    if (filters.supplier_confirms !== '') params.supplier_confirms = filters.supplier_confirms;
    if (filters.supplier_delivery_date) params.supplier_delivery_date = filters.supplier_delivery_date;
    if (filters.page > 1) params.page = filters.page.toString();

    setSearchParams(params);
  }, [filters, setSearchParams]);

  // Handle filter changes
  const handleFilterChange = (key: string, value: string) => {
    setFilters((prev) => ({
      ...prev,
      [key]: value,
      page: 1, // Reset to first page
    }));
  };

  // Clear all filters
  const handleClearFilters = () => {
    setFilters({
      search: '',
      product_id: '',
      supplier_confirms: '',
      supplier_delivery_date: '',
      page: 1,
      per_page: 10,
    });
  };

  // Handle page change
  const handlePageChange = (newPage: number) => {
    setFilters((prev) => ({
      ...prev,
      page: newPage,
    }));
  };

  // Handle refresh
  const handleRefresh = () => {
    refetch();
    toast.success('Orders refreshed');
  };

  return (
    <DashboardLayout menuItems={supplierMenuItems}>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold text-gray-900">Supplier Orders</h1>
            <p className="text-gray-600 mt-1">Manage and track your order items</p>
          </div>
          <button
            onClick={handleRefresh}
            disabled={isFetching}
            className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <RefreshCw className={`w-4 h-4 ${isFetching ? 'animate-spin' : ''}`} />
            Refresh
          </button>
        </div>

        {/* Metrics Cards */}
        <OrderMetricsCards 
          metrics={data?.data?.metrics || null} 
          loading={isLoading} 
        />

        {/* Filters */}
        <OrderFilters
          filters={filters}
          onFilterChange={handleFilterChange}
          onClearFilters={handleClearFilters}
          products={products}
        />

        {/* Orders Table */}
        <OrdersTable
          orders={data?.data?.data || []}
          loading={isLoading || isFetching}
          pagination={data?.data?.pagination || null}
          onPageChange={handlePageChange}
        />
      </div>
    </DashboardLayout>
  );
};

export default SupplierOrders;
/* FILE: src/routes/index.tsx */
// src/routes/index.tsx
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom';
import ProtectedRoute from './ProtectedRoute';

// Import pages
import Login from '../pages/public/Login';
import RegisterClient from '../pages/public/RegisterClient';
import RegisterSupplier from '../pages/public/RegisterSupplier';

import ClientDashboard from '../pages/client/Dashboard';
import SupplierDashboard from '../pages/supplier/Dashboard';
import AdminDashboard from '../pages/admin/Dashboard';

// Admin - User Management
import UserManagement from '../pages/admin/UserManagement';
import UserDetail from '../pages/admin/UserDetail';
import UserEdit from '../pages/admin/UserEdit';
import UserCreate from '../pages/admin/UserCreate';

//Admin Supplier Delivery Zones
import AdminSupplierDeliveryZones from '../pages/admin/AdminSupplierDeliveryZones';

//Admin Master Products
import MasterProductsList from '../pages/admin/MasterProducts/MasterProductsList';
import AddMasterProduct from '../pages/admin/MasterProducts/AddMasterProduct';
import EditMasterProduct from '../pages/admin/MasterProducts/EditMasterProduct';
import ViewMasterProduct from '../pages/admin/MasterProducts/ViewMasterProduct';

//Admin Orders
import AdminOrdersList from '../pages/admin/Orders/AdminOrdersList';
import AdminOrderView from '../pages/admin/Orders/AdminOrderView';

//Client Projects
import ProjectsList from '../pages/client/projects/ProjectsList';
import ProjectDetail from '../pages/client/projects/ProjectDetail';
import ProjectEdit from '../pages/client/projects/ProjectEdit';
import ProjectCreate from '../pages/client/projects/ProjectCreate';

//Client Orders
import OrderCreate from '../pages/client/OrderCreate';
import ClientOrders from '../pages/client/ClientOrders';
import ClientOrderView from '../pages/client/ClientOrderView';

//Supplier Delivery Zones
import DeliveryZonesPage from '../pages/supplier/DeliveryZones';
import ProductManagement from '../pages/supplier/ProductManagement';

//Supplier Orders
import SupplierOrders from '../pages/supplier/SupplierOrders';
import SupplierOrderDetail from '../pages/supplier/SupplierOrderDetail';

// Shared
import ProfileSettings from '../pages/shared/ProfileSettings';
const basePath = import.meta.env.VITE_BASE_PATH || '/';

const AppRouter = () => {
  return (
      <BrowserRouter basename={basePath}>
      <Routes>
        {/* Public Routes */}
        <Route path="/login" element={<Login />} />
        <Route path="/register/client" element={<RegisterClient />} />
        <Route path="/register/supplier" element={<RegisterSupplier />} />

        {/* Client Routes */}
        <Route
          path="/client/dashboard"
          element={
            <ProtectedRoute allowedRoles={['client']}>
              <ClientDashboard />
            </ProtectedRoute>
          }
        />
        <Route
          path="/client/profile"
          element={
            <ProtectedRoute allowedRoles={['client']}>
              <ProfileSettings />
            </ProtectedRoute>
          }
        />
        <Route
          path="/client/projects"
          element={
            <ProtectedRoute allowedRoles={['client']}>
              <ProjectsList />
            </ProtectedRoute>
          }
        />
        <Route
          path="/client/projects/create"
          element={
            <ProtectedRoute allowedRoles={['client']}>
              <ProjectCreate />
            </ProtectedRoute>
          }
        />
        <Route
          path="/client/projects/:id"
          element={
            <ProtectedRoute allowedRoles={['client']}>
              <ProjectDetail />
            </ProtectedRoute>
          }
        />
        <Route 
          path="/client/orders/create" 
          element={
            <ProtectedRoute allowedRoles={['client']}>
              <OrderCreate />
            </ProtectedRoute>
          } 
        />
        <Route
          path="/client/projects/:id/edit"
          element={
            <ProtectedRoute allowedRoles={['client']}>
              <ProjectEdit />
            </ProtectedRoute>
          }
        />
        <Route 
          path="/client/orders" 
          element={
          <ProtectedRoute allowedRoles={['client']}>
          <ClientOrders />
          </ProtectedRoute>
          } 
        />
        <Route 
          path="/client/orders/:orderId" 
          element={
            <ProtectedRoute allowedRoles={['client']}>
            <ClientOrderView />
            </ProtectedRoute>
          } 
        />


        {/* Supplier Routes */}
        <Route
          path="/supplier/dashboard"
          element={
            <ProtectedRoute allowedRoles={['supplier']}>
              <SupplierDashboard />
            </ProtectedRoute>
          }
        />
        <Route
          path="/supplier/profile"
          element={
            <ProtectedRoute allowedRoles={['supplier']}>
              <ProfileSettings />
            </ProtectedRoute>
          }
        />
        <Route
          path="/supplier/zones"
          element={
            <ProtectedRoute allowedRoles={['supplier']}>
              <DeliveryZonesPage />
            </ProtectedRoute>
          }
        />
        <Route
            path="/supplier/products"
            element={
              <ProtectedRoute allowedRoles={['supplier']}>
                <ProductManagement />
              </ProtectedRoute>
            }
          />
        <Route
          path="/supplier/orders"
          element={
            <ProtectedRoute allowedRoles={['supplier']}>
              <SupplierOrders />
            </ProtectedRoute>
          }
        />
        <Route
          path="/supplier/orders/:id"
          element={
            <ProtectedRoute allowedRoles={['supplier']}>
              <SupplierOrderDetail />
            </ProtectedRoute>
          }
        />

        {/* Admin Routes - IMPORTANT: ORDER MATTERS! */}
        <Route
          path="/admin/dashboard"
          element={
            <ProtectedRoute allowedRoles={['admin','support','accountant']}>
              <AdminDashboard />
            </ProtectedRoute>
          }
        />
        
        {/* NEW: Supplier Delivery Zones */}
        <Route
          path="/admin/supplier-zones"
          element={
            <ProtectedRoute allowedRoles={['admin','support','accountant']}>
              <AdminSupplierDeliveryZones />
            </ProtectedRoute>
          }
        />

        {/* User Management - Specific routes BEFORE dynamic :id */}
        <Route
          path="/admin/users"
          element={
            <ProtectedRoute allowedRoles={['admin','support','accountant']}>
              <UserManagement />
            </ProtectedRoute>
          }
        />
        
        {/* CREATE - Must come before :id */}
        <Route
          path="/admin/users/create"
          element={
            <ProtectedRoute allowedRoles={['admin','support','accountant']}>
              <UserCreate />
            </ProtectedRoute>
          }
        />
        
        {/* EDIT - Must come before plain :id */}
        <Route
          path="/admin/users/:id/edit"
          element={
            <ProtectedRoute allowedRoles={['admin','support','accountant']}>
              <UserEdit />
            </ProtectedRoute>
          }
        />
        
        {/* VIEW - Dynamic route comes LAST */}
        <Route
          path="/admin/users/:id"
          element={
            <ProtectedRoute allowedRoles={['admin','support','accountant']}>
              <UserDetail />
            </ProtectedRoute>
          }
        />

        {/* Master Products Routes */}
        <Route
          path="/admin/master-products"
          element={
            <ProtectedRoute allowedRoles={['admin','support','accountant']}>
              <MasterProductsList />
            </ProtectedRoute>
          }
        />
        <Route
          path="/admin/master-products/add"
          element={
            <ProtectedRoute allowedRoles={['admin','support','accountant']}>
              <AddMasterProduct />
            </ProtectedRoute>
          }
        />
        <Route
          path="/admin/master-products/edit/:id"
          element={
            <ProtectedRoute allowedRoles={['admin','support','accountant']}>
              <EditMasterProduct />
            </ProtectedRoute>
          }
        />
        <Route
          path="/admin/master-products/view/:id"
          element={
            <ProtectedRoute allowedRoles={['admin','support','accountant']}>
              <ViewMasterProduct />
            </ProtectedRoute>
          }
        />
        
        <Route
          path="/admin/profile"
          element={
            <ProtectedRoute allowedRoles={['admin','support','accountant']}>
              <ProfileSettings />
            </ProtectedRoute>
          }
        />
        {/* Admin Order Routes */}
        <Route
          path="/admin/orders"
          element={
            <ProtectedRoute allowedRoles={['admin','support','accountant']}>
              <AdminOrdersList />
            </ProtectedRoute>
          }
        />
        <Route
          path="/admin/orders/:id"
          element={
            <ProtectedRoute allowedRoles={['admin','support','accountant']}>
              <AdminOrderView />
            </ProtectedRoute>
          }
        />
        {/* Fallback */}
        <Route path="/" element={<Navigate to="/login" replace />} />
        <Route path="*" element={<Navigate to="/login" replace />} />
      </Routes>
    </BrowserRouter>
  );
};

export default AppRouter;
/* FILE: src/routes/ProtectedRoute.tsx */
// src/routes/ProtectedRoute.tsx
import { Navigate } from 'react-router-dom';
import { useAuthStore } from '../store/authStore';
import type { ReactNode } from 'react';

interface ProtectedRouteProps {
  children: ReactNode;
  allowedRoles?: ('admin' | 'client' | 'supplier' | 'accountant' | 'support')[];
}

const ProtectedRoute = ({ children, allowedRoles }: ProtectedRouteProps) => {
  const { isAuthenticated, user } = useAuthStore();

  if (!isAuthenticated) {
    return <Navigate to="/login" replace />;
  }

  if (allowedRoles && user && !allowedRoles.includes(user.role)) {
    const dashboardMap: Record<string, string> = {
      admin: '/admin/dashboard',
      client: '/client/dashboard',
      supplier: '/supplier/dashboard',
    };
    return <Navigate to={dashboardMap[user.role] || '/login'} replace />;
  }

  return <>{children}</>;
};

export default ProtectedRoute;
/* FILE: src/store/authStore.ts */
// src/store/authStore.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface User {
  id: number;
  name: string;
  email: string;
  role: 'admin' | 'client' | 'supplier' | 'support' | 'accountant';
  profile_image?: string;
  company_id?: number;
  contact_name?: string;
  contact_number?: string;
  location?: string;
  lat?: number;
  long?: number;
  delivery_radius?: number;
  shipping_address?: string;
  billing_address?: string;
  company?: {
    id: number;
    name: string;
  };
}

interface AuthState {
  user: User | null;
  token: string | null;
  isAuthenticated: boolean;
  login: (user: User, token: string) => void;
  logout: () => void;
  updateUser: (userData: Partial<User>) => void;
  checkAuth: () => Promise<boolean>;
  setToken: (token: string) => void; // ✅ NEW: Update token only
  isAdmin: () => boolean;
  isClient: () => boolean;
  isSupplier: () => boolean;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set, get) => ({
      user: null,
      token: null,
      isAuthenticated: false,
      
      // Actions
      login: (user, token) => {
        set({ user, token, isAuthenticated: true });
      },
      
      logout: () => {
        set({ user: null, token: null, isAuthenticated: false });
        localStorage.clear();
      },
      checkAuth: async () => {
        const { token, logout } = get();
        if (!token) {
          logout();
          return false;
        }

        try {
          const res = await fetch(`${import.meta.env.VITE_API_BASE_URL}user  `, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!res.ok) throw new Error('Token invalid');

          const data = await res.json();
          if (data.user) set({ user: data.user, isAuthenticated: true });
          else set({ isAuthenticated: true });

          return true;
        } catch {
          logout();
          return false;
        }
      },
      
      updateUser: (userData) => {
        set((state) => {
          if (!state.user) return state;
          
          console.log('Current user:', state.user);
          console.log('Updating with:', userData);
          
          const updatedUser = {
            ...state.user,
            ...userData,
            // Ensure nested objects like company are properly merged
            ...(userData.company && {
              company: {
                ...state.user.company,
                ...userData.company,
              },
            }),
          };
          
          console.log('Updated user:', updatedUser);
          
          return { user: updatedUser };
        });
      },
      
      // ✅ NEW: Set token only (for password change)
      setToken: (token) => {
        set({ token });
      },
      
      // Role checks
      isAdmin: () => get().user?.role === 'admin' || get().user?.role === 'support' || get().user?.role === 'accountant',
      isClient: () => get().user?.role === 'client',
      isSupplier: () => get().user?.role === 'supplier',

    }),
    {
      name: 'auth-storage',
    }
  )
);
/* FILE: src/styles/animation.css */
/* src/styles/animations.css */

/**
 * CUSTOM ANIMATIONS FOR ORDER WIZARD
 * Add these animations to your main CSS file or Tailwind config
 */

/* Fade In Animation */
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

.animate-fadeIn {
  animation: fadeIn 0.3s ease-in-out;
}

/* Slide In From Right */
@keyframes slideInRight {
  from {
    transform: translateX(100%);
  }
  to {
    transform: translateX(0);
  }
}

.animate-slideInRight {
  animation: slideInRight 0.3s ease-out;
}

/* Slide In From Left */
@keyframes slideInLeft {
  from {
    transform: translateX(-100%);
  }
  to {
    transform: translateX(0);
  }
}

.animate-slideInLeft {
  animation: slideInLeft 0.3s ease-out;
}

/* Scale In */
@keyframes scaleIn {
  from {
    transform: scale(0.95);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}

.animate-scaleIn {
  animation: scaleIn 0.2s ease-out;
}

/* Bounce */
@keyframes bounce {
  0%, 100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-5px);
  }
}

.animate-bounce {
  animation: bounce 0.6s ease-in-out infinite;
}

/* Pulse */
@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.7;
  }
}

.animate-pulse {
  animation: pulse 2s ease-in-out infinite;
}

/* Spin */
@keyframes spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

.animate-spin {
  animation: spin 1s linear infinite;
}

/* Modal Backdrop */
@keyframes backdropFadeIn {
  from {
    opacity: 0;
    backdrop-filter: blur(0px);
  }
  to {
    opacity: 1;
    backdrop-filter: blur(8px);
  }
}

.animate-backdropFadeIn {
  animation: backdropFadeIn 0.3s ease-out;
}

/* Progress Bar Fill */
@keyframes progressFill {
  from {
    width: 0%;
  }
  to {
    width: 100%;
  }
}

.animate-progressFill {
  animation: progressFill 0.5s ease-out;
}

/* Shake (for validation errors) */
@keyframes shake {
  0%, 100% {
    transform: translateX(0);
  }
  25% {
    transform: translateX(-5px);
  }
  75% {
    transform: translateX(5px);
  }
}

.animate-shake {
  animation: shake 0.3s ease-in-out;
}

/* Glow Effect */
@keyframes glow {
  0%, 100% {
    box-shadow: 0 0 5px rgba(var(--primary-600), 0.5);
  }
  50% {
    box-shadow: 0 0 20px rgba(var(--primary-600), 0.8);
  }
}

.animate-glow {
  animation: glow 2s ease-in-out infinite;
}
/* FILE: src/types/adminOrder.types.ts */
// FILE PATH: src/types/adminOrder.types.ts

/**
 * Admin Orders Type Definitions - UPDATED
 * All TypeScript interfaces for admin order management
 * Updated to match new pricing logic and backend responses
 */

// ==================== DELIVERY ZONE ====================
export interface DeliveryZone {
  address: string;
  lat: number;
  long: number;
  radius: number;
}

// ==================== ELIGIBLE SUPPLIER ====================
export interface EligibleSupplier {
  supplier_id: number;
  id:number;
  name: string;
  offer_id: number;
  distance: number | null;
  unit_cost: number | null;
}

// ==================== ORDER ITEM (UPDATED) ====================
export interface AdminOrderItem {
  id: number;
  product_id: number;
  product_name: string;
  quantity: number;
  
  // Supplier Info
  supplier?: {
    id: number;
    name: string;
    profile_image?: string;
    delivery_zones?: DeliveryZone[];
  } | null;
  supplier_id?: number | null;
  choosen_offer_id?: number | null;
  
  // Supplier Costs
  supplier_unit_cost?: number | null;
  supplier_delivery_cost?: number | null;  // NEW
  supplier_discount?: number | null;
  delivery_cost?: number | null;
  delivery_type?: string | null;
  supplier_delivery_date?: string | null;
  supplier_notes?: string;
  
  // Status Fields
  supplier_confirms?: number; // 0 or 1
  is_quoted: number; // 0 or 1
  is_paid: number; // 0 or 1 - NEW usage
  supplier_status?: string; // 'Paid' | 'Unpaid' - NEW
  
  // Quoted Price
  quoted_price?: number | null;
  
  // Eligible Suppliers (for assignment)
  eligible_suppliers?: EligibleSupplier[];
}

// ==================== ORDER DETAIL (UPDATED) ====================
export interface AdminOrderDetail {
  id: number;
  po_number: string;
  client: string;
  project: string;
  delivery_address: string;
  delivery_lat: number | null;
  delivery_long: number | null;
  delivery_date: string;
  delivery_time: string;
  workflow: WorkflowStatus;
  payment_status: PaymentStatus;
  
  // NEW: Supplier Costs Breakdown
  supplier_item_cost: number;
  supplier_delivery_cost: number;
  supplier_total: number;
  
  
  // NEW: Customer Costs Breakdown
  customer_item_cost: number;
  customer_delivery_cost: number;
  
  // Legacy fields (kept for backward compatibility)
  supplier_cost: number;
  customer_cost: number;
  
  // Profit & Calculations
  admin_margin: number;
  profit_amount: number; // NEW - same as admin_margin
  profit_before_tax: number; // NEW
  profit_margin_percent: number; // NEW
  
  // Charges & Taxes
  gst_tax: number;
  subtotal: number;
  discount: number;
  fuel_levy: number;
  other_charges: number;
  total_price: number; // NEW - same as customer_cost
  
  // Additional Info
  special_notes?: string | null;
  delivery_method?: string;
  
  // Items
  items: AdminOrderItem[];
  
  // Filters
  filters: {
    projects: ProjectFilter[];
  };
}

// ==================== ORDER LIST ITEM (UPDATED) ====================
export interface AdminOrder {
  id: number;
  po_number: string;
  client: string;
  project: string;
  delivery_date: string;
  delivery_time: string;
  delivery_method?: string;
  workflow: WorkflowStatus;
  payment_status: PaymentStatus;
  order_process?: string;
  items_count: number;
  unassigned_items_count: number;
  suppliers_count: number;
  
  // NEW: Supplier costs
  supplier_item_cost: number;
  supplier_delivery_cost: number;
  supplier_total: number;
  
  // NEW: Customer costs
  customer_item_cost: number;
  customer_delivery_cost: number;
  
  // Totals and profit
  total_price: number;
  profit_amount: number;
  profit_margin_percent: number;
  
  // Other charges
  gst_tax: number;
  discount: number;
  other_charges: number;
  
  order_info?: string | null;
  repeat_order?: boolean;
  created_at: string;
  updated_at: string;
}

// ==================== FILTERS ====================
export interface UserFilter {
  id: number;
  name: string;
  profile_image?: string;
}

export interface ProjectFilter {
  id: number;
  name: string;
}

export interface AdminOrderFilters {
  clients: UserFilter[];
  suppliers: UserFilter[];
  projects: ProjectFilter[];
  workflows: WorkflowStatus[];
  payment_statuses: PaymentStatus[];
  delivery_methods: string[];
}

// ==================== METRICS ====================
export interface AdminOrderMetrics {
  total_orders_count: number;
  supplier_missing_count: number;
  supplier_assigned_count: number;
  awaiting_payment_count: number;
  delivered_count: number;
}

// ==================== API RESPONSES ====================
export interface AdminOrdersListResponse {
  data: AdminOrder[];
  pagination: {
    per_page: number;
    current_page: number;
    total_pages: number;
    total_items: number;
    has_more_pages: boolean;
  };
  metrics: AdminOrderMetrics;
  filters?: AdminOrderFilters;
}

export interface AdminOrderDetailResponse {
  data: AdminOrderDetail;
}

// ==================== API QUERY PARAMS ====================
export interface AdminOrdersQueryParams {
  per_page?: number;
  search?: string;
  client_id?: string;
  project_id?: string;
  supplier_id?: string;
  workflow?: string;
  payment_status?: string;
  delivery_date_from?: string;
  delivery_date_to?: string;
  delivery_method?: string;
  repeat_order?: string;
  has_missing_supplier?: string;
  supplier_confirms?: string;
  min_total?: string;
  max_total?: string;
  sort?: string;
  dir?: string;
  details?: boolean;
  page?: number;
}

// ==================== UPDATE PAYLOADS ====================

/**
 * Admin Update Payload
 * Used for /admin/orders/{id}/admin-update endpoint
 */
export interface AdminOrderUpdatePayload {
  discount?: number;  // For discount updates
  item_id?: number;   // For payment status updates
  is_paid?: boolean;  // For marking item as paid/unpaid
}

/**
 * Assign Supplier Payload
 * Used for /admin/orders/{orderId}/items/{itemId}/assign-supplier endpoint
 */
export interface AssignSupplierPayload {
  order_id: number;
  item_id: number;
  supplier: number;
  offer_id?: number;
}

/**
 * Set Quoted Price Payload
 * Used for /admin/orders/{orderId}/items/{itemId}/quoted-price endpoint
 */
export interface SetQuotedPricePayload {
  quoted_price: number | null;
}

// ==================== ENUMS ====================
export type WorkflowStatus =
  | 'Requested'
  | 'Supplier Missing'
  | 'Supplier Assigned'
  | 'Payment Requested'
  | 'On Hold'
  | 'Delivered';

export type PaymentStatus =
  | 'Pending'
  | 'Requested'
  | 'Paid'
  | 'Partially Paid'
  | 'Partial Refunded'
  | 'Refunded';

// ==================== HELPER TYPES ====================

/**
 * Response from adminUpdate endpoint
 */
export interface AdminUpdateResponse {
  success: boolean;
  message: string;
  order?: AdminOrderDetail;
  item?: AdminOrderItem;
}

/**
 * Response from assignSupplier endpoint
 */
export interface AssignSupplierResponse {
  message: string;
  order: {
    id: number;
    workflow: WorkflowStatus;
    total_price: number;
    profit_amount: number;
    profit_margin_percent: number;
  };
  item: {
    id: number;
    product_id: number;
    supplier_id: number;
    choosen_offer_id: number;
    supplier_unit_cost: number;
    supplier_discount: number;
    supplier_delivery_cost: number | null;
    delivery_type: string | null;
    delivery_cost: number | null;
  };
  offer: {
    id: number;
    supplier_id: number;
    master_product_id: number;
  };
}

/**
 * Response from setItemQuotedPrice endpoint
 */
export interface SetQuotedPriceResponse {
  message: string;
  order: {
    id: number;
    customer_item_cost: number;
    customer_delivery_cost: number;
    gst_tax: number;
    total_price: number;
    profit_amount: number;
    profit_margin_percent: number;
  };
  item: {
    id: number;
    is_quoted: number;
    quoted_price: number | null;
  };
}



/**
 * Admin Update Order Item Payload
 * Used for /admin/update-item-pricing/{orderItem} endpoint
 */
export interface AdminUpdateOrderItemPayload {
  supplier_unit_cost?: number;
  supplier_discount?: number;
  delivery_cost?: number;
  delivery_type?: 'Included' | 'Supplier' | 'ThirdParty' | 'Fleet' | 'None';
  supplier_delivery_date?: string; // ISO date format
  supplier_confirms?: boolean;
  supplier_notes?: string;
  quantity?: number; // NEW: Allow quantity update
}

/**
 * Response from adminUpdateOrderItem endpoint
 */
export interface AdminUpdateOrderItemResponse {
  success: boolean;
  message: string;
  data: AdminOrderItem;
}







/* FILE: src/types/clientOrder.types.ts */
// src/types/clientOrder.types.ts

import type { WorkflowStatus } from "./adminOrder.types";

export type OrderStatus = 'Draft' | 'Confirmed' | 'Scheduled' | 'In Transit' | 'Delivered' | 'Completed' | 'Cancelled';
export type PaymentStatus = 'Pending' | 'Partially Paid' | 'Paid' | 'Partial Refunded' | 'Refunded' | 'Requested';

export interface ClientOrder {
  id: number;
  po_number: string;

  project: {
    id: number;
    name: string;
    added_by: number;
    site_contact_name?: string | null;
    site_contact_phone?: string | null;
    site_instructions?: string | null;
    delivery_address?: string | null;
    delivery_lat?: number | null;
    delivery_long?: number | null;
    created_at: string;
    updated_at: string;
  };

  // Delivery
  delivery_address: string;
  delivery_date: string;
  delivery_time: string;
  delivery_method: string;

  // Status
  order_status: OrderStatus;
  workflow: WorkflowStatus;
  payment_status: PaymentStatus;

  // Counts / totals
  items_count: number;
  total_price: number;
  gst_tax: number;
  discount: number;

  repeat_order: boolean;
  order_info?: string | null;

  created_at: string;
  updated_at: string;
  reason?: string;

  // Pricing breakdown (NEW)
  customer_item_cost?: number;
  customer_delivery_cost?: number;
  supplier_item_cost?: number;
  supplier_delivery_cost?: number;
  other_charges?: number;
}


export interface ClientOrderMetrics {
  total_orders_count: number;
  draft_count: number;
  confirmed_count: number;
  scheduled_count: number;
  in_transit_count: number;
  delivered_count: number;
  completed_count: number;
  cancelled_count: number;
}

export interface ProjectFilter {
  id: number;
  name: string;
}

export interface ClientOrderFilters {
  projects: ProjectFilter[];
  order_statuses: OrderStatus[];
  payment_statuses: PaymentStatus[];
  delivery_methods: string[];
}

export interface ClientOrdersListResponse {
  data: ClientOrder[];
  pagination: {
    per_page: number;
    current_page: number;
    total_pages: number;
    total_items: number;
    has_more_pages: boolean;
  };
  metrics: ClientOrderMetrics;
  projects?: ProjectFilter[];
  order_statuses?: OrderStatus[];
  payment_statuses?: PaymentStatus[];
  delivery_methods?: string[];
}

export interface ClientOrdersQueryParams {
  per_page?: number;
  search?: string;
  project_id?: string;
  order_status?: string;
  payment_status?: string;
  delivery_date?: string;
  delivery_method?: string;
  repeat_order?: string;
  sort?: string;
  dir?: string;
  details?: boolean;
  page?: number;
}

export interface RepeatOrderPayload {
  items: Array<{
    product_id: number;
    quantity: number;
  }>;
}

export interface ClientOrdersResponse {
  data: ClientOrderListItem[];
  pagination: {
    per_page: number;
    current_page: number;
    total_pages: number;
    total_items: number;
    has_more_pages: boolean;
  };
  metrics: ClientOrderMetrics;
  projects?: Array<{
    id: number;
    name: string;
  }>;
  order_statuses?: OrderStatus[];
  payment_statuses?: PaymentStatus[];
  delivery_methods?: string[];
}


export interface ClientOrderListItem {
  id: number;
  po_number: string;
  project_id: number;
  client_id: number;
  workflow: string;

  // Status
  order_status: OrderStatus;
  payment_status: PaymentStatus;

  delivery_address: string;
  delivery_date: string;
  delivery_time: string;
  delivery_method?: string;

  repeat_order: boolean;
  order_info?: string | null;

  created_at: string;
  updated_at: string;

  // Counts / totals for list view
  items_count: number;
  discount: number;
  total_price?: number;
  gst_tax?: number;

  // Pricing breakdown (optional)
  customer_item_cost?: number;
  customer_delivery_cost?: number;

  // Legacy
  subtotal?: number;
  fuel_levy?: number;
  other_charges?: number;

  // Relationships
  project?: {
    id: number;
    name: string;
  };
}

export interface ClientOrderDetailResponse {
  success: boolean;
  data: ClientOrderDetail;
}


export interface ClientOrderDetail {
  order: ClientOrder;
  items: ClientOrderItem[];
}

export interface ClientOrderItem {
}
/* FILE: src/types/order.types.ts */
/* FILE: src/types/order.types.ts */
// FILE PATH: src/types/order.types.ts

/**
 * Order Module Type Definitions
 * 
 * Defines TypeScript interfaces for:
 * - Product listings and details
 * - Shopping cart items
 * - Projects
 * - Order creation and responses
 */

// ==================== PRODUCT TYPES ====================

export interface Product {
  id: number;
  added_by: number;
  is_approved: number;
  approved_by: number;
  slug: string;
  category: {
    id: number;
    name: string;
  };
  product_name: string;
  product_type: string;
  specifications: string;
  unit_of_measure: string;
  tech_doc: string | null;
  photo: string;
  created_at: string;
  updated_at: string;
  price_min?: string;
  price_max?: string;
  price?: string;
}

export interface ProductsResponse {
  data: Product[];
  meta: {
    current_page: number;
    per_page: number;
    total: number;
    last_page: number;
  };
}

// ==================== CART TYPES ====================

export interface CartItem {
  product_id: number;
  product_name: string;
  product_photo: string;
  product_type: string;
  quantity: number;
  unit_of_measure: string;
  custom_blend_mix?: string;
}

// ==================== PROJECT TYPES ====================

/**
 * Project interface matching Laravel API response
 * FIXED: Using 'name' instead of 'project_name' to match API
 */
export interface Project {
  id: number;
  name: string; // ✅ Fixed: was 'project_name'
  site_contact_name?: string | null;
  site_contact_phone?: string | null;
  site_instructions?: string | null;
  delivery_address?: string;
  delivery_lat?: number;
  delivery_long?: number;
  added_by: number;
  created_at: string;
  updated_at: string;
}

// ==================== ORDER TYPES ====================

export interface OrderFormData {
  po_number?: string;
  project_id: number;
  delivery_address: string;
  delivery_lat: number;
  delivery_long: number;
  delivery_date: string;
  delivery_time?: string;
  load_size?: string;
  special_equipment?: string;
  special_notes?: string;
  repeat_order?: boolean;
  items: {
    product_id: number;
    quantity: number;
    custom_blend_mix?: string | null;
  }[];
}

export interface OrderResponse {
  message: string;
  order: {
    id: number;
    po_number: string;
    project_id: number;
    delivery_address: string;
    delivery_date: string;
    delivery_method: string;
    order_status: string;
    payment_status: string;
    workflow: string;
    created_at: string;
    items_count: number;
  };
}
/* FILE: src/utils/cartUtils.ts */
// src/utils/cartUtils.ts
import type { CartItem } from '../types/order.types';

const CART_STORAGE_KEY = 'client_order_cart';

export const cartUtils = {
  // Get all cart items
  getCart: (): CartItem[] => {
    try {
      const cart = localStorage.getItem(CART_STORAGE_KEY);
      return cart ? JSON.parse(cart) : [];
    } catch (error) {
      console.error('Error reading cart from localStorage:', error);
      return [];
    }
  },

  // Save cart to localStorage
  saveCart: (cart: CartItem[]): void => {
    try {
      localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
    } catch (error) {
      console.error('Error saving cart to localStorage:', error);
    }
  },

  // Add item to cart
  addItem: (product: {
    id: number;
    product_name: string;
    photo: string;
    product_type: string;
    unit_of_measure: string;
  }): CartItem[] => {
    const cart = cartUtils.getCart();
    
    // Check if product already exists
    const existingIndex = cart.findIndex(item => item.product_id === product.id);
    
    if (existingIndex > -1) {
      // Increment quantity
      cart[existingIndex].quantity += 1;
    } else {
      // Add new item
      cart.push({
        product_id: product.id,
        product_name: product.product_name,
        product_photo: product.photo,
        product_type: product.product_type,
        quantity: 1,
        unit_of_measure: product.unit_of_measure,
        custom_blend_mix: undefined,
      });
    }
    
    cartUtils.saveCart(cart);
    return cart;
  },

  // Update item quantity
  updateQuantity: (productId: number, quantity: number): CartItem[] => {
    const cart = cartUtils.getCart();
    const index = cart.findIndex(item => item.product_id === productId);
    
    if (index > -1) {
      if (quantity <= 0) {
        // Remove item if quantity is 0 or less
        cart.splice(index, 1);
      } else {
        cart[index].quantity = quantity;
      }
      cartUtils.saveCart(cart);
    }
    
    return cart;
  },

  // Update custom blend
  updateCustomBlend: (productId: number, customBlend: string): CartItem[] => {
    const cart = cartUtils.getCart();
    const index = cart.findIndex(item => item.product_id === productId);
    
    if (index > -1) {
      cart[index].custom_blend_mix = customBlend || undefined;
      cartUtils.saveCart(cart);
    }
    
    return cart;
  },

  // Remove item
  removeItem: (productId: number): CartItem[] => {
    const cart = cartUtils.getCart();
    const filtered = cart.filter(item => item.product_id !== productId);
    cartUtils.saveCart(filtered);
    return filtered;
  },

  // Clear entire cart
  clearCart: (): void => {
    localStorage.removeItem(CART_STORAGE_KEY);
  },

  // Get cart count
  getCartCount: (): number => {
    const cart = cartUtils.getCart();
    return cart.reduce((total, item) => total + item.quantity, 0);
  },

  // Check if product is in cart
  isInCart: (productId: number): boolean => {
    const cart = cartUtils.getCart();
    return cart.some(item => item.product_id === productId);
  },
};


/* FILE: src/utils/colors.ts */
// FILE PATH: src/utils/colors.ts

/**
 * Professional Color Palette
 * Consistent colors used across the admin order view
 */

export const COLORS = {
  // Primary - Blue (for main actions, info)
  primary: {
    50: '#eff6ff',
    100: '#dbeafe',
    200: '#bfdbfe',
    300: '#93c5fd',
    400: '#60a5fa',
    500: '#3b82f6',
    600: '#2563eb',
    700: '#1d4ed8',
    800: '#1e40af',
    900: '#1e3a8a',
  },
  
  // Success - Green (for positive states, confirmed, paid)
  success: {
    50: '#f0fdf4',
    100: '#dcfce7',
    200: '#bbf7d0',
    300: '#86efac',
    400: '#4ade80',
    500: '#22c55e',
    600: '#16a34a',
    700: '#15803d',
    800: '#166534',
    900: '#14532d',
  },
  
  // Warning - Amber (for pending states, attention needed)
  warning: {
    50: '#fffbeb',
    100: '#fef3c7',
    200: '#fde68a',
    300: '#fcd34d',
    400: '#fbbf24',
    500: '#f59e0b',
    600: '#d97706',
    700: '#b45309',
    800: '#92400e',
    900: '#78350f',
  },
  
  // Danger - Red (for errors, negative states)
  danger: {
    50: '#fef2f2',
    100: '#fee2e2',
    200: '#fecaca',
    300: '#fca5a5',
    400: '#f87171',
    500: '#ef4444',
    600: '#dc2626',
    700: '#b91c1c',
    800: '#991b1b',
    900: '#7f1d1d',
  },
  
  // Purple - For special features (quoted prices, profit)
  purple: {
    50: '#faf5ff',
    100: '#f3e8ff',
    200: '#e9d5ff',
    300: '#d8b4fe',
    400: '#c084fc',
    500: '#a855f7',
    600: '#9333ea',
    700: '#7e22ce',
    800: '#6b21a8',
    900: '#581c87',
  },
  
  // Indigo - For secondary actions
  indigo: {
    50: '#eef2ff',
    100: '#e0e7ff',
    200: '#c7d2fe',
    300: '#a5b4fc',
    400: '#818cf8',
    500: '#6366f1',
    600: '#4f46e5',
    700: '#4338ca',
    800: '#3730a3',
    900: '#312e81',
  },
  
  // Gray - For neutral elements
  gray: {
    50: '#f9fafb',
    100: '#f3f4f6',
    200: '#e5e7eb',
    300: '#d1d5db',
    400: '#9ca3af',
    500: '#6b7280',
    600: '#4b5563',
    700: '#374151',
    800: '#1f2937',
    900: '#111827',
  },
};

/**
 * Workflow Status Colors
 */
export const WORKFLOW_COLORS = {
  'Requested': {
    bg: COLORS.primary[50],
    text: COLORS.primary[700],
    border: COLORS.primary[300],
  },
  'Supplier Missing': {
    bg: COLORS.warning[50],
    text: COLORS.warning[700],
    border: COLORS.warning[300],
  },
  'Supplier Assigned': {
    bg: COLORS.indigo[50],
    text: COLORS.indigo[700],
    border: COLORS.indigo[300],
  },
  'Payment Requested': {
    bg: COLORS.purple[50],
    text: COLORS.purple[700],
    border: COLORS.purple[300],
  },
  'On Hold': {
    bg: COLORS.gray[100],
    text: COLORS.gray[700],
    border: COLORS.gray[300],
  },
  'Delivered': {
    bg: COLORS.success[50],
    text: COLORS.success[700],
    border: COLORS.success[300],
  },
};

/**
 * Payment Status Colors
 */
export const PAYMENT_COLORS = {
  'Pending': {
    bg: COLORS.gray[100],
    text: COLORS.gray[700],
    border: COLORS.gray[300],
  },
  'Requested': {
    bg: COLORS.warning[50],
    text: COLORS.warning[700],
    border: COLORS.warning[300],
  },
  'Paid': {
    bg: COLORS.success[50],
    text: COLORS.success[700],
    border: COLORS.success[300],
  },
  'Partially Paid': {
    bg: COLORS.indigo[50],
    text: COLORS.indigo[700],
    border: COLORS.indigo[300],
  },
  'Partial Refunded': {
    bg: COLORS.purple[50],
    text: COLORS.purple[700],
    border: COLORS.purple[300],
  },
  'Refunded': {
    bg: COLORS.danger[50],
    text: COLORS.danger[700],
    border: COLORS.danger[300],
  },
};

/**
 * Tab Colors
 */
export const TAB_COLORS = {
  overview: {
    active: `bg-blue-600 text-white border-blue-700`,
    inactive: `text-blue-700 hover:bg-blue-50 border-blue-200`,
    icon: COLORS.primary[600],
  },
  items: {
    active: `bg-purple-600 text-white border-purple-700`,
    inactive: `text-purple-700 hover:bg-purple-50 border-purple-200`,
    icon: COLORS.purple[600],
  },
  costing: {
    active: `bg-green-600 text-white border-green-700`,
    inactive: `text-green-700 hover:bg-green-50 border-green-200`,
    icon: COLORS.success[600],
  },
  map: {
    active: `bg-orange-600 text-white border-orange-700`,
    inactive: `text-orange-700 hover:bg-orange-50 border-orange-200`,
    icon: '#ea580c', // orange-600
  },
  admin: {
    active: `bg-indigo-600 text-white border-indigo-700`,
    inactive: `text-indigo-700 hover:bg-indigo-50 border-indigo-200`,
    icon: COLORS.indigo[600],
  },
};

/**
 * Get workflow badge classes
 */
export const getWorkflowBadgeClass = (workflow: string): string => {
  const colors = WORKFLOW_COLORS[workflow as keyof typeof WORKFLOW_COLORS];
  if (!colors) return 'bg-gray-100 text-gray-700 border-gray-300';
  
  return `bg-[${colors.bg}] text-[${colors.text}] border-[${colors.border}]`;
};

/**
 * Get payment badge classes
 */
export const getPaymentBadgeClass = (status: string): string => {
  const colors = PAYMENT_COLORS[status as keyof typeof PAYMENT_COLORS];
  if (!colors) return 'bg-gray-100 text-gray-700 border-gray-300';
  
  return `bg-[${colors.bg}] text-[${colors.text}] border-[${colors.border}]`;
};

/* FILE: src/utils/menuItems.tsx */
// src/utils/menuItems.tsx
// ============================================
// MENU ITEMS WITH PERMISSION-BASED FILTERING
// ============================================
// NOTE: This file MUST be .tsx (not .ts) because it contains JSX

import {
  Home,
  Users,
  Package,
  ShoppingCart,
  MapPin,
  FolderOpen,
  DollarSign,
  User,
  PlusCircle,
  CreditCard,
} from 'lucide-react';
import type { ReactNode } from 'react';
import type { Role } from '../config/permissions';

// ==================== TYPES ====================

export interface MenuItem {
  label: string;
  path: string;
  icon: ReactNode;
}

// ==================== CLIENT MENU ====================

export const clientMenuItems: MenuItem[] = [
  { label: 'Dashboard', path: '/client/dashboard', icon: <Home size={20} /> },
  { label: 'Projects', path: '/client/projects', icon: <FolderOpen size={20} /> },
  { label: 'Orders', path: '/client/orders', icon: <ShoppingCart size={20} /> },
  { label: 'New Order', path: '/client/orders/create', icon: <PlusCircle size={20} /> },
];

// ==================== ADMIN MENU (Full Access) ====================

export const adminMenuItems: MenuItem[] = [
  { label: 'Dashboard', path: '/admin/dashboard', icon: <Home size={20} /> },
  { label: 'Users', path: '/admin/users', icon: <Users size={20} /> },
  { label: 'Products', path: '/admin/master-products', icon: <Package size={20} /> },
  { label: 'Supplier Zones', path: '/admin/supplier-zones', icon: <MapPin size={20} /> },
  { label: 'Orders', path: '/admin/orders', icon: <ShoppingCart size={20} /> },
  // { label: 'Payments', path: '/admin/payments', icon: <CreditCard size={20} /> },
  // { label: 'Reports', path: '/admin/reports', icon: <BarChart3 size={20} /> },
  // { label: 'Settings', path: '/admin/settings', icon: <Settings size={20} /> },
];

// ==================== SUPPLIER MENU ====================

export const supplierMenuItems: MenuItem[] = [
  { label: 'Dashboard', path: '/supplier/dashboard', icon: <Home size={20} /> },
  { label: 'My Products', path: '/supplier/products', icon: <Package size={20} /> },
  { label: 'Orders', path: '/supplier/orders', icon: <DollarSign size={20} /> },
  { label: 'Delivery Zones', path: '/supplier/zones', icon: <MapPin size={20} /> },
  { label: 'Profile', path: '/supplier/profile', icon: <User size={20} /> },
];

// ==================== SUPPORT MENU (Ops Support) ====================
// Can: view all, edit projects, create orders, mark delivered, enter quoted rates
// Cannot: view cost price, view profit margin, edit supplier rates

export const supportMenuItems: MenuItem[] = [
  { label: 'Dashboard', path: '/admin/dashboard', icon: <Home size={20} /> },
  { label: 'Users', path: '/admin/users', icon: <Users size={20} /> },
  { label: 'Products', path: '/admin/master-products', icon: <Package size={20} /> },
  { label: 'Supplier Zones', path: '/admin/supplier-zones', icon: <MapPin size={20} /> },
  { label: 'Orders', path: '/admin/orders', icon: <ShoppingCart size={20} /> },
  // No Payments, Reports, or Settings for Support
];

// ==================== ACCOUNTANT MENU ====================
// Can: view all (read-only), view cost price, view profit margin, reports
// Cannot: edit anything, create orders, mark delivered

export const accountantMenuItems: MenuItem[] = [
  { label: 'Dashboard', path: '/admin/dashboard', icon: <Home size={20} /> },
  { label: 'Users', path: '/admin/users', icon: <Users size={20} /> },
  { label: 'Orders', path: '/admin/orders', icon: <ShoppingCart size={20} /> },
  { label: 'Xero (Coming Soon)', path: '/admin/dashboard', icon: <CreditCard size={20} /> },
  // { label: 'Reports', path: '/admin/reports', icon: <BarChart3 size={20} /> },
  // No Products, Supplier Zones, or Settings for Accountant
];

// ==================== MENU GETTER BY ROLE ====================

/**
 * Get menu items based on user role
 * Returns the appropriate menu items for each role
 */
export const getMenuItemsByRole = (role: Role | null | undefined): MenuItem[] => {
  if (!role) {
    return []; // Return empty array if no role
  }
  
  switch (role) {
    case 'admin':
      return adminMenuItems;
    case 'support':
      return supportMenuItems;
    case 'accountant':
      return accountantMenuItems;
    case 'supplier':
      return supplierMenuItems;
    case 'client':
      return clientMenuItems;
    default:
      return [];
  }
};
/* FILE: src/utils/menuItemss.ts */
// // src/utils/menuItems.ts
// // ============================================
// // MENU ITEMS WITH PERMISSION-BASED FILTERING
// // ============================================

// import {
//   LayoutDashboard,
//   Users,
//   Package,
//   ShoppingCart,
//   Settings,
//   MapPin,
//   Building2,
//   Truck,
//   FolderKanban,
//   CreditCard,
//   BarChart3,
//   Tags,
//   type LucideIcon,
// } from 'lucide-react';
// import { Permission, Role, roleHasPermission } from '../config/permissions';

// // ==================== TYPES ====================

// export interface MenuItem {
//   id: string;
//   label: string;
//   icon: LucideIcon;
//   path: string;
//   /** Permissions required to see this menu item (any one is enough) */
//   permissions?: Permission[];
//   /** If true, requires ALL permissions */
//   requireAllPermissions?: boolean;
//   /** Specific roles that can see this (bypasses permissions) */
//   allowedRoles?: Role[];
//   /** Badge count (optional) */
//   badge?: number;
//   /** Sub-menu items */
//   children?: MenuItem[];
// }

// // ==================== ADMIN MENU ITEMS (RAW) ====================
// // These are all the menu items - filtering happens based on role

// const allAdminMenuItems: MenuItem[] = [
//   {
//     id: 'dashboard',
//     label: 'Dashboard',
//     icon: LayoutDashboard,
//     path: '/admin/dashboard',
//     permissions: ['system.view_dashboard'],
//   },
//   {
//     id: 'users',
//     label: 'User Management',
//     icon: Users,
//     path: '/admin/users',
//     permissions: ['users.view'],
//   },
//   {
//     id: 'orders',
//     label: 'Orders',
//     icon: ShoppingCart,
//     path: '/admin/orders',
//     permissions: ['orders.view_all'],
//   },
//   {
//     id: 'master-products',
//     label: 'Master Products',
//     icon: Package,
//     path: '/admin/master-products',
//     permissions: ['products.view'],
//   },
//   {
//     id: 'categories',
//     label: 'Categories',
//     icon: Tags,
//     path: '/admin/categories',
//     permissions: ['system.manage_categories'],
//     allowedRoles: ['admin'], // Only admin can manage categories
//   },
//   {
//     id: 'supplier-zones',
//     label: 'Supplier Zones',
//     icon: MapPin,
//     path: '/admin/supplier-zones',
//     permissions: ['suppliers.view_zones'],
//   },
//   {
//     id: 'clients',
//     label: 'Clients',
//     icon: Building2,
//     path: '/admin/clients',
//     permissions: ['clients.view'],
//   },
//   {
//     id: 'suppliers',
//     label: 'Suppliers',
//     icon: Truck,
//     path: '/admin/suppliers',
//     permissions: ['suppliers.view'],
//   },
//   {
//     id: 'projects',
//     label: 'Projects',
//     icon: FolderKanban,
//     path: '/admin/projects',
//     permissions: ['projects.view_all'],
//   },
//   {
//     id: 'payments',
//     label: 'Payments',
//     icon: CreditCard,
//     path: '/admin/payments',
//     permissions: ['payments.view'],
//   },
//   {
//     id: 'reports',
//     label: 'Reports',
//     icon: BarChart3,
//     path: '/admin/reports',
//     permissions: ['reports.view'],
//   },
//   {
//     id: 'settings',
//     label: 'Settings',
//     icon: Settings,
//     path: '/admin/settings',
//     permissions: ['system.manage_settings'],
//     allowedRoles: ['admin'], // Only admin can access settings
//   },
// ];

// // ==================== FILTER FUNCTION ====================

// /**
//  * Filter menu items based on user's role and permissions
//  */
// export const filterMenuItemsByRole = (items: MenuItem[], role: Role): MenuItem[] => {
//   return items.filter((item) => {
//     // Check allowedRoles first (bypasses permissions)
//     if (item.allowedRoles && item.allowedRoles.length > 0) {
//       if (!item.allowedRoles.includes(role)) {
//         return false;
//       }
//       return true;
//     }

//     // Check permissions
//     if (item.permissions && item.permissions.length > 0) {
//       if (item.requireAllPermissions) {
//         // Require ALL permissions
//         return item.permissions.every((perm) => roleHasPermission(role, perm));
//       } else {
//         // Require ANY permission
//         return item.permissions.some((perm) => roleHasPermission(role, perm));
//       }
//     }

//     // No restrictions, show the item
//     return true;
//   });
// };

// /**
//  * Get filtered admin menu items for a specific role
//  */
// export const getAdminMenuItems = (role: Role): MenuItem[] => {
//   return filterMenuItemsByRole(allAdminMenuItems, role);
// };

// // ==================== STATIC EXPORTS (for backwards compatibility) ====================

// // Full admin menu (for actual admin role)
// export const adminMenuItems: MenuItem[] = [
//   {
//     id: 'dashboard',
//     label: 'Dashboard',
//     icon: LayoutDashboard,
//     path: '/admin/dashboard',
//   },
//   {
//     id: 'users',
//     label: 'User Management',
//     icon: Users,
//     path: '/admin/users',
//   },
//   {
//     id: 'orders',
//     label: 'Orders',
//     icon: ShoppingCart,
//     path: '/admin/orders',
//   },
//   {
//     id: 'master-products',
//     label: 'Master Products',
//     icon: Package,
//     path: '/admin/master-products',
//   },
//   {
//     id: 'categories',
//     label: 'Categories',
//     icon: Tags,
//     path: '/admin/categories',
//   },
//   {
//     id: 'supplier-zones',
//     label: 'Supplier Zones',
//     icon: MapPin,
//     path: '/admin/supplier-zones',
//   },
//   {
//     id: 'clients',
//     label: 'Clients',
//     icon: Building2,
//     path: '/admin/clients',
//   },
//   {
//     id: 'suppliers',
//     label: 'Suppliers',
//     icon: Truck,
//     path: '/admin/suppliers',
//   },
//   {
//     id: 'projects',
//     label: 'Projects',
//     icon: FolderKanban,
//     path: '/admin/projects',
//   },
//   {
//     id: 'payments',
//     label: 'Payments',
//     icon: CreditCard,
//     path: '/admin/payments',
//   },
//   {
//     id: 'reports',
//     label: 'Reports',
//     icon: BarChart3,
//     path: '/admin/reports',
//   },
//   {
//     id: 'settings',
//     label: 'Settings',
//     icon: Settings,
//     path: '/admin/settings',
//   },
// ];

// // Client menu items
// export const clientMenuItems: MenuItem[] = [
//   {
//     id: 'dashboard',
//     label: 'Dashboard',
//     icon: LayoutDashboard,
//     path: '/client/dashboard',
//   },
//   {
//     id: 'projects',
//     label: 'My Projects',
//     icon: FolderKanban,
//     path: '/client/projects',
//   },
//   {
//     id: 'orders',
//     label: 'My Orders',
//     icon: ShoppingCart,
//     path: '/client/orders',
//   },
//   {
//     id: 'profile',
//     label: 'Profile',
//     icon: Users,
//     path: '/client/profile',
//   },
// ];

// // Supplier menu items
// export const supplierMenuItems: MenuItem[] = [
//   {
//     id: 'dashboard',
//     label: 'Dashboard',
//     icon: LayoutDashboard,
//     path: '/supplier/dashboard',
//   },
//   {
//     id: 'products',
//     label: 'My Products',
//     icon: Package,
//     path: '/supplier/products',
//   },
//   {
//     id: 'orders',
//     label: 'Orders',
//     icon: ShoppingCart,
//     path: '/supplier/orders',
//   },
//   {
//     id: 'delivery-zones',
//     label: 'Delivery Zones',
//     icon: MapPin,
//     path: '/supplier/delivery-zones',
//   },
//   {
//     id: 'profile',
//     label: 'Profile',
//     icon: Users,
//     path: '/supplier/profile',
//   },
// ];

// // ==================== ROLE-SPECIFIC ADMIN MENUS ====================

// // Support role menu (limited admin access)
// export const supportMenuItems: MenuItem[] = [
//   {
//     id: 'dashboard',
//     label: 'Dashboard',
//     icon: LayoutDashboard,
//     path: '/admin/dashboard',
//   },
//   {
//     id: 'users',
//     label: 'User Management',
//     icon: Users,
//     path: '/admin/users',
//   },
//   {
//     id: 'orders',
//     label: 'Orders',
//     icon: ShoppingCart,
//     path: '/admin/orders',
//   },
//   {
//     id: 'master-products',
//     label: 'Master Products',
//     icon: Package,
//     path: '/admin/master-products',
//   },
//   {
//     id: 'supplier-zones',
//     label: 'Supplier Zones',
//     icon: MapPin,
//     path: '/admin/supplier-zones',
//   },
//   {
//     id: 'clients',
//     label: 'Clients',
//     icon: Building2,
//     path: '/admin/clients',
//   },
//   {
//     id: 'suppliers',
//     label: 'Suppliers',
//     icon: Truck,
//     path: '/admin/suppliers',
//   },
//   {
//     id: 'projects',
//     label: 'Projects',
//     icon: FolderKanban,
//     path: '/admin/projects',
//   },
// ];

// // Accountant role menu (read-only focus + reports)
// export const accountantMenuItems: MenuItem[] = [
//   {
//     id: 'dashboard',
//     label: 'Dashboard',
//     icon: LayoutDashboard,
//     path: '/admin/dashboard',
//   },
//   {
//     id: 'orders',
//     label: 'Orders',
//     icon: ShoppingCart,
//     path: '/admin/orders',
//   },
//   {
//     id: 'users',
//     label: 'Users',
//     icon: Users,
//     path: '/admin/users',
//   },
//   {
//     id: 'clients',
//     label: 'Clients',
//     icon: Building2,
//     path: '/admin/clients',
//   },
//   {
//     id: 'suppliers',
//     label: 'Suppliers',
//     icon: Truck,
//     path: '/admin/suppliers',
//   },
//   {
//     id: 'payments',
//     label: 'Payments',
//     icon: CreditCard,
//     path: '/admin/payments',
//   },
//   {
//     id: 'reports',
//     label: 'Reports',
//     icon: BarChart3,
//     path: '/admin/reports',
//   },
// ];

// // ==================== MENU GETTER BY ROLE ====================

// /**
//  * Get menu items based on user role
//  */
// export const getMenuItemsByRole = (role: Role): MenuItem[] => {
//   switch (role) {
//     case 'admin':
//       return adminMenuItems;
//     case 'support':
//       return supportMenuItems;
//     case 'accountant':
//       return accountantMenuItems;
//     case 'supplier':
//       return supplierMenuItems;
//     case 'client':
//       return clientMenuItems;
//     default:
//       return [];
//   }
// };
/* FILE: src/utils/validators.ts */
/* FILE: src/utils/validators.ts */
// FILE PATH: src/utils/validators.ts

import { z } from 'zod';

// ==================== ENUMS ====================
export const AvailabilityEnum = z.enum(["In Stock", "Out of Stock", "Limited"]);
export const DeliveryMethodEnum = z.enum(['Other', 'Tipper', 'Agitator', 'Pump', 'Ute']);

// ==================== AUTH SCHEMAS ====================

export const loginSchema = z.object({
  email: z.string().email('Invalid email address'),
  password: z.string().min(6, 'Password must be at least 6 characters'),
});

export const clientRegistrationSchema = z.object({
  name: z.string().min(1, 'Name is required'),
  email: z.string().email('Invalid email address'),
  password: z.string().min(6, 'Password must be at least 6 characters'),
  contact_name: z.string().min(1, 'Contact name is required'),
  contact_number: z.string().min(1, 'Contact number is required'),
  shipping_address: z.string().min(1, 'Shipping address is required'),
  billing_address: z.string().min(1, 'Billing address is required'),
  company_name: z.string().optional(),
  profile_image: z.any().optional(),
  lat: z.number(),
  long: z.number(),
});

export const supplierRegistrationSchema = z.object({
  name: z.string().min(1, 'Name is required'),
  email: z.string().email('Invalid email address'),
  password: z.string().min(6, 'Password must be at least 6 characters'),
  contact_name: z.string().min(1, 'Contact name is required'),
  contact_number: z.string().min(1, 'Contact number is required'),
  location: z.string().min(1, 'Location is required'),
  delivery_radius: z.number().positive('Delivery radius must be positive').optional(),
  company_name: z.string().min(1, 'Company name is required'),
  profile_image: z.any().optional(),
});

// ==================== PROFILE SCHEMAS ====================

export const profileUpdateSchema = z.object({
  name: z.string().min(1, 'Name is required').optional(),
  email: z.string().email('Invalid email address').optional(),
  contact_name: z.string().optional(),
  contact_number: z.string().optional(),
  company_name: z.string().optional(),
  profile_image: z.any().optional(),
  
  // Client-specific fields
  shipping_address: z.string().optional(),
  billing_address: z.string().optional(),
  lat: z.number().optional(),
  long: z.number().optional(),
  
  // Supplier-specific fields
  location: z.string().optional(),
  delivery_radius: z.number().positive('Delivery radius must be positive').optional(),
});

export const changePasswordSchema = z.object({
  current_password: z.string().min(1, 'Current password is required'),
  new_password: z.string().min(6, 'New password must be at least 6 characters'),
  new_password_confirmation: z.string().min(1, 'Please confirm your password'),
}).refine((data) => data.new_password === data.new_password_confirmation, {
  message: "Passwords don't match",
  path: ['new_password_confirmation'],
});

// ==================== SUPPLIER PRODUCT MANAGEMENT SCHEMAS ====================

/**
 * Schema for adding a product to supplier offers
 */
export const addOfferSchema = z.object({
  price: z
    .string()
    .min(1, "Price is required")
    .refine((v) => !isNaN(parseFloat(v)) && parseFloat(v) > 0, {
      message: "Price must be a positive number",
    }),
  availability_status: AvailabilityEnum,
});

/**
 * Schema for updating supplier offer
 */
export const updateOfferSchema = z.object({
  price: z
    .string()
    .min(1, "Price is required")
    .refine((v) => !isNaN(parseFloat(v)) && parseFloat(v) > 0, {
      message: "Price must be a positive number",
    }),
  availability_status: AvailabilityEnum,
});

/**
 * Schema for requesting new master product
 */
export const requestProductSchema = z
  .object({
    product_name: z
      .string()
      .min(1, "Product name is required")
      .min(3, "Product name must be at least 3 characters")
      .max(255, "Product name must not exceed 255 characters"),

    product_type: z
      .string()
      .min(1, "Product type is required")
      .max(255, "Product type must not exceed 255 characters"),

    category_id: z.number().positive("Please select a valid category"),

    unit_of_measure: z
      .string()
      .min(1, "Unit of measure is required")
      .max(50, "Unit of measure must not exceed 50 characters"),

    specifications: z.string().max(1000, "Specifications must not exceed 1000 characters").optional(),

    price: z
      .string()
      .min(1, "Price is required")
      .refine((v) => !isNaN(parseFloat(v)) && parseFloat(v) > 0, {
        message: "Price must be a positive number",
      }),

    availability_status: AvailabilityEnum,
  })
  .superRefine((val, ctx) => {
    if (val.category_id === undefined || val.category_id === null) {
      ctx.addIssue({
        code: z.ZodIssueCode.custom,
        path: ["category_id"],
        message: "Category is required",
      });
    }
  });

// ==================== ORDER SCHEMAS ====================

/**
 * Schema for order creation form
 */
export const orderFormSchema = z.object({
  // Optional PO number
  po_number: z.string().optional(),
  
  // Required project selection
  project_id: z.number().positive('Please select a project'),
  
  // Required delivery address
  delivery_address: z.string().min(1, 'Delivery address is required').max(500, 'Address is too long'),
  
  // Required latitude
  delivery_lat: z.number().min(-90, 'Invalid latitude').max(90, 'Invalid latitude'),
  
  // Required longitude
  delivery_long: z.number().min(-180, 'Invalid longitude').max(180, 'Invalid longitude'),
  
  // Required delivery date (cannot be in past)
  delivery_date: z
    .string()
    .min(1, 'Delivery date is required')
    .refine((date) => {
      const selectedDate = new Date(date);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      return selectedDate >= today;
    }, 'Delivery date cannot be in the past'),
  
  // Required delivery time
  delivery_time: z.string().min(1, 'Delivery time is required'),
  
  
  // Required load size
  load_size: z.string().min(1, 'Load size is required').max(50, 'Load size is too long'),
  
  // Optional special equipment
  special_equipment: z.string().max(255).optional(),
  
  // Optional special notes
  special_notes: z.string().max(1000).optional(),
  
  // Optional repeat order flag
  repeat_order: z.boolean().optional(),
});

// ==================== TYPE EXPORTS ====================

export type LoginFormData = z.infer<typeof loginSchema>;
export type ClientRegistrationFormData = z.infer<typeof clientRegistrationSchema>;
export type SupplierRegistrationFormData = z.infer<typeof supplierRegistrationSchema>;
export type ProfileUpdateFormData = z.infer<typeof profileUpdateSchema>;
export type ChangePasswordFormData = z.infer<typeof changePasswordSchema>;
export type RequestProductFormData = z.infer<typeof requestProductSchema>;
export type AddOfferFormData = z.infer<typeof addOfferSchema>;
export type UpdateOfferFormData = z.infer<typeof updateOfferSchema>;
export type OrderFormValues = z.infer<typeof orderFormSchema>;
/* FILE: src/vite-env.d.ts */
// src/vite-env.d.ts
interface ImportMetaEnv {
  readonly VITE_IMAGE_BASE_URL: string;
  readonly VITE_API_BASE_URL: string;
  readonly VITE_GOOGLE_MAPS_API_KEY: string;
  readonly VITE_IMG_URL: string;
  readonly VITE_ENVRIONMENT: string;
  readonly VITE_BASE_PATH: string;
  readonly VITE_STRIPE_PUBLISHABLE_KEY: string;
}
interface ImportMeta {
  readonly env: ImportMetaEnv;
}
